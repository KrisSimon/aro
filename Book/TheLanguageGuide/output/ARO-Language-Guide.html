<!DOCTYPE html><html><head><meta charset="utf-8">
<title>ARO: Business Logic as Language - The Language Guide</title>
<style>/* ARO Language Guide - Unix Handbook Style for Screens */

@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Serif:wght@400;500;600&display=swap');

:root {
    --bg-color: #fdfdf8;
    --text-color: #1a1a1a;
    --heading-color: #0a0a0a;
    --code-bg: #f4f4f0;
    --code-border: #e0e0d8;
    --link-color: #1a4d80;
    --accent: #333;
    --chapter-num: #666;
}

@media (prefers-color-scheme: dark) {
    :root {
        --bg-color: #1a1a1a;
        --text-color: #e0e0e0;
        --heading-color: #ffffff;
        --code-bg: #2a2a2a;
        --code-border: #3a3a3a;
        --link-color: #6aafe6;
        --accent: #888;
        --chapter-num: #888;
    }
}

* {
    box-sizing: border-box;
}

html {
    font-size: 15px;
}

body {
    font-family: 'IBM Plex Serif', 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
    line-height: 1.65;
    color: var(--text-color);

    max-width: 42rem;
    margin: 0 auto;
    padding: 2rem;
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
    font-family: 'IBM Plex Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    color: var(--heading-color);
    font-weight: 600;
    line-height: 1.3;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
}

h1 {
    font-size: 2.2rem;
    border-bottom: 3px solid var(--accent);
    padding-bottom: 0.5rem;
    margin-top: 3rem;
    page-break-before: always;
}


h1::before {
    content: "§ ";
    color: var(--chapter-num);
    font-weight: 400;
}

h2 {
    font-size: 1.5rem;
    border-bottom: 1px solid var(--code-border);
    padding-bottom: 0.3rem;
}

h3 {
    font-size: 1.2rem;
}

h4 {
    font-size: 1.1rem;
    font-style: italic;
}

/* Epigraphs - the italic quotes under chapter titles */
h1 + p > em:only-child,
h2 + p > em:only-child {
    display: block;
    font-size: 1rem;
    color: var(--chapter-num);
    border-left: 3px solid var(--code-border);
    padding-left: 1rem;
    margin: 1rem 0 2rem 0;
}

p {
    margin: 1rem 0;
    text-align: justify;
    hyphens: auto;
}

/* Links */
a {
    color: var(--link-color);
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

/* Code - clean minimal style */
code {
    font-family: 'IBM Plex Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
    font-size: 0.85rem;
    padding: 0.1rem 0.3rem;
}

pre {
    font-family: 'IBM Plex Mono', 'Menlo', 'Monaco', 'Consolas', monospace;
    font-size: 0.8rem;
    line-height: 1.5;
    border-left: 3px solid var(--accent);
    padding: 0.8rem 1rem;
    overflow-x: auto;
    margin: 1.5rem 0;
}

pre code {
    background: none;
    border: none;
    padding: 0;
    font-size: inherit;
}

/* Tables - clean minimal style */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.9rem;
}

th, td {
    text-align: left;
    padding: 0.5rem 0.6rem;
    border-bottom: 1px solid var(--code-border);
}

th {
    font-family: 'IBM Plex Sans', sans-serif;
    font-weight: 600;
    border-bottom: 2px solid var(--accent);
}

/* Lists */
ul, ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
}

li {
    margin: 0.3rem 0;
}

li > ul, li > ol {
    margin: 0.3rem 0;
}

/* Blockquotes */
blockquote {
    margin: 1.5rem 0;
    padding: 0.5rem 1rem;
    border-left: 3px solid var(--accent);
    font-style: italic;
}

blockquote p {
    margin: 0.5rem 0;
}

/* Horizontal rules - chapter separators */
hr {
    border: none;
    border-top: 1px solid var(--code-border);
    margin: 3rem 0;
}

hr::after {
    content: "* * *";
    display: block;
    text-align: center;
    margin-top: -0.7rem;
    background: var(--bg-color);
    color: var(--chapter-num);
    font-size: 0.9rem;
    width: 4rem;
    margin-left: auto;
    margin-right: auto;
}

/* Table of Contents */
#TOC {
    padding: 1rem 0;
    margin: 2rem 0;
    page-break-after: always;
}

#TOC::before {
    content: "Contents";
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 1.2rem;
    font-weight: 600;
    display: block;
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--accent);
    padding-bottom: 0.5rem;
}

#TOC ul {
    list-style: none;
    padding-left: 0;
}

#TOC > ul > li {
    margin: 0.8rem 0;
    font-weight: 500;
}

#TOC > ul > li > ul {
    font-weight: 400;
    padding-left: 1.5rem;
    margin-top: 0.3rem;
}

#TOC > ul > li > ul > li {
    margin: 0.2rem 0;
    font-size: 0.95rem;
}

/* Print styles */
@media print {
    body {
        max-width: none;
        padding: 0;
        font-size: 11pt;
    }

    h1 {
        page-break-before: always;
    }

    h1:first-of-type {
        page-break-before: avoid;
    }

    pre, blockquote, table {
        page-break-inside: avoid;
    }

    a {
        color: inherit;
        text-decoration: none;
    }
}

/* Title page styling */
.title-block {
    text-align: center;
    margin: 4rem 0;
    padding: 2rem;
    border: 2px solid var(--accent);
}

.title {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.subtitle {
    font-size: 1.3rem;
    color: var(--chapter-num);
}

.author, .date {
    margin-top: 1rem;
    font-size: 1rem;
}</style>
</head><body>
<div class="cover-page"
style="page-break-after: always; text-align: center; padding-top: 20%;">
<div
style="font-size: 72pt; font-weight: bold; letter-spacing: 0.2em; margin-bottom: 0.5em;">
<p>ARO</p>
</div>
<div
style="font-size: 14pt; text-transform: uppercase; letter-spacing: 0.3em; color: #666; margin-bottom: 3em;">
<p>Action • Result • Object</p>
</div>
<div style="font-size: 28pt; margin-bottom: 0.5em;">
<p>The Language Guide</p>
</div>
<div style="font-size: 14pt; color: #666; margin-bottom: 4em;">
<p>Business Logic as Language</p>
</div>
<div
style="position: absolute; bottom: 15%; width: 100%; text-align: center;">
<div style="font-size: 12pt; color: #888;">
<p>December 2025</p>
</div>
<div style="font-size: 11pt; color: #aaa; margin-top: 1em;">
<p>Version 1.0</p>
</div>
</div>
</div>
<h1 id="chapter-1-why-aro-the-power-of-constraints">Chapter 1: Why ARO?
— The Power of Constraints</h1>
<p><em>“The most powerful thing a language can do is say no.”</em></p>
<hr />
<h2 id="the-paradox-of-less">1.1 The Paradox of Less</h2>
<p>Every programmer eventually discovers a counterintuitive truth:
sometimes the best code is the code you couldn’t write.</p>
<p>General-purpose languages like Python, JavaScript, and Go are
magnificent tools. They let you express almost anything. But “almost
anything” is precisely the problem. When a language permits infinite
variation, every codebase becomes a unique dialect. Reading someone
else’s Express.js handler requires decoding their personal philosophy of
error handling, their opinions on async/await versus callbacks, their
stance on mutation.</p>
<p>ARO takes a different path. It deliberately limits what you can
express. No loops. No conditionals. No arbitrary function definitions.
Just 24 verbs, a fixed grammar, and a commitment to the happy path.</p>
<p>This isn’t a limitation born of laziness or naivety. It’s a design
philosophy with historical precedent:</p>
<ul>
<li><strong>SQL</strong> (1974): You can’t write loops. You describe
<em>what</em> you want, not <em>how</em> to get it. Result: the most
successful data language in history.</li>
<li><strong>Make</strong> (1976): You can’t express arbitrary control
flow. You declare dependencies and recipes. Result: still building
software 50 years later.</li>
<li><strong>Terraform</strong> (2014): You can’t write general programs.
You declare desired state. Result: infrastructure-as-code became an
industry.</li>
<li><strong>Dhall</strong> (2016): You can’t write Turing-complete
programs. You get guaranteed termination. Result: configuration that
actually validates.</li>
</ul>
<p>These languages succeeded not despite their constraints but because
of them. When a language says “no” to complexity, it creates space for
clarity.</p>
<hr />
<h2 id="anatomy-of-a-constrained-language">1.2 Anatomy of a Constrained
Language</h2>
<p>ARO makes specific choices about what it will and won’t express:</p>
<p><strong>What ARO Has:</strong> - 24 built-in actions (verbs like
Extract, Compute, Return, Emit) - A fixed sentence structure:
<code>&lt;Action&gt; the &lt;Result&gt; preposition the &lt;Object&gt;</code>
- Feature sets that respond to events - First-class support for HTTP,
files, and sockets - Native compilation to standalone binaries</p>
<p><strong>What ARO Deliberately Lacks:</strong> - Traditional if/else
(uses <code>when</code> guards and <code>match</code> expressions
instead) - Traditional loops (uses <code>for each</code> and collection
actions instead of while/recursion) - User-defined functions (feature
sets aren’t functions) - Complex type system (primitives built-in,
complex types from OpenAPI schemas) - Exception handling (happy path
only)</p>
<p>This sounds limiting because it is. But limitation is the point. When
the 24 built-in actions aren’t enough, ARO provides escape
hatches—custom actions written in Swift and distributable plugins. But
that’s a topic for later chapters, after you’ve learned the language
itself.</p>
<hr />
<h2 id="the-honest-trade-offs">1.3 The Honest Trade-offs</h2>
<p>We promised fairness. Here it is.</p>
<h3 id="the-pros">The Pros</h3>
<p><strong>Reduced Cognitive Load</strong></p>
<p>When there’s only one way to fetch data from a database, code review
becomes trivial. You don’t debate style. You don’t argue about error
handling patterns. You don’t wonder if the author knows about that
“better” approach. There’s one approach.</p>
<p>A team of five developers writing ARO will produce code that looks
like it was written by one person. A team of five developers writing
TypeScript will produce five dialects.</p>
<p><strong>Smaller Attack Surface</strong></p>
<p>Simple APIs have less room for bugs. When you can’t write:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (user<span class="op">.</span><span class="at">role</span> <span class="op">===</span> <span class="st">&#39;admin&#39;</span> <span class="op">||</span> user<span class="op">.</span><span class="at">department</span> <span class="op">===</span> currentDepartment) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Complex permission logic with subtle edge cases</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>You can’t write the subtle bug hiding in that conditional. ARO’s
permission checks happen in dedicated actions that can be audited once
and trusted forever.</p>
<p><strong>Enforced Patterns</strong></p>
<p>ARO doesn’t need a style guide. The grammar <em>is</em> the style
guide. Every statement follows the same structure. Every feature set has
the same shape. This isn’t just aesthetics—it’s a forcing function for
architectural consistency.</p>
<p><strong>Auditability</strong></p>
<p>Consider this ARO feature set:</p>
<pre class="aro"><code>(createUser: User API) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.
    &lt;Validate&gt; the &lt;data&gt; against the &lt;user: schema&gt;.
    &lt;Create&gt; the &lt;user&gt; with &lt;data&gt;.
    &lt;Emit&gt; a &lt;UserCreated: event&gt; with &lt;user&gt;.
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.
}</code></pre>
<p>A business analyst can read this. A compliance officer can audit it.
A new developer can understand it in seconds. The code <em>is</em> the
documentation.</p>
<p><strong>AI-Friendly</strong></p>
<p>Large language models excel at constrained grammars. Ask GPT to write
“a Python function that does X” and you’ll get endless variation. Ask it
to write “an ARO feature set that does X” and the constrained grammar
guides it toward consistency.</p>
<p>This matters for AI-assisted development, automated code generation,
and the emerging world of agents that write code.</p>
<h3 id="the-cons">The Cons</h3>
<p><strong>Ceiling of Expression</strong></p>
<p>Some problems genuinely need conditionals. Calculating tax brackets.
Routing based on user roles. Retrying with exponential backoff. ARO
handles these by pushing complexity into custom actions—but that means
escaping to Swift, which defeats some of the simplicity benefits.</p>
<p>If your domain is inherently conditional, you’ll spend more time
writing extensions than writing ARO.</p>
<p><strong>Extension Overhead</strong></p>
<p>When you need a custom action, you need to: 1. Write Swift code 2.
Understand ARO’s action protocol 3. Register the action 4. Rebuild</p>
<p>This is more friction than adding a function in a general-purpose
language. For rapid prototyping, this overhead hurts.</p>
<p><strong>Learning Curve</strong></p>
<p>Thinking in actions feels unnatural at first. Programmers are trained
to think in terms of functions, loops, and conditionals. ARO requires
unlearning those instincts and relearning a declarative vocabulary.</p>
<p>The payoff comes later, but the initial investment is real.</p>
<p><strong>Ecosystem Immaturity</strong></p>
<p>Stack Overflow doesn’t have ARO answers. There’s no npm with
thousands of packages. The community is small. When you hit a problem,
you’re often on your own.</p>
<p>This is the tax every new language pays. ARO is paying it now.</p>
<p><strong>Abstraction Leaks</strong></p>
<p>ARO’s “happy path only” philosophy is beautiful until something goes
wrong. When a database query fails, you get a runtime error message that
describes what couldn’t be done. Sometimes that’s enough. Sometimes you
desperately need conditional error handling.</p>
<p>When the abstraction leaks, you feel it acutely.</p>
<hr />
<h2 id="domain-suitability">1.4 Domain Suitability</h2>
<p>Not every domain is equally suited to ARO’s constraints. Here’s an
honest assessment:</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 40%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th>Domain</th>
<th>Suitability</th>
<th>Reasoning</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Business Logic / CRUD APIs</strong></td>
<td>Excellent</td>
<td>ARO’s natural home. Extract data, validate, transform, persist,
return. The action vocabulary maps perfectly to business
operations.</td>
</tr>
<tr>
<td><strong>DevOps / Infrastructure</strong></td>
<td>Good</td>
<td>Declarative actions like <code>&lt;Provision&gt;</code>,
<code>&lt;Deploy&gt;</code>, <code>&lt;Configure&gt;</code> map well to
infrastructure verbs. The lack of conditionals is less painful because
infrastructure should be idempotent anyway.</td>
</tr>
<tr>
<td><strong>Build Systems</strong></td>
<td>Promising</td>
<td>Actions as build steps, events as triggers, dependency graphs as
feature set chains. Make proved this paradigm works. ARO could extend
it.</td>
</tr>
<tr>
<td><strong>IoT / Edge Computing</strong></td>
<td>Interesting</td>
<td>Small compiled binaries. Event-driven architecture. Limited
resources favor limited languages. Native compilation makes deployment
feasible.</td>
</tr>
<tr>
<td><strong>System Administration</strong></td>
<td>Moderate</td>
<td>Scripts often need conditionals (“if file exists, do X”). ARO would
require more custom actions than might be practical.</td>
</tr>
<tr>
<td><strong>Data Science / ML</strong></td>
<td>Poor</td>
<td>Iteration is fundamental. Exploration requires flexibility. The
REPL-driven workflow clashes with ARO’s compile-run cycle.</td>
</tr>
<tr>
<td><strong>Game Development</strong></td>
<td>Poor</td>
<td>Tight loops for physics. Real-time requirements. Mutable state
everywhere. ARO’s constraints actively hurt here.</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="when-simplicity-wins">1.5 When Simplicity Wins</h2>
<p>Here’s a mental model for when ARO’s trade-offs favor you:</p>
<p><strong>The Bug Equation</strong></p>
<pre><code>Bugs ∝ (API Surface) × (Complexity) × (Mutability)</code></pre>
<p>ARO attacks all three factors: - <strong>Smaller API
surface</strong>: 24 actions vs. infinite function possibilities -
<strong>Reduced complexity</strong>: No control flow means fewer
execution paths - <strong>Limited mutability</strong>: Actions transform
and return; they don’t mutate shared state (though explicit shared
repositories exist for business domain data and can be safely used
across feature sets)</p>
<p>Consider a real comparison. A typical Express.js endpoint handler
might span 500 lines: request parsing, authentication, authorization,
validation, business logic, database queries, error handling, response
formatting, logging. Each line is a potential bug. Each conditional
doubles the test matrix.</p>
<p>The equivalent ARO feature set might be 15 lines. Each line is a
single action with well-defined semantics. The test matrix is
manageable.</p>
<p><strong>When the Trade-off Favors Constraints</strong></p>
<ol type="1">
<li><p><strong>Team Size &gt; 5</strong>: Consistency becomes more
valuable than flexibility when more people touch the code.</p></li>
<li><p><strong>Regulatory Environments</strong>: Healthcare, finance,
and government need auditable code. ARO reads like
documentation.</p></li>
<li><p><strong>Long-Lived Systems</strong>: Code is read more than it’s
written. Readability beats cleverness over a 10-year lifespan.</p></li>
<li><p><strong>AI-Assisted Development</strong>: If agents will modify
your code, constrained grammars make their output more
predictable.</p></li>
<li><p><strong>High-Reliability Requirements</strong>: Fewer execution
paths mean fewer untested paths. Constraints prevent entire categories
of bugs.</p></li>
</ol>
<hr />
<h2 id="when-to-look-elsewhere">1.6 When to Look Elsewhere</h2>
<p>ARO isn’t the right choice for:</p>
<p><strong>Real-Time Systems</strong></p>
<p>Microsecond precision requires low-level control. ARO’s abstraction
layer adds latency you can’t afford.</p>
<p><strong>Heavy Algorithmic Work</strong></p>
<p>Sorting algorithms. Graph traversal. Machine learning training loops.
These need iteration and fine-grained control. ARO would require
escaping to Swift for virtually everything.</p>
<p><strong>Exploratory Programming</strong></p>
<p>Some domains benefit from REPL-driven experimentation. Data analysis.
Prototyping. Research. ARO’s compile-run cycle creates friction that
hurts exploration.</p>
<p><strong>Teams with Strong Existing Patterns</strong></p>
<p>If your team already has battle-tested Go services with excellent
patterns, introducing ARO adds cognitive overhead without clear benefit.
The value of constraints diminishes when you already have good
constraints.</p>
<hr />
<h2 id="the-missing-parts-a-pre-alpha-disclaimer">1.7 The Missing Parts
— A Pre-Alpha Disclaimer</h2>
<blockquote>
<p>ARO is pre-alpha software. This section exists because honesty is a
feature.</p>
</blockquote>
<h3 id="whats-not-here-yet">What’s Not Here Yet</h3>
<p><strong>Conditional Logic</strong></p>
<p>ARO has no traditional if/else. Instead, it provides guarded
statements with <code>when</code> clauses and <code>match</code>
expressions for pattern matching. These cover most conditional needs
while maintaining ARO’s declarative style, though complex nested
conditionals still require custom actions.</p>
<p><strong>Iteration</strong></p>
<p>ARO provides <code>for each</code> loops for serial iteration and
<code>parallel for each</code> for concurrent processing. Collection
actions like <code>&lt;Filter&gt;</code>,
<code>&lt;Transform&gt;</code>, <code>&lt;Sum&gt;</code>,
<code>&lt;Sort&gt;</code>, and others handle common operations
declaratively. While not as flexible as general-purpose loops, these
constructs cover most business processing needs.</p>
<p><strong>Type System</strong></p>
<p>ARO has four built-in primitive types (String, Integer, Float,
Boolean) and collection types (List, Map). Complex types—records and
enums—are defined in your <code>openapi.yaml</code> file’s
components/schemas section. This “single source of truth” approach means
OpenAPI defines both your HTTP routes and your data types. Runtime type
checking validates data against these schemas, with errors reported in
business terms rather than technical stack traces.</p>
<p><strong>Debugging Tools</strong></p>
<p>No step debugger exists. Limited introspection. Debugging means
reading logs and error messages. IDE integration is primitive—syntax
highlighting exists; language server protocol support is in
progress.</p>
<p><strong>Standard Library</strong></p>
<p>24 actions is a starting point. The vocabulary will grow. File
operations beyond basic I/O. Database abstractions. Authentication
patterns. These need to be built.</p>
<p><strong>Documentation</strong></p>
<p>You’re reading the first attempt. Expect gaps, errors, and outdated
information.</p>
<h3 id="what-will-change">What Will Change</h3>
<p>This is pre-alpha software. Expect:</p>
<ul>
<li>Action signatures may evolve incompatibly</li>
<li>Preposition semantics are still being refined</li>
<li>Native compilation is experimental</li>
<li>Plugin API is unstable</li>
<li>Error messages will improve (they’re rough now)</li>
</ul>
<h3 id="the-commitment">The Commitment</h3>
<p>This book is maintained alongside the language. We use AI-assisted
tooling to keep chapters synchronized with the codebase. When ARO
changes, the book follows.</p>
<p>For the latest version, check the repository. For the authoritative
specification, read the proposals in <code>Proposals/</code>.</p>
<hr />
<pre><code>This chapter reflects ARO as of December 2025.
Language version: pre-alpha
Book revision: 0.1</code></pre>
<hr />
<p><em>Next: Chapter 2 — The ARO Mental Model</em></p>
<h1 id="chapter-2-the-aro-mental-model">Chapter 2: The ARO Mental
Model</h1>
<p><em>“Every statement is a sentence. Every program is a
story.”</em></p>
<hr />
<h2 id="thinking-in-sentences">2.1 Thinking in Sentences</h2>
<p>Most programming languages ask you to think in terms of instructions.
You assign variables, call functions, iterate over collections, and
handle exceptions. The cognitive overhead accumulates with every new
construct you learn. ARO takes a radically different approach: it asks
you to think in terms of sentences.</p>
<p>Consider how you might explain a business process to a colleague. You
would not say “iterate over the user collection, extract the email
field, and invoke the send method on each result.” You would say “send
an email to each user.” Natural language describes what should happen,
not the mechanical steps to achieve it.</p>
<p>This observation forms the foundation of ARO’s design. The language
constrains you to express operations as sentences, each following a
consistent grammatical structure. This constraint is not a limitation
but a clarifying force. When every line of code must fit the same
pattern, you cannot hide complexity in clever abstractions or obscure
syntax. The code reads like a description of the process itself.</p>
<p>The fundamental pattern is simple: an action verb, followed by a
result noun, followed by a preposition and an object. Every statement in
ARO follows this structure without exception. There are no special
cases, no alternative syntaxes, no shortcuts that break the pattern.
This uniformity means that once you understand how to read one ARO
statement, you can read any ARO statement in any program.</p>
<hr />
<h2 id="the-fdd-heritage">2.2 The FDD Heritage</h2>
<p>ARO’s Action-Result-Object pattern did not emerge from thin air. It
traces back to 1997, when Jeff De Luca and Peter Coad faced a crisis on
a massive banking project for United Overseas Bank in Singapore.
Developers from around the world could not understand the business
requirements, and business people could not understand the developers.
The project was failing.</p>
<p>De Luca and Coad asked a radical question: what if they structured
the entire development process around something everyone could
understand—features? They called their approach Feature-Driven
Development, or FDD, and it worked. The banking project was saved.</p>
<p>At the heart of FDD was a deceptively simple idea. Every feature
should be expressed as an action performed on a result for a business
object. The formula was: <em>Action the Result for the Object</em>.
“Calculate the total for the shopping cart.” “Validate the credentials
for the user.” “Send the notification to the customer.” This was not
just a naming convention. It was a language—a way for product managers,
business analysts, and developers to speak the same tongue.</p>
<p>Features grouped into Feature Sets, collections of related
functionality that together delivered a business capability. A “User
Management” feature set might contain “Create the account for the user,”
“Validate the credentials for the user,” “Update the profile for the
user,” and “Reset the password for the user.” Visual dashboards called
Parking Lots showed the status of all feature sets at a glance.
Anyone—even executives without technical backgrounds—could see what was
done, what was in progress, and what was coming.</p>
<p>In 2002, Stephen R. Palmer and John M. Felsing published “A Practical
Guide to Feature-Driven Development,” documenting FDD’s principles. But
by then, the Agile movement had begun. Scrum and Kanban captured the
industry’s attention, and FDD faded into a footnote in methodology
discussions.</p>
<p>FDD did not die because it was wrong. It faded because it was ahead
of its time. In 1997, there was no technology to make feature-language
into real code. Developers still had to translate those beautifully
clear feature descriptions into Python, Java, or C#. The gap between
specification and implementation remained.</p>
<p>Twenty-five years later, Large Language Models changed everything. AI
that understands natural language made feature-language suddenly
practical. When a statement like “Extract the user from the request” is
both the specification <em>and</em> the code, there is no translation
gap. The AI does not have to guess what you mean. The structure is the
specification.</p>
<p>ARO is the realization of FDD’s vision. The Action-Result-Object
pattern that De Luca and Coad invented for documentation becomes an
actual programming language. Feature sets that once existed only in
project plans now execute directly. The bridge between business and
code, imagined in 1997, finally exists.</p>
<hr />
<h2 id="the-three-components">2.3 The Three Components</h2>
<p>Every ARO statement consists of exactly three semantic components
that work together to express a complete operation.</p>
<p>The first component is the <strong>Action</strong>, which represents
what you want to do. Actions are verbs—words like Extract, Create,
Return, Validate, or Store. They describe the operation in terms of its
intent rather than its implementation. When you write an Extract action,
you are expressing that you want to pull data out of something. You are
not specifying how that extraction happens, what data structures are
involved, or what error handling should occur. The verb captures the
essence of the operation.</p>
<p>The second component is the <strong>Result</strong>, which represents
what you get back. Every action produces something, even if that
something is simply a confirmation that the operation succeeded. The
result is the variable that will hold the produced value. You give it a
name that describes what it represents in your domain. If you are
extracting a user identifier from a request, you name the result
“user-id” because that is what it is. The name becomes part of the
program’s documentation, making the code self-describing.</p>
<p>The third component is the <strong>Object</strong>, which represents
the input or context for the action. Objects are introduced by
prepositions—words like “from,” “with,” “into,” and “against.” The
choice of preposition is significant because it communicates the
relationship between the action and its input. When you extract
something “from” a source, the preposition indicates that data is moving
from the object toward the result. When you store something “into” a
repository, the preposition indicates that data is moving from the
result toward the object.</p>
<p>These three components combine to form a complete sentence. Consider
this statement:</p>
<pre class="aro"><code>&lt;Extract&gt; the &lt;user-id&gt; from the &lt;pathParameters: id&gt;.</code></pre>
<p>The action is Extract, telling us that we are pulling data out of
something. The result is user-id, which will hold the extracted value.
The object is pathParameters with a qualifier of id, indicating where
the data comes from. The preposition “from” establishes that data flows
from the path parameters into the user-id variable.</p>
<p>Reading this statement aloud produces natural English: “Extract the
user-id from the path parameters id.” No translation is needed between
the code and its meaning.</p>
<h2 id="understanding-semantic-roles">2.4 Understanding Semantic
Roles</h2>
<p>Actions in ARO are not arbitrary verbs. Each action carries a
semantic role that describes the direction of data flow. The runtime
automatically classifies actions based on their verbs, and this
classification has important implications for how the program
executes.</p>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="140" height="140" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
<text x="70" y="16" text-anchor="middle" font-family="sans-serif" font-size="12" font-weight="bold" fill="#6366f1">REQUEST</text>
<rect x="30" y="25" width="80" height="35" rx="4" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
<text x="70" y="47" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#4338ca">External</text>
<line x1="70" y1="60" x2="70" y2="80" stroke="#6366f1" stroke-width="2"/>
<polygon points="70,90 63,78 77,78" fill="#6366f1"/>
<rect x="30" y="95" width="80" height="35" rx="4" fill="#c7d2fe" stroke="#6366f1" stroke-width="2"/>
<text x="70" y="117" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#4338ca">Feature
Set</text>
</svg>
</div>
<p>The first role is called <strong>REQUEST</strong>, which describes
actions that bring data from outside the feature set into the current
context. Think of request actions as inbound data flows. They reach out
to external sources—HTTP requests, databases, files, or other
services—and pull data into your local scope. Verbs like Extract,
Retrieve, Fetch, and Read all carry the request role. When you use one
of these verbs, you are declaring that you need data from somewhere
else.</p>
<div style="clear: both;">

</div>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="140" height="120" viewBox="0 0 140 120" xmlns="http://www.w3.org/2000/svg">
<text x="70" y="16" text-anchor="middle" font-family="sans-serif" font-size="12" font-weight="bold" fill="#10b981">OWN</text>
<rect x="30" y="30" width="80" height="70" rx="4" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
<text x="70" y="55" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#059669">Feature
Set</text>
<circle cx="70" cy="78" r="15" fill="none" stroke="#10b981" stroke-width="2"/>
<path d="M 70 63 A 15 15 0 1 1 55 78" fill="none" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)"/>
<defs><marker id="arrowGreen" markerWidth="6" markerHeight="6" refX="3" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#10b981"/></marker></defs>
</svg>
</div>
<p>The second role is called <strong>OWN</strong>, which describes
actions that transform data already present in the current context.
These actions neither bring data in from outside nor send it out. They
work entirely within the boundaries of the current feature set, taking
existing values and producing new ones. Verbs like Create, Compute,
Validate, Transform, and Merge carry the own role. These are the
workhorse actions that implement your business logic.</p>
<div style="clear: both;">

</div>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="140" height="140" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
<text x="70" y="16" text-anchor="middle" font-family="sans-serif" font-size="12" font-weight="bold" fill="#ef4444">RESPONSE</text>
<rect x="30" y="25" width="80" height="35" rx="4" fill="#fecaca" stroke="#ef4444" stroke-width="2"/>
<text x="70" y="47" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#dc2626">Feature
Set</text>
<line x1="70" y1="60" x2="70" y2="80" stroke="#ef4444" stroke-width="2"/>
<polygon points="70,90 63,78 77,78" fill="#ef4444"/>
<rect x="30" y="95" width="80" height="35" rx="4" fill="#fee2e2" stroke="#ef4444" stroke-width="2"/>
<text x="70" y="112" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#dc2626">Caller</text>
<text x="70" y="124" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#991b1b">[terminates]</text>
</svg>
</div>
<p>The third role is called <strong>RESPONSE</strong>, which describes
actions that send data out of the feature set to the caller. Response
actions are outbound data flows that terminate the current execution
path. The Return verb is the most common example, sending a response
back to whoever invoked the feature set. Other verbs like Throw and
Respond also carry this role.</p>
<div style="clear: both;">

</div>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="160" height="120" viewBox="0 0 160 120" xmlns="http://www.w3.org/2000/svg">
<text x="45" y="16" text-anchor="middle" font-family="sans-serif" font-size="12" font-weight="bold" fill="#f59e0b">EXPORT</text>
<rect x="10" y="30" width="70" height="70" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="45" y="55" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#d97706">Feature
Set</text>
<text x="45" y="85" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#92400e">[continues]</text>
<line x1="80" y1="45" x2="100" y2="45" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowAmber)"/>
<line x1="80" y1="65" x2="100" y2="65" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowAmber)"/>
<line x1="80" y1="85" x2="100" y2="85" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowAmber)"/>
<text x="130" y="48" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#92400e">Repository</text>
<text x="130" y="68" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#92400e">Event
Bus</text>
<text x="130" y="88" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#92400e">Log</text>
<defs><marker id="arrowAmber" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#f59e0b"/></marker></defs>
</svg>
</div>
<p>The fourth role is called <strong>EXPORT</strong>, which describes
actions that make data available beyond the current execution without
terminating it. Unlike response actions, export actions allow execution
to continue. They persist data to repositories, emit events for other
handlers to process, or publish values for access within the same
business activity. Verbs like Store, Emit, Publish, and Log carry the
export role.</p>
<div style="clear: both;">

</div>
<p>Understanding these roles helps you reason about your programs. A
typical feature set begins with request actions that gather the needed
data, follows with own actions that process and transform that data,
includes export actions that persist results or notify other parts of
the system, and concludes with a response action that sends the final
result to the caller. This pattern emerges naturally from the semantic
roles.</p>
<h2 id="why-uniformity-matters">2.5 Why Uniformity Matters</h2>
<p>The uniform structure of ARO statements might seem restrictive at
first. Why force every operation into the same grammatical pattern? The
answer lies in what uniformity enables.</p>
<p>When every statement follows the same structure, reading code becomes
effortless. You never wonder what syntax you are looking at or what
special rules apply. Every line is an action, a result, a preposition,
and an object. Your eyes learn to parse this pattern automatically, and
soon you can scan ARO code as quickly as you scan prose.</p>
<p>Uniformity also benefits writing. You never face the question of how
to express something. The grammar constrains you to the
action-result-object pattern, and within that pattern, you simply choose
the verb that matches your intent and the names that describe your data.
There are no style debates about whether to use a function or a method,
whether to inline an expression or extract it, or whether to use early
returns or guard clauses. The grammar makes these decisions for you.</p>
<p>For tools, uniformity is transformative. Parsers, analyzers, code
generators, and formatters all work identically across every statement
because there are no special cases. An AI assistant can generate or
verify ARO code with high confidence because the constrained grammar
limits the space of possible outputs. Refactoring tools can manipulate
code safely because the structure is completely predictable.</p>
<p>Perhaps most importantly, uniformity benefits teams. When five
developers write ARO code, the result looks like it was written by one
person. There are no personal styles, no preferred idioms, no clever
tricks that only the author understands. The code is what it is,
expressed in the only way the grammar permits.</p>
<h2 id="the-declarative-shift">2.6 The Declarative Shift</h2>
<p>Traditional programming is imperative. You tell the computer how to
do something by listing the steps it should follow. Fetch the request
body. Parse the JSON. Check if the email field exists. Validate the
format. Query the database. Handle the not-found case. Construct the
response. Send it back. Each step is a command, and you must get every
command right in the right order.</p>
<p>ARO is declarative. You tell the computer what you want to happen,
and the runtime figures out how to make it happen. This shift has
profound implications for how you think about programming.</p>
<p>Consider a typical operation: getting a user by their identifier. In
an imperative style, you would write code that explicitly handles each
step and each potential failure. In ARO, you write:</p>
<pre class="aro"><code>(getUser: User API) {
    &lt;Extract&gt; the &lt;user-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where &lt;id&gt; is &lt;user-id&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}</code></pre>
<p>This code does not explain how to extract the identifier from the
path. It does not specify what happens if the identifier is missing. It
does not detail how to query the repository or what to do if the user is
not found. It simply states what should happen when everything works
correctly.</p>
<p>The runtime handles everything else. If the extraction fails because
the path parameter is missing, the runtime produces an appropriate error
message. If the retrieval fails because no user has that identifier, the
runtime produces a not-found response. You do not write error handling
code because there is nothing to handle. You express the successful
case, and the runtime handles the unsuccessful cases.</p>
<p>This is the “happy path” philosophy. Your code contains only the path
through the logic when everything succeeds. The runtime, which is tested
and trusted, handles the paths where things fail. This dramatically
reduces the amount of code you write and eliminates entire categories of
bugs that arise from incorrect error handling.</p>
<h2 id="data-as-transformation">2.7 Data as Transformation</h2>
<p>The ARO mental model encourages you to think about data as a series
of transformations rather than as mutable state that you manipulate over
time.</p>
<p>Each statement in a feature set transforms the available data. The
first statement might extract a value from the request, making that
value available to subsequent statements. The second statement might use
that value to retrieve something from a repository, making the retrieved
data available. The third statement might combine several values into a
new object. The fourth might persist that object.</p>
<p>At each step, you are not modifying existing data. You are producing
new data from existing data. The symbol table grows as execution
proceeds, accumulating the results of each transformation. Nothing is
overwritten or mutated. If you need a different value, you create a new
binding with a new name.</p>
<p>This immutability has practical benefits. You can always trace where
a value came from by following the chain of transformations backward.
You never face the confusion of a variable changing unexpectedly because
some distant code modified it. Debugging becomes straightforward because
the state at any point is simply the accumulation of all previous
results.</p>
<p>Think of a feature set as a pipeline. Data enters at one end, flows
through a series of transformations, and exits at the other end. Each
transformation is a pure function of its inputs, producing outputs
without side effects on the local state. Export actions have external
side effects—they persist data or emit events—but they do not change the
local symbol table in unexpected ways.</p>
<h2 id="variables-and-binding">2.8 Variables and Binding</h2>
<p>When an action produces a result, that result is bound to a name. The
binding is permanent within the scope of the feature set. You cannot
rebind a name to a different value.</p>
<p>This design prevents a common source of bugs: the accidental reuse of
a variable name for a different purpose. In many languages, you might
write code like this pseudocode: “set x to 1, then later set x to 2,
then later use x expecting it to be 1.” The bug is subtle and easy to
overlook. ARO makes this impossible. If you try to bind a name that is
already bound, the compiler rejects your code.</p>
<p>The practical implication is that you must choose descriptive names
for your results. You cannot use generic names like “temp” or “result”
for everything because you cannot reuse them. This constraint pushes you
toward self-documenting code. Instead of “result,” you write
“validated-user-data.” Instead of “temp,” you write
“calculated-total.”</p>
<p>Subsequent statements reference bound names using angle brackets.
When you write a statement that includes something like
<code>with &lt;user-data&gt;</code>, you are referencing the value that
was bound to the name “user-data” by a previous statement. If no
previous statement bound that name, the runtime reports an error.</p>
<h2 id="comparing-approaches">2.9 Comparing Approaches</h2>
<p>To understand the ARO mental model fully, it helps to contrast it
with other programming paradigms.</p>
<p>Imperative programming focuses on how to accomplish something. You
write step-by-step instructions: do this, then do that, check this
condition, loop over this collection. The computer follows your
instructions exactly. The power is that you have complete control. The
cost is that you must handle every detail.</p>
<p>Functional programming focuses on what relationships exist between
inputs and outputs. You compose functions that transform data, building
complex behaviors from simple, pure functions. The power is that pure
functions are easy to test and reason about. The cost is that real-world
programs have side effects that pure functions cannot express
directly.</p>
<p>Object-oriented programming focuses on what entities exist and how
they interact. You model your domain as objects with state and behavior,
passing messages between them. The power is that objects map naturally
to real-world concepts. The cost is that complex object graphs become
difficult to understand and modify.</p>
<p>ARO takes a different approach. It focuses on what should happen in
business terms. You express operations as sentences that describe
business activities. The power is that the code directly reflects the
business process, readable by anyone who understands the domain. The
cost is that some technical operations do not fit naturally into
sentence form and must be pushed into custom actions.</p>
<p>Each approach has its place. ARO excels at expressing business
logic—the rules and processes that define what a system does. It is less
suited to algorithmic work, systems programming, or exploratory data
analysis. Knowing when to use ARO and when to use other approaches is
part of becoming proficient with the language.</p>
<h2 id="from-understanding-to-practice">2.10 From Understanding to
Practice</h2>
<p>The mental model described in this chapter is the foundation for
everything that follows. Every chapter in this guide builds on the
concepts introduced here: actions and their semantic roles, results and
their bindings, objects and their prepositions, the uniform structure of
statements, and the declarative approach to expressing logic.</p>
<p>As you continue reading, keep these principles in mind. When you
encounter a new feature or pattern, ask yourself how it fits into the
mental model. How does this feature express data transformation? What
semantic role does this action carry? How does this pattern leverage the
uniform structure of statements?</p>
<p>The goal is not to memorize rules but to internalize a way of
thinking. Once the mental model becomes natural, writing ARO code
becomes as straightforward as describing a business process in
conversation. The language disappears, and only the intent remains.</p>
<hr />
<p><em>Next: Chapter 3 — Getting Started</em></p>
<h1 id="chapter-3-getting-started">Chapter 3: Getting Started</h1>
<p><em>“The best way to learn a language is to write
something.”</em></p>
<hr />
<h2 id="installation">3.1 Installation</h2>
<p>ARO is implemented in Swift and distributed as a command-line tool.
The implementation requires Swift 6.0 or later, which means you will
need macOS 14 or a recent Linux distribution with Swift installed. On
macOS, Xcode 16 provides everything you need. On Linux, you can install
Swift from swift.org.</p>
<p>The simplest way to get ARO is to build it from source. Clone the
repository and run Swift Package Manager’s build command. For
development work, a debug build is sufficient and compiles faster. For
running applications you intend to deploy, a release build with
optimizations produces a significantly smaller and faster binary.</p>
<p>After building, you will find the <code>aro</code> executable in the
<code>.build</code> directory. To use it conveniently from any
directory, add this location to your shell’s PATH environment variable.
Once configured, running <code>aro --help</code> should display the
available subcommands, confirming that the installation was
successful.</p>
<p>The ARO command-line tool provides four primary subcommands. The
<code>run</code> command compiles and executes an application in a
single step, which is what you will use most during development. The
<code>check</code> command validates source files without running them,
useful for catching errors before execution. The <code>build</code>
command compiles an application to a native binary for deployment. The
<code>compile</code> command produces intermediate output for tooling
integration.</p>
<hr />
<h2 id="your-first-application">3.2 Your First Application</h2>
<p>ARO applications are directories, not single files. This might seem
unusual if you are accustomed to languages where a single source file
can be a complete program. The directory-based approach exists because
ARO applications typically consist of multiple feature sets spread
across several files, and the runtime automatically discovers and loads
all of them.</p>
<p>To create an application, start by making a directory. The name you
choose becomes the application name. Inside this directory, create a
file named <code>main.aro</code> that contains your application’s entry
point.</p>
<p>Every ARO application must have exactly one
<code>Application-Start</code> feature set. This is where execution
begins. The runtime looks for this specific feature set name and
executes it when the application launches. Having zero entry points is
an error because there would be nothing to run. Having multiple entry
points is also an error because the runtime would not know which one to
execute first.</p>
<p>A minimal entry point creates a value, does something with it, and
returns a status indicating success. The <code>Create</code> action
produces a new value and binds it to a name. The <code>Log</code> action
writes output to the console. The <code>Return</code> action signals
completion. Every feature set should end with a Return action to
indicate whether it completed successfully or encountered a problem.</p>
<p>The second part of a feature set declaration, after the colon, is
called the business activity. This is a descriptive label that explains
what the feature set represents in business terms. For an entry point,
common choices include “Entry Point,” “Application,” “System
Initialization,” or something more domain-specific like “Order
Processing System.”</p>
<p>When you run your application using the <code>aro run</code> command
followed by the path to your application directory, the runtime
discovers all ARO source files, compiles them, identifies the entry
point, and executes it. If everything works correctly, you see your
output and the application terminates. If something goes wrong, you see
an error message explaining what happened and where.</p>
<hr />
<h2 id="understanding-application-structure">3.3 Understanding
Application Structure</h2>
<p>The directory-based organization reflects how ARO applications are
intended to be structured. A typical application has a main file
containing the entry point and lifecycle handlers, plus additional files
containing feature sets organized by domain or purpose.</p>
<p>The runtime automatically discovers all files with the
<code>.aro</code> extension in the application directory. You do not
need import statements or explicit file references. When the runtime
starts, it scans the directory, parses each file, validates the combined
set of feature sets, and registers them with the event bus. This means
you can add new feature sets simply by creating new files, and they
become available immediately.</p>
<p>The automatic discovery has an important implication: all feature
sets are globally visible within an application. A feature set in one
file can emit an event that triggers a feature set in another file
without any explicit connection between them. This loose coupling is
intentional. It allows you to organize code however makes sense for your
project without worrying about dependency graphs between files.</p>
<p>There is one constraint on this freedom: exactly one
<code>Application-Start</code> must exist across all files. The runtime
enforces this during startup and reports an error if the constraint is
violated. Similarly, you can have at most one
<code>Application-End: Success</code> for handling graceful shutdown and
at most one <code>Application-End: Error</code> for handling crash
scenarios. See Chapter 10 for complete lifecycle details.</p>
<p>For applications that expose HTTP APIs, you will typically include an
<code>openapi.yaml</code> file in the application directory. This file
defines the API contract using the OpenAPI specification. When present,
the runtime uses it to configure HTTP routing, matching incoming
requests to feature sets based on operation identifiers defined in the
contract. Without this file, no HTTP server starts. This is deliberate:
ARO follows a contract-first approach where the API specification drives
the implementation rather than the other way around.</p>
<hr />
<h2 id="the-command-line-interface">3.4 The Command-Line Interface</h2>
<p>The <code>aro run</code> command is your primary tool during
development. It takes a path to an application directory, compiles all
source files, validates the application structure, and executes the
entry point. The process is designed to be fast enough that you can
iterate quickly, making changes and rerunning to see the effects.</p>
<p>The verbose flag adds detailed output showing what the runtime is
doing. You can see which files were discovered, how they were parsed,
which feature sets were registered, and how events flow during
execution. This visibility is invaluable when debugging issues or
understanding how an application behaves.</p>
<p>For servers and other long-running applications, you need to use the
Keepalive action to prevent the application from terminating after the
entry point completes. Without it, the runtime executes the entry point
and exits, which is fine for batch processes but not for services that
need to wait for incoming requests.</p>
<p>The <code>aro check</code> command validates source files without
executing them. Think of it as a sophisticated linter that catches not
just syntax errors but also semantic issues like undefined variables,
duplicate bindings, and type mismatches. The output categorizes issues
as errors, which prevent compilation, and warnings, which indicate
potential problems but do not block execution.</p>
<p>Running check before run can save time because compilation errors are
often easier to understand when presented in isolation rather than mixed
with runtime output. Many developers add a check step to their
continuous integration pipelines to catch errors before code is
merged.</p>
<p>The <code>aro build</code> command compiles an application to a
native binary. Unlike interpreted execution with <code>run</code>, the
build command generates LLVM IR from your ARO source, compiles it to
machine code, and links the result with the ARO runtime library. The
output is a standalone executable that can run on any compatible system
without requiring ARO to be installed.</p>
<p>Native compilation is particularly useful for deployment. The
resulting binaries start almost instantaneously because there is no
parsing or compilation at runtime. The optimize flag enables compiler
optimizations that can significantly improve performance for
compute-intensive applications.</p>
<hr />
<h2 id="development-workflow">3.5 Development Workflow</h2>
<p>A typical development session follows a predictable rhythm. You write
or modify code in your editor, run the check command to catch obvious
errors, then run the application to verify the behavior. When something
does not work as expected, you examine the error message, adjust the
code, and repeat.</p>
<p>The error messages are designed to be helpful. Parse errors report
the file, line number, and character position where parsing failed,
along with an explanation of what was expected. Semantic errors explain
what semantic rule was violated and often suggest corrections based on
similar identifiers in scope. Runtime errors describe what operation
could not be completed, expressed in the business terms of your
statements rather than implementation details.</p>
<p>Verbose mode becomes particularly useful when debugging event-driven
behavior. Because feature sets communicate through events, it can
sometimes be unclear why a particular feature set did or did not
execute. The verbose output shows every event emission and every handler
invocation, making the flow visible.</p>
<p>As your application grows, you will naturally organize feature sets
into separate files. Common patterns include grouping by domain
(users.aro, orders.aro), by concern (handlers.aro, notifications.aro),
or by layer (api.aro, events.aro). The specific organization matters
less than consistency. Choose a pattern that makes sense for your team
and stick with it.</p>
<hr />
<h2 id="error-messages-and-debugging">3.6 Error Messages and
Debugging</h2>
<p>ARO prioritizes readable error messages because debugging time is a
significant portion of development effort. The goal is for error
messages to tell you not just what went wrong but also where and why,
with enough context to fix the problem.</p>
<p>Parse errors occur when the source code does not match the grammar.
The parser reports the file, line number, and character position where
parsing failed, along with a description of what it expected to find.
These errors typically indicate typos, missing punctuation, or malformed
statements. The statement structure is so regular that once you
internalize it, parse errors become rare.</p>
<p>Semantic errors occur when the source code is syntactically valid but
violates a semantic rule. Common examples include referencing a variable
that was never defined, attempting to rebind a name that is already
bound, or using an action with an incompatible preposition. The analyzer
tries to provide helpful context, such as listing similar identifiers
that might be what you meant.</p>
<p>Runtime errors occur during execution when an operation cannot be
completed. These are described in terms of what the statement was trying
to accomplish. If a Retrieve action cannot find the requested record,
the error message says so using the names from your code, not internal
implementation details. This makes runtime errors easier to understand
and correlate with specific statements.</p>
<p>When debugging complex issues, the debug flag provides additional
internal information. This includes the state of symbol tables, the
contents of events, and the sequence of action executions. This level of
detail is rarely needed but can be invaluable when tracking down subtle
problems.</p>
<hr />
<h2 id="from-here">3.7 From Here</h2>
<p>You now understand how to install ARO, create applications, and use
the command-line tools. You have seen the basic structure of an ARO
program and understand why applications are directories rather than
single files.</p>
<p>The next chapter examines the syntax of statements in detail,
explaining each component of the action-result-object pattern.
Understanding this pattern deeply is essential because every statement
you write follows it. After that, chapter five covers feature sets,
exploring how they are triggered, how they communicate through events,
and how they form the building blocks of applications.</p>
<p>The best way to proceed is to experiment. Create a small application,
add feature sets, emit events, and observe what happens. The language is
designed to be discoverable. If you try something that does not work,
the error message should guide you toward what does.</p>
<hr />
<p><em>Next: Chapter 4 — Anatomy of a Statement</em></p>
<h1 id="chapter-4-anatomy-of-a-statement">Chapter 4: Anatomy of a
Statement</h1>
<p><em>“Grammar is the logic of speech.”</em></p>
<hr />
<h2 id="the-universal-structure">4.1 The Universal Structure</h2>
<div style="text-align: center; margin: 2em 0;">
<svg width="520" height="80" viewBox="0 0 520 80" xmlns="http://www.w3.org/2000/svg">
<!-- Action -->
<rect x="5" y="25" width="70" height="30" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
<text x="40" y="45" text-anchor="middle" font-family="monospace" font-size="11" fill="#1e40af">&lt;Action&gt;</text>
<text x="40" y="70" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">verb</text>
<!-- Article 1 -->
<rect x="85" y="25" width="35" height="30" rx="4" fill="#f3f4f6" stroke="#9ca3af" stroke-width="1"/>
<text x="102" y="45" text-anchor="middle" font-family="serif" font-size="11" fill="#374151">the</text>
<!-- Result -->
<rect x="130" y="25" width="70" height="30" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="165" y="45" text-anchor="middle" font-family="monospace" font-size="11" fill="#166534">&lt;Result&gt;</text>
<text x="165" y="70" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">output</text>
<!-- Preposition -->
<rect x="210" y="25" width="55" height="30" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="237" y="45" text-anchor="middle" font-family="serif" font-size="11" fill="#92400e">from</text>
<text x="237" y="70" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">relation</text>
<!-- Article 2 -->
<rect x="275" y="25" width="35" height="30" rx="4" fill="#f3f4f6" stroke="#9ca3af" stroke-width="1"/>
<text x="292" y="45" text-anchor="middle" font-family="serif" font-size="11" fill="#374151">the</text>
<!-- Object -->
<rect x="320" y="25" width="70" height="30" rx="4" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
<text x="355" y="45" text-anchor="middle" font-family="monospace" font-size="11" fill="#9d174d">&lt;Object&gt;</text>
<text x="355" y="70" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">input</text>
<!-- Period -->
<rect x="400" y="25" width="25" height="30" rx="4" fill="#1f2937" stroke="#1f2937" stroke-width="2"/>
<text x="412" y="45" text-anchor="middle" font-family="serif" font-size="14" font-weight="bold" fill="#ffffff">.</text>
<!-- Connectors -->
<line x1="75" y1="40" x2="85" y2="40" stroke="#9ca3af" stroke-width="1"/>
<line x1="120" y1="40" x2="130" y2="40" stroke="#9ca3af" stroke-width="1"/>
<line x1="200" y1="40" x2="210" y2="40" stroke="#9ca3af" stroke-width="1"/>
<line x1="265" y1="40" x2="275" y2="40" stroke="#9ca3af" stroke-width="1"/>
<line x1="310" y1="40" x2="320" y2="40" stroke="#9ca3af" stroke-width="1"/>
<line x1="390" y1="40" x2="400" y2="40" stroke="#9ca3af" stroke-width="1"/>
<!-- Legend -->
<text x="460" y="35" font-family="sans-serif" font-size="8" fill="#6b7280">Required</text>
<text x="460" y="50" font-family="sans-serif" font-size="8" fill="#6b7280">elements</text>
</svg>
</div>
<p>Every ARO statement follows the same grammatical pattern. This is not
a guideline or a convention that you might occasionally break. It is an
invariant property of the language, enforced by the parser, and
fundamental to how ARO works.</p>
<p>The pattern consists of an action, followed by an article, followed
by a result, followed by a preposition, followed by another article,
followed by an object, and terminated by a period. Within this
structure, there are optional elements—qualifiers, literal values, where
clauses, and when conditions—but the core pattern is always present.</p>
<p>Understanding this pattern deeply is essential because it shapes how
you think about expressing operations in ARO. When you internalize the
pattern, writing ARO code becomes as natural as writing sentences. When
you fight against the pattern, trying to express operations that do not
fit, you struggle unnecessarily. The pattern is not a constraint to
overcome but a tool to master.</p>
<p>Let us examine each component in detail, understanding not just what
it is but why it exists and how it contributes to the expressiveness of
the language.</p>
<h2 id="actions-the-verb-of-your-sentence">4.2 Actions: The Verb of Your
Sentence</h2>
<p>An action is a verb enclosed in angle brackets. It tells the reader
what operation the statement performs. Actions are the most prominent
part of any ARO statement because they appear at the beginning and
because they carry semantic meaning that affects how the runtime
behaves.</p>
<p>When you write an action, you are choosing from a vocabulary of
approximately two dozen built-in verbs, each representing a fundamental
operation. The choice of verb is significant because each verb carries a
semantic role that determines the direction of data flow. When you
choose Extract, you are telling the runtime that you want to pull data
from an external source into the current context. When you choose
Return, you are telling the runtime that you want to send data out to
the caller and terminate execution.</p>
<p>The verbs are case-sensitive. Extract is a valid action. extract is
not. This case sensitivity is deliberate: it makes actions visually
distinctive from other identifiers in your code, and it aligns with the
convention that actions are proper verbs deserving of
capitalization.</p>
<p>The built-in actions cover the operations that virtually every
business application needs. You can extract data from requests, retrieve
data from repositories, create new values, validate inputs against
schemas, transform data between formats, store data persistently, emit
events for other handlers, and return responses to callers. When these
built-in actions are insufficient for your needs, you can create custom
actions in Swift, extending the vocabulary of the language for your
specific domain.</p>
<p>The power of actions comes from their abstraction. When you write a
Retrieve action, you are not specifying whether the data comes from an
in-memory store, a relational database, a document database, or an
external service. You are expressing the intent to retrieve data from a
named repository. The runtime, or a custom action implementation,
handles the details. This abstraction allows your ARO code to remain
focused on business logic while technical concerns are handled
elsewhere.</p>
<h2 id="results-the-noun-you-create">4.3 Results: The Noun You
Create</h2>
<p>The result is the variable that will hold the value produced by the
action. It appears after the action and its article, enclosed in angle
brackets. The result is where the output of the operation lands, giving
it a name that you can reference in subsequent statements.</p>
<p>Choosing good result names is one of the most important skills in
writing ARO code. The name you choose becomes part of the program’s
documentation. It appears in error messages when something goes wrong.
It serves as the identifier that subsequent statements use to reference
the value. A well-chosen name makes the code self-explanatory; a poorly
chosen name obscures intent.</p>
<p>Consider the difference between naming a result “x” versus naming it
“user-email-address.” The first name tells you nothing about what the
value represents. The second name tells you exactly what you are dealing
with. Because ARO does not allow you to rebind names, you cannot use
generic names for everything. This constraint pushes you toward
descriptive names, which in turn makes your code more readable.</p>
<p>Results can include type qualifiers, written after a colon. When you
write a result like “user-id: String” you are documenting that the
result is expected to be a string. Currently, ARO uses runtime typing,
so these qualifiers do not affect execution. However, they serve as
documentation for readers and may enable static type checking in future
versions of the language. Using qualifiers is optional but recommended
for results whose types are not obvious from context.</p>
<p>ARO allows hyphenated identifiers, which is unusual among programming
languages. This feature exists because hyphenated names often read more
naturally than camelCase or snake_case for business concepts.
“user-email-address” reads more like natural language than
“userEmailAddress” or “user_email_address.” You can choose whichever
style you prefer, but the language supports hyphens for those who want
them.</p>
<h2 id="objects-the-context-you-operate-on">4.4 Objects: The Context You
Operate On</h2>
<p>The object is the input or context for the action. It appears after
the preposition, enclosed in angle brackets. The object provides the
data or reference that the action operates on.</p>
<p>Objects are introduced by prepositions, and the choice of preposition
is significant. The preposition communicates the relationship between
the action and its object. Different prepositions imply different types
of operations, and the runtime uses this information to understand data
flow.</p>
<p>Like results, objects can include qualifiers. When you write an
object like “request: body” you are specifying that you want the body
property of the request. Qualifiers allow you to navigate into nested
structures. You can chain qualifiers to access deeply nested properties,
writing something like “user: address.city” to access the city property
of the address property of the user.</p>
<p>The distinction between results and objects is fundamental. Results
are outputs—the values produced by actions, which become available for
subsequent statements. Objects are inputs—the values consumed by
actions, which must have been produced by previous statements or be
available from the execution context. This input-output distinction is
how data flows through a feature set.</p>
<h2 id="prepositions-the-relationships-between-things">4.5 Prepositions:
The Relationships Between Things</h2>
<p>Prepositions are small words that carry large meaning. In ARO,
prepositions connect actions to their objects while communicating the
nature of that connection. The language supports ten prepositions:</p>
<table>
<thead>
<tr>
<th>Preposition</th>
<th>Meaning</th>
<th>Common Actions</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>from</code></td>
<td>Source extraction</td>
<td>Extract, Retrieve, Fetch, Read</td>
</tr>
<tr>
<td><code>with</code></td>
<td>Accompaniment/provision</td>
<td>Create, Return, Emit</td>
</tr>
<tr>
<td><code>for</code></td>
<td>Purpose/target</td>
<td>Compute, Return, Log</td>
</tr>
<tr>
<td><code>to</code></td>
<td>Destination</td>
<td>Send, Write</td>
</tr>
<tr>
<td><code>into</code></td>
<td>Insertion</td>
<td>Store</td>
</tr>
<tr>
<td><code>against</code></td>
<td>Comparison/validation</td>
<td>Validate, Compare</td>
</tr>
<tr>
<td><code>via</code></td>
<td>Intermediate channel</td>
<td>Fetch (with proxy)</td>
</tr>
<tr>
<td><code>on</code></td>
<td>Location/attachment</td>
<td>Listen, Start</td>
</tr>
<tr>
<td><code>at</code></td>
<td>Position/placement</td>
<td>CreateDirectory, Make</td>
</tr>
<tr>
<td><code>as</code></td>
<td>Type annotation</td>
<td>Filter, Reduce, Map</td>
</tr>
</tbody>
</table>
<p>Choosing the right preposition makes your code clearer and more
accurate. When you extract a user identifier from the path parameters,
“from” is the natural choice. When you create a user with provided data,
“with” is the natural choice. When you store a user into a repository,
“into” is the natural choice. Let the semantics of your operation guide
your choice of preposition.</p>
<blockquote>
<p><strong>See Appendix B</strong> for complete preposition semantics
with examples.</p>
</blockquote>
<h2 id="articles-the-grammar-connectors">4.6 Articles: The Grammar
Connectors</h2>
<p>Articles—“the,” “a,” and “an”—appear between the action and the
result, and between the preposition and the object. They serve a
grammatical purpose, making statements read like natural English
sentences.</p>
<p>The choice of article does not affect the semantics of the statement.
Whether you write “the user” or “a user” has no impact on how the
statement executes. However, the choice can affect readability. In
general, use “the” when referring to a specific, known thing, and use
“a” or “an” when introducing something new or when the thing is one of
many possible things.</p>
<p>For results, “the” is usually the appropriate choice because you are
creating a specific binding. For objects, “the” is also usually
appropriate because you are referring to something specific. For return
statuses, “an” or “a” often reads more naturally—“Return an OK status”
rather than “Return the OK status.”</p>
<p>The important thing is to be consistent within your codebase. Whether
you prefer “the” everywhere or vary your articles for readability, stick
with your choice so that readers can focus on the meaning rather than
the grammatical choices.</p>
<h2 id="literal-values">4.7 Literal Values</h2>
<p>Some statements include literal values—strings, numbers, booleans,
arrays, or objects. Literal values provide concrete data within the
statement rather than referencing previously bound variables.</p>
<p>String literals are enclosed in double quotes. You can include
special characters using escape sequences: backslash-n for newline,
backslash-t for tab, backslash followed by a quote for a literal quote
character. Strings can contain any text and are commonly used for
messages, paths, and configuration values.</p>
<p>Number literals can be integers or floating-point values. Integers
are written as sequences of digits, optionally preceded by a minus sign
for negative numbers. Floating-point numbers include a decimal point
between digits. There is no distinction in syntax between integers and
floats; the runtime handles numeric types appropriately.</p>
<p>Boolean literals are written as “true” or “false” without any
enclosing symbols. They represent the two truth values and are commonly
used for flags and conditions.</p>
<p>Array literals are enclosed in square brackets with elements
separated by commas. The elements can be any valid expression, including
other literals, variable references, or nested arrays. Array literals
provide a convenient way to create collections inline.</p>
<p>Object literals are enclosed in curly braces with fields written as
key-colon-value pairs separated by commas. The keys are identifiers; the
values can be any valid expression. Object literals allow you to
construct structured data inline, which is particularly useful for
return values and event payloads.</p>
<pre class="aro"><code>&lt;Create&gt; the &lt;user&gt; with { name: &quot;Alice&quot;, email: &quot;alice@example.com&quot;, active: true }.</code></pre>
<h2 id="where-clauses">4.8 Where Clauses</h2>
<p>The where clause allows you to filter or constrain operations. It
appears after the object clause and begins with the keyword “where,”
followed by a condition.</p>
<p>Where clauses are most commonly used with Retrieve actions to specify
which records to fetch from a repository. When you write a where clause,
you are expressing a constraint that the retrieved data must satisfy.
The repository implementation uses this constraint to filter results,
often translating it into a database query.</p>
<p>Conditions in where clauses can use equality checks with “is” or “=”
and inequality checks with “!=”. They can use comparison operators for
numeric values. They can combine multiple conditions with “and” and
“or.” The expressive power is similar to the WHERE clause in SQL, which
is intentional—many repositories are backed by databases, and the
mapping should be straightforward.</p>
<p>Where clauses can also appear with Filter actions, where they specify
which elements of a collection to include in the result. The semantics
are the same: only elements satisfying the condition are included.</p>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt; where id = &lt;order-id&gt;.</code></pre>
<h2 id="when-conditions">4.9 When Conditions</h2>
<p>The when condition allows you to make a statement conditional on some
expression being true. It appears at the end of the statement, after any
where clause, and begins with the keyword “when.”</p>
<p>Unlike traditional if-statements, when conditions do not create
branches in control flow. A statement with a when condition either
executes (if the condition is true) or is skipped (if the condition is
false). There is no else clause, no alternative path. This design keeps
the linear flow of ARO feature sets intact while allowing for
conditional execution of individual statements.</p>
<p>When conditions are useful for optional operations—things that should
happen only if certain prerequisites are met. For example, you might
send a notification only when the user has opted into notifications, or
log debug information only when debug mode is enabled.</p>
<p>The condition can be any boolean expression. You can reference bound
variables, compare values, check for existence, and combine conditions
with logical operators. The same expression syntax used elsewhere in ARO
applies within when conditions.</p>
<pre class="aro"><code>&lt;Send&gt; the &lt;notification&gt; to the &lt;user: email&gt; when &lt;user: notifications&gt; is true.</code></pre>
<h2 id="comments">4.10 Comments</h2>
<p>Comments in ARO use Pascal-style syntax: an opening parenthesis
followed by an asterisk, the comment text, an asterisk followed by a
closing parenthesis. Comments can span multiple lines and can appear
anywhere in the source where whitespace is allowed.</p>
<p>Comments are completely ignored by the parser. They exist solely for
human readers, providing explanation, context, or temporary notes. Use
comments to explain why something is done, not what is done. The code
itself, with its natural-language-like structure, should explain what is
happening.</p>
<h2 id="statement-termination">4.11 Statement Termination</h2>
<p>Every statement ends with a period. This is not optional; omitting
the period is a syntax error. The period serves as an unambiguous
statement terminator, making it clear where one statement ends and the
next begins.</p>
<p>The period also reinforces the sentence metaphor. Just as English
sentences end with periods, ARO statements end with periods. This small
detail contributes to the natural-language feel of ARO code.</p>
<h2 id="putting-it-all-together">4.12 Putting It All Together</h2>
<p>Having examined each component in isolation, let us see how they
combine in complete statements of varying complexity.</p>
<p>A minimal statement has an action, an article, a result, a
preposition, an article, and an object:</p>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;users&gt; from the &lt;user-repository&gt;.</code></pre>
<p><em>Source: <a
href="../Examples/UserService/users.aro">Examples/UserService/users.aro:7</a></em></p>
<p>A statement with a qualifier on the result and object adds more
specificity:</p>
<pre class="aro"><code>&lt;Extract&gt; the &lt;user-id: String&gt; from the &lt;pathParameters: id&gt;.</code></pre>
<p>A statement with a literal value provides data inline:</p>
<pre class="aro"><code>&lt;Create&gt; the &lt;greeting&gt; with &quot;Hello, World!&quot;.</code></pre>
<p>A statement with an expression computes a value:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;total&gt; with &lt;subtotal&gt; + &lt;tax&gt;.</code></pre>
<p>A statement with a where clause filters the operation:</p>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where &lt;id&gt; is &lt;user-id&gt;.</code></pre>
<p><em>Source: <a
href="../Examples/UserService/users.aro">Examples/UserService/users.aro:14</a></em></p>
<p>A statement with a when condition executes conditionally:</p>
<pre class="aro"><code>&lt;Send&gt; the &lt;notification&gt; to the &lt;user&gt; when &lt;user: notifications&gt; is true.</code></pre>
<p>Each of these statements follows the same fundamental pattern while
using optional elements to add precision and expressiveness. The pattern
is the constant; the optional elements are the variables. Once you
internalize the pattern, you can read and write any ARO statement
fluently.</p>
<hr />
<p><em>Next: Chapter 5 — Feature Sets</em></p>
<h1 id="chapter-5-feature-sets">Chapter 5: Feature Sets</h1>
<p><em>“A feature set is not a function. It’s a response to the
world.”</em></p>
<hr />
<h2 id="what-is-a-feature-set">5.1 What Is a Feature Set?</h2>
<p>A feature set is ARO’s fundamental unit of organization. It groups
related statements that together accomplish a business goal. If
statements are sentences, then a feature set is a paragraph—a coherent
unit of meaning that expresses a complete thought about what should
happen in response to some triggering condition.</p>
<p>The term “feature set” is deliberately chosen over alternatives like
“function,” “method,” or “procedure” because it emphasizes the reactive
nature of ARO code. A feature set does not run because you call it. It
runs because something in the world triggered it. An HTTP request
arrives. A file changes. A custom event is emitted. The application
starts. These external stimuli activate feature sets, which then execute
their statements in response.</p>
<p>This reactive model is fundamental to understanding ARO. In
traditional programming, you write a main function that calls other
functions in a sequence you control. In ARO, you write feature sets that
respond to events, and the runtime orchestrates when they execute based
on what happens. You describe what should occur when certain conditions
arise; the runtime ensures your descriptions become reality when those
conditions occur.</p>
<p>Every feature set has a two-part header enclosed in parentheses,
followed by a body enclosed in curly braces. The header consists of a
feature name and a business activity, separated by a colon. The body
contains the statements that execute when the feature set is triggered.
There is no other structure. No parameter lists, no return type
declarations, no visibility modifiers. The simplicity is
intentional.</p>
<hr />
<h2 id="the-header">5.2 The Header</h2>
<p>The feature set header serves two purposes: it gives the feature set
a unique identity, and it documents what business context the feature
set belongs to.</p>
<p>The first part, before the colon, is the feature name. This name must
be unique within the application. If two feature sets have the same
name, the compiler reports an error. The name identifies this specific
feature set for routing purposes—HTTP requests match against feature
names that correspond to operation identifiers in the OpenAPI
specification, custom events match against handler patterns that include
the event name.</p>
<p>Names can take several forms. Simple identifiers like
<code>listUsers</code> or <code>getOrder</code> are common for HTTP
handlers because OpenAPI operation identifiers typically follow this
style. Hyphenated names like <code>Application-Start</code> or
<code>Handle-Error</code> read more like natural language and are common
for lifecycle handlers. Descriptive phrases with spaces like
<code>Send Welcome Email</code> work well for event handlers because
they clearly describe the purpose.</p>
<p>The second part, after the colon, is the business activity. This
describes the domain context or purpose of the feature set. For an HTTP
API handling user operations, you might use <code>User API</code> as the
business activity. For an event handler dealing with order processing,
you might use <code>Order Processing</code>. For the application entry
point, you might use the application name itself.</p>
<p>The business activity serves two purposes: documentation and
scoping.</p>
<p>As documentation, it helps readers understand what larger goal this
feature set contributes to. When you scan a file containing many feature
sets, the business activities provide orientation. They answer the
question: what is this code about?</p>
<p>As a scoping mechanism, the business activity controls variable
visibility. When you publish a variable using the Publish action, that
variable becomes accessible only to other feature sets with the same
business activity. This enforces modularity and prevents unintended
coupling between different business domains.</p>
<div style="text-align: center; margin: 2em 0;">
<svg width="460" height="200" viewBox="0 0 460 200" xmlns="http://www.w3.org/2000/svg">
<rect x="10" y="30" width="200" height="140" rx="8" fill="none" stroke="#3b82f6" stroke-width="2" stroke-dasharray="6,3"/><text x="110" y="20" text-anchor="middle" font-family="sans-serif" font-size="11" font-weight="bold" fill="#1e40af">User
Management</text><rect x="25" y="50" width="80" height="50" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/><text x="65" y="70" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#1e40af">Auth</text><text x="65" y="82" text-anchor="middle" font-family="monospace" font-size="7" fill="#3b82f6">publishes</text><text x="65" y="92" text-anchor="middle" font-family="monospace" font-size="7" fill="#3b82f6">&lt;user&gt;</text><rect x="120" y="50" width="80" height="50" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/><text x="160" y="70" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#1e40af">Profile</text><text x="160" y="85" text-anchor="middle" font-family="monospace" font-size="7" fill="#22c55e">can
access</text><line x1="105" y1="75" x2="120" y2="75" stroke="#22c55e" stroke-width="1.5"/><polygon points="120,75 114,71 114,79" fill="#22c55e"/><rect x="70" y="110" width="80" height="50" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/><text x="110" y="130" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#1e40af">Audit</text><text x="110" y="145" text-anchor="middle" font-family="monospace" font-size="7" fill="#22c55e">can
access</text><line x1="65" y1="100" x2="90" y2="110" stroke="#22c55e" stroke-width="1.5"/><polygon points="90,110 83,108 85,114" fill="#22c55e"/><rect x="250" y="30" width="200" height="140" rx="8" fill="none" stroke="#f59e0b" stroke-width="2" stroke-dasharray="6,3"/><text x="350" y="20" text-anchor="middle" font-family="sans-serif" font-size="11" font-weight="bold" fill="#92400e">Order
Processing</text><rect x="265" y="50" width="80" height="50" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/><text x="305" y="70" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#92400e">Checkout</text><text x="305" y="85" text-anchor="middle" font-family="monospace" font-size="7" fill="#ef4444">cannot
access</text><rect x="360" y="50" width="80" height="50" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/><text x="400" y="70" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#92400e">Shipping</text><text x="400" y="85" text-anchor="middle" font-family="monospace" font-size="7" fill="#ef4444">cannot
access</text><line x1="210" y1="75" x2="240" y2="75" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4,2"/><text x="225" y="68" text-anchor="middle" font-family="sans-serif" font-size="12" fill="#ef4444">✗</text><text x="230" y="190" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">Published
variables are scoped to business activity</text>
</svg>
</div>
<p>Consider an application with two business activities:
<code>User Management</code> and <code>Order Processing</code>. If a
feature set in <code>User Management</code> publishes a variable, only
other feature sets with the same <code>User Management</code> activity
can access it. Feature sets in <code>Order Processing</code> cannot see
that variable, even if they use the same name. This boundary prevents
unintended dependencies between unrelated domains.</p>
<p>Certain business activity patterns also have semantic significance.
When the pattern ends with “Handler,” the runtime treats the feature set
as an event handler. The text before “Handler” specifies which event
triggers it. This convention transforms what looks like documentation
into configuration, allowing you to wire up event handling simply by
naming things according to the pattern.</p>
<hr />
<h2 id="triggering-patterns">5.3 Triggering Patterns</h2>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="170" height="180" viewBox="0 0 170 180" xmlns="http://www.w3.org/2000/svg">
<!-- Title -->
<text x="85" y="15" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#374151">Triggers</text>
<!-- HTTP -->
<rect x="10" y="30" width="65" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
<text x="42" y="45" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#1e40af">HTTP</text>
<text x="42" y="57" text-anchor="middle" font-family="monospace" font-size="7" fill="#3b82f6">operationId</text>
<!-- Event -->
<rect x="95" y="30" width="65" height="35" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="127" y="45" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#166534">Event</text>
<text x="127" y="57" text-anchor="middle" font-family="monospace" font-size="7" fill="#22c55e">*Handler</text>
<!-- File -->
<rect x="10" y="80" width="65" height="35" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<text x="42" y="95" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#92400e">File</text>
<text x="42" y="107" text-anchor="middle" font-family="monospace" font-size="7" fill="#f59e0b">File
Event</text> <!-- Socket -->
<rect x="95" y="80" width="65" height="35" rx="4" fill="#f3e8ff" stroke="#a855f7" stroke-width="1.5"/>
<text x="127" y="95" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#7c3aed">Socket</text>
<text x="127" y="107" text-anchor="middle" font-family="monospace" font-size="7" fill="#a855f7">Socket
Event</text> <!-- Arrows to feature set -->
<line x1="42" y1="65" x2="85" y2="135" stroke="#6b7280" stroke-width="1"/>
<line x1="127" y1="65" x2="85" y2="135" stroke="#6b7280" stroke-width="1"/>
<line x1="42" y1="115" x2="85" y2="135" stroke="#6b7280" stroke-width="1"/>
<line x1="127" y1="115" x2="85" y2="135" stroke="#6b7280" stroke-width="1"/>
<!-- Feature Set -->
<rect x="35" y="135" width="100" height="30" rx="4" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
<text x="85" y="155" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#4338ca">Feature
Set</text>
<text x="85" y="178" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">name
matches pattern</text>
</svg>
</div>
<p>Feature sets execute in response to events. The runtime maintains an
event bus that routes events to matching feature sets based on their
headers. The triggering mechanism matches feature set names to incoming
events:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 41%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Trigger Type</th>
<th>Naming Pattern</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Lifecycle</td>
<td><code>Application-Start</code>, <code>Application-End</code></td>
<td>Entry point, shutdown</td>
</tr>
<tr>
<td>HTTP</td>
<td>OpenAPI <code>operationId</code></td>
<td><code>listUsers</code>, <code>createOrder</code></td>
</tr>
<tr>
<td>Custom Event</td>
<td><code>{EventName} Handler</code></td>
<td><code>UserCreated Handler</code></td>
</tr>
<tr>
<td>File Event</td>
<td><code>File Event Handler</code></td>
<td>React to file changes</td>
</tr>
<tr>
<td>Socket Event</td>
<td><code>Socket Event Handler</code></td>
<td>React to socket messages</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>See Chapter 10</strong> for application lifecycle details
(startup, shutdown, Keepalive).</p>
</blockquote>
<blockquote>
<p><strong>See Chapter 9</strong> for event bus mechanics and handler
patterns.</p>
</blockquote>
<hr />
<h2 id="structure-and-execution">5.4 Structure and Execution</h2>
<p>Within a feature set, statements execute in order from top to bottom.
There is no branching, no looping, no early return. Execution begins
with the first statement and proceeds through each subsequent statement
until reaching the end or encountering an error.</p>
<p>This linearity might seem limiting, but it actually simplifies
reasoning about code. When you look at a feature set, you know exactly
what order things happen. There are no hidden control flows, no
callbacks that might execute at unexpected times, no conditional
branches that might skip important steps. What you see is what
executes.</p>
<p>The <code>when</code> clause provides conditional execution without
branching. A statement with a when clause executes only if the condition
is true; otherwise, the statement is skipped and execution continues
with the next statement. This is not a branch—there is no else path, no
alternative action. Either the statement happens or it does not.</p>
<p>Each statement can bind a result to a name. That binding becomes
available to all subsequent statements in the same feature set. If you
create a value named <code>user</code> in the first statement, you can
reference <code>user</code> in the second, third, and all following
statements. This accumulation of bindings creates the context in which
later statements operate.</p>
<p>Bindings are immutable within a feature set. Once you bind a name to
a value, you cannot rebind it to a different value. If you try, the
compiler reports an error. This constraint prevents a common class of
bugs where a variable changes unexpectedly. It also pushes you toward
descriptive names because you cannot reuse generic names like
<code>temp</code> or <code>result</code>.</p>
<hr />
<h2 id="scope-and-visibility">5.5 Scope and Visibility</h2>
<p>Variables bound within a feature set are visible only within that
feature set. A binding in one feature set does not affect bindings in
another. Each feature set has its own isolated symbol table that begins
empty and accumulates bindings as statements execute.</p>
<p>This isolation has important implications. If you create a value in
one feature set and need to use it in another, you cannot simply
reference it by name. The second feature set has no knowledge of what
the first feature set bound. This prevents accidental coupling between
feature sets that happen to use the same variable names.</p>
<p>When you need to share data between feature sets, you have two
options. The first is through events: emit an event carrying the data,
and have the receiving feature set extract what it needs from the event
payload. This maintains loose coupling because the emitting feature set
does not need to know which handlers will receive the event.</p>
<p>The second option is the Publish action, which makes a binding
available to other feature sets within the same business activity. When
you publish a value under an alias, that alias becomes accessible from
any feature set with the same business activity that executes afterward.
This scoping enforces modularity—different business domains cannot
accidentally depend on each other’s published variables. Use publishing
for configuration data loaded at startup or for values that need to be
shared within a domain, but use it sparingly because shared state
complicates reasoning about program behavior.</p>
<p>The execution context provides access to information that is always
available. For HTTP handlers, this includes request data: path
parameters extracted from the URL, query parameters, headers, and the
request body. For event handlers, this includes the event payload
containing whatever data was emitted with the event. These context
values are not bound to names in advance; you extract them using the
Extract action, which binds them to names you choose.</p>
<hr />
<h2 id="naming-conventions">5.6 Naming Conventions</h2>
<p>Good naming makes code readable. In ARO, feature set names serve
double duty as identifiers and documentation, so choosing appropriate
names is particularly important.</p>
<p>For HTTP handlers, names should match the operation identifiers in
your OpenAPI specification exactly. This is not a convention but a
requirement—the routing mechanism uses name matching to connect requests
to handlers. Operation identifiers typically follow camelCase
conventions: <code>listUsers</code>, <code>createOrder</code>,
<code>getProductById</code>. Your feature set names should match.</p>
<p>For event handlers, names should be descriptive of the action being
performed. The convention is a verb phrase describing the handler’s
purpose: <code>Send Welcome Email</code>,
<code>Update Search Index</code>, <code>Notify Administrator</code>. The
business activity specifies the triggering event by ending with
“Handler” preceded by the event name: <code>UserCreated Handler</code>,
<code>OrderPlaced Handler</code>.</p>
<p>For lifecycle handlers, use the reserved names exactly as specified.
<code>Application-Start</code> with a business activity of your choice.
<code>Application-End</code> with business activity <code>Success</code>
for graceful shutdown. <code>Application-End</code> with business
activity <code>Error</code> for error handling.</p>
<p>For internal feature sets that handle domain logic but are not
directly triggered by external events, use names that describe the
business operation. <code>Calculate Shipping</code>,
<code>Validate Payment</code>, <code>Check Inventory</code>. These
feature sets might be triggered by custom events emitted from other
feature sets or might be called through other mechanisms.</p>
<hr />
<h2 id="file-organization">5.7 File Organization</h2>
<p>ARO applications are directories, and the runtime automatically
discovers all files with the <code>.aro</code> extension in that
directory. You do not need import statements or explicit file
references. When you create a new file and add feature sets to it, those
feature sets become part of the application immediately.</p>
<p>This automatic discovery encourages organizing feature sets into
files by domain or purpose. A typical pattern separates lifecycle
concerns from business logic: one file for application start and
shutdown, other files for different domains of functionality. A user
service might have a main file for lifecycle, a users file for
user-related HTTP handlers, an orders file for order-related handlers,
and an events file for event handlers.</p>
<p>The specific organization you choose matters less than consistency.
Some teams prefer fine-grained files with only a few feature sets each.
Others prefer coarser files that group all related functionality
together. What matters is that team members can find what they are
looking for and understand where new code should be added.</p>
<p>Because there are no imports, all feature sets are visible throughout
the application. An event emitted in one file triggers handlers defined
in any file. A variable published in one file is accessible from any
feature set with the same business activity, regardless of which file it
is defined in. This visibility is powerful but requires discipline.
Establish conventions for how feature sets in different files should
interact, and document those conventions so team members can follow
them.</p>
<hr />
<h2 id="the-context-object">5.8 The Context Object</h2>
<p>When a feature set executes, it has access to contextual information
appropriate to how it was triggered. This information is available
through special identifiers that you access using the Extract
action.</p>
<p>HTTP handlers have access to request data. The
<code>pathParameters</code> object contains values extracted from the
URL path based on path templates in the OpenAPI specification. If the
path template is <code>/users/{id}</code>, the <code>id</code> path
parameter contains whatever value appeared in that position of the
actual URL. The <code>queryParameters</code> object contains query
string parameters. The <code>headers</code> object contains HTTP
headers. The <code>request</code> object contains the full request,
including the body.</p>
<p>Event handlers have access to the event that triggered them through
the <code>event</code> identifier. The event object contains whatever
data was included when the event was emitted. If a feature set emits a
<code>UserCreated</code> event with user data, the handler can extract
that user data from the event.</p>
<p>File event handlers have access to file system event details: the
path of the file that changed, the type of change that occurred
(created, modified, deleted), and other relevant metadata depending on
the file system implementation.</p>
<p>You access context data using the Extract action with qualifiers. The
expression <code>&lt;pathParameters: id&gt;</code> means “the id
property of the pathParameters object.” The expression
<code>&lt;event: user.email&gt;</code> means “the email property of the
user property of the event object.” Qualifiers chain to allow navigation
into nested structures.</p>
<hr />
<h2 id="from-here-1">5.9 From Here</h2>
<p>Feature sets are the building blocks of ARO applications. They
respond to events, execute statements, and either complete successfully
or encounter errors. The runtime orchestrates their execution based on
matching patterns between events and feature set headers.</p>
<p>The next chapter explores how data flows through feature sets and
between them. Understanding data flow is essential for building
applications that share information appropriately while maintaining the
loose coupling that makes event-driven architectures powerful.</p>
<hr />
<p><em>Next: Chapter 6 — Data Flow</em></p>
<h1 id="chapter-6-data-flow">Chapter 6: Data Flow</h1>
<p><em>“Data flows forward, never backward.”</em></p>
<hr />
<h2 id="the-direction-of-data">6.1 The Direction of Data</h2>
<p>Every ARO statement moves data in a predictable direction. This is
not merely a conceptual framework but a fundamental property of the
language that the runtime enforces. Understanding data flow is essential
for writing effective ARO code because it shapes how you think about
structuring your feature sets.</p>
<p>The fundamental principle is that data enters from the outside world,
transforms within the feature set, and exits to the outside world.
External sources include HTTP requests, files, databases, and network
connections. Internal transformations include creating new values,
validating existing ones, computing results, and restructuring data.
External destinations include responses to callers, persistent storage,
emitted events, and outbound communications.</p>
<p>This directional flow creates a natural structure for feature sets.
The beginning of a feature set typically contains actions that bring
data in. The middle contains actions that transform that data. The end
contains actions that send results out. While this is not enforced
syntactically—you can technically write statements in any order—the data
dependencies between statements create an inherent ordering that usually
follows this pattern.</p>
<p>The flow is unidirectional within a single execution. Data moves
forward through the statement sequence; it does not loop back. Each
statement receives its inputs from the accumulated results of previous
statements and produces outputs that become available to subsequent
statements. This forward-only flow simplifies reasoning about program
behavior because you can trace the origin of any value by looking
backward through the statement sequence.</p>
<hr />
<h2 id="semantic-roles">6.2 Semantic Roles</h2>
<p>Every action in ARO has a semantic role that categorizes its data
flow characteristics. The role is determined by the action’s verb and
affects how the runtime processes the action and validates its usage.
There are four roles: REQUEST, OWN, RESPONSE, and EXPORT.</p>
<p>REQUEST actions bring data from outside the feature set into its
local scope. When you extract data from a request, retrieve records from
a repository, fetch content from a URL, or read a file, you are
performing a REQUEST operation. The characteristic of REQUEST actions is
that they produce new bindings by pulling data inward. After a REQUEST
action executes, the symbol table contains a new entry that was not
there before, and the value came from somewhere external.</p>
<p>OWN actions transform data that already exists within the feature
set. When you create a new value from existing ones, compute a result
from inputs, validate data against a schema, filter a collection, or
merge objects, you are performing an OWN operation. The characteristic
of OWN actions is that they read from existing bindings and produce new
bindings, but all the data stays internal to the feature set. No
external communication occurs.</p>
<p>RESPONSE actions send data out of the feature set to the caller and
terminate normal execution. When you return a response to an HTTP client
or throw an error, you are performing a RESPONSE operation. The
characteristic of RESPONSE actions is that they move data outward and
end the feature set’s execution. After a RESPONSE action, no subsequent
statements execute because control has returned to the caller.</p>
<p>EXPORT actions make data available beyond the current execution
without terminating it. When you store data to a repository, emit an
event for handlers to process, publish a value for other feature sets in
the same business activity, log a message, or send a notification, you
are performing an EXPORT operation. The characteristic of EXPORT actions
is that they have side effects—they change something in the outside
world—but execution continues with the next statement.</p>
<p>The runtime uses these roles for validation and optimization. It can
detect when you try to use a value that has not been bound, when you
attempt to read from a binding that a statement’s role would not
produce, or when you have dead code after a RESPONSE action.
Understanding the roles helps you write code that the runtime can
validate effectively.</p>
<hr />
<h2 id="the-symbol-table">6.3 The Symbol Table</h2>
<p>As statements execute, ARO maintains a symbol table that maps
variable names to values. This table is the mechanism by which data
flows between statements. When a statement produces a result, the result
is added to the symbol table under the specified name. When a subsequent
statement references that name, the runtime looks up the value in the
symbol table.</p>
<p>The symbol table starts empty at the beginning of each feature set
execution. As each statement executes, any result it produces is added
to the table. This accumulation creates the context in which later
statements operate. A statement near the end of the feature set has
access to all the bindings created by statements that came before
it.</p>
<p>The symbol table is append-only within a single execution. You cannot
rebind a name to a different value. If you try to create a binding for a
name that already exists, the compiler or runtime reports an error. This
immutability prevents a common class of bugs where variables change
unexpectedly and makes it easier to reason about program behavior—when
you see a reference to a name, you know it refers to exactly the value
that was originally bound.</p>
<p>When a statement references a variable that does not exist in the
symbol table, the runtime produces an error describing which variable is
undefined and where the reference occurred. This is a runtime error
rather than a compile-time error because the compiler cannot always
determine whether a binding will exist. Some bindings depend on
conditional execution or on values that only become known during
execution.</p>
<p>The symbol table is scoped to the feature set. Bindings in one
feature set do not affect bindings in another. Each feature set
maintains its own independent table that exists only for the duration of
that feature set’s execution. This isolation prevents unintended
interactions between feature sets and allows you to use descriptive
names without worrying about conflicts.</p>
<hr />
<h2 id="data-flow-patterns">6.4 Data Flow Patterns</h2>
<p>Several common patterns emerge in how data flows through feature
sets. Recognizing these patterns helps you structure your code
effectively and understand existing code more quickly.</p>
<div
style="display: flex; flex-wrap: wrap; justify-content: space-around; margin: 2em 0;">
<div style="text-align: center; margin: 0.5em;">
<svg width="160" height="100" viewBox="0 0 160 100" xmlns="http://www.w3.org/2000/svg">
<text x="80" y="12" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#1e40af">Linear
Pipeline</text>
<rect x="10" y="25" width="30" height="20" rx="3" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
<line x1="40" y1="35" x2="55" y2="35" stroke="#6b7280" stroke-width="1.5"/>
<polygon points="55,35 50,32 50,38" fill="#6b7280"/>
<rect x="55" y="25" width="30" height="20" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<line x1="85" y1="35" x2="100" y2="35" stroke="#6b7280" stroke-width="1.5"/>
<polygon points="100,35 95,32 95,38" fill="#6b7280"/>
<rect x="100" y="25" width="30" height="20" rx="3" fill="#fce7f3" stroke="#ec4899" stroke-width="1.5"/>
<line x1="130" y1="35" x2="145" y2="35" stroke="#6b7280" stroke-width="1.5"/>
<polygon points="145,35 140,32 140,38" fill="#6b7280"/>
<text x="80" y="65" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#6b7280">A
→ B → C → out</text>
<text x="80" y="78" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">sequential
transforms</text>
</svg>
</div>
<div style="text-align: center; margin: 0.5em;">
<svg width="160" height="100" viewBox="0 0 160 100" xmlns="http://www.w3.org/2000/svg">
<text x="80" y="12" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#166534">Fan-Out</text>
<rect x="55" y="20" width="50" height="20" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<line x1="55" y1="40" x2="30" y2="55" stroke="#22c55e" stroke-width="1.5"/>
<line x1="80" y1="40" x2="80" y2="55" stroke="#22c55e" stroke-width="1.5"/>
<line x1="105" y1="40" x2="130" y2="55" stroke="#22c55e" stroke-width="1.5"/>
<rect x="10" y="55" width="40" height="16" rx="3" fill="#e0e7ff" stroke="#6366f1" stroke-width="1"/>
<rect x="60" y="55" width="40" height="16" rx="3" fill="#e0e7ff" stroke="#6366f1" stroke-width="1"/>
<rect x="110" y="55" width="40" height="16" rx="3" fill="#e0e7ff" stroke="#6366f1" stroke-width="1"/>
<text x="80" y="88" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">one
to many outputs</text>
</svg>
</div>
<div style="text-align: center; margin: 0.5em;">
<svg width="160" height="100" viewBox="0 0 160 100" xmlns="http://www.w3.org/2000/svg">
<text x="80" y="12" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#7c3aed">Aggregation</text>
<rect x="10" y="22" width="40" height="16" rx="3" fill="#f3e8ff" stroke="#a855f7" stroke-width="1"/>
<rect x="60" y="22" width="40" height="16" rx="3" fill="#f3e8ff" stroke="#a855f7" stroke-width="1"/>
<rect x="110" y="22" width="40" height="16" rx="3" fill="#f3e8ff" stroke="#a855f7" stroke-width="1"/>
<line x1="30" y1="38" x2="70" y2="52" stroke="#a855f7" stroke-width="1.5"/>
<line x1="80" y1="38" x2="80" y2="52" stroke="#a855f7" stroke-width="1.5"/>
<line x1="130" y1="38" x2="90" y2="52" stroke="#a855f7" stroke-width="1.5"/>
<rect x="55" y="52" width="50" height="20" rx="3" fill="#f3e8ff" stroke="#a855f7" stroke-width="1.5"/>
<text x="80" y="88" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">many
to one result</text>
</svg>
</div>
<div style="text-align: center; margin: 0.5em;">
<svg width="160" height="100" viewBox="0 0 160 100" xmlns="http://www.w3.org/2000/svg">
<text x="80" y="12" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#92400e">Enrichment</text>
<rect x="10" y="30" width="40" height="20" rx="3" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<line x1="50" y1="40" x2="65" y2="40" stroke="#6b7280" stroke-width="1.5"/>
<polygon points="65,40 60,37 60,43" fill="#6b7280"/>
<rect x="65" y="30" width="40" height="20" rx="3" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<line x1="105" y1="40" x2="120" y2="40" stroke="#6b7280" stroke-width="1.5"/>
<polygon points="120,40 115,37 115,43" fill="#6b7280"/>
<rect x="120" y="30" width="30" height="20" rx="3" fill="#fee2e2" stroke="#ef4444" stroke-width="1.5"/>
<!-- Plus signs -->
<text x="85" y="58" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#f59e0b">+</text>
<line x1="85" y1="20" x2="85" y2="30" stroke="#f59e0b" stroke-width="1" stroke-dasharray="2,1"/>
<rect x="70" y="8" width="30" height="12" rx="2" fill="#fef9c3" stroke="#eab308" stroke-width="1"/>
<text x="80" y="88" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">add
related data</text>
</svg>
</div>
</div>
<p>The linear pipeline is the most common pattern. Data enters at the
beginning, flows through a series of transformations, and exits at the
end. Each statement takes the output of the previous statement (or the
original input) and produces something that the next statement needs.
This creates a chain of dependencies that naturally organizes the
code.</p>
<p>The fan-out pattern occurs when a single piece of data needs to
trigger multiple independent operations. You might create a user and
then want to store it, emit an event, log an audit message, and send a
notification. Each of these operations uses the same user data but is
otherwise independent. The statements appear in sequence but could
conceptually execute in parallel because they do not depend on each
other’s results.</p>
<p>The aggregation pattern collects data from multiple sources and
combines it into a single result. You might retrieve users from one
repository, orders from another, and products from a third, then create
a summary object that includes counts or statistics from all three. The
gathering happens through multiple REQUEST actions, and the combination
happens through an OWN action that references all the gathered
bindings.</p>
<p>The enrichment pattern starts with a primary piece of data and
augments it with related information from other sources. You might
retrieve an order, then retrieve the customer associated with that
order, then retrieve the items in that order, and finally assemble a
detailed response that includes all of this related information. The key
characteristic is that each subsequent retrieval depends on information
from previous retrievals.</p>
<p>These patterns can combine in complex feature sets. A realistic API
handler might aggregate data from multiple sources, enrich some of that
data with additional lookups, fan out to multiple export operations, and
finally return a response. Understanding the underlying patterns helps
you navigate this complexity.</p>
<hr />
<h2 id="cross-feature-set-communication">6.5 Cross-Feature Set
Communication</h2>
<p>Because each feature set has its own isolated symbol table, data does
not automatically flow between feature sets. If one feature set creates
a value and another feature set needs that value, you must explicitly
communicate it through one of several mechanisms.</p>
<p>The Publish action makes a binding available to other feature sets
within the same business activity. When you publish a value under an
alias, that alias becomes accessible from any feature set with the same
business activity that executes afterward. This scoping to business
activity enforces modularity—feature sets in different business domains
cannot accidentally depend on each other’s published variables. Use
publishing for configuration data, constants, or values that need to be
shared within a domain, but prefer events for communication when the
pattern fits.</p>
<p>Events provide a structured way to pass data between feature sets
while maintaining loose coupling. When you emit an event with a payload,
all handlers for that event type receive access to the payload. The
emitting feature set does not need to know which handlers exist or what
they will do with the data. The handlers extract what they need from the
event payload and proceed independently. This decoupling allows you to
add new behaviors by adding handlers without modifying the emitting
code.</p>
<p>Repositories act as shared persistent storage. One feature set can
store a value to a repository, and another feature set can retrieve it
later. This communication is asynchronous in the sense that the
retriever does not need to execute while the storer is executing. The
repository holds the data between executions. This is appropriate for
persistent data that outlives individual requests.</p>
<p>Repository names must end with <code>-repository</code>—this is not
merely a convention but a requirement that enables the runtime to
identify storage targets. When you write
<code>&lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;</code>,
the runtime recognizes <code>user-repository</code> as persistent
storage because of its suffix. Names like <code>users</code> or
<code>user-data</code> would not trigger repository semantics.</p>
<p>Repositories are scoped to business activities by default. A
<code>user-repository</code> accessed by feature sets with the business
activity “User Management” is separate from a
<code>user-repository</code> accessed by feature sets with the business
activity “Admin Tools”. This scoping prevents unintended data sharing
between different domains of your application.</p>
<p>Repositories store data as ordered lists. Each Store operation
appends to the repository. A Retrieve operation returns all stored items
unless you specify a filter with a where clause. This list-based storage
differs from key-value stores—you can have multiple items that match the
same criteria, and you retrieve them all unless you filter.</p>
<p>The context object provides data that is available to handlers based
on how they were triggered. HTTP handlers receive request data. Event
handlers receive event payloads. This is not really communication
between feature sets but rather communication from the triggering
mechanism to the handler. The context is read-only; handlers cannot
modify it to communicate back.</p>
<hr />
<h2 id="qualified-access">6.6 Qualified Access</h2>
<p>When you reference a variable, you can use qualifiers to access
nested properties within that variable’s value. The qualifier path is
written after the variable name, separated by colons. This allows you to
navigate into structured data without creating intermediate
bindings.</p>
<p>Accessing a property uses a single qualifier: referencing something
like <code>user: name</code> accesses the name property of the user
object. Accessing a deeply nested property chains qualifiers:
referencing something like <code>order: customer.address.city</code>
navigates three levels deep to get the city from the customer’s address
on the order.</p>
<p>Array indexing works similarly. You can access a specific element by
index: referencing <code>items: 0</code> gets the most recently added
element of the items array. Index 1 gets the second most recent, and so
on. This reverse indexing matches common use cases where applications
typically want to access recent data. You can combine array access with
property access: referencing <code>items: 0: name</code> gets the name
property of the most recent item.</p>
<p>Qualifiers work on the result of Extract actions, Create actions, and
any other action that produces structured data. They also work on
context objects like pathParameters, queryParameters, headers, and event
payloads. This allows you to extract specific pieces of complex
structures without binding the entire structure to an intermediate
name.</p>
<p>The qualifier syntax reads naturally when the values have descriptive
names. If you have a user with an address that has a city, then
<code>user: address.city</code> reads almost like natural language
describing what you want. This is another aspect of ARO’s design
philosophy of making code read like descriptions of intent rather than
instructions to a computer.</p>
<hr />
<h2 id="best-practices">6.7 Best Practices</h2>
<p>Several practices help maintain clarity in data flow.</p>
<p>Keep the flow linear when possible. The most readable feature sets
are those where data flows straight through from input to output with
clear transformations along the way. When you find yourself with complex
dependencies or multiple sources feeding into multiple outputs, consider
whether the feature set is doing too much and might benefit from being
split or from using events to separate concerns.</p>
<p>Name variables to reflect their state in the transformation pipeline.
If you extract raw input, validate it, and then use it to create an
entity, names like <code>raw-input</code>, <code>validated-data</code>,
and <code>user</code> help readers understand what each value represents
at that point in the flow. Names like <code>data1</code>,
<code>data2</code>, and <code>data3</code> obscure this progression.</p>
<p>Minimize what you publish. Shared state creates dependencies between
feature sets that can make code harder to understand and modify. Each
published variable is a potential coupling point within its business
activity. Prefer events for communication when the pattern fits, as they
are more explicit about what is being communicated and to whom.</p>
<p>Use events for fan-out scenarios. When a single occurrence needs to
trigger multiple independent actions, emitting an event and having
multiple handlers is cleaner than listing all the actions inline. It
also allows you to add new behaviors by adding handlers rather than
modifying the original feature set.</p>
<p>Document complex data flows when the structure is not obvious from
the code. A comment describing what data is available at each stage, or
a diagram showing how data flows through the feature set, can help
future readers understand non-trivial transformations.</p>
<hr />
<p><em>Next: Chapter 7 — Computations</em></p>
<h1 id="chapter-6a-export-actions">Chapter 6A: Export Actions</h1>
<p><em>“Know where your data goes.”</em></p>
<hr />
<h2 id="a.1-three-paths-out">6A.1 Three Paths Out</h2>
<p>When data leaves your feature set, it takes one of three paths. Each
path serves a distinct purpose in the ARO architecture. Understanding
which path to choose is essential for building well-structured
applications.</p>
<div style="text-align: center; margin: 2em 0;">
<svg width="500" height="200" viewBox="0 0 500 200" xmlns="http://www.w3.org/2000/svg">
<!-- Central feature set box -->
<p><rect x="175" y="20" width="150" height="50" rx="5" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
<text x="250" y="50" text-anchor="middle" font-family="sans-serif" font-size="12" font-weight="bold" fill="#4338ca">Feature
Set</text></p>
<!-- Three diverging arrows -->
<!-- Store path (left) -->
<p><line x1="200" y1="70" x2="100" y2="130" stroke="#22c55e" stroke-width="2"/>
<polygon points="100,130 108,122 112,130" fill="#22c55e"/>
<rect x="50" y="140" width="100" height="40" rx="5" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="100" y="158" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#166534">Repository</text>
<text x="100" y="172" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#16a34a">&lt;Store&gt;</text></p>
<!-- Emit path (center) -->
<p><line x1="250" y1="70" x2="250" y2="130" stroke="#f59e0b" stroke-width="2"/>
<polygon points="250,130 244,120 256,120" fill="#f59e0b"/>
<rect x="200" y="140" width="100" height="40" rx="5" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="250" y="158" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#92400e">Event
Bus</text>
<text x="250" y="172" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#d97706">&lt;Emit&gt;</text></p>
<!-- Publish path (right) -->
<line x1="300" y1="70" x2="400" y2="130" stroke="#8b5cf6" stroke-width="2"/>
<polygon points="400,130 392,122 388,130" fill="#8b5cf6"/>
<rect x="350" y="140" width="100" height="40" rx="5" fill="#f3e8ff" stroke="#8b5cf6" stroke-width="2"/>
<text x="400" y="158" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#6b21a8">Global
Registry</text>
<text x="400" y="172" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#7c3aed">&lt;Publish&gt;</text>
</svg>
</div>
<p><strong>Store</strong> sends data to a repository. The data persists
for the application’s lifetime and can be retrieved later by any feature
set. Use Store when you need to save data for future access.</p>
<p><strong>Emit</strong> sends data to the event bus. Handlers that
match the event type receive the data and execute independently. Use
Emit when you want to trigger reactive behavior in other parts of the
application.</p>
<p><strong>Publish</strong> registers data in a global registry. The
data becomes accessible to other feature sets but does not trigger any
handlers. Use Publish when you need to share a value without triggering
logic.</p>
<p>Each path has different characteristics that make it suitable for
different scenarios. The following sections explore each path in
detail.</p>
<hr />
<h2 id="a.2-store-persistent-data">6A.2 Store: Persistent Data</h2>
<p>The Store action saves data to a named repository. Repositories are
identified by names ending with <code>-repository</code>. This naming
convention is not merely a style guide—the runtime uses this suffix to
recognize storage targets.</p>
<h3 id="when-to-use-store">When to Use Store</h3>
<p>Store is the right choice when:</p>
<ul>
<li>You need to save data for later retrieval</li>
<li>Multiple feature sets need to query the same data</li>
<li>You want to maintain a collection of records</li>
<li>You need audit logs or history</li>
</ul>
<h3 id="basic-storage">Basic Storage</h3>
<p>The simplest form of Store appends a value to a repository:</p>
<pre class="aro"><code>(createUser: User API) {
    &lt;Extract&gt; the &lt;user-data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;user&gt; with &lt;user-data&gt;.

    (* Store saves the user to the repository *)
    &lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.
}</code></pre>
<p>Each Store operation appends to the repository. If you store three
users, the repository contains all three. Repositories are list-based,
not key-value stores.</p>
<h3 id="retrieval">Retrieval</h3>
<p>Data stored in a repository can be retrieved by any feature set:</p>
<pre class="aro"><code>(listUsers: User API) {
    (* Retrieve all users from the repository *)
    &lt;Retrieve&gt; the &lt;users&gt; from the &lt;user-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;users&gt;.
}

(getUser: User API) {
    &lt;Extract&gt; the &lt;id&gt; from the &lt;pathParameters: id&gt;.

    (* Retrieve with a filter *)
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}</code></pre>
<p>The where clause filters the repository contents. Multiple conditions
can be combined:</p>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;orders&gt; from the &lt;order-repository&gt;
    where status = &quot;pending&quot; and customer = &lt;customer-id&gt;.</code></pre>
<h3 id="repository-observers">Repository Observers</h3>
<p>When data is stored, updated, or deleted in a repository, observers
can react automatically. This is a powerful pattern for implementing
side effects without coupling:</p>
<pre class="aro"><code>(* This observer runs automatically when user-repository changes *)
(Audit Changes: user-repository Observer) {
    &lt;Extract&gt; the &lt;changeType&gt; from the &lt;event: changeType&gt;.
    &lt;Extract&gt; the &lt;entityId&gt; from the &lt;event: entityId&gt;.

    &lt;Log&gt; the &lt;audit: message&gt; for the &lt;console&gt;
        with &quot;[AUDIT] user-repository: &quot; + &lt;changeType&gt; + &quot; (id: &quot; + &lt;entityId&gt; + &quot;)&quot;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;audit&gt;.
}</code></pre>
<p>The observer receives an event with details about the change:</p>
<table>
<colgroup>
<col style="width: 35%" />
<col style="width: 65%" />
</colgroup>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>changeType</code></td>
<td>“created”, “updated”, or “deleted”</td>
</tr>
<tr>
<td><code>entityId</code></td>
<td>ID of the affected entity (if the entity has an “id” field)</td>
</tr>
<tr>
<td><code>newValue</code></td>
<td>The new value (nil for deletes)</td>
</tr>
<tr>
<td><code>oldValue</code></td>
<td>The previous value (nil for creates)</td>
</tr>
<tr>
<td><code>repositoryName</code></td>
<td>Name of the repository</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="a.3-emit-event-driven-communication">6A.3 Emit: Event-Driven
Communication</h2>
<p>The Emit action fires a domain event that triggers handlers in other
feature sets. Unlike Store, the event payload is transient—it exists
only during handler execution. Once all handlers complete, the event is
gone.</p>
<h3 id="when-to-use-emit">When to Use Emit</h3>
<p>Emit is the right choice when:</p>
<ul>
<li>You want to trigger side effects (notifications, analytics,
etc.)</li>
<li>You are building event-driven workflows or sagas</li>
<li>You need loose coupling between feature sets</li>
<li>Multiple handlers should react to the same occurrence</li>
</ul>
<h3 id="basic-emission">Basic Emission</h3>
<p>Emit creates a domain event with a type and payload:</p>
<pre class="aro"><code>(createUser: User API) {
    &lt;Extract&gt; the &lt;user-data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;user&gt; with &lt;user-data&gt;.
    &lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.

    (* Emit notifies interested handlers *)
    &lt;Emit&gt; a &lt;UserCreated: event&gt; with &lt;user&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.
}</code></pre>
<p>The event type is derived from the result descriptor. In this case,
<code>UserCreated</code> becomes the event type, and handlers for
“UserCreated Handler” are triggered.</p>
<h3 id="event-handlers">Event Handlers</h3>
<p>Handlers receive the event payload and can extract data from it:</p>
<pre class="aro"><code>(* Triggered by &lt;Emit&gt; a &lt;UserCreated: event&gt; with &lt;user&gt; *)
(Send Welcome Email: UserCreated Handler) {
    &lt;Extract&gt; the &lt;user&gt; from the &lt;event: user&gt;.
    &lt;Extract&gt; the &lt;email&gt; from the &lt;user: email&gt;.

    &lt;Send&gt; the &lt;welcome-email&gt; to the &lt;email-service&gt; with {
        to: &lt;email&gt;,
        subject: &quot;Welcome!&quot;,
        template: &quot;welcome&quot;
    }.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;notification&gt;.
}

(* Another handler for the same event *)
(Track Signup: UserCreated Handler) {
    &lt;Extract&gt; the &lt;user&gt; from the &lt;event: user&gt;.

    &lt;Send&gt; the &lt;analytics-event&gt; to the &lt;analytics-service&gt; with {
        event: &quot;user_signup&quot;,
        properties: &lt;user&gt;
    }.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;tracking&gt;.
}</code></pre>
<p>Both handlers execute independently when a UserCreated event is
emitted. The emitting code does not know or care which handlers
exist.</p>
<h3 id="event-chains">Event Chains</h3>
<p>Handlers can emit additional events, creating processing chains:</p>
<pre class="aro"><code>(* OrderPlaced triggers inventory reservation *)
(Reserve Inventory: OrderPlaced Handler) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Update&gt; the &lt;inventory&gt; for the &lt;order: items&gt;.

    (* Continue the chain *)
    &lt;Emit&gt; an &lt;InventoryReserved: event&gt; with &lt;order&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;reservation&gt;.
}

(* InventoryReserved triggers payment *)
(Process Payment: InventoryReserved Handler) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Send&gt; the &lt;charge&gt; to the &lt;payment-gateway&gt; with &lt;order&gt;.

    (* Continue the chain *)
    &lt;Emit&gt; a &lt;PaymentProcessed: event&gt; with &lt;order&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;payment&gt;.
}</code></pre>
<p>This pattern enables complex workflows while keeping each handler
focused on a single responsibility.</p>
<hr />
<h2 id="a.4-publish-shared-values">6A.4 Publish: Shared Values</h2>
<p>The Publish action makes a value globally accessible without
triggering any logic. Published values are available to other feature
sets within the same business activity but do not cause handlers to
execute.</p>
<h3 id="when-to-use-publish">When to Use Publish</h3>
<p>Publish is rarely needed. Consider it only when:</p>
<ul>
<li>You load configuration at startup that multiple feature sets
need</li>
<li>You create a singleton resource (connection pool, service
instance)</li>
<li>You compute a value that multiple feature sets use without needing
events</li>
</ul>
<p>In most cases, Emit provides better decoupling. Use Publish only when
you specifically need a shared value without reactive behavior.</p>
<h3 id="basic-publication">Basic Publication</h3>
<p>Publish registers a value under an alias:</p>
<pre class="aro"><code>(Application-Start: Config Loader) {
    &lt;Read&gt; the &lt;config-data&gt; from the &lt;file: &quot;./config.json&quot;&gt;.
    &lt;Parse&gt; the &lt;config: JSON&gt; from the &lt;config-data&gt;.

    (* Make config available to all feature sets *)
    &lt;Publish&gt; as &lt;app-config&gt; &lt;config&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}</code></pre>
<p>The alias (<code>app-config</code>) becomes the name other feature
sets use to access the value.</p>
<h3 id="accessing-published-values">Accessing Published Values</h3>
<p>Published values can be referenced directly by their alias:</p>
<pre class="aro"><code>(getApiUrl: Configuration Handler) {
    (* app-config was published at startup *)
    &lt;Extract&gt; the &lt;url&gt; from the &lt;app-config: apiUrl&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;url&gt;.
}</code></pre>
<p>Published values are scoped to the business activity. Feature sets in
different business activities cannot access each other’s published
values.</p>
<hr />
<h2 id="a.5-decision-guide">6A.5 Decision Guide</h2>
<p>Choosing between Store, Emit, and Publish becomes straightforward
when you ask the right question.</p>
<div style="text-align: center; margin: 2em 0;">
<svg width="450" height="220" viewBox="0 0 450 220" xmlns="http://www.w3.org/2000/svg">
<!-- Question boxes and decision flow -->
<p><rect x="125" y="10" width="200" height="35" rx="5" fill="#f3f4f6" stroke="#6b7280" stroke-width="1.5"/>
<text x="225" y="32" text-anchor="middle" font-family="sans-serif" font-size="11" fill="#374151">What
do you need?</text></p>
<!-- Three branches -->
<p><line x1="175" y1="45" x2="80" y2="80" stroke="#6b7280" stroke-width="1.5"/>
<line x1="225" y1="45" x2="225" y2="80" stroke="#6b7280" stroke-width="1.5"/>
<line x1="275" y1="45" x2="370" y2="80" stroke="#6b7280" stroke-width="1.5"/></p>
<!-- Store branch -->
<p><rect x="20" y="80" width="120" height="45" rx="5" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="80" y="98" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#166534">Persist
data for</text>
<text x="80" y="112" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#166534">later
retrieval?</text>
<line x1="80" y1="125" x2="80" y2="155" stroke="#22c55e" stroke-width="1.5"/>
<polygon points="80,155 75,148 85,148" fill="#22c55e"/>
<rect x="30" y="160" width="100" height="30" rx="5" fill="#22c55e"/>
<text x="80" y="180" text-anchor="middle" font-family="sans-serif" font-size="11" font-weight="bold" fill="white">&lt;Store&gt;</text></p>
<!-- Emit branch -->
<p><rect x="165" y="80" width="120" height="45" rx="5" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<text x="225" y="98" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#92400e">Trigger
handlers</text>
<text x="225" y="112" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#92400e">reactively?</text>
<line x1="225" y1="125" x2="225" y2="155" stroke="#f59e0b" stroke-width="1.5"/>
<polygon points="225,155 220,148 230,148" fill="#f59e0b"/>
<rect x="175" y="160" width="100" height="30" rx="5" fill="#f59e0b"/>
<text x="225" y="180" text-anchor="middle" font-family="sans-serif" font-size="11" font-weight="bold" fill="white">&lt;Emit&gt;</text></p>
<!-- Publish branch -->
<rect x="310" y="80" width="120" height="45" rx="5" fill="#f3e8ff" stroke="#8b5cf6" stroke-width="1.5"/>
<text x="370" y="98" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b21a8">Share
value without</text>
<text x="370" y="112" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b21a8">triggering
logic?</text>
<line x1="370" y1="125" x2="370" y2="155" stroke="#8b5cf6" stroke-width="1.5"/>
<polygon points="370,155 365,148 375,148" fill="#8b5cf6"/>
<rect x="320" y="160" width="100" height="30" rx="5" fill="#8b5cf6"/>
<text x="370" y="180" text-anchor="middle" font-family="sans-serif" font-size="11" font-weight="bold" fill="white">&lt;Publish&gt;</text>
</svg>
</div>
<h3 id="comparison-table">Comparison Table</h3>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 20%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>Store</th>
<th>Emit</th>
<th>Publish</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Target</strong></td>
<td>Repository</td>
<td>Event bus</td>
<td>Global registry</td>
</tr>
<tr>
<td><strong>Triggers</strong></td>
<td>Repository observers</td>
<td>Event handlers</td>
<td>Nothing</td>
</tr>
<tr>
<td><strong>Data lifespan</strong></td>
<td>Application lifetime</td>
<td>Handler execution only</td>
<td>Application lifetime</td>
</tr>
<tr>
<td><strong>Access pattern</strong></td>
<td><code>&lt;Retrieve&gt;</code> with filters</td>
<td><code>&lt;Extract&gt;</code> from event</td>
<td>Direct variable reference</td>
</tr>
<tr>
<td><strong>Typical use</strong></td>
<td>CRUD data, audit logs</td>
<td>Reactive workflows, notifications</td>
<td>Config, singletons</td>
</tr>
<tr>
<td><strong>Coupling</strong></td>
<td>Medium (via repository name)</td>
<td>Low (via event type)</td>
<td>Low (via alias name)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="a.6-common-mistakes">6A.6 Common Mistakes</h2>
<h3 id="using-emit-for-persistence">Using Emit for Persistence</h3>
<p>A common mistake is emitting an event when you need persistent
data:</p>
<pre class="aro"><code>(* WRONG: Events are transient *)
(createMessage: Chat API) {
    &lt;Extract&gt; the &lt;message-data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;message&gt; with &lt;message-data&gt;.

    (* This event disappears after handlers complete! *)
    &lt;Emit&gt; a &lt;MessageCreated: event&gt; with &lt;message&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;message&gt;.
}

(listMessages: Chat API) {
    (* ERROR: There&#39;s no way to retrieve emitted events *)
    (* The messages are gone! *)
}</code></pre>
<p>The fix is to Store the data:</p>
<pre class="aro"><code>(* CORRECT: Store for persistence, Emit for notifications *)
(createMessage: Chat API) {
    &lt;Extract&gt; the &lt;message-data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;message&gt; with &lt;message-data&gt;.

    (* Store the message for later retrieval *)
    &lt;Store&gt; the &lt;message&gt; into the &lt;message-repository&gt;.

    (* Also emit for any handlers that want to react *)
    &lt;Emit&gt; a &lt;MessageCreated: event&gt; with &lt;message&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;message&gt;.
}

(listMessages: Chat API) {
    (* Now we can retrieve stored messages *)
    &lt;Retrieve&gt; the &lt;messages&gt; from the &lt;message-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;messages&gt;.
}</code></pre>
<h3 id="using-store-for-communication">Using Store for
Communication</h3>
<p>Another mistake is storing data just to trigger an observer when Emit
would be cleaner:</p>
<pre class="aro"><code>(* AWKWARD: Using store just to trigger behavior *)
(processPayment: Payment API) {
    &lt;Extract&gt; the &lt;payment&gt; from the &lt;request: body&gt;.

    (* Storing just to trigger the observer *)
    &lt;Store&gt; the &lt;payment&gt; into the &lt;payment-notification-repository&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;payment&gt;.
}

(Send Receipt: payment-notification-repository Observer) {
    (* This works but is awkward *)
    &lt;Extract&gt; the &lt;payment&gt; from the &lt;event: newValue&gt;.
    &lt;Send&gt; the &lt;receipt&gt; to the &lt;email-service&gt;.
}</code></pre>
<p>The fix is to use Emit for reactive behavior:</p>
<pre class="aro"><code>(* BETTER: Use Emit for reactive communication *)
(processPayment: Payment API) {
    &lt;Extract&gt; the &lt;payment&gt; from the &lt;request: body&gt;.

    (* Emit for handlers that need to react *)
    &lt;Emit&gt; a &lt;PaymentProcessed: event&gt; with &lt;payment&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;payment&gt;.
}

(Send Receipt: PaymentProcessed Handler) {
    &lt;Extract&gt; the &lt;payment&gt; from the &lt;event: payment&gt;.
    &lt;Send&gt; the &lt;receipt&gt; to the &lt;email-service&gt;.
}</code></pre>
<p>Use Store when you need persistence. Use Emit when you need reactive
behavior. Use both when you need both.</p>
<h3 id="overusing-publish">Overusing Publish</h3>
<p>Publish is sometimes overused when Emit would provide better
decoupling:</p>
<pre class="aro"><code>(* QUESTIONABLE: Publishing user for other feature sets *)
(createUser: User API) {
    &lt;Create&gt; the &lt;user&gt; with &lt;user-data&gt;.
    &lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.

    (* Publishing forces other feature sets to poll for this value *)
    &lt;Publish&gt; as &lt;latest-user&gt; &lt;user&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.
}</code></pre>
<p>The problem is that other feature sets must know to check for the
published value. With Emit, handlers are triggered automatically:</p>
<pre class="aro"><code>(* BETTER: Emit notifies interested parties automatically *)
(createUser: User API) {
    &lt;Create&gt; the &lt;user&gt; with &lt;user-data&gt;.
    &lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.

    (* Handlers are triggered automatically *)
    &lt;Emit&gt; a &lt;UserCreated: event&gt; with &lt;user&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.
}</code></pre>
<p>Reserve Publish for truly shared values like configuration, not for
communication between feature sets.</p>
<hr />
<h2 id="a.7-complete-example-user-registration">6A.7 Complete Example:
User Registration</h2>
<p>Here is a realistic example that uses all three export actions
appropriately. The scenario is user registration with email
verification, welcome notifications, and analytics tracking.</p>
<p><strong>main.aro</strong> — Application startup:</p>
<pre class="aro"><code>(Application-Start: User Service) {
    &lt;Read&gt; the &lt;config-data&gt; from the &lt;file: &quot;./config.json&quot;&gt;.
    &lt;Parse&gt; the &lt;config: JSON&gt; from the &lt;config-data&gt;.

    (* Publish config for all feature sets *)
    &lt;Publish&gt; as &lt;app-config&gt; &lt;config&gt;.

    &lt;Start&gt; the &lt;http-server&gt; with &lt;contract&gt;.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}</code></pre>
<p><strong>users.aro</strong> — User creation:</p>
<pre class="aro"><code>(createUser: User API) {
    &lt;Extract&gt; the &lt;user-data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;user&gt; with &lt;user-data&gt;.

    (* Store for persistence — we need to retrieve users later *)
    &lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.

    (* Emit for reactive behavior — handlers will send emails, track analytics *)
    &lt;Emit&gt; a &lt;UserCreated: event&gt; with &lt;user&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.
}

(getUser: User API) {
    &lt;Extract&gt; the &lt;id&gt; from the &lt;pathParameters: id&gt;.

    (* Retrieve stored user *)
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}

(listUsers: User API) {
    (* Retrieve all stored users *)
    &lt;Retrieve&gt; the &lt;users&gt; from the &lt;user-repository&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;users&gt;.
}</code></pre>
<p><strong>handlers.aro</strong> — Event handlers:</p>
<pre class="aro"><code>(* Send welcome email when user is created *)
(Send Welcome Email: UserCreated Handler) {
    &lt;Extract&gt; the &lt;user&gt; from the &lt;event: user&gt;.
    &lt;Extract&gt; the &lt;email&gt; from the &lt;user: email&gt;.

    (* Access published config *)
    &lt;Extract&gt; the &lt;from-address&gt; from the &lt;app-config: email.fromAddress&gt;.

    &lt;Send&gt; the &lt;welcome-email&gt; to the &lt;email-service&gt; with {
        to: &lt;email&gt;,
        from: &lt;from-address&gt;,
        subject: &quot;Welcome to our service!&quot;,
        template: &quot;welcome&quot;
    }.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;notification&gt;.
}

(* Track signup in analytics *)
(Track Signup: UserCreated Handler) {
    &lt;Extract&gt; the &lt;user&gt; from the &lt;event: user&gt;.

    (* Access published config *)
    &lt;Extract&gt; the &lt;analytics-key&gt; from the &lt;app-config: analytics.apiKey&gt;.

    &lt;Send&gt; the &lt;analytics-event&gt; to the &lt;analytics-service&gt; with {
        apiKey: &lt;analytics-key&gt;,
        event: &quot;user_signup&quot;,
        properties: {
            userId: &lt;user: id&gt;,
            email: &lt;user: email&gt;,
            createdAt: &lt;user: createdAt&gt;
        }
    }.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;tracking&gt;.
}</code></pre>
<p><strong>observers.aro</strong> — Repository observers:</p>
<pre class="aro"><code>(* Audit all changes to user repository *)
(Audit User Changes: user-repository Observer) {
    &lt;Extract&gt; the &lt;changeType&gt; from the &lt;event: changeType&gt;.
    &lt;Extract&gt; the &lt;entityId&gt; from the &lt;event: entityId&gt;.
    &lt;Extract&gt; the &lt;timestamp&gt; from the &lt;event: timestamp&gt;.

    &lt;Log&gt; the &lt;audit: message&gt; for the &lt;console&gt;
        with &quot;[AUDIT] &quot; + &lt;timestamp&gt; + &quot; user-repository: &quot; + &lt;changeType&gt; + &quot; (id: &quot; + &lt;entityId&gt; + &quot;)&quot;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;audit&gt;.
}</code></pre>
<p>This example demonstrates:</p>
<ul>
<li><strong>Publish</strong> for shared configuration loaded at
startup</li>
<li><strong>Store</strong> for user data that needs to be retrieved
later</li>
<li><strong>Emit</strong> for triggering welcome emails and
analytics</li>
<li><strong>Repository observers</strong> for audit logging</li>
</ul>
<p>Each action serves its intended purpose, creating a well-structured,
maintainable application.</p>
<hr />
<p><em>Next: Chapter 7 — Computations</em></p>
<h1 id="chapter-7-computations">Chapter 7: Computations</h1>
<p><em>“Transform what you have into what you need.”</em></p>
<hr />
<h2 id="the-own-role">7.1 The OWN Role</h2>
<p>Among the four semantic roles in ARO—REQUEST, OWN, RESPONSE, and
EXPORT—the OWN role occupies a special place. While REQUEST brings data
in and RESPONSE sends it out, OWN is where the actual work happens. OWN
actions transform data that already exists within the feature set,
producing new values without external side effects.</p>
<p>The Compute action is the quintessential OWN action. It takes
existing bindings, applies operations to them, and produces new
bindings. No network calls, no file access, no external
dependencies—just pure transformation of data that is already present.
This purity makes OWN actions predictable and easy to reason about.</p>
<p>Consider what happens when you compute a string’s length. The input
string exists in the symbol table, bound to some variable name. The
Compute action reads that value, performs a calculation (counting
characters), and binds the result to a new variable name. The original
string remains unchanged. The new binding appears in the symbol table.
The flow continues.</p>
<p>This pattern—read, transform, bind—is the heartbeat of data
processing in ARO.</p>
<hr />
<h2 id="built-in-computations">7.2 Built-in Computations</h2>
<p>ARO provides several built-in computations that cover common
transformation needs:</p>
<div
style="display: flex; flex-wrap: wrap; justify-content: center; gap: 1em; margin: 2em 0;">
<div style="text-align: center;">
<svg width="120" height="80" viewBox="0 0 120 80" xmlns="http://www.w3.org/2000/svg">
<rect x="10" y="20" width="100" height="40" rx="5" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
<text x="60" y="35" text-anchor="middle" font-family="monospace" font-size="10" fill="#1e40af">“Hello”</text>
<text x="60" y="50" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#3b82f6">→
5</text>
<text x="60" y="72" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#1e40af">length</text>
</svg>
</div>
<div style="text-align: center;">
<svg width="120" height="80" viewBox="0 0 120 80" xmlns="http://www.w3.org/2000/svg">
<rect x="10" y="20" width="100" height="40" rx="5" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="60" y="35" text-anchor="middle" font-family="monospace" font-size="10" fill="#166534">“hello”</text>
<text x="60" y="50" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#22c55e">→
“HELLO”</text>
<text x="60" y="72" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#166534">uppercase</text>
</svg>
</div>
<div style="text-align: center;">
<svg width="120" height="80" viewBox="0 0 120 80" xmlns="http://www.w3.org/2000/svg">
<rect x="10" y="20" width="100" height="40" rx="5" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="60" y="35" text-anchor="middle" font-family="monospace" font-size="10" fill="#92400e">“HELLO”</text>
<text x="60" y="50" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#f59e0b">→
“hello”</text>
<text x="60" y="72" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#92400e">lowercase</text>
</svg>
</div>
<div style="text-align: center;">
<svg width="120" height="80" viewBox="0 0 120 80" xmlns="http://www.w3.org/2000/svg">
<rect x="10" y="20" width="100" height="40" rx="5" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/>
<text x="60" y="35" text-anchor="middle" font-family="monospace" font-size="10" fill="#7c3aed">“secret”</text>
<text x="60" y="50" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#a855f7">→
839201</text>
<text x="60" y="72" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#7c3aed">hash</text>
</svg>
</div>
</div>
<p>The <strong>length</strong> and <strong>count</strong> operations
count elements—characters in strings, items in arrays, keys in
dictionaries. While interchangeable for most purposes,
<code>length</code> is typically used for strings and <code>count</code>
for collections. The <strong>uppercase</strong> and
<strong>lowercase</strong> operations transform case. The
<strong>hash</strong> operation produces an integer hash value useful
for comparisons.</p>
<p>The <strong>identity</strong> operation, while seemingly trivial,
serves an important purpose: it allows arithmetic expressions to be
written naturally:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;total&gt; from &lt;price&gt; * &lt;quantity&gt;.</code></pre>
<p>Here, the expression <code>&lt;price&gt; * &lt;quantity&gt;</code> is
the actual computation. The result binds to <code>total</code>. This is
identity in action—the expression’s result passes through unchanged.</p>
<hr />
<h2 id="naming-your-results">7.3 Naming Your Results</h2>
<p>A subtle problem arises when you need multiple results of the same
operation. Consider computing the lengths of two different messages:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;length&gt; from the &lt;greeting&gt;.
&lt;Compute&gt; the &lt;length&gt; from the &lt;farewell&gt;.  (* Overwrites! *)</code></pre>
<p>Since ARO variables are immutable within their scope, the second
statement overwrites the first. Both computations produce lengths, but
only the last one survives.</p>
<p>The solution is the <strong>qualifier-as-name</strong> syntax. In
this pattern, the qualifier specifies the operation while the base
becomes the variable name:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;greeting-length: length&gt; from the &lt;greeting&gt;.
&lt;Compute&gt; the &lt;farewell-length: length&gt; from the &lt;farewell&gt;.</code></pre>
<p>Now both lengths exist with distinct names. You can compare them:</p>
<pre class="aro"><code>&lt;Compare&gt; the &lt;greeting-length&gt; against the &lt;farewell-length&gt;.</code></pre>
<p>This syntax separates two concerns that were previously conflated: -
The <strong>base</strong> (<code>greeting-length</code>) is what you
want to call the result - The <strong>qualifier</strong>
(<code>length</code>) is what operation to perform</p>
<p>The same pattern works with all computed operations:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;name-upper: uppercase&gt; from the &lt;name&gt;.
&lt;Compute&gt; the &lt;name-lower: lowercase&gt; from the &lt;name&gt;.
&lt;Compute&gt; the &lt;password-hash: hash&gt; from the &lt;password&gt;.</code></pre>
<p>For backward compatibility, the original syntax still works. Writing
<code>&lt;Compute&gt; the &lt;length&gt; from &lt;msg&gt;.</code>
recognizes <code>length</code> as both the variable name and the
operation.</p>
<hr />
<h2 id="extending-computations">7.4 Extending Computations</h2>
<p>The built-in operations cover common cases, but real applications
often need domain-specific computations. ARO’s plugin system allows you
to add custom operations that integrate seamlessly with the Compute
action.</p>
<p>Plugins implement the <code>ComputationService</code> protocol:</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> ComputationService<span class="op">:</span> <span class="dt">Sendable</span> <span class="op">{</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">compute</span><span class="op">(</span><span class="va">named</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">input</span><span class="op">:</span> <span class="dt">Any</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">any</span> <span class="fu">Sendable</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>When the Compute action executes, it first checks for a registered
computation service. If one exists, it delegates to the plugin. This
allows plugins to provide operations like cryptographic hashes, custom
string transformations, or domain-specific calculations.</p>
<p>A cryptography plugin might provide:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;password-hash: sha256&gt; from the &lt;password&gt;.
&lt;Compute&gt; the &lt;signature: hmac&gt; from the &lt;message&gt;.</code></pre>
<p>A formatting plugin might provide:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;formatted-date: iso8601&gt; from the &lt;timestamp&gt;.
&lt;Compute&gt; the &lt;money-display: currency&gt; from the &lt;amount&gt;.</code></pre>
<p>The syntax remains consistent regardless of whether the operation is
built-in or plugin-provided. This uniformity means you can start with
built-in operations and add plugins later without changing how your code
reads.</p>
<p>See Chapter 17 for the full plugin development guide.</p>
<hr />
<h2 id="computation-patterns">7.5 Computation Patterns</h2>
<p>Several patterns emerge in how computations are used within feature
sets.</p>
<p><strong>Derived values</strong> compute new data from existing
bindings:</p>
<pre class="aro"><code>&lt;Extract&gt; the &lt;price&gt; from the &lt;product: price&gt;.
&lt;Extract&gt; the &lt;quantity&gt; from the &lt;order: quantity&gt;.
&lt;Compute&gt; the &lt;subtotal&gt; from &lt;price&gt; * &lt;quantity&gt;.
&lt;Compute&gt; the &lt;tax&gt; from &lt;subtotal&gt; * 0.08.
&lt;Compute&gt; the &lt;total&gt; from &lt;subtotal&gt; + &lt;tax&gt;.</code></pre>
<p><strong>Normalization</strong> ensures consistent data formats:</p>
<pre class="aro"><code>&lt;Extract&gt; the &lt;email&gt; from the &lt;input: email&gt;.
&lt;Compute&gt; the &lt;normalized-email: lowercase&gt; from the &lt;email&gt;.</code></pre>
<p><strong>Chained transformations</strong> build complex results step
by step:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;base&gt; from &lt;quantity&gt; * &lt;unit-price&gt;.
&lt;Compute&gt; the &lt;discounted&gt; from &lt;base&gt; * (1 - &lt;discount-rate&gt;).
&lt;Compute&gt; the &lt;with-tax&gt; from &lt;discounted&gt; * (1 + &lt;tax-rate&gt;).</code></pre>
<p><strong>Aggregation</strong> combines collection data:</p>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;orders&gt; from the &lt;order-repository&gt;.
&lt;Compute&gt; the &lt;order-count: count&gt; from the &lt;orders&gt;.</code></pre>
<p>Each pattern follows the read-transform-bind rhythm. Data flows
forward, transformations produce new values, and the symbol table
accumulates bindings that subsequent statements can use.</p>
<hr />
<p><em>Next: Chapter 8 — Understanding Qualifiers</em></p>
<h1 id="chapter-8-understanding-qualifiers">Chapter 8: Understanding
Qualifiers</h1>
<p><em>“The colon is context-aware: it navigates data or selects
operations.”</em></p>
<hr />
<h2 id="the-two-roles-of-qualifiers">8.1 The Two Roles of
Qualifiers</h2>
<p>Throughout ARO, you encounter the colon syntax
<code>&lt;name: qualifier&gt;</code>. This compact notation carries
significant meaning, but that meaning depends on context. Understanding
when the colon navigates data versus when it selects operations is
essential for writing clear ARO code.</p>
<p>The qualifier serves two distinct purposes:</p>
<table>
<colgroup>
<col style="width: 37%" />
<col style="width: 25%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr>
<th>Context</th>
<th>Role</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Operations</strong> (Compute, Transform, Sort)</td>
<td>Selects which operation to perform</td>
<td><code>&lt;len: length&gt;</code></td>
</tr>
<tr>
<td><strong>Data Access</strong> (Extract, Objects)</td>
<td>Navigates to nested properties</td>
<td><code>&lt;event: user&gt;</code></td>
</tr>
</tbody>
</table>
<p>This distinction matters because the same syntax produces
fundamentally different results depending on the action being
performed.</p>
<hr />
<h2 id="operation-qualifiers">8.2 Operation Qualifiers</h2>
<p>When using actions like Compute, Validate, Transform, or Sort, the
qualifier specifies which operation to apply. The base identifier
becomes the variable name for the result.</p>
<h3 id="the-problem-name-collisions">The Problem: Name Collisions</h3>
<p>Consider computing lengths of multiple strings:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;length&gt; from the &lt;greeting&gt;.
&lt;Compute&gt; the &lt;length&gt; from the &lt;farewell&gt;.</code></pre>
<p>Both statements attempt to bind to <code>length</code>. Since ARO
variables are immutable within a scope, the second overwrites the first.
You lose the greeting’s length.</p>
<h3 id="the-solution-qualifier-as-name">The Solution:
Qualifier-as-Name</h3>
<p>Separate the variable name from the operation:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;greeting-length: length&gt; from the &lt;greeting&gt;.
&lt;Compute&gt; the &lt;farewell-length: length&gt; from the &lt;farewell&gt;.</code></pre>
<p>Now <code>greeting-length</code> holds 12 and
<code>farewell-length</code> holds 8. Both values exist simultaneously,
ready for comparison:</p>
<pre class="aro"><code>&lt;Compare&gt; the &lt;greeting-length&gt; against the &lt;farewell-length&gt;.</code></pre>
<h3 id="available-operations-by-action">Available Operations by
Action</h3>
<table>
<colgroup>
<col style="width: 42%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr>
<th>Action</th>
<th>Operations</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Compute</strong></td>
<td><code>length</code>, <code>count</code>, <code>hash</code>,
<code>uppercase</code>, <code>lowercase</code>,
<code>identity</code></td>
</tr>
<tr>
<td><strong>Validate</strong></td>
<td><code>required</code>, <code>exists</code>, <code>nonempty</code>,
<code>email</code>, <code>numeric</code></td>
</tr>
<tr>
<td><strong>Transform</strong></td>
<td><code>string</code>, <code>int</code>, <code>integer</code>,
<code>double</code>, <code>float</code>, <code>bool</code>,
<code>boolean</code>, <code>json</code>, <code>identity</code></td>
</tr>
<tr>
<td><strong>Sort</strong></td>
<td><code>ascending</code>, <code>descending</code></td>
</tr>
</tbody>
</table>
<h3 id="examples">Examples</h3>
<pre class="aro"><code>(* Multiple computations with distinct names *)
&lt;Compute&gt; the &lt;name-upper: uppercase&gt; from the &lt;name&gt;.
&lt;Compute&gt; the &lt;name-lower: lowercase&gt; from the &lt;name&gt;.
&lt;Compute&gt; the &lt;name-len: length&gt; from the &lt;name&gt;.

(* Validation with named results *)
&lt;Validate&gt; the &lt;email-valid: email&gt; for the &lt;input-email&gt;.
&lt;Validate&gt; the &lt;age-valid: numeric&gt; for the &lt;input-age&gt;.

(* Transformations *)
&lt;Transform&gt; the &lt;user-json: json&gt; from the &lt;user&gt;.
&lt;Transform&gt; the &lt;count-str: string&gt; from the &lt;count&gt;.</code></pre>
<hr />
<h2 id="field-navigation-qualifiers">8.3 Field Navigation
Qualifiers</h2>
<p>When accessing data from objects, events, or requests, the qualifier
navigates to nested properties. The qualifier acts as a path into the
data structure.</p>
<h3 id="single-level-access">Single-Level Access</h3>
<pre class="aro"><code>(* Extract user from event payload *)
&lt;Extract&gt; the &lt;user&gt; from the &lt;event: user&gt;.

(* Extract body from request *)
&lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.

(* Extract id from path parameters *)
&lt;Extract&gt; the &lt;user-id&gt; from the &lt;pathParameters: id&gt;.</code></pre>
<h3 id="deep-navigation">Deep Navigation</h3>
<p>For nested structures, use dot-separated paths:</p>
<pre class="aro"><code>(* Access deeply nested data *)
&lt;Extract&gt; the &lt;city&gt; from the &lt;user: address.city&gt;.
&lt;Extract&gt; the &lt;zip&gt; from the &lt;user: address.postal-code&gt;.

(* Navigate through arrays and objects *)
&lt;Extract&gt; the &lt;first-name&gt; from the &lt;response: data.users.0.name&gt;.</code></pre>
<h3 id="common-patterns">Common Patterns</h3>
<pre class="aro"><code>(* HTTP request handling *)
&lt;Extract&gt; the &lt;auth-token&gt; from the &lt;request: headers.Authorization&gt;.
&lt;Extract&gt; the &lt;content-type&gt; from the &lt;request: headers.Content-Type&gt;.

(* Event handling *)
&lt;Extract&gt; the &lt;order&gt; from the &lt;event: payload.order&gt;.
&lt;Extract&gt; the &lt;customer-id&gt; from the &lt;event: payload.order.customer-id&gt;.

(* Configuration access *)
&lt;Extract&gt; the &lt;timeout&gt; from the &lt;config: server.timeout&gt;.
&lt;Extract&gt; the &lt;max-retries&gt; from the &lt;config: server.retry.max-attempts&gt;.</code></pre>
<hr />
<h2 id="type-annotations-with-as">8.4 Type Annotations with
<code>as</code></h2>
<p>For data pipeline operations (Filter, Reduce, Map), you can
optionally specify result types using the <code>as</code> keyword:</p>
<pre class="aro"><code>(* Without type - inferred automatically *)
&lt;Filter&gt; the &lt;active-users&gt; from the &lt;users&gt; where &lt;active&gt; is true.

(* With explicit type using &#39;as&#39; *)
&lt;Filter&gt; the &lt;active-users&gt; as List&lt;User&gt; from the &lt;users&gt; where &lt;active&gt; is true.

(* Reduce with type for precision *)
&lt;Reduce&gt; the &lt;total&gt; as Float from the &lt;orders&gt; with sum(&lt;amount&gt;).</code></pre>
<p>Type annotations are <strong>optional</strong> because ARO infers
result types from the operation. Use explicit types when:</p>
<ol type="1">
<li>You need a specific numeric precision (Float vs Integer)</li>
<li>You want documentation in the code</li>
<li>You’re overriding default inference</li>
</ol>
<p>See ARO-0038 for the full specification.</p>
<hr />
<h2 id="the-ambiguity-case">8.5 The Ambiguity Case</h2>
<p>A natural question arises: what happens when data contains a field
named like an operation?</p>
<pre class="aro"><code>&lt;Create&gt; the &lt;data&gt; with { length: 42, items: [1, 2, 3] }.</code></pre>
<p>If you write:</p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;len: length&gt; from the &lt;data&gt;.</code></pre>
<p>What does ARO compute? The <code>length</code> field (42) or the
length of <code>data</code> (2 keys)?</p>
<p><strong>The rule</strong>: Operation qualifiers apply to the action’s
semantic meaning, not field access. The Compute action computes
<code>length</code> (the operation) on <code>data</code>, returning 2
(two keys in the dictionary).</p>
<p>To access the <code>length</code> field, use Extract:</p>
<pre class="aro"><code>&lt;Extract&gt; the &lt;len&gt; from the &lt;data: length&gt;.</code></pre>
<p>This returns 42—the value of the <code>length</code> field.</p>
<h3 id="summary-of-resolution">Summary of Resolution</h3>
<table>
<colgroup>
<col style="width: 32%" />
<col style="width: 44%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Statement</th>
<th>Interpretation</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;Compute&gt; the &lt;len: length&gt; from &lt;data&gt;.</code></td>
<td>Compute length of data</td>
<td>2</td>
</tr>
<tr>
<td><code>&lt;Extract&gt; the &lt;len&gt; from &lt;data: length&gt;.</code></td>
<td>Extract length field</td>
<td>42</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="best-practices-1">8.6 Best Practices</h2>
<p><strong>Use descriptive base names with operation
qualifiers:</strong></p>
<pre class="aro"><code>(* Good: Clear what each variable holds *)
&lt;Compute&gt; the &lt;greeting-length: length&gt; from the &lt;greeting&gt;.
&lt;Compute&gt; the &lt;password-hash: hash&gt; from the &lt;password&gt;.

(* Avoid: Unclear what &#39;len&#39; or &#39;h&#39; represent *)
&lt;Compute&gt; the &lt;len: length&gt; from the &lt;greeting&gt;.
&lt;Compute&gt; the &lt;h: hash&gt; from the &lt;password&gt;.</code></pre>
<p><strong>Keep object structures shallow when possible:</strong></p>
<p>Deeply nested paths become hard to read and maintain. Consider
flattening data structures or extracting intermediate values:</p>
<pre class="aro"><code>(* Hard to read *)
&lt;Extract&gt; the &lt;name&gt; from the &lt;response: data.results.0.user.profile.name&gt;.

(* Clearer with intermediate steps *)
&lt;Extract&gt; the &lt;user&gt; from the &lt;response: data.results.0.user&gt;.
&lt;Extract&gt; the &lt;profile&gt; from the &lt;user: profile&gt;.
&lt;Extract&gt; the &lt;name&gt; from the &lt;profile: name&gt;.</code></pre>
<p><strong>When ambiguity exists, prefer explicit actions:</strong></p>
<p>If a field name collides with an operation name, use the appropriate
action explicitly rather than relying on context resolution:</p>
<pre class="aro"><code>(* Explicit about intent *)
&lt;Extract&gt; the &lt;len-value&gt; from the &lt;obj: length&gt;.     (* Get the field *)
&lt;Compute&gt; the &lt;obj-size: count&gt; from the &lt;obj&gt;.       (* Count the keys *)</code></pre>
<p>In summary, qualifiers serve two purposes: navigating data structures
and selecting operations.</p>
<pre class="aro"><code>&lt;Extract&gt; the &lt;city&gt; from the &lt;user: address.city&gt;.
&lt;Compute&gt; the &lt;name-upper: uppercase&gt; from the &lt;name&gt;.</code></pre>
<hr />
<p><em>Next: Chapter 9 — The Happy Path</em></p>
<h1 id="chapter-9-the-happy-path">Chapter 9: The Happy Path</h1>
<p><em>“Optimism is a strategy, not naivety.”</em></p>
<hr />
<h2 id="the-philosophy">7.1 The Philosophy</h2>
<p>ARO code expresses only the happy path—what should happen when
everything works correctly. There is no try/catch mechanism, no error
handling blocks, no defensive programming patterns. You write the
successful case, and the runtime handles everything else.</p>
<p>This is not an oversight or a limitation. It is a deliberate design
choice based on the observation that error handling code often obscures
the business logic it surrounds. When you read traditional code, you
spend significant mental effort distinguishing between the actual work
and the error handling scaffolding. The happy path philosophy eliminates
this noise by moving error handling entirely to the runtime.</p>
<p>The approach works because the structure of ARO statements provides
enough information to generate meaningful error messages automatically.
Every statement expresses what it intends to accomplish in business
terms: extracting a user identifier from path parameters, retrieving a
user from a repository, returning an OK status with data. When any of
these operations fails, the runtime constructs an error message from the
statement itself, describing what could not be done using the same
business language.</p>
<p>This means that error handling is not absent—it is automated. The
runtime catches every failure, logs it with appropriate context, and
returns or propagates an appropriate error response. You get consistent
error handling across your entire application without writing any error
handling code.</p>
<hr />
<h2 id="how-errors-work">7.2 How Errors Work</h2>
<p>When an action cannot complete successfully, ARO generates an error
message derived from the failed statement. The message describes the
operation in business terms rather than technical ones. If a statement
attempts to retrieve a user from a repository and no matching user
exists, the error message says exactly that: “Cannot retrieve the user
from the user-repository where id = 42.”</p>
<p>For HTTP handlers, the runtime translates these errors into
appropriate HTTP responses. A failed retrieval becomes a 404 response. A
failed validation becomes a 400 response. A permission denial becomes a
403 response. The runtime infers the appropriate status code from the
error context, and the response body contains a structured
representation of the error including the descriptive message.</p>
<p>The key insight is that the error message describes what the code was
trying to accomplish, not what went wrong internally. This makes error
messages immediately understandable to anyone who knows the business
domain. A message like “Cannot retrieve the user from the
user-repository where id = 42” tells you exactly what the application
was trying to do. You do not need to understand implementation details
to understand the error.</p>
<p>The runtime also logs every error with full context: which feature
set was executing, which statement failed, what values were involved,
the timestamp, and a request identifier for correlation. This logging
happens automatically for every failure, ensuring that debugging
information is always available when you need it.</p>
<hr />
<h2 id="error-message-generation">7.3 Error Message Generation</h2>
<p>ARO constructs error messages systematically from the components of
the failed statement. The message typically follows the pattern “Cannot
[action] the [result] [preposition] the [object]” with any where clause
or other qualifiers appended.</p>
<p>The action verb provides the main operation that failed. The result
name identifies what was being produced or acted upon. The preposition
clarifies the relationship between the action and its object. The object
identifies the source, destination, or context of the operation. If the
statement includes a where clause for filtering, that clause appears in
the error message to help identify which specific item could not be
found.</p>
<p>This systematic construction means that choosing good names in your
code automatically produces good error messages. If you name your result
“user-profile” and your repository “user-repository,” the error message
will say “Cannot retrieve the user-profile from the user-repository,”
which is immediately comprehensible. If you use names like “x” and
“data,” the error message becomes “Cannot retrieve the x from the data,”
which tells you nothing useful.</p>
<p>This connection between code quality and error message quality
creates a positive incentive. Writing readable code with descriptive
names not only helps human readers understand the code but also produces
better error messages that help during debugging and
troubleshooting.</p>
<h3 id="error-message-examples">Error Message Examples</h3>
<p>Here is ARO code followed by the runtime error messages it produces
when operations fail:</p>
<p><strong>Code:</strong></p>
<pre class="aro"><code>(getUser: User API) {
    &lt;Extract&gt; the &lt;id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}</code></pre>
<p><strong>When user ID 530 does not exist:</strong></p>
<pre><code>Runtime Error: Cannot retrieve the user from the user-repository where id = 530
  Feature: getUser
  Statement: &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;</code></pre>
<p><strong>When pathParameters does not contain id:</strong></p>
<pre><code>Runtime Error: Cannot extract the id from the pathParameters
  Feature: getUser
  Statement: &lt;Extract&gt; the &lt;id&gt; from the &lt;pathParameters: id&gt;
  Cause: Key &#39;id&#39; not found in pathParameters</code></pre>
<p><strong>Another example with validation:</strong></p>
<pre class="aro"><code>(createOrder: Order API) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.
    &lt;Validate&gt; the &lt;data&gt; against the &lt;order-schema&gt;.
    &lt;Store&gt; the &lt;order&gt; in the &lt;order-repository&gt;.
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;order&gt;.
}</code></pre>
<p><strong>When validation fails:</strong></p>
<pre><code>Runtime Error: Cannot validate the data against the order-schema
  Feature: createOrder
  Statement: &lt;Validate&gt; the &lt;data&gt; against the &lt;order-schema&gt;
  Cause: Validation failed</code></pre>
<p><strong>When the repository is unavailable:</strong></p>
<pre><code>Runtime Error: Cannot store the order in the order-repository
  Feature: createOrder
  Statement: &lt;Store&gt; the &lt;order&gt; in the &lt;order-repository&gt;
  Cause: Connection refused</code></pre>
<p>The pattern is consistent: the statement’s natural language structure
becomes the error message, with context about which feature failed and
what caused the failure.</p>
<hr />
<h2 id="why-this-works">7.4 Why This Works</h2>
<p>The happy path philosophy reduces code dramatically. Traditional
error handling often quadruples the size of a function. Every operation
that might fail needs a corresponding error check. Every error check
needs logging, response construction, and potentially cleanup. A simple
three-step operation can become twenty or thirty lines when fully
protected with error handling.</p>
<p>ARO’s approach eliminates all of this boilerplate. A three-step
operation remains three statements. The code expresses exactly what it
accomplishes with no noise from error handling. Readers can understand
the business logic at a glance because there is nothing else to distract
them.</p>
<p>The approach also produces consistent error responses across the
entire application. In traditional codebases, different developers write
error messages differently. One might say “User not found,” another
“user_not_found,” another “404.” Status codes vary for similar errors.
Some errors include stack traces, others do not. This inconsistency
makes APIs harder to use and debug.</p>
<p>With ARO, every error follows the same format because every error is
generated by the same mechanism. Clients can rely on consistent response
structures. Operators can rely on consistent log formats. The
application behaves predictably in all error scenarios because the
runtime, not the developer, determines how errors are expressed.</p>
<p>Automatic logging eliminates another common failure mode. In
traditional code, developers sometimes forget to log errors, especially
in rarely-executed code paths. ARO logs every failure automatically with
full context, ensuring that debugging information exists when you need
it.</p>
<hr />
<h2 id="when-happy-path-hurts">7.5 When Happy Path Hurts</h2>
<p>The happy path philosophy is not universally applicable. Several
categories of problems fit poorly with this approach.</p>
<p>Custom error messages are difficult when validation rules require
specific feedback. If a password must contain at least eight characters,
a number, and a special character, and the user’s password fails all
three requirements, the generic “Cannot validate the password against
the password-rules” message does not tell the user how to fix the
problem. Custom actions can provide more detailed error messages, but
this pushes complexity out of ARO and into Swift.</p>
<p>Conditional error handling becomes awkward when different failures
require different responses. If duplicate email and invalid email format
both fail validation but require different instructions to the user, ARO
cannot distinguish between them at the language level. The runtime
treats all validation failures identically.</p>
<p>Retry logic has no direct expression in ARO because there are no
loops. If an external service is temporarily unavailable and the
operation should be retried with exponential backoff, that logic must be
implemented in a custom action. The ARO statement sees only success or
failure; it cannot express “try again.”</p>
<p>Partial failures present a fundamental mismatch with the happy path
model. If you need to send an email, update analytics, and sync with a
CRM, and you want to continue even if some of these fail, ARO’s approach
of stopping on first failure does not work. All-or-nothing semantics are
built into the model.</p>
<p>Graceful degradation, where an application continues with reduced
functionality when some components fail, similarly does not fit. ARO
assumes that every statement is required for successful completion.
There is no way to mark some statements as optional or to provide
fallback behavior when they fail.</p>
<hr />
<h2 id="strategies-for-complex-error-handling">7.6 Strategies for
Complex Error Handling</h2>
<p>When you need error handling that goes beyond the automatic behavior,
several strategies can help.</p>
<p>Custom actions are the primary escape hatch. By implementing an
action in Swift, you gain full access to traditional error handling
patterns. You can provide detailed validation error messages, implement
retry logic, handle multiple error conditions differently, and perform
any other error-related processing. The ARO statement that invokes your
action sees only the final result—success with a value, or failure with
an error that propagates according to normal rules.</p>
<p>Event-based error handling allows recovery code to execute in a
separate feature set. When certain errors occur, the runtime can emit
events that trigger handlers. These handlers can log additional context,
notify administrators, attempt compensating actions, or perform other
recovery activities. The original feature set still fails, but the
handlers provide an opportunity for side effects related to that
failure.</p>
<p>The when clause provides conditional execution that can skip
non-critical operations. A statement with a when clause that evaluates
to false is simply not executed rather than causing an error. This is
useful for optional notifications, analytics updates, or other
operations that should not block the main flow if preconditions are not
met.</p>
<p>Separating concerns into multiple feature sets can isolate failures.
If you have operations that should succeed or fail independently,
triggering them via events rather than executing them inline means each
can complete or fail without affecting the others. Event handlers
execute in their own isolated contexts.</p>
<hr />
<h2 id="the-happy-path-contract">7.7 The Happy Path Contract</h2>
<p>When you write ARO code, you implicitly accept a contract about how
error handling works. You express what should happen when inputs are
valid and systems are working. The runtime handles what happens when
things fail. Custom actions provide escape hatches for scenarios that
require more sophisticated error handling.</p>
<p>This contract works well for CRUD operations, data pipelines, event
handling, and straightforward API endpoints—scenarios where the success
path is clear and the failure mode is essentially “it didn’t work.” The
automatic error messages are usually sufficient because there is
typically only one kind of failure: the operation could not be
completed.</p>
<p>The contract works less well for distributed transactions where you
need coordination across multiple systems, retry-heavy workflows where
transient failures should be retried automatically, complex validation
with many specific error cases that each require different user
guidance, and real-time systems that must degrade gracefully rather than
failing entirely.</p>
<p>Knowing when to use ARO and when to use custom actions or other
approaches is part of becoming proficient with the language. The happy
path philosophy is a powerful default that eliminates enormous amounts
of boilerplate for common scenarios. Recognizing the scenarios where it
does not fit is equally important.</p>
<hr />
<h2 id="best-practices-2">7.8 Best Practices</h2>
<p>Trust the runtime’s error handling. Do not add defensive checks for
conditions that the runtime already handles. If the runtime will produce
an appropriate error when a required value is missing, there is no need
to add a validation statement that checks for its presence. The
redundant check adds code without adding value.</p>
<p>Use descriptive names because they become part of error messages. The
quality of your variable and repository names directly affects the
quality of automatically generated error messages. Names like
“user-profile,” “order-repository,” and “email-address” produce clear,
understandable error messages. Names like “x,” “data,” and “repo”
produce error messages that tell you nothing useful.</p>
<p>Keep feature sets focused so that errors have clear context. When a
feature set performs a single coherent operation, an error in that
feature set has obvious meaning. When a feature set performs many
unrelated operations, errors become harder to interpret because the
context is muddied.</p>
<p>Design your domain model so that validation can be expressed through
structure rather than explicit checks. If invalid data cannot be created
in the first place because the types enforce validity, you eliminate
entire categories of validation errors from your code.</p>
<hr />
<p><em>Next: Chapter 10 — The Event Bus</em></p>
<h1 id="chapter-10-the-event-bus">Chapter 10: The Event Bus</h1>
<p><em>“In an event-driven system, everything is a reaction.”</em></p>
<hr />
<h2 id="events-not-calls">9.1 Events, Not Calls</h2>
<p>ARO is fundamentally event-driven. Feature sets do not call each
other directly—they react to events. This is a crucial architectural
distinction that shapes how you design and reason about ARO
applications.</p>
<p>In traditional programming, you invoke functions by name. The caller
knows about the callee and depends on it directly. If the callee changes
its signature or behavior, the caller must be updated. This coupling
creates a web of dependencies that grows denser as applications
expand.</p>
<p>ARO takes a different approach. When a feature set needs something to
happen afterward, it emits an event describing what occurred. Other
feature sets can register as handlers for that event type. The emitting
feature set does not know which handlers exist or what they will do. It
simply publishes information about what happened and moves on.</p>
<p>This decoupling has profound implications. You can add new behaviors
by adding handlers without modifying existing code. You can remove
behaviors by removing handlers without affecting the emitting code.
Multiple independent subsystems can react to the same event without
coordination. The architecture remains loose and extensible.</p>
<p>The event bus is the runtime component that makes this work. It
receives events from Emit actions, matches them to handlers based on
naming patterns, and dispatches them for execution. The bus is invisible
to your code—you simply emit events and register handlers, and the
runtime handles the routing.</p>
<hr />
<h2 id="how-the-event-bus-works">9.2 How the Event Bus Works</h2>
<div style="float: left; margin: 0 1.5em 1em 0;">
<svg width="200" height="220" viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg">
<!-- Emitter -->
<rect x="60" y="10" width="80" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
<text x="100" y="25" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#1e40af">Feature
Set</text>
<text x="100" y="38" text-anchor="middle" font-family="monospace" font-size="8" fill="#3b82f6">&lt;Emit&gt;</text>
<!-- Arrow down to bus -->
<line x1="100" y1="45" x2="100" y2="70" stroke="#6b7280" stroke-width="2"/>
<polygon points="100,70 95,62 105,62" fill="#6b7280"/>
<!-- Event Bus -->
<rect x="30" y="75" width="140" height="30" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="100" y="95" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#92400e">EVENT
BUS</text> <!-- Fan-out arrows -->
<line x1="55" y1="105" x2="35" y2="140" stroke="#22c55e" stroke-width="2"/>
<polygon points="35,140 43,135 39,143" fill="#22c55e"/>
<line x1="100" y1="105" x2="100" y2="140" stroke="#22c55e" stroke-width="2"/>
<polygon points="100,140 95,132 105,132" fill="#22c55e"/>
<line x1="145" y1="105" x2="165" y2="140" stroke="#22c55e" stroke-width="2"/>
<polygon points="165,140 157,135 161,143" fill="#22c55e"/>
<!-- Handler 1 -->
<rect x="5" y="145" width="60" height="35" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="35" y="160" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#166534">Handler
A</text>
<text x="35" y="172" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#22c55e">email</text>
<!-- Handler 2 -->
<rect x="70" y="145" width="60" height="35" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="100" y="160" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#166534">Handler
B</text>
<text x="100" y="172" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#22c55e">analytics</text>
<!-- Handler 3 -->
<rect x="135" y="145" width="60" height="35" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="165" y="160" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#166534">Handler
C</text>
<text x="165" y="172" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#22c55e">audit</text>
<!-- Isolated label -->
<text x="100" y="200" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#6b7280">handlers
run in isolation</text>
<text x="100" y="212" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#6b7280">order
not guaranteed</text>
</svg>
</div>
<p>The event bus maintains a registry of handlers organized by event
type. When the application starts, the runtime scans all feature sets,
identifies those whose business activity matches the handler pattern,
and registers them with the bus. This registration happens automatically
based on naming conventions.</p>
<p>When a feature set executes an Emit action, the runtime creates an
event object containing the event name and payload data. This object is
delivered to the event bus, which looks up all handlers registered for
that event type. Each matching handler receives the event and executes
independently.</p>
<p>The bus provides delivery guarantees within a single application
instance. When you emit an event, all registered handlers will
eventually execute. However, the order of execution is not
guaranteed—handlers may run in any sequence. If you need guaranteed
ordering, you must express it through event chaining where each handler
emits an event that triggers the next step.</p>
<p>Handler execution is isolated. Each handler runs in its own context
with its own symbol table. A failure in one handler does not affect
other handlers for the same event. The emitting feature set is also
isolated—it completes regardless of whether handlers succeed or fail.
This fire-and-forget semantics makes event emission a non-blocking
operation that does not wait for handlers to complete.</p>
<hr />
<h2 id="event-matching">9.3 Event Matching</h2>
<p>Handlers are matched to events based on their business activity. The
standard pattern is that the business activity ends with “Handler”
preceded by the event name. When a feature set declares its business
activity as “UserCreated Handler,” it becomes a handler for events named
“UserCreated.”</p>
<p>This naming-based matching is simple and transparent. By reading the
feature set declaration, you know exactly which events it handles. By
searching the codebase for “UserCreated Handler,” you find all handlers
for that event type. No configuration files or external registrations
are needed—the code itself declares its event relationships.</p>
<p>The runtime supports several built-in event types generated by
services rather than user code. File system services emit File Event
when files change. Socket services emit Socket Event when messages
arrive. Timer services emit Timer Event on schedule. HTTP services
generate events that trigger feature sets matching OpenAPI operation
identifiers. These built-in events follow the same matching rules as
custom events.</p>
<p>You can have multiple handlers for the same event. When UserCreated
is emitted, every feature set with “UserCreated Handler” in its business
activity will execute. This allows you to add behaviors incrementally.
One handler might send a welcome email. Another might update analytics.
A third might create an audit record. Each handler does one thing well,
and together they compose the complete response to the event.</p>
<hr />
<h2 id="emitting-events">9.4 Emitting Events</h2>
<p>The Emit action publishes an event to the bus. The action takes an
event type and a payload. The event type appears in the result position
with an “event” qualifier. The payload follows the “with” preposition
and can be any value—a simple variable, an object literal, or a complex
expression.</p>
<p>The event type becomes the name used for handler matching. If you
emit an event with type “OrderPlaced,” handlers with business activity
“OrderPlaced Handler” will receive it. Choose event names that describe
what happened in business terms rather than technical terms.
“CustomerRegistered” is better than “RecordInserted.” “PaymentDeclined”
is better than “ErrorOccurred.”</p>
<p>The payload is the data that handlers will receive. Handlers access
this data using the Extract action with the “event” identifier. Include
everything that handlers might need to do their work, but avoid
including sensitive information that not all handlers should access. The
payload is delivered unchanged to every handler, so all handlers see the
same data.</p>
<p>A single feature set can emit multiple events. This is common when
different subsystems need to react to different aspects of an operation.
Creating an order might emit OrderCreated for order processing,
PaymentRequired for the payment system, and InventoryUpdate for
warehouse management. Each subsystem handles the event relevant to its
domain.</p>
<hr />
<h2 id="accessing-event-data">9.5 Accessing Event Data</h2>
<p>Within a handler, the event is available through the special “event”
identifier. You use the Extract action to pull specific data out of the
event payload into local bindings.</p>
<p>The event object contains the payload that was provided when the
event was emitted. If the emitter provided a user object as the payload,
you can extract that user with appropriate qualifiers. If the emitter
provided an object literal with multiple fields, you can extract each
field individually.</p>
<p>Beyond the payload, events carry metadata about their origin. The
event identifier provides a unique value for correlating logs and
traces. The timestamp records when the event was emitted. The source
identifies which feature set emitted the event. This metadata is useful
for debugging and auditing.</p>
<p>The extraction patterns for events follow the same qualifier syntax
used elsewhere in ARO. You chain qualifiers with colons to navigate into
nested structures. If the payload contains an order with a customer with
an email, you can extract that email directly using multiple
qualifiers.</p>
<hr />
<h2 id="multiple-handlers-and-execution">9.6 Multiple Handlers and
Execution</h2>
<p>When multiple handlers register for the same event type, all of them
execute when that event is emitted. This parallel reaction is one of the
most powerful aspects of event-driven architecture because it allows
independent modules to respond to the same stimulus without coordinating
with each other.</p>
<p>Each handler runs independently. They do not share state. A failure
in one handler does not prevent other handlers from running. If one
handler encounters an error, that error is logged, but the other
handlers continue normally. This isolation makes handlers resilient—a
bug in one handler does not bring down the entire system.</p>
<p>The order of handler execution is not specified. The runtime may
execute handlers in any order, and that order may vary between
executions. If your handlers must execute in a specific sequence, you
need to express that through event chaining rather than relying on
implicit ordering.</p>
<p>Handlers may execute concurrently if the runtime determines that they
are independent. This parallelism can improve performance, but it also
means handlers must not assume exclusive access to shared resources.
Design handlers to be safe for concurrent execution, avoiding race
conditions in shared state.</p>
<hr />
<h2 id="event-chains-1">9.7 Event Chains</h2>
<p>Events can trigger handlers that emit additional events, creating
chains of processing. This pattern allows you to break complex workflows
into discrete steps that execute in sequence.</p>
<p>The chain is established through the event naming. When the first
event triggers a handler that emits a second event, handlers for that
second event run next. Each step in the chain is a separate feature set
with its own isolation and error handling.</p>
<p>Event chains are useful for orchestrating multi-step processes. An
order processing workflow might start with OrderCreated, which triggers
inventory checking. If inventory is available, InventoryReserved
triggers payment processing. If payment succeeds, PaymentProcessed
triggers fulfillment. Each step emits the event that triggers the next
step.</p>
<p>The advantage of chains over monolithic handlers is modularity. Each
step can be developed, tested, and modified independently. You can add
steps by adding handlers. You can modify a step’s implementation without
affecting other steps. The overall workflow emerges from the composition
of independent parts.</p>
<p>Be cautious of circular chains where A triggers B triggers A. This
creates an infinite loop that will exhaust resources. Design your event
flows to be acyclic, with clear beginning and end points.</p>
<blockquote>
<p><strong>Compiler Check</strong>: The ARO compiler detects circular
event chains at compile time. If your handlers form a cycle (for
example, <code>Alpha Handler</code> emits <code>Beta</code> and
<code>Beta Handler</code> emits <code>Alpha</code>), you will receive an
error:</p>
<pre><code>error: Circular event chain detected: Alpha -&gt; Beta -&gt; Alpha
  hint: Event handlers form an infinite loop that will exhaust resources
  hint: Consider breaking the chain by using different event types or adding termination conditions</code></pre>
<p>This static analysis catches cycles before your code runs, preventing
runtime infinite loops.</p>
</blockquote>
<hr />
<h2 id="error-handling-in-events">9.8 Error Handling in Events</h2>
<p>Error handling for events differs from synchronous execution. When a
handler fails, the error is logged with full context, but the failure
does not propagate to the emitter or to other handlers. Each handler
succeeds or fails independently.</p>
<p>This design reflects the fire-and-forget nature of event emission.
The emitting feature set has already moved on by the time handlers
execute. It cannot meaningfully handle handler failures because it has
already returned its result. The isolation is intentional—it prevents
cascading failures and keeps the emitter’s behavior predictable.</p>
<p>For scenarios where handler success is critical, you need different
patterns. You might use synchronous validation before emitting the
event, checking conditions that would cause handler failure. You might
use compensating events where failure handlers emit events that trigger
recovery. You might move critical operations into the emitting feature
set itself rather than relying on handlers.</p>
<p>The runtime logs all handler failures. You can configure alerts based
on these logs to notify operators when handlers are failing. The logs
include the event type, handler name, error message, and full context,
providing the information needed to diagnose and fix issues.</p>
<hr />
<h2 id="best-practices-3">9.9 Best Practices</h2>
<p>Name events for business meaning rather than technical operations.
The event name should describe what happened in domain terms that
non-technical stakeholders would understand. “CustomerRegistered” tells
you about a business occurrence. “DatabaseRowInserted” tells you about
an implementation detail.</p>
<p>Keep handlers focused on single responsibilities. A handler that
sends email and updates analytics and notifies administrators is doing
too much. Split these into three handlers that each do one thing well.
The event bus will invoke all of them, and each will be easier to
understand, test, and maintain.</p>
<p>Design handlers for idempotency when possible. Events might be
delivered more than once in some scenarios—retries after transient
failures, replays for recovery, or duplicate emissions due to bugs. If
handlers can safely process the same event multiple times without
causing incorrect behavior, your system is more resilient.</p>
<p>Avoid circular event chains. If event A triggers handler B which
emits event A, you have an infinite loop. The compiler will catch these
cycles and report them as errors during <code>aro check</code>. Map out
your event flows to ensure they are directed acyclic graphs. Each event
should lead forward through the workflow, not backward to create
cycles.</p>
<p>Document event contracts. The payload of an event is a contract
between emitters and handlers. Document what fields are included, their
types, and their meanings. When you change an event’s structure, update
all handlers to accommodate the change.</p>
<hr />
<h2 id="repository-observers-1">9.10 Repository Observers</h2>
<p>Repository observers are a specialized form of event handlers that
react to changes in repository data. When items are stored, updated, or
deleted from a repository, observers automatically receive the change
details including both old and new values.</p>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="180" height="200" viewBox="0 0 180 200" xmlns="http://www.w3.org/2000/svg">
<!-- Repository -->
<p><rect x="50" y="10" width="80" height="35" rx="4" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
<text x="90" y="25" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#4338ca">user-repository</text>
<text x="90" y="38" text-anchor="middle" font-family="monospace" font-size="7" fill="#6366f1">&lt;Store&gt;
| &lt;Delete&gt;</text></p>
<!-- Arrow to event -->
<p><line x1="90" y1="45" x2="90" y2="70" stroke="#6b7280" stroke-width="2"/>
<polygon points="90,70 85,62 95,62" fill="#6b7280"/></p>
<!-- Event -->
<p><rect x="35" y="75" width="110" height="25" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="90" y="91" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#92400e">RepositoryChangedEvent</text></p>
<!-- Fan-out to observers -->
<p><line x1="60" y1="100" x2="40" y2="130" stroke="#a855f7" stroke-width="2"/>
<polygon points="40,130 48,125 44,133" fill="#a855f7"/>
<line x1="120" y1="100" x2="140" y2="130" stroke="#a855f7" stroke-width="2"/>
<polygon points="140,130 132,125 136,133" fill="#a855f7"/></p>
<!-- Observer 1 -->
<p><rect x="5" y="135" width="70" height="35" rx="4" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/>
<text x="40" y="150" text-anchor="middle" font-family="sans-serif" font-size="7" font-weight="bold" fill="#7c3aed">Audit
Observer</text>
<text x="40" y="162" text-anchor="middle" font-family="sans-serif" font-size="6" fill="#a855f7">old
+ new values</text></p>
<!-- Observer 2 -->
<p><rect x="105" y="135" width="70" height="35" rx="4" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/>
<text x="140" y="150" text-anchor="middle" font-family="sans-serif" font-size="7" font-weight="bold" fill="#7c3aed">Sync
Observer</text>
<text x="140" y="162" text-anchor="middle" font-family="sans-serif" font-size="6" fill="#a855f7">changeType</text></p>
<text x="90" y="190" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#6b7280">automatic
reactive patterns</text>
</svg>
</div>
<p>The observer pattern for repositories enables powerful reactive
architectures. You can implement audit logging that captures every
change with full before-and-after context. You can synchronize data
across systems when items change. You can enforce business rules that
react to modifications.</p>
<p>To create a repository observer, name your feature set’s business
activity with the pattern “{repository-name} Observer.” When any feature
set stores to or deletes from that repository, your observer executes
with full change context.</p>
<p>The observer receives an event payload with the repository name,
change type (created, updated, or deleted), entity ID if available, and
both old and new values. For creates, the old value is nil. For deletes,
the new value is nil. For updates, both are present, allowing you to
compare what changed.</p>
<p>This built-in observer mechanism works with the repository semantics.
Updates are detected by matching on the entity’s id field. When you
store an item with an id that already exists, the store becomes an
update, and observers see both the previous and new versions of that
item.</p>
<p>Repository observers follow the same isolation rules as other event
handlers. Each observer runs independently with its own context.
Failures in one observer do not affect others. The original store or
delete operation completes regardless of observer success or
failure.</p>
<p>The design enables domain-driven patterns where each bounded context
can observe relevant repositories without coupling to the code that
modifies them. Audit systems observe without being called.
Synchronization happens automatically. The architecture remains loose
and extensible.</p>
<hr />
<h2 id="state-observers">9.11 State Observers</h2>
<p>State observers are a specialized form of event handler that react to
state transitions. When the Accept action successfully transitions a
state field, it emits a StateTransitionEvent that observers can
handle.</p>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
<!-- Accept Action -->
<rect x="60" y="10" width="80" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
<text x="100" y="25" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#1e40af">&lt;Accept&gt;</text>
<text x="100" y="38" text-anchor="middle" font-family="monospace" font-size="7" fill="#3b82f6">draft
→ placed</text> <!-- Arrow to event -->
<line x1="100" y1="45" x2="100" y2="65" stroke="#f59e0b" stroke-width="2"/>
<polygon points="100,70 95,62 105,62" fill="#f59e0b"/>
<!-- StateTransitionEvent -->
<rect x="35" y="70" width="130" height="25" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="100" y="87" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#92400e">StateTransitionEvent</text>
<!-- Fan-out arrows -->
<line x1="55" y1="95" x2="35" y2="120" stroke="#22c55e" stroke-width="2"/>
<polygon points="35,125 43,118 39,126" fill="#22c55e"/>
<line x1="100" y1="95" x2="100" y2="120" stroke="#22c55e" stroke-width="2"/>
<polygon points="100,125 95,117 105,117" fill="#22c55e"/>
<line x1="145" y1="95" x2="165" y2="120" stroke="#22c55e" stroke-width="2"/>
<polygon points="165,125 157,118 161,126" fill="#22c55e"/>
<!-- Observers -->
<rect x="5" y="130" width="60" height="35" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="35" y="145" text-anchor="middle" font-family="sans-serif" font-size="7" font-weight="bold" fill="#166534">Audit</text>
<text x="35" y="157" text-anchor="middle" font-family="sans-serif" font-size="6" fill="#22c55e">all
transitions</text>
<rect x="70" y="130" width="60" height="35" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="100" y="145" text-anchor="middle" font-family="sans-serif" font-size="7" font-weight="bold" fill="#166534">Notify</text>
<text x="100" y="157" text-anchor="middle" font-family="sans-serif" font-size="6" fill="#22c55e">&lt;draft_to_placed&gt;</text>
<rect x="135" y="130" width="60" height="35" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="165" y="145" text-anchor="middle" font-family="sans-serif" font-size="7" font-weight="bold" fill="#166534">Track</text>
<text x="165" y="157" text-anchor="middle" font-family="sans-serif" font-size="6" fill="#22c55e">&lt;shipped_to_delivered&gt;</text>
<!-- Label -->
<text x="100" y="185" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#6b7280">matching
observers run after transition</text>
</svg>
</div>
<p>State observers bridge the gap between state machines and
event-driven architecture. The Accept action manages the
“what”—validating and applying state transitions. Observers manage the
“then what”—reacting to those transitions with side effects like audit
logging, notifications, or analytics.</p>
<p>The observer pattern is declared through business activity naming. A
feature set with business activity “status StateObserver” observes all
transitions on fields named “status.” Adding a transition filter like
“status StateObserver<draft_to_placed>” restricts the observer to only
that specific transition. A feature set with just “StateObserver”
observes all state transitions regardless of field name.</p>
<pre class="aro"><code>(* Observe ALL status transitions *)
(Audit Order Status: status StateObserver) {
    &lt;Extract&gt; the &lt;orderId&gt; from the &lt;transition: entityId&gt;.
    &lt;Extract&gt; the &lt;fromState&gt; from the &lt;transition: fromState&gt;.
    &lt;Extract&gt; the &lt;toState&gt; from the &lt;transition: toState&gt;.

    &lt;Log&gt; the &lt;audit: message&gt; for the &lt;console&gt;
        with &quot;[AUDIT] Order ${orderId}: ${fromState} -&gt; ${toState}&quot;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;audit&gt;.
}

(* Observe ONLY when order is placed *)
(Notify Order Placed: status StateObserver&lt;draft_to_placed&gt;) {
    &lt;Extract&gt; the &lt;orderId&gt; from the &lt;transition: entityId&gt;.
    &lt;Log&gt; the &lt;notification&gt; for the &lt;console&gt;
        with &quot;Order ${orderId} has been placed!&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;notification&gt;.
}

(* Observe ONLY when order ships *)
(Send Shipping Notification: status StateObserver&lt;paid_to_shipped&gt;) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;transition: entity&gt;.
    &lt;Extract&gt; the &lt;tracking&gt; from the &lt;order: trackingNumber&gt;.

    &lt;Log&gt; the &lt;notification&gt; for the &lt;console&gt;
        with &quot;Order shipped! Tracking: ${tracking}&quot;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;notification&gt;.
}</code></pre>
<p>Within an observer, the transition data is available through the
“transition” identifier. You extract specific fields using the familiar
qualifier syntax. The fromState and toState fields tell you what
changed. The fieldName and objectName provide context about where the
change occurred. The entityId offers a convenient way to identify the
affected entity. The entity field gives you the complete object after
the transition if you need additional context.</p>
<p>Observers execute after the Accept action succeeds. If Accept throws
because the current state does not match the expected state, no event is
emitted and no observers run. This ensures observers only react to valid
transitions. Observers themselves run in isolation—if one observer
fails, other observers for the same transition still execute. The
failure is logged but does not affect the original Accept action or
other observers.</p>
<p>The separation between Accept and observers creates a clean
architecture. Accept is synchronous and transactional—it validates and
applies the state change atomically. Observers are asynchronous and
independent—they react to the change with side effects that do not
affect the core state transition. This separation makes the system more
testable, more maintainable, and more extensible.</p>
<hr />
<p><em>Next: Chapter 11 — Application Lifecycle</em></p>
<h1 id="chapter-11-application-lifecycle">Chapter 11: Application
Lifecycle</h1>
<p><em>“Every program has a beginning, a middle, and an end.”</em></p>
<hr />
<h2 id="the-three-phases">9.1 The Three Phases</h2>
<div style="text-align: center; margin: 2em 0;">
<svg width="480" height="120" viewBox="0 0 480 120" xmlns="http://www.w3.org/2000/svg">
<!-- Startup Phase -->
<rect x="20" y="35" width="120" height="50" rx="6" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
<text x="80" y="55" text-anchor="middle" font-family="sans-serif" font-size="12" font-weight="bold" fill="#1e40af">STARTUP</text>
<text x="80" y="72" text-anchor="middle" font-family="monospace" font-size="9" fill="#3b82f6">Application-Start</text>
<!-- Arrow 1 -->
<line x1="140" y1="60" x2="175" y2="60" stroke="#6b7280" stroke-width="2"/>
<polygon points="175,60 165,55 165,65" fill="#6b7280"/>
<!-- Execution Phase -->
<rect x="180" y="35" width="120" height="50" rx="6" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="240" y="55" text-anchor="middle" font-family="sans-serif" font-size="12" font-weight="bold" fill="#166534">EXECUTION</text>
<text x="240" y="72" text-anchor="middle" font-family="monospace" font-size="9" fill="#22c55e">Keepalive
+ Events</text> <!-- Arrow 2 -->
<line x1="300" y1="60" x2="335" y2="60" stroke="#6b7280" stroke-width="2"/>
<polygon points="335,60 325,55 325,65" fill="#6b7280"/>
<!-- Shutdown Phase -->
<rect x="340" y="35" width="120" height="50" rx="6" fill="#fee2e2" stroke="#ef4444" stroke-width="2"/>
<text x="400" y="55" text-anchor="middle" font-family="sans-serif" font-size="12" font-weight="bold" fill="#991b1b">SHUTDOWN</text>
<text x="400" y="72" text-anchor="middle" font-family="monospace" font-size="9" fill="#ef4444">Application-End</text>
<!-- Phase labels -->
<text x="80" y="105" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">Initialize</text>
<text x="240" y="105" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">Process
Events</text>
<text x="400" y="105" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">Cleanup</text>
<!-- Top labels -->
<text x="80" y="22" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#9ca3af">required</text>
<text x="240" y="22" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#9ca3af">servers
only</text>
<text x="400" y="22" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#9ca3af">optional</text>
</svg>
</div>
<p>ARO applications have three distinct lifecycle phases: startup,
execution, and shutdown. Each phase has specific responsibilities and
corresponding feature sets that can handle them.</p>
<p>The startup phase initializes resources, establishes connections, and
prepares the application to do work. This is when configuration is
loaded, services are started, and the application transitions from inert
code to a running system. Startup must complete successfully for the
application to proceed.</p>
<p>The execution phase is where the application does its actual work.
For batch applications, this might be a single sequence of operations.
For servers and daemons, this is an ongoing process of handling events,
requests, and other stimuli. The execution phase can last indefinitely
for long-running applications.</p>
<p>The shutdown phase cleans up resources, closes connections, and
prepares the application to terminate. This is when pending work is
completed, buffers are flushed, and the application transitions from a
running system back to inert code. Proper shutdown prevents resource
leaks and data loss.</p>
<p>Each phase has a corresponding feature set that you can define to
handle its responsibilities. The startup phase uses
<code>Application-Start</code>, which is required. The shutdown phase
uses <code>Application-End: Success</code> for normal shutdown and
<code>Application-End: Error</code> for error shutdown, both of which
are optional.</p>
<hr />
<h2 id="application-start">9.2 Application-Start</h2>
<p>Every ARO application must have exactly one feature set named
<code>Application-Start</code>. This is where execution begins. The
runtime looks for this feature set when the application launches and
executes it to initialize the application. Without an Application-Start
feature set, there is nothing to execute, and the application cannot
run.</p>
<p>Having multiple Application-Start feature sets is also an error. If
you spread your application across multiple files and accidentally
define Application-Start in more than one of them, the runtime reports
the conflict and refuses to start. This constraint ensures that there is
always exactly one unambiguous entry point.</p>
<p>The business activity (the text after the colon) can be anything
descriptive of your application. Common choices include the application
name, a description of its purpose, or simply “Application” or “Entry
Point.” This text has no semantic significance for Application-Start—it
is purely documentation.</p>
<p>The startup feature set typically performs several initialization
tasks. Loading configuration from files or environment variables is
common. Starting services like HTTP servers, database connections, or
file watchers is typical for server applications. Publishing values that
other feature sets in the same business activity will need is another
common task. Each of these tasks is expressed as statements in the
feature set.</p>
<p>The startup feature set must return a status to indicate whether
initialization succeeded. If any statement fails during startup, the
runtime logs the error, invokes the error shutdown handler if one
exists, and terminates the application with a non-zero exit code. A
successful startup means the application is ready to do work.</p>
<hr />
<h2 id="the-keepalive-action">9.3 The Keepalive Action</h2>
<p>For applications that need to continue running after startup to
process ongoing events, the Keepalive action is essential. Without it,
the runtime executes the startup feature set, reaches the return
statement, and terminates the application. This is fine for batch
applications that do their work during startup, but servers and daemons
need to stay running.</p>
<p>The Keepalive action blocks execution at the point where it appears.
It allows the event loop to continue processing events—HTTP requests,
file system changes, socket messages, timer events, and custom
events—while the startup feature set waits. The application remains
active, handling events as they arrive.</p>
<p>When the application receives a shutdown signal, either from the user
pressing Ctrl+C (SIGINT) or from the operating system sending SIGTERM,
the Keepalive action returns. Execution resumes from where it left off,
and any statements after the Keepalive execute. Then the return
statement completes the startup feature set, which triggers the shutdown
phase.</p>
<p>Applications that do not use Keepalive execute their startup
statements and immediately terminate. This is appropriate for
command-line tools that perform a specific task and exit, data
processing scripts that run to completion, or any application where
continued execution is not needed. The absence of Keepalive does not
indicate an error—it simply indicates that the application has no
ongoing work to do.</p>
<hr />
<h2 id="application-end-success">9.4 Application-End: Success</h2>
<p>The success shutdown handler runs when the application terminates
normally. This means the user sent a shutdown signal, the application
called for shutdown programmatically, or any other clean termination
occurred. It is an opportunity to perform cleanup that should happen on
every normal exit.</p>
<p>The handler is optional. If you do not define one, the application
terminates without any cleanup phase. For simple applications that do
not hold external resources, this is fine. For applications with
database connections, open files, or other resources that should be
closed properly, defining a success handler is important.</p>
<p>Typical cleanup tasks include stopping services so they stop
accepting new work, draining any pending operations so they complete
rather than being lost, closing database connections so they are
returned to connection pools, flushing log buffers so no messages are
lost, and performing any other resource release that should happen on
shutdown.</p>
<p>The handler should be designed to complete reasonably quickly.
Shutdown has a default timeout, and if the handler takes too long, the
process is terminated forcibly. If you have long-running cleanup tasks,
consider whether they can be shortened or made asynchronous.</p>
<p>The shutdown handler receives no special input—unlike error shutdown,
there is no error context because nothing went wrong. It simply performs
its cleanup and returns a status indicating that shutdown completed
successfully.</p>
<hr />
<h2 id="application-end-error">9.5 Application-End: Error</h2>
<p>The error shutdown handler runs when the application terminates due
to an unhandled error. This means an exception occurred that was not
caught by any handler, a fatal condition was detected, or some other
error situation triggered abnormal termination.</p>
<p>Unlike success shutdown, error shutdown provides access to the error
that caused the termination. You can extract this error from the
shutdown context and use it for logging, alerting, or diagnostic
purposes. The error contains information about what went wrong, where it
happened, and any associated context.</p>
<p>The handler is optional, but defining one is strongly recommended for
production applications. Without it, errors cause silent termination
with no opportunity for cleanup or notification. With it, you can ensure
that administrators are alerted, logs contain sufficient information for
diagnosis, and resources are released even in error scenarios.</p>
<p>Cleanup during error shutdown should be defensive. Some resources
might be in inconsistent states due to the error. Cleanup code should be
prepared for failures and should continue even if some cleanup steps
fail. The goal is best-effort cleanup, not guaranteed perfect
cleanup.</p>
<p>The distinction between success and error shutdown allows you to
handle these cases differently. Success shutdown might wait for pending
work to complete. Error shutdown might skip that wait and proceed
directly to resource release. Success shutdown might log a friendly
goodbye message. Error shutdown might log a detailed error report.</p>
<hr />
<h2 id="shutdown-signals">9.6 Shutdown Signals</h2>
<p>The operating system communicates with processes through signals. ARO
handles the common shutdown signals appropriately.</p>
<p>SIGINT is sent when the user presses Ctrl+C in the terminal. ARO
treats this as a request for graceful shutdown. The Keepalive action
returns, and the success shutdown handler executes. This allows the user
to stop a running application cleanly.</p>
<p>SIGTERM is the standard signal for requesting process termination.
Process managers, container orchestrators, and system shutdown sequences
typically send SIGTERM before escalating to forced termination. ARO
handles SIGTERM the same as SIGINT—graceful shutdown with the success
handler.</p>
<p>SIGKILL cannot be caught or handled. When a process receives SIGKILL,
the operating system terminates it immediately. There is no opportunity
for cleanup. This is the last resort for stopping a process that does
not respond to SIGTERM. Applications should not rely on SIGKILL for
normal operation—if your application requires SIGKILL to stop, something
is wrong with its shutdown handling.</p>
<p>The shutdown process has a timeout. If the shutdown handlers do not
complete within a reasonable time (typically 30 seconds), the process is
terminated forcibly. This prevents hung shutdown handlers from keeping
the process alive indefinitely. Design your handlers to complete quickly
enough to finish before the timeout.</p>
<hr />
<h2 id="startup-errors">9.7 Startup Errors</h2>
<p>If the Application-Start feature set fails, the application cannot
proceed. The runtime logs the error with full context, invokes the error
shutdown handler if one exists, and terminates the process with a
non-zero exit code.</p>
<p>Common startup failures include configuration files that do not exist
or contain invalid data, services that cannot be reached such as
databases or external APIs, permissions that prevent the application
from accessing needed resources, and port conflicts where a server
cannot bind to its configured port.</p>
<p>The error messages for startup failures follow the same pattern as
other ARO errors. They describe what the statement was trying to
accomplish in business terms. “Cannot read the config from the file with
config.json” tells you exactly what failed. The error includes
additional context about why it failed—file not found, permission
denied, or similar.</p>
<p>Designing for startup resilience involves validating assumptions
early. If your application requires a configuration file, failing fast
during startup is better than failing later when the configuration is
first used. The startup feature set is the appropriate place to verify
that all prerequisites are met.</p>
<hr />
<h2 id="best-practices-4">9.8 Best Practices</h2>
<p>Always use Keepalive for server applications. If your application
starts an HTTP server, file watcher, socket listener, or any other
service that should run continuously, the Keepalive action is necessary
to prevent immediate termination after startup.</p>
<p>Define both shutdown handlers for production applications. The
success handler ensures clean shutdown during normal operation. The
error handler ensures that error conditions are logged and resources are
released even when things go wrong.</p>
<p>Log lifecycle events for operational visibility. Logging at startup
provides confirmation that the application started successfully and with
what configuration. Logging at shutdown helps diagnose whether shutdown
completed cleanly. These logs are invaluable for debugging operational
issues.</p>
<p>Clean up resources in reverse order of acquisition. If you start the
database, then the cache, then the HTTP server during startup, stop the
HTTP server, then the cache, then the database during shutdown. This
order ensures that dependent resources are still available when cleanup
needs them.</p>
<p>Keep shutdown handlers fast. Long shutdown times frustrate operators
and can cause problems with process managers that expect quick
termination. If you have work that takes a long time to complete,
consider whether it can be deferred or done asynchronously rather than
during shutdown.</p>
<hr />
<p><em>Next: Chapter 12 — Custom Events</em></p>
<h1 id="chapter-12-custom-events">Chapter 12: Custom Events</h1>
<p><em>“Design your domain events like you design your domain
model.”</em></p>
<hr />
<h2 id="domain-events">10.1 Domain Events</h2>
<p>Custom events represent significant occurrences in your business
domain. Unlike the built-in events that the runtime generates for file
changes, socket messages, and HTTP requests, custom events are defined
by you to capture business-meaningful happenings within your
application.</p>
<p>A domain event records that something important occurred. A new user
registered. An order was placed. A payment was received. Inventory fell
below a threshold. Each event captures a moment in time when the state
of the business changed in a way that other parts of the system might
care about.</p>
<p>The power of domain events comes from their role in decoupling. The
code that causes an event does not need to know what will happen
afterward. It simply announces that something occurred. Other code can
react to that announcement. This separation allows you to add new
reactions without modifying the original code, to test event producers
and consumers independently, and to understand each part of the system
in isolation.</p>
<p>Designing good domain events requires thinking about your business
domain. What are the significant state changes? What information would
observers need to react appropriately? How should events relate to each
other? These questions parallel the questions you ask when designing a
domain model, which is why event design and domain modeling often go
hand in hand.</p>
<hr />
<h2 id="emitting-events-1">10.2 Emitting Events</h2>
<p>The Emit action publishes an event to the event bus. The event has a
type and a payload. The type is specified in the result position with an
“event” qualifier. The payload follows the “with” preposition.</p>
<p>The event type becomes the name used for matching handlers. Choose
event names that describe what happened rather than what should happen.
Use past tense to emphasize that the event records something that
already occurred. “CustomerRegistered” and “OrderPlaced” and
“PaymentReceived” are good names. “RegisterCustomer” and “PlaceOrder”
are commands, not events—they describe actions to be taken, not facts
that have been recorded.</p>
<p>Event names should be specific and business-meaningful. “UserUpdated”
is vague—what was updated? The user’s email? Their password? Their role?
More specific names like “UserEmailChanged,” “UserPasswordReset,” and
“UserRoleUpdated” tell handlers exactly what happened, allowing them to
react appropriately.</p>
<p>The payload is the data that travels with the event. It should
contain everything that handlers might need to do their work. For a
UserCreated event, include the full user object or at least the
properties that handlers will need. For an OrderPlaced event, include
the order details, customer information, and anything else relevant to
order processing.</p>
<p>The payload should be self-contained. Handlers should not need to
make additional queries to understand the event. If a handler needs the
customer’s email address to send a notification, include the email in
the event payload rather than forcing the handler to retrieve it
separately.</p>
<hr />
<h2 id="handling-events">10.3 Handling Events</h2>
<p>A feature set becomes an event handler when its business activity
matches the handler pattern. The pattern consists of the event name
followed by “Handler.” A feature set with business activity “UserCreated
Handler” handles UserCreated events. A feature set with business
activity “OrderPlaced Handler” handles OrderPlaced events.</p>
<p>Within a handler, the event is available through the “event”
identifier. You use Extract actions to pull data out of the event into
local bindings. The event object contains the payload that was provided
when the event was emitted, plus metadata about the event itself.</p>
<p>The payload structure depends on what the emitter provided. If the
emitter passed a single object as the payload, you can extract
properties from that object. If the emitter passed an object literal
with multiple fields, you can extract each field by name. The structure
of the event is an implicit contract between emitters and
handlers—handlers must know what to expect.</p>
<p>Event metadata includes an identifier for correlating logs and
traces, a timestamp recording when the event was emitted, and a source
identifying which feature set emitted the event. This metadata is useful
for debugging, auditing, and understanding event flows through the
system.</p>
<p>Handlers should be focused on single responsibilities. A handler that
sends email and updates analytics and notifies administrators is doing
too much. Split these into separate handlers that each do one thing
well. The event bus will invoke all handlers for the event, and each
handler can be developed and tested independently.</p>
<hr />
<h2 id="event-patterns">10.4 Event Patterns</h2>
<p>Several patterns emerge in how events are used to structure
applications.</p>
<div style="text-align: center; margin: 2em 0;">
<svg width="480" height="110" viewBox="0 0 480 110" xmlns="http://www.w3.org/2000/svg">
<!-- Command-Event Pattern -->
<text x="120" y="15" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#1e40af">Command-Event</text>
<rect x="20" y="25" width="60" height="30" rx="3" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
<text x="50" y="43" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#1e40af">Command</text>
<line x1="80" y1="40" x2="100" y2="40" stroke="#6b7280" stroke-width="1.5"/>
<polygon points="100,40 95,37 95,43" fill="#6b7280"/>
<rect x="100" y="25" width="60" height="30" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="130" y="43" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#166534">Work</text>
<line x1="160" y1="40" x2="180" y2="40" stroke="#6b7280" stroke-width="1.5"/>
<polygon points="180,40 175,37 175,43" fill="#6b7280"/>
<rect x="180" y="25" width="60" height="30" rx="3" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<text x="210" y="43" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#92400e">Event</text>
<text x="120" y="75" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">“do
X” → does X → “X done”</text> <!-- Divider -->
<line x1="260" y1="20" x2="260" y2="90" stroke="#e5e7eb" stroke-width="1"/>
<!-- Event Chain Pattern -->
<text x="370" y="15" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#7c3aed">Event
Chain</text>
<rect x="280" y="25" width="50" height="25" rx="3" fill="#f3e8ff" stroke="#a855f7" stroke-width="1.5"/>
<text x="305" y="41" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#7c3aed">Event
A</text>
<line x1="330" y1="37" x2="345" y2="37" stroke="#a855f7" stroke-width="1.5"/>
<polygon points="345,37 340,34 340,40" fill="#a855f7"/>
<rect x="345" y="25" width="50" height="25" rx="3" fill="#f3e8ff" stroke="#a855f7" stroke-width="1.5"/>
<text x="370" y="41" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#7c3aed">Event
B</text>
<line x1="395" y1="37" x2="410" y2="37" stroke="#a855f7" stroke-width="1.5"/>
<polygon points="410,37 405,34 405,40" fill="#a855f7"/>
<rect x="410" y="25" width="50" height="25" rx="3" fill="#f3e8ff" stroke="#a855f7" stroke-width="1.5"/>
<text x="435" y="41" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#7c3aed">Event
C</text>
<text x="370" y="75" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">each
handler emits next</text>
</svg>
</div>
<p>The command-event pattern separates the action that causes a change
from the event that records it. An HTTP handler receives a command
(create a user), performs the work (validate data, store user), and
emits an event (UserCreated). The command is imperative—it asks for
something to happen. The event is declarative—it states what happened.
This separation clarifies responsibilities and enables loose
coupling.</p>
<p>Event chains occur when handlers emit additional events. An
OrderPlaced event might trigger an inventory handler that emits
InventoryReserved, which triggers a payment handler that emits
PaymentProcessed, which triggers a fulfillment handler. Each step in the
chain is a separate handler with its own isolation, error handling, and
potential for independent evolution.</p>
<p>The saga pattern uses event chains to implement long-running
processes that span multiple steps. A refund saga might involve
reversing a payment, restoring inventory, updating the order status, and
notifying the customer. Each step emits an event that triggers the next
step. If a step fails, compensation events can trigger rollback of
previous steps.</p>
<h3 id="complete-saga-example-order-processing">Complete Saga Example:
Order Processing</h3>
<p>Here is a complete order processing saga showing event-driven
choreography:</p>
<pre class="aro"><code>(* Step 1: HTTP handler creates order and starts the saga *)
(createOrder: Order API) {
    &lt;Extract&gt; the &lt;order-data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;order&gt; with &lt;order-data&gt;.
    &lt;Store&gt; the &lt;order&gt; in the &lt;order-repository&gt;.

    (* Emit event to start the saga *)
    &lt;Emit&gt; an &lt;OrderPlaced: event&gt; with &lt;order&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;order&gt;.
}

(* Step 2: Reserve inventory when order is placed *)
(Reserve Inventory: OrderPlaced Handler) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Extract&gt; the &lt;items&gt; from the &lt;order: items&gt;.

    (* Reserve each item in inventory *)
    &lt;Retrieve&gt; the &lt;inventory&gt; from the &lt;inventory-service&gt; for &lt;items&gt;.
    &lt;Update&gt; the &lt;inventory&gt; with { reserved: true }.
    &lt;Store&gt; the &lt;inventory&gt; in the &lt;inventory-service&gt;.

    (* Continue the saga *)
    &lt;Emit&gt; an &lt;InventoryReserved: event&gt; with &lt;order&gt;.
}

(* Step 3: Process payment after inventory is reserved *)
(Process Payment: InventoryReserved Handler) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Extract&gt; the &lt;amount&gt; from the &lt;order: total&gt;.
    &lt;Extract&gt; the &lt;payment-method&gt; from the &lt;order: paymentMethod&gt;.

    (* Charge the customer *)
    &lt;Send&gt; the &lt;charge-request&gt; to the &lt;payment-gateway&gt; with {
        amount: &lt;amount&gt;,
        method: &lt;payment-method&gt;
    }.

    (* Continue the saga *)
    &lt;Emit&gt; a &lt;PaymentProcessed: event&gt; with &lt;order&gt;.
}

(* Step 4: Ship order after payment succeeds *)
(Ship Order: PaymentProcessed Handler) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.

    (* Update order status and create shipment *)
    &lt;Update&gt; the &lt;order&gt; with { status: &quot;shipped&quot; }.
    &lt;Store&gt; the &lt;order&gt; in the &lt;order-repository&gt;.
    &lt;Send&gt; the &lt;shipment-request&gt; to the &lt;shipping-service&gt; with &lt;order&gt;.

    (* Final event in the happy path *)
    &lt;Emit&gt; an &lt;OrderShipped: event&gt; with &lt;order&gt;.
}

(* Notification handler - runs in parallel with saga *)
(Notify Customer: OrderShipped Handler) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Extract&gt; the &lt;email&gt; from the &lt;order: customerEmail&gt;.

    &lt;Send&gt; the &lt;shipping-notification&gt; to the &lt;email-service&gt; with {
        to: &lt;email&gt;,
        template: &quot;order-shipped&quot;,
        order: &lt;order&gt;
    }.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;notification&gt;.
}</code></pre>
<p>This saga demonstrates: - <strong>Event chain</strong>: OrderPlaced →
InventoryReserved → PaymentProcessed → OrderShipped -
<strong>Decoupling</strong>: Each handler focuses on one step, unaware
of the others - <strong>Fan-out</strong>: Multiple handlers can listen
to the same event (e.g., OrderShipped triggers both shipping and
notifications)</p>
<p>Fan-out occurs when multiple handlers react to the same event. An
OrderPlaced event might trigger handlers for inventory, payment,
notifications, analytics, and fraud checking. All these handlers run
when the event is emitted. Each handler focuses on its specific concern,
and together they implement the complete response to a new order.</p>
<hr />
<h2 id="event-design-guidelines">10.5 Event Design Guidelines</h2>
<p>Good event design requires thinking about both producers and
consumers.</p>
<p>Include sufficient context in event payloads. Handlers should have
what they need without additional queries. If a UserUpdated event only
contains the user identifier, every handler must retrieve the user to
learn what changed. If the event includes the changes, previous values,
who made the change, and when, handlers can react immediately.</p>
<p>Use past tense consistently. Events record what happened, not what
should happen. “UserCreated” states a fact. “CreateUser” requests an
action. The distinction matters because it clarifies the nature of the
communication—events are announcements, not requests.</p>
<p>Be specific rather than generic. “UserUpdated” could mean many
things. “UserEmailChanged” is unambiguous. Specific events allow
handlers to know exactly what occurred and whether they should react. A
handler that only cares about email changes can ignore password resets
if they are separate events.</p>
<p>Treat event payloads as immutable. The payload is a snapshot of state
at the moment the event was emitted. Handlers should not expect to
modify the payload or to have modifications affect other handlers. Each
handler receives an independent view of the event.</p>
<p>Design for evolution. Events are contracts between producers and
consumers. Changing an event’s structure can break consumers. When you
add fields, make them optional so existing consumers continue to work.
When you remove fields, ensure no consumers still depend on them.
Version events if incompatible changes are necessary.</p>
<hr />
<h2 id="error-handling-in-events-1">10.6 Error Handling in Events</h2>
<p>Event handlers run in isolation. If one handler fails, other handlers
for the same event still run. The emitting feature set is not affected
by handler failures—it continues with its own execution regardless of
what handlers do.</p>
<p>This isolation reflects the fire-and-forget nature of event emission.
The emitter announces what happened and moves on. It does not wait for
handlers to complete, does not receive their results, and does not fail
if they fail. This makes event emission a non-blocking operation and
prevents cascading failures.</p>
<p>For scenarios where handler success is important, additional patterns
help. Compensation events can trigger recovery when things fail. A
PaymentFailed event can trigger handlers that cancel the order and
notify the customer. The failure handler runs as a reaction to the
failure event, providing a mechanism for recovery without coupling the
original operation to error handling.</p>
<p>The runtime logs all handler failures with full context. Operators
can monitor these logs to detect failing handlers. Alerts can trigger
when failure rates exceed thresholds. The information in the logs—event
type, handler name, error message, timestamp, correlation
identifier—supports diagnosis and debugging.</p>
<p>Designing handlers for idempotency provides resilience. If a handler
can safely process the same event multiple times without incorrect
behavior, temporary failures can be recovered by reprocessing the event.
This is particularly valuable in distributed systems where exactly-once
delivery is difficult to guarantee.</p>
<hr />
<h2 id="best-practices-5">10.7 Best Practices</h2>
<p>Name events from the perspective of the domain, not the
infrastructure. “CustomerJoinedLoyaltyProgram” is a domain event.
“DatabaseRowInserted” is an infrastructure event. Domain events
communicate business meaning; infrastructure events communicate
implementation details. Prefer domain events because they remain stable
as implementations change.</p>
<p>Document the contract between event producers and consumers. The
payload structure is an implicit contract—producers must provide what
consumers expect. Documenting this contract makes the expectation
explicit. Include what fields are present, their types, and their
semantics. When the contract changes, communicate the change to all
affected parties.</p>
<p>Use events for cross-cutting concerns. Audit logging, analytics,
notifications, and other concerns that touch many parts of the
application are natural fits for events. The code that creates a user
does not need to know about audit logging—it just emits UserCreated, and
an audit handler captures it.</p>
<p>Test handlers in isolation. Because handlers are independent feature
sets with well-defined inputs (the event), they are straightforward to
test. Construct a mock event with the expected payload, invoke the
handler, and verify the behavior. This unit testing approach scales to
complex systems.</p>
<p>Avoid circular event chains. If event A triggers a handler that emits
event B, and event B triggers a handler that emits event A, you have an
infinite loop. The ARO compiler detects these cycles at compile time and
reports them as errors, so you will catch this problem before your code
runs. Map your event flows to ensure they form directed acyclic graphs
with clear start and end points.</p>
<hr />
<h2 id="compiler-validation">10.8 Compiler Validation</h2>
<p>The ARO compiler performs static analysis on your event handlers to
detect potential issues before runtime.</p>
<p><strong>Circular Event Chain Detection</strong>: The compiler builds
a graph of event flows by analyzing which handlers emit which events. If
a cycle is detected (for example, <code>Alpha Handler</code> emits
<code>Beta</code> and <code>Beta Handler</code> emits
<code>Alpha</code>), the compiler reports an error:</p>
<pre><code>error: Circular event chain detected: Alpha -&gt; Beta -&gt; Alpha
  hint: Event handlers form an infinite loop that will exhaust resources
  hint: Consider breaking the chain by using different event types or adding termination conditions</code></pre>
<p>This check examines all Emit statements, including those inside Match
statements and ForEach loops, treating any potential emission path as
part of the event flow graph.</p>
<p><strong>Breaking Cycles</strong>: If you need handlers to communicate
back and forth, consider these approaches: - Use a termination condition
based on data in the event payload - Design a linear workflow where each
step moves forward, not backward - Introduce a new event type that
represents a terminal state - Move the repeated logic into a single
handler rather than chaining</p>
<p>The goal is to ensure that every event chain has a clear end point
where no further events are emitted.</p>
<hr />
<p><em>Next: Chapter 13 — OpenAPI Integration</em></p>
<h1 id="chapter-13-openapi-integration">Chapter 13: OpenAPI
Integration</h1>
<p><em>“Your contract is your router.”</em></p>
<hr />
<h2 id="contract-first-development">11.1 Contract-First Development</h2>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="180" height="200" viewBox="0 0 180 200" xmlns="http://www.w3.org/2000/svg">
<!-- OpenAPI file -->
<rect x="50" y="10" width="80" height="45" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="90" y="28" text-anchor="middle" font-family="monospace" font-size="9" font-weight="bold" fill="#92400e">openapi.yaml</text>
<text x="90" y="42" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#b45309">operationId:</text>
<text x="90" y="52" text-anchor="middle" font-family="monospace" font-size="7" fill="#d97706">listUsers</text>
<!-- Arrow down -->
<line x1="90" y1="55" x2="90" y2="75" stroke="#6b7280" stroke-width="2"/>
<polygon points="90,75 85,67 95,67" fill="#6b7280"/> <!-- Router box -->
<rect x="40" y="80" width="100" height="30" rx="4" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
<text x="90" y="100" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#4338ca">Route
Matcher</text> <!-- Arrow down -->
<line x1="90" y1="110" x2="90" y2="130" stroke="#6b7280" stroke-width="2"/>
<polygon points="90,130 85,122 95,122" fill="#6b7280"/>
<!-- Feature Set -->
<rect x="30" y="135" width="120" height="50" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="90" y="152" text-anchor="middle" font-family="monospace" font-size="8" fill="#166534">(listUsers:
User API)</text>
<text x="90" y="165" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#22c55e">&lt;Retrieve&gt;…</text>
<text x="90" y="178" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#22c55e">&lt;Return&gt;…</text>
<!-- Label -->
<text x="90" y="198" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">name
= operationId</text>
</svg>
</div>
<p>ARO embraces contract-first API development. Rather than defining
routes in code and hoping documentation stays synchronized, you define
your API in an OpenAPI specification file, and ARO uses that
specification to configure routing automatically. The specification is
the source of truth; the code implements what the specification
declares.</p>
<p>This approach inverts the typical relationship between code and
documentation. In most frameworks, you write code and generate
documentation from it. In ARO, you write the specification and implement
handlers for it. The specification comes first, defining what the API
looks like from a client’s perspective. The implementation comes second,
fulfilling the promises made by the specification.</p>
<p>The connection between specification and code is the operation
identifier. Each operation in your OpenAPI specification has an
operationId that uniquely identifies it. When a request arrives, ARO
determines which operation it matches based on the path and method,
looks up the operationId, and triggers the feature set with that name.
The feature set name becomes the operationId; the operationId becomes
the feature set name.</p>
<p>This design ensures that your API cannot drift from its
documentation. If the specification declares an operation, you must
implement a feature set with that name, or clients receive an error. If
you implement a feature set that does not correspond to an operation, it
never receives HTTP requests. The specification and implementation are
bound together.</p>
<hr />
<h2 id="the-openapi-requirement">11.2 The OpenAPI Requirement</h2>
<p>ARO’s HTTP server depends on the presence of an OpenAPI specification
file in the application directory. The runtime checks for specification
files in this order of precedence:</p>
<ol type="1">
<li><code>openapi.yaml</code> (preferred)</li>
<li><code>openapi.yml</code></li>
<li><code>openapi.json</code></li>
</ol>
<p>The first file found is used as the API contract. Without any of
these files, no HTTP server starts. No port is opened. No requests are
received.</p>
<p>This requirement is deliberate. It enforces the contract-first
philosophy at the framework level. You cannot accidentally create an
undocumented API because the documentation is required for the API to
exist. You cannot forget to update documentation when changing routes
because changing routes means changing the specification.</p>
<p>The requirement also simplifies the runtime. There is no route
registration API, no decorator syntax for paths, no configuration file
for endpoints. The OpenAPI specification provides all of this
information in a standard format that tools throughout the industry
understand. Your API specification can be viewed in Swagger UI,
validated with standard tools, and used to generate client libraries,
all because it follows the OpenAPI standard.</p>
<p>If you are building an application that does not expose an HTTP API—a
file processing daemon, a socket server, a command-line tool—you simply
omit the openapi.yaml file. The application runs normally; it just does
not handle HTTP requests.</p>
<hr />
<h2 id="operation-identifiers">11.3 Operation Identifiers</h2>
<p>The operationId is the key that connects HTTP routes to feature sets.
When you define an operation in your OpenAPI specification, you assign
it an operationId. When you implement the handler in ARO, you create a
feature set with that identifier as its name.</p>
<p>Operation identifiers should be descriptive verbs that indicate what
the operation does. Common conventions include verb-noun patterns like
listUsers, createOrder, getProductById, and deleteComment. The
identifier should make sense when read in isolation, as it will appear
in logs, error messages, and feature set declarations.</p>
<p>Each operation in your specification must have a unique operationId.
The OpenAPI standard requires this, and ARO relies on it for routing. If
two operations shared an identifier, there would be ambiguity about
which feature set should handle which request. The uniqueness constraint
eliminates this possibility.</p>
<p>When a request arrives that matches a path and method in your
specification, ARO looks up the corresponding operationId and searches
for a feature set with that name. If found, the feature set executes
with the request context available for extraction. If not found, ARO
returns a 501 Not Implemented response indicating that the operation
exists in the specification but has no handler.</p>
<hr />
<h2 id="route-matching">11.4 Route Matching</h2>
<p>ARO matches incoming HTTP requests to operations through a two-step
process. First, it matches the request path against the path templates
in the specification. Second, it matches the HTTP method against the
methods defined for that path. The combination of path and method
identifies a unique operation.</p>
<p>Path templates can include parameters enclosed in braces. A template
like /users/{id} matches paths like /users/123 or /users/abc. When a
match occurs, the actual value from the URL is extracted and made
available as a path parameter. The parameter name in the template (id in
this example) becomes the key for accessing the value.</p>
<p>Multiple methods can be defined for the same path. The /users path
might support GET for listing users and POST for creating users. Each
method has its own operationId and its own feature set. A GET request to
/users triggers listUsers; a POST request to /users triggers createUser.
The path is the same, but the operations are different.</p>
<p>Requests that do not match any path receive a 404 response. Requests
that match a path but use an undefined method receive a 405 Method Not
Allowed response. These responses are generated automatically based on
the specification; you do not write code to handle unmatched routes.</p>
<hr />
<h2 id="automatic-server-startup">11.5 Automatic Server Startup</h2>
<p>The HTTP server starts automatically when an
<code>openapi.yaml</code> file is present in your application directory.
There is no explicit Start action required for HTTP services. When the
runtime discovers the OpenAPI specification during application
initialization, it reads the file, configures routing based on its
contents, and begins accepting requests on the default port (8080).</p>
<p>After the server starts, you use the Keepalive action to keep the
application running and processing requests. Without Keepalive, the
application would start the server and immediately terminate:</p>
<pre class="aro"><code>(Application-Start: User API) {
    &lt;Log&gt; the &lt;startup: message&gt; for the &lt;console&gt; with &quot;API starting...&quot;.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}</code></pre>
<p>You can configure the port on which the server listens using
environment variables or configuration files. This flexibility allows
you to run multiple services on different ports or to conform to
container orchestration requirements.</p>
<p>The server starts synchronously during initialization. If the port is
already in use or binding fails for any other reason, the startup fails
with an appropriate error. This fail-fast behavior ensures you know
immediately if the server cannot start, rather than discovering the
problem later when requests fail.</p>
<hr />
<h2 id="request-context">11.6 Request Context</h2>
<p>When a feature set handles an HTTP request, it has access to
information about that request through special context identifiers. You
use the Extract action to pull specific pieces of information into local
bindings.</p>
<p>Path parameters are values extracted from the URL based on the path
template. If your template is /users/{id} and the request URL is
/users/123, the path parameter “id” has the value “123”. You access this
through the pathParameters identifier with the parameter name as a
qualifier.</p>
<p>Query parameters are the key-value pairs in the URL’s query string. A
request to /users?limit=10&amp;offset=20 has query parameters “limit”
and “offset”. You access these through the queryParameters identifier.
Query parameters are optional by default; extracting a parameter that
was not provided produces an empty or missing value rather than an
error.</p>
<p>The request body is the content sent with POST, PUT, and PATCH
requests. For JSON content, the runtime parses the body into a
structured object that you can extract and navigate. You access the body
through the request identifier with “body” as the qualifier.</p>
<p>Headers are the HTTP headers sent with the request. Authentication
tokens, content types, and other metadata arrive as headers. You access
these through the headers identifier with the header name as a
qualifier. Header names are case-insensitive per the HTTP
specification.</p>
<hr />
<h2 id="response-mapping">11.7 Response Mapping</h2>
<p>ARO maps return statements to HTTP responses based on the status
qualifier you provide. The qualifier determines the HTTP status code,
and the payload becomes the response body.</p>
<p>Common status qualifiers include OK for 200 responses, Created for
201 responses when a resource is created, Accepted for 202 when
processing is deferred, and NoContent for 204 when there is no response
body. Error statuses include BadRequest for 400, NotFound for 404, and
Conflict for 409.</p>
<p>The payload you provide with the response becomes the response body,
typically serialized as JSON. You can return a single object, an array,
or an object literal that you construct inline. The runtime handles
serialization and sets appropriate content-type headers.</p>
<p>If your feature set fails rather than returning normally, the runtime
generates an error response. The status code depends on the type of
failure—not found errors become 404, validation errors become 400,
internal errors become 500. The response body contains the error message
generated from the failed statement.</p>
<hr />
<h2 id="validation">11.8 Validation</h2>
<p>OpenAPI specifications can include schemas that define the structure
and constraints of request bodies and responses. ARO can validate
incoming requests against these schemas, rejecting invalid requests
before they reach your feature set.</p>
<p>Automatic validation can be enabled when starting the server. With
validation enabled, the runtime checks each incoming request body
against the schema defined in the specification. If the request does not
conform, the client receives a 400 response with details about which
validations failed.</p>
<p>Manual validation is an alternative when you want more control. You
extract the request body and then validate it explicitly using the
Validate action with a reference to the schema. This approach lets you
perform additional processing before or after validation, or handle
validation failures in custom ways.</p>
<p>Schema validation provides a first line of defense against malformed
requests. It ensures that your feature set receives data in the expected
structure with the expected types. This eliminates the need for
defensive type checking in your business logic and catches problems at
the API boundary where they can be reported clearly to clients.</p>
<hr />
<h2 id="best-practices-6">11.9 Best Practices</h2>
<p>Design your API specification before writing implementation code.
Think about what resources your API exposes, what operations clients
need to perform, and what data structures are involved. Write this
design down in OpenAPI format. Then implement feature sets to fulfill
the specification.</p>
<p>Choose operation identifiers that describe what the operation does in
clear, consistent terms. Use verb-noun patterns like listUsers,
createOrder, getProductById. Avoid generic names like “handle” or
“process” that do not convey meaning. The identifier appears in your
feature set declarations, in logs, and in error messages, so clarity
matters.</p>
<p>Group related operations using tags in your OpenAPI specification.
Tags help organize documentation and make the specification easier to
navigate. A user management API might tag all user-related operations
with “Users” and all authentication operations with “Auth.”</p>
<p>Document the possible responses for each operation. Clients need to
know not just the success response but also what error responses they
might receive and under what conditions. This documentation helps API
consumers handle all cases appropriately.</p>
<p>Keep your specification and implementation synchronized. When you
change the API, update the specification first, then update the
implementation. When you add new operations, add them to the
specification first. The contract should always accurately reflect what
the API does.</p>
<hr />
<p><em>Next: Chapter 14 — HTTP Feature Sets</em></p>
<h1 id="chapter-14-http-feature-sets">Chapter 14: HTTP Feature Sets</h1>
<p><em>“Every endpoint tells a story.”</em></p>
<hr />
<h2 id="http-handler-basics">12.1 HTTP Handler Basics</h2>
<p>HTTP feature sets handle requests routed through the OpenAPI
contract. When a request matches a path and method defined in your
specification, the corresponding feature set executes with the request
data available for extraction.</p>
<p>The feature set name must exactly match the operationId from your
OpenAPI specification. This matching is case-sensitive. If your
specification defines an operation with operationId “getUser”, you must
create a feature set named “getUser”—not “GetUser”, not “get-user”, not
“getuser”. The names must be identical.</p>
<p>A typical HTTP handler follows a predictable pattern. It extracts
data from the request, performs some processing, and returns a response.
The extraction pulls relevant information from path parameters, query
parameters, headers, or the request body. The processing might retrieve
data from repositories, create new entities, validate inputs, or compute
results. The response returns an appropriate status code with optional
data.</p>
<p>The business activity (the text after the colon in the feature set
declaration) can be anything descriptive. Common choices include the
name of the API or service, a description of the resource being managed,
or a broader category that groups related operations. This text appears
in logs and helps readers understand the context.</p>
<hr />
<h2 id="crud-operations">12.2 CRUD Operations</h2>
<p>Most HTTP APIs implement CRUD operations—Create, Read, Update, and
Delete—for their resources. Each operation has a characteristic pattern
in ARO.</p>
<p>List operations retrieve collections of resources. They typically
extract pagination parameters from the query string, retrieve matching
records from a repository, and return the collection. The response often
includes metadata about the total count, current page, and whether more
records exist.</p>
<p>Read operations retrieve a single resource by identifier. They
extract the identifier from the path, retrieve the matching record, and
return it. If no record matches, the runtime generates a not-found error
that becomes a 404 response.</p>
<p>Create operations make new resources. They extract data from the
request body, validate it against a schema, create the new entity, store
it in a repository, and return it with a Created status. They often emit
an event so other parts of the system can react to the new resource.</p>
<p>Update operations modify existing resources. They extract the
identifier from the path and the update data from the body, retrieve the
existing record, merge the updates, store the result, and return the
updated entity. Full updates (PUT) replace all fields; partial updates
(PATCH) modify only the provided fields.</p>
<p>Delete operations remove resources. They extract the identifier from
the path, delete the matching record from the repository, and return a
NoContent status indicating success. They often emit an event so other
parts of the system can react to the deletion.</p>
<hr />
<h2 id="request-data-access">12.3 Request Data Access</h2>
<p>HTTP handlers have access to various parts of the incoming request
through special context identifiers. Each type of request data has its
own identifier and access pattern.</p>
<p>Path parameters are values embedded in the URL path based on the
template defined in your OpenAPI specification. A template like
/users/{id}/orders/{orderId} defines two path parameters: “id” and
“orderId”. You extract these using the pathParameters identifier with
the parameter name as a qualifier.</p>
<p>Query parameters are the key-value pairs in the URL’s query string. A
request to /search?q=widgets&amp;page=2 has query parameters “q” and
“page”. You extract these using the queryParameters identifier. Query
parameters are typically optional; extracting one that was not provided
yields an empty value rather than an error.</p>
<p>The request body contains data sent with POST, PUT, and PATCH
requests. For JSON content, the runtime parses the body into a
structured object. You extract it using the request identifier with
“body” as the qualifier. You can then extract individual fields from the
body using additional qualifiers.</p>
<p>Headers contain metadata about the request. Authentication tokens
typically arrive in the Authorization header. Content type information
appears in the Content-Type header. Custom headers can carry
application-specific data. You extract headers using the headers
identifier with the header name as a qualifier.</p>
<p>The full request object provides access to additional information
including the HTTP method, the original path, and all headers as a
collection. This is useful for debugging or when you need information
not available through the specific accessors.</p>
<hr />
<h2 id="response-patterns">12.4 Response Patterns</h2>
<p>ARO provides a variety of status qualifiers for different response
scenarios. Choosing the right status communicates the outcome clearly to
clients.</p>
<p>Success responses indicate the operation completed as expected. OK
(200) is the standard success status for retrieving data or completing
an operation. Created (201) indicates a new resource was created,
typically used with POST requests. Accepted (202) indicates the request
was received for asynchronous processing. NoContent (204) indicates
success with no response body, typically used for DELETE operations.</p>
<p>Error responses indicate something prevented successful completion.
BadRequest (400) indicates the client sent invalid data. Unauthorized
(401) indicates authentication is required. Forbidden (403) indicates
the client lacks permission for the operation. NotFound (404) indicates
the requested resource does not exist. Conflict (409) indicates the
request conflicts with current state, such as creating a duplicate.</p>
<p>The response body can be a single object, an array, or an object
literal constructed inline. For single resources, return the entity
directly. For collections, return an array or a structured object with
the array and metadata. For errors, return a structured object with
error details.</p>
<p>Collection responses often include pagination metadata. Beyond the
data array, include the total count, current page, page size, and
whether more pages exist. This information helps clients navigate
through large result sets.</p>
<hr />
<h2 id="authentication-and-authorization">12.5 Authentication and
Authorization</h2>
<p>Many APIs require authentication to identify the caller and
authorization to verify permissions. ARO handles these concerns through
request data extraction and validation.</p>
<p>Authentication typically involves extracting a token from the
Authorization header, validating it against an authentication service or
by verifying its signature, and extracting identity information such as
a user identifier or role list. The validated identity becomes available
for use in subsequent statements.</p>
<p>Authorization checks whether the authenticated identity has
permission for the requested operation. This might involve checking a
role list against required roles, querying a permissions service, or
applying custom authorization logic. If authorization fails, you return
a Forbidden status.</p>
<p>The pattern is to extract and validate authentication early in the
feature set, before performing any business logic. This ensures that
unauthenticated or unauthorized requests fail fast with appropriate
error responses rather than partially executing before failing.</p>
<p>Custom actions can encapsulate complex authentication and
authorization logic. A ValidateToken action might handle JWT
verification, signature checking, and expiration validation. A
CheckPermission action might query a permissions database or evaluate
policy rules. These actions keep your feature sets focused on business
logic.</p>
<hr />
<h2 id="nested-resources">12.6 Nested Resources</h2>
<p>APIs often model relationships between resources through nested URL
paths. A user has orders; an order belongs to a user. The path
/users/{userId}/orders represents the orders belonging to a specific
user.</p>
<p>Nested resource paths involve multiple path parameters. You extract
each parameter by name. The parent identifier constrains which records
to consider; the child identifier (if present) identifies a specific
record within that constraint.</p>
<p>When listing nested resources, include the parent identifier in your
repository query. When creating nested resources, include the parent
identifier in the stored record. When retrieving or modifying specific
nested resources, verify that the child belongs to the specified
parent.</p>
<p>The nesting expresses ownership and access control. A request for
/users/123/orders/456 should only succeed if order 456 actually belongs
to user 123. Your where clause should include both constraints to
enforce this relationship.</p>
<h3 id="complete-nested-resource-example">Complete Nested Resource
Example</h3>
<p>Here is a complete example for managing order items as a nested
resource under orders:</p>
<p><strong>OpenAPI specification (partial):</strong></p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">/orders/{orderId}/items</span><span class="kw">:</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">get</span><span class="kw">:</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> listOrderItems</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">post</span><span class="kw">:</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> createOrderItem</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">/orders/{orderId}/items/{itemId}</span><span class="kw">:</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">get</span><span class="kw">:</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> getOrderItem</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">put</span><span class="kw">:</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> updateOrderItem</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">delete</span><span class="kw">:</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> deleteOrderItem</span></span></code></pre></div>
<p><strong>ARO handlers:</strong></p>
<pre class="aro"><code>(* List all items for an order *)
(listOrderItems: Order API) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: orderId&gt;.

    (* Verify order exists *)
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt; where id = &lt;order-id&gt;.

    (* Get items for this order *)
    &lt;Retrieve&gt; the &lt;items&gt; from the &lt;item-repository&gt; where orderId = &lt;order-id&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;items&gt;.
}

(* Get a specific item, verifying it belongs to the order *)
(getOrderItem: Order API) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: orderId&gt;.
    &lt;Extract&gt; the &lt;item-id&gt; from the &lt;pathParameters: itemId&gt;.

    (* Retrieve with both constraints to enforce ownership *)
    &lt;Retrieve&gt; the &lt;item&gt; from the &lt;item-repository&gt;
        where id = &lt;item-id&gt; and orderId = &lt;order-id&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;item&gt;.
}

(* Create a new item for an order *)
(createOrderItem: Order API) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: orderId&gt;.
    &lt;Extract&gt; the &lt;item-data&gt; from the &lt;request: body&gt;.

    (* Verify order exists before adding item *)
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt; where id = &lt;order-id&gt;.

    (* Create item with parent reference *)
    &lt;Create&gt; the &lt;item&gt; with {
        orderId: &lt;order-id&gt;,
        productId: &lt;item-data&gt;.productId,
        quantity: &lt;item-data&gt;.quantity,
        price: &lt;item-data&gt;.price
    }.

    &lt;Store&gt; the &lt;item&gt; in the &lt;item-repository&gt;.

    (* Recalculate order total *)
    &lt;Emit&gt; an &lt;OrderItemAdded: event&gt; with { order: &lt;order&gt;, item: &lt;item&gt; }.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;item&gt;.
}

(* Delete an item from an order *)
(deleteOrderItem: Order API) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: orderId&gt;.
    &lt;Extract&gt; the &lt;item-id&gt; from the &lt;pathParameters: itemId&gt;.

    (* Verify ownership before deletion *)
    &lt;Retrieve&gt; the &lt;item&gt; from the &lt;item-repository&gt;
        where id = &lt;item-id&gt; and orderId = &lt;order-id&gt;.

    &lt;Delete&gt; the &lt;item&gt; from the &lt;item-repository&gt;.

    &lt;Emit&gt; an &lt;OrderItemRemoved: event&gt; with { orderId: &lt;order-id&gt;, itemId: &lt;item-id&gt; }.

    &lt;Return&gt; a &lt;NoContent: status&gt; for the &lt;deletion&gt;.
}</code></pre>
<p>Key patterns in this example: - <strong>Parent verification</strong>:
Always verify the parent exists before creating nested resources -
<strong>Ownership enforcement</strong>: Include both parent and child
IDs in where clauses - <strong>Event emission</strong>: Notify other
handlers when nested resources change</p>
<p>Deep nesting (more than two levels) can make URLs unwieldy and logic
complex. Consider whether deep nesting is necessary or whether flatter
alternatives would serve your API design better.</p>
<hr />
<h2 id="best-practices-7">12.7 Best Practices</h2>
<p>Keep handlers focused on single responsibilities. A handler that
retrieves a user should not also retrieve their orders, payments, and
statistics. If clients need aggregated data, provide a separate endpoint
or use a pattern like GraphQL that’s designed for flexible queries.</p>
<p>Use consistent naming across your API. If you name one operation
“listUsers”, name similar operations “listOrders” and “listProducts”,
not “getOrders” or “findProducts”. Consistency makes your API
predictable and easier to learn.</p>
<p>Emit events for side effects rather than performing them inline. When
creating a user, emit a UserCreated event rather than directly sending
welcome emails, updating analytics, and notifying administrators. Event
handlers keep side effects separate and make the core logic clearer.</p>
<p>Validate inputs early. Extract and validate request data at the
beginning of your feature set, before performing any business logic.
This ensures that invalid requests fail immediately with clear error
messages rather than partially executing.</p>
<p>Return appropriate status codes. Use Created for successful POST
requests that create resources. Use NoContent for successful DELETE
requests. Use specific error codes rather than generic 500 responses.
Clients rely on status codes to understand outcomes.</p>
<hr />
<p><em>Next: Chapter 15 — Request/Response Patterns</em></p>
<h1 id="chapter-15-requestresponse-patterns">Chapter 15:
Request/Response Patterns</h1>
<p><em>“Input, transform, output. The rhythm of every API.”</em></p>
<hr />
<h2 id="the-request-response-cycle">13.1 The Request-Response Cycle</h2>
<div style="text-align: center; margin: 2em 0;">
<svg width="400" height="100" viewBox="0 0 400 100" xmlns="http://www.w3.org/2000/svg">
<!-- Extract -->
<rect x="20" y="30" width="90" height="40" rx="5" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
<text x="65" y="48" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#1e40af">EXTRACT</text>
<text x="65" y="62" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#3b82f6">path,
query, body</text> <!-- Arrow -->
<line x1="110" y1="50" x2="140" y2="50" stroke="#6b7280" stroke-width="2"/>
<polygon points="140,50 133,45 133,55" fill="#6b7280"/> <!-- Process -->
<rect x="145" y="30" width="90" height="40" rx="5" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="190" y="48" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#166534">PROCESS</text>
<text x="190" y="62" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#22c55e">validate,
transform</text> <!-- Arrow -->
<line x1="235" y1="50" x2="265" y2="50" stroke="#6b7280" stroke-width="2"/>
<polygon points="265,50 258,45 258,55" fill="#6b7280"/> <!-- Return -->
<rect x="270" y="30" width="90" height="40" rx="5" fill="#fce7f3" stroke="#ec4899" stroke-width="2"/>
<text x="315" y="48" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#9d174d">RETURN</text>
<text x="315" y="62" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#ec4899">status
+ data</text> <!-- Labels below -->
<text x="65" y="88" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#9ca3af">input</text>
<text x="190" y="88" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#9ca3af">business
logic</text>
<text x="315" y="88" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#9ca3af">output</text>
</svg>
</div>
<p>Every HTTP handler follows a fundamental cycle: receive a request,
process it, and return a response. This cycle structures how you think
about and write HTTP feature sets in ARO.</p>
<p>The cycle begins with extraction. Data arrives in the request through
various channels—path parameters embedded in the URL, query parameters
in the query string, headers containing metadata, and a body containing
the primary payload. Your feature set pulls out the pieces it needs
using Extract actions.</p>
<p>The middle of the cycle is processing. This is where your business
logic lives. You might validate the extracted data against schemas or
business rules. You might retrieve existing data from repositories. You
might create new entities, compute derived values, or transform data
between formats. You might store results or emit events.</p>
<p>The cycle concludes with the response. You return a status indicating
the outcome and optionally include data in the response body. The status
code communicates success or failure; the body provides details. The
runtime serializes your response and sends it to the client.</p>
<p>This cycle is the same regardless of what your API does. A simple
health check endpoint and a complex multi-step transaction both follow
the same pattern: extract, process, return.</p>
<hr />
<h2 id="extraction-patterns">13.2 Extraction Patterns</h2>
<p>Extraction is the first step in handling any request. You need to get
data out of the request and into local bindings where you can work with
it.</p>
<p>Simple extraction pulls a single value from a known location.
Extracting a user identifier from path parameters, a search query from
query parameters, or an authentication token from headers are all simple
extractions. Each uses the Extract action with the appropriate context
identifier and qualifier.</p>
<p>Nested extraction navigates into structured data. The request body is
often a JSON object with nested properties. You can extract the entire
body and then extract individual fields from it, or you can use chained
qualifiers to navigate directly to nested values.</p>
<p>Default values handle optional data. Query parameters are typically
optional—clients may or may not include them. When you extract an
optional parameter, you might get an empty value. You can use the Create
action with an “or” clause to provide a default when the extracted value
is missing.</p>
<p>Multiple extractions gather all the data you need. A complex handler
might extract several path parameters, multiple query parameters, the
request body, and one or more headers. Each extraction creates a binding
that subsequent statements can use.</p>
<p>The pattern is to perform all extractions early in the feature set,
before any processing logic. This makes it clear what data the handler
needs and ensures that missing required data causes immediate failure
rather than partial processing.</p>
<hr />
<h2 id="validation-patterns">13.3 Validation Patterns</h2>
<p>Validation ensures that extracted data meets expectations before you
use it in business logic. Invalid data caught early produces clear error
messages; invalid data caught late produces confusing failures.</p>
<p>Schema validation checks that data conforms to a defined structure.
OpenAPI specifications include schemas for request bodies, and ARO can
validate against these schemas. The Validate action compares data
against a schema and fails if the data does not conform.</p>
<p>Business rule validation checks constraints beyond structure. A
quantity must be positive. A date range must have the start before the
end. An email must be in a valid format. These rules express business
requirements that pure schema validation cannot capture.</p>
<p>Cross-field validation checks relationships between multiple values.
A password confirmation must match the password. A shipping address is
required when the delivery method is not pickup. These validations
involve multiple extracted values and their relationships.</p>
<p>Custom validation actions encapsulate complex validation logic. When
validation rules are elaborate or shared across multiple handlers,
implementing them as custom actions keeps your feature sets focused on
the business flow rather than validation details.</p>
<hr />
<h2 id="transformation-patterns">13.4 Transformation Patterns</h2>
<p>Transformation is the heart of request processing. You take input
data and produce output data through various operations.</p>
<p>Entity creation transforms raw input into domain objects. You extract
unstructured data from the request, perhaps validate it, and create a
typed entity. The created entity has a well-defined structure and
possibly additional computed properties.</p>
<p>Data enrichment augments core data with related information. You
retrieve a primary entity and then retrieve additional entities
referenced by the primary one. The enriched result combines the primary
entity with its related data.</p>
<p>Aggregation computes summary values from collections. You retrieve a
set of records and compute totals, counts, averages, or other aggregate
values. The response includes these computed values rather than or in
addition to the raw records.</p>
<p>Format transformation converts between representations. You might
transform an internal entity into an API response format, convert
between date representations, or restructure nested data into a flat
format.</p>
<p>Each transformation takes bound values as input and produces new
bindings as output. The sequence of transformations builds up the data
needed for the response.</p>
<hr />
<h2 id="response-patterns-1">13.5 Response Patterns</h2>
<p>Response patterns determine how you communicate outcomes to clients.
The combination of status code and response body tells clients what
happened and provides any resulting data.</p>
<p>Success with data returns a status indicating success along with the
relevant data. For retrievals, this is typically OK with the retrieved
entity. For creations, this is typically Created with the new entity.
The data might be a single object, an array, or a structured object
containing data and metadata.</p>
<p>Success without data indicates the operation completed but there is
nothing to return. Delete operations typically use NoContent because the
deleted resource no longer exists. Some update operations might also
return NoContent if the updated state is not needed by the client.</p>
<p>Collection responses return multiple items, often with pagination
metadata. Beyond the array of items, include information about the total
count, current page, page size, and whether additional pages exist. This
metadata helps clients navigate large result sets.</p>
<p>Error responses indicate what went wrong. The status code categorizes
the error—client error versus server error, not found versus forbidden.
The response body provides details including an error message and
possibly additional context like field-level validation errors.</p>
<p>Structured responses maintain consistency across endpoints. Rather
than returning raw data for success and structured objects for errors,
consider always returning a consistent structure with “data” and “error”
fields, or “data” and “meta” fields. Consistency makes your API easier
for clients to consume.</p>
<hr />
<h2 id="common-patterns-1">13.6 Common Patterns</h2>
<p>Several patterns recur across APIs and have established solutions in
ARO.</p>
<p>Get-or-create retrieves an existing resource if it exists or creates
a new one if it does not. This pattern is useful for idempotent
operations where clients want to ensure a resource exists without caring
whether it was already present.</p>
<p>Upsert updates an existing resource if found or creates it if not.
Unlike get-or-create, upsert applies updates to existing resources
rather than returning them unchanged. The identifier might be a natural
key like an email address rather than a generated identifier.</p>
<p>Bulk operations process multiple items in a single request. Creating,
updating, or deleting multiple resources at once reduces round trips
compared to processing each item individually. The response might
summarize results rather than returning all processed items.</p>
<p>Search with filters handles complex queries. Rather than defining
separate endpoints for each query variation, a single search endpoint
accepts filter parameters that constrain the results. The handler builds
a query from the provided filters and executes it against an index or
database.</p>
<hr />
<h2 id="response-headers">13.7 Response Headers</h2>
<p>Beyond the status code and body, responses can include headers that
provide additional metadata or instructions to clients.</p>
<p>Content disposition headers control how browsers handle downloaded
files. For file downloads, you set the Content-Disposition header to
indicate that the response should be saved as a file with a particular
name.</p>
<p>Cache control headers tell clients and intermediaries how long to
cache the response. Setting appropriate cache headers reduces load on
your server and improves client performance for responses that do not
change frequently.</p>
<p>Custom headers can carry application-specific metadata. Rate limit
information, correlation identifiers, and pagination links are examples
of data that might travel in headers rather than the body.</p>
<p>The Return action can include header specifications that the runtime
applies to the HTTP response. Headers are key-value pairs that augment
the response status and body.</p>
<hr />
<h2 id="best-practices-8">13.8 Best Practices</h2>
<p>Extract and validate early. Get all the data you need from the
request at the beginning of your handler. Validate it immediately after
extraction. This pattern ensures that invalid requests fail fast with
clear errors.</p>
<p>Use meaningful response structures. Consistent response shapes across
your API make client development easier. Consider standard patterns like
wrapping data in a “data” field and including metadata in a “meta”
field.</p>
<p>Be consistent across endpoints. If one endpoint returns pagination in
a particular format, all endpoints with pagination should use the same
format. If one endpoint includes error details in a particular
structure, all endpoints should use the same structure.</p>
<p>Document your response shapes. Clients need to know what to expect
from your API. The OpenAPI specification should document not just the
types but also the structure and meaning of responses. Good
documentation reduces client development time and support requests.</p>
<p>Handle edge cases explicitly. What happens when a list endpoint finds
no matching items—an empty array or a 404? What happens when an optional
related resource is missing? Decide these behaviors intentionally and
implement them consistently.</p>
<hr />
<p><em>Next: Chapter 16 — Built-in Services</em></p>
<h1 id="chapter-16-built-in-services">Chapter 16: Built-in Services</h1>
<p><em>“Batteries included.”</em></p>
<hr />
<h2 id="available-services">16.1 Available Services</h2>
<p>ARO provides five built-in services that handle common infrastructure
concerns: an HTTP server for serving web requests, an HTTP client for
making outbound requests, a file system service for reading and writing
files, and socket services for TCP communication.</p>
<p>These services are available without additional configuration or
dependencies. When you need to serve HTTP requests, you start the HTTP
server. When you need to make outbound API calls, you use the HTTP
client. When you need to read configuration files or write data, you use
the file system service. When you need low-level TCP communication, you
use the socket services.</p>
<p>Each service follows the same pattern of interaction. You start or
configure the service using an action, you interact with it through
subsequent actions, and you stop it during shutdown. Services that
produce events—file changes, socket messages—trigger event handlers that
you define.</p>
<p>The services are designed to be sufficient for most application needs
while remaining simple. If you need more specialized functionality, you
can create custom actions that wrap specialized libraries.</p>
<hr />
<h2 id="http-server">16.2 HTTP Server</h2>
<p>The HTTP server handles incoming HTTP requests based on your OpenAPI
specification. It provides a production-capable server built on SwiftNIO
that efficiently handles concurrent connections.</p>
<p>Starting the server is a single statement that tells the runtime to
load the OpenAPI specification, configure routes, and begin listening
for connections. The server typically starts during Application-Start
and runs until shutdown. Without the Keepalive action, the application
would start the server and immediately exit.</p>
<p>You can configure the port on which the server listens. The default
is typically port 8080, but you can specify any available port. You can
also specify a host address to control which network interfaces accept
connections—binding to “0.0.0.0” accepts connections from any interface,
while binding to “127.0.0.1” accepts only local connections.</p>
<p>Additional configuration options control request validation, timeout
behavior, maximum body size, and CORS settings. Validation tells the
server to check incoming requests against the OpenAPI schemas before
routing them to handlers. Timeout settings control how long requests can
run. CORS settings control cross-origin access for browser-based
clients.</p>
<p>Stopping the server during shutdown allows it to complete in-flight
requests gracefully. The server stops accepting new connections, waits
for existing requests to complete, and then releases resources.</p>
<hr />
<h2 id="http-client">16.3 HTTP Client</h2>
<p>The HTTP client makes outbound HTTP requests to external services. It
provides a high-performance client built on AsyncHTTPClient that handles
connection pooling, timeouts, and retries.</p>
<p>Simple GET requests use the Fetch action with a URL. The action makes
the request, waits for the response, and binds the result. You can then
extract the response body, status code, and headers.</p>
<p>POST, PUT, DELETE, and other methods use the Send action with method,
body, and header configuration. The body is serialized as JSON by
default. Headers can include authentication tokens, content type
specifications, and other metadata.</p>
<p>The client supports various configuration options. Timeout settings
control how long to wait for a response. Retry settings enable automatic
retry on transient failures. Follow redirect settings control whether
redirects are followed automatically.</p>
<p>Error handling follows the same happy path philosophy as other ARO
operations. If a request fails—connection refused, timeout, server
error—the runtime generates an appropriate error message. You do not
write explicit error handling for HTTP failures.</p>
<hr />
<h2 id="file-system-service">16.4 File System Service</h2>
<p>The file system service provides comprehensive operations for
reading, writing, and managing files and directories. It handles the
mechanics of file I/O while you focus on what data to read or write.</p>
<h3 id="reading-files">Reading Files</h3>
<p>Reading files uses the Read action with a file path. The action reads
the file contents and binds them to a result. For JSON files, the
content is parsed into a structured object. For text files, the content
is a string. The path can be relative to the application directory or
absolute.</p>
<pre class="aro"><code>&lt;Read&gt; the &lt;content&gt; from the &lt;file: &quot;./README.md&quot;&gt;.
&lt;Read&gt; the &lt;config: JSON&gt; from the &lt;file: &quot;./config.json&quot;&gt;.
&lt;Read&gt; the &lt;image: bytes&gt; from the &lt;file: &quot;./logo.png&quot;&gt;.</code></pre>
<h3 id="writing-files">Writing Files</h3>
<p>Writing files uses the Write action with data and a path. The action
serializes the data and writes it to the specified location. Parent
directories are created automatically if they do not exist.</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;report&gt; to the &lt;file: &quot;./output/report.txt&quot;&gt;.
&lt;Write&gt; the &lt;data: JSON&gt; to the &lt;file: &quot;./export.json&quot;&gt;.</code></pre>
<h3 id="appending-to-files">Appending to Files</h3>
<p>The Append action adds content to the end of an existing file,
creating the file if it does not exist.</p>
<pre class="aro"><code>&lt;Append&gt; the &lt;log-line&gt; to the &lt;file: &quot;./logs/app.log&quot;&gt;.</code></pre>
<h3 id="checking-file-existence">Checking File Existence</h3>
<p>The Exists action checks whether a file or directory exists at a
given path.</p>
<pre class="aro"><code>&lt;Exists&gt; the &lt;found&gt; for the &lt;file: &quot;./config.json&quot;&gt;.

when &lt;found&gt; is false {
    &lt;Log&gt; the &lt;warning&gt; for the &lt;console&gt; with &quot;Config not found!&quot;.
}</code></pre>
<h3 id="getting-file-information">Getting File Information</h3>
<p>The Stat action retrieves detailed metadata about a file or
directory, including size, modification dates, and permissions.</p>
<pre class="aro"><code>&lt;Stat&gt; the &lt;info&gt; for the &lt;file: &quot;./document.pdf&quot;&gt;.
&lt;Log&gt; the &lt;size&gt; for the &lt;console&gt; with &lt;info: size&gt;.
&lt;Log&gt; the &lt;modified&gt; for the &lt;console&gt; with &lt;info: modified&gt;.</code></pre>
<p>The result contains: name, path, size (bytes), isFile, isDirectory,
created, modified, accessed, and permissions.</p>
<h3 id="listing-directory-contents">Listing Directory Contents</h3>
<p>The List action retrieves the contents of a directory. You can filter
by glob pattern and list recursively.</p>
<pre class="aro"><code>(* List all files in a directory *)
&lt;Create&gt; the &lt;uploads-path&gt; with &quot;./uploads&quot;.
&lt;List&gt; the &lt;entries&gt; from the &lt;directory: uploads-path&gt;.

(* Filter with glob pattern *)
&lt;Create&gt; the &lt;src-path&gt; with &quot;./src&quot;.
&lt;List&gt; the &lt;aro-files&gt; from the &lt;directory: src-path&gt; matching &quot;*.aro&quot;.

(* List recursively *)
&lt;Create&gt; the &lt;project-path&gt; with &quot;./project&quot;.
&lt;List&gt; the &lt;all-files&gt; from the &lt;directory: project-path&gt; recursively.</code></pre>
<p>Each entry contains: name, path, size, isFile, isDirectory, and
modified.</p>
<h3 id="creating-directories">Creating Directories</h3>
<p>The CreateDirectory action creates a directory, including any
necessary parent directories.</p>
<pre class="aro"><code>&lt;CreateDirectory&gt; the &lt;output-dir&gt; to the &lt;path: &quot;./output/reports/2024&quot;&gt;.</code></pre>
<h3 id="copying-files-and-directories">Copying Files and
Directories</h3>
<p>The Copy action copies a file or directory to a new location.
Directory copies are recursive by default.</p>
<pre class="aro"><code>&lt;Copy&gt; the &lt;file: &quot;./template.txt&quot;&gt; to the &lt;destination: &quot;./copy.txt&quot;&gt;.
&lt;Copy&gt; the &lt;directory: &quot;./src&quot;&gt; to the &lt;destination: &quot;./backup/src&quot;&gt;.</code></pre>
<h3 id="moving-and-renaming">Moving and Renaming</h3>
<p>The Move action moves or renames a file or directory.</p>
<pre class="aro"><code>&lt;Move&gt; the &lt;file: &quot;./draft.txt&quot;&gt; to the &lt;destination: &quot;./final.txt&quot;&gt;.
&lt;Move&gt; the &lt;file: &quot;./inbox/report.pdf&quot;&gt; to the &lt;destination: &quot;./archive/report.pdf&quot;&gt;.</code></pre>
<h3 id="deleting-files">Deleting Files</h3>
<p>The Delete action removes a file from the file system.</p>
<pre class="aro"><code>&lt;Delete&gt; the &lt;file: &quot;./temp/cache.json&quot;&gt;.</code></pre>
<h3 id="file-watching">File Watching</h3>
<p>File watching monitors a directory for changes and emits events when
files are created, modified, or deleted. You start watching during
Application-Start by specifying the directory to monitor. When changes
occur, the runtime emits File Event events that your handlers can
process. This is useful for applications that need to react to external
file changes—configuration reloading, data import, file
synchronization.</p>
<pre class="aro"><code>&lt;Watch&gt; the &lt;file-monitor&gt; for the &lt;directory&gt; with &quot;./data&quot;.</code></pre>
<p>Event handlers are named according to the event type:
<code>Handle File Created</code>, <code>Handle File Modified</code>, or
<code>Handle File Deleted</code>.</p>
<h3 id="cross-platform-behavior">Cross-Platform Behavior</h3>
<p>File operations work consistently across macOS, Linux, and Windows.
Path separators use <code>/</code> in ARO code and are translated
appropriately for each platform. Hidden files (those starting with
<code>.</code> on Unix or with the hidden attribute on Windows) are
included in listings by default.</p>
<hr />
<h2 id="socket-services">16.5 Socket Services</h2>
<p>The socket server and client provide low-level TCP communication for
applications that need more control than HTTP offers or that need to
communicate using custom protocols.</p>
<p>The socket server listens for incoming TCP connections on a specified
port. When clients connect and send data, the runtime emits Socket Event
events. Your handlers receive the client identifier and the data, and
can send responses back to specific clients or broadcast to all
connected clients.</p>
<p>The socket client connects to remote TCP servers. You establish a
connection, send data, receive responses, and close the connection when
done. This is useful for communicating with services that use custom TCP
protocols.</p>
<p>Socket communication is lower level than HTTP. You are responsible
for message framing, serialization, and protocol handling. The services
provide the transport; you provide the protocol logic.</p>
<p>For most web applications, HTTP is the appropriate choice. Use
sockets when you need persistent connections, when you need to implement
a specific protocol, or when HTTP overhead is unacceptable for your
performance requirements.</p>
<hr />
<h2 id="service-lifecycle">16.6 Service Lifecycle</h2>
<p>Services have a lifecycle that mirrors the application lifecycle.
They start during Application-Start, run during the application’s
lifetime, and stop during Application-End.</p>
<p>Starting services is typically one of the first things you do during
startup. You start the HTTP server to begin accepting requests. You
start file monitoring to begin watching for changes. You start socket
servers to begin accepting connections.</p>
<p>After starting services, you use the Keepalive action to keep the
application running. Without it, the application would complete the
startup sequence and exit. Keepalive blocks until a shutdown signal
arrives, allowing services to process events.</p>
<p>When shutdown occurs, you stop services in your Application-End
handler. Stopping in reverse order of starting is a common
practice—resources started last are often dependencies of resources
started first, so they should be stopped first.</p>
<p>The error shutdown handler (Application-End: Error) should also stop
services, attempting best-effort cleanup even when an error has
occurred. Services might be in inconsistent states, so cleanup should be
defensive.</p>
<hr />
<h2 id="service-configuration">16.7 Service Configuration</h2>
<p>Services accept configuration options that control their behavior.
These options are passed when starting or using the service.</p>
<p>HTTP server configuration includes port and host for network binding,
validation for request checking, timeout for request duration limits,
body size limits, and CORS settings for browser access control. These
options shape how the server behaves and what requests it accepts.</p>
<p>HTTP client configuration includes timeout for response waiting,
retry for transient failure recovery, and redirect handling. These
options affect outbound request behavior.</p>
<p>File system configuration includes encoding for text handling and
directory creation settings. These options affect how files are read and
written.</p>
<p>Configuration can be hardcoded in your ARO statements or loaded from
external files during startup. Loading from external files allows
configuration to vary between environments without code changes.</p>
<hr />
<h2 id="practical-example-services-in-action">16.8 Practical Example:
Services in Action</h2>
<p>Here is a complete example demonstrating multiple built-in services
working together. This application watches a directory for configuration
changes and uses the HTTP client to report them to an external
monitoring service.</p>
<pre class="aro"><code>(* Config Monitor - Watch files and report changes via HTTP *)

(Application-Start: Config Monitor) {
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Starting configuration monitor...&quot;.

    (* Load the monitoring endpoint from environment or config *)
    &lt;Create&gt; the &lt;webhook-url&gt; with &quot;https://monitoring.example.com/webhook&quot;.

    (* Start watching the config directory *)
    &lt;Watch&gt; the &lt;file-monitor&gt; for the &lt;directory&gt; with &quot;./config&quot;.

    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Watching ./config for changes...&quot;.

    (* Keep running until shutdown signal *)
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}

(Report Config Change: File Event Handler) {
    (* Extract the changed file path *)
    &lt;Extract&gt; the &lt;path&gt; from the &lt;event: path&gt;.
    &lt;Extract&gt; the &lt;event-type&gt; from the &lt;event: type&gt;.

    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Config changed:&quot;.
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &lt;path&gt;.

    (* Build notification payload *)
    &lt;Create&gt; the &lt;notification&gt; with {
        file: &lt;path&gt;,
        change: &lt;event-type&gt;,
        timestamp: &quot;now&quot;
    }.

    (* Send to monitoring webhook *)
    &lt;Send&gt; the &lt;notification&gt; to the &lt;webhook-url&gt;.

    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Change reported to monitoring service.&quot;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;event&gt;.
}

(Application-End: Success) {
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Config monitor stopped.&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;shutdown&gt;.
}</code></pre>
<p>This example shows:</p>
<ul>
<li><strong>File system service</strong>: The <code>Watch</code> action
starts monitoring the <code>./config</code> directory</li>
<li><strong>HTTP client</strong>: The <code>Send</code> action posts
change notifications to an external webhook</li>
<li><strong>Lifecycle management</strong>: <code>Keepalive</code> keeps
the app running, <code>Application-End</code> provides graceful
shutdown</li>
<li><strong>Event handling</strong>: The File Event Handler processes
each file change event</li>
</ul>
<blockquote>
<p><strong>See also:</strong> <code>Examples/FileWatcher</code> and
<code>Examples/HTTPClient</code> for standalone examples of each
service.</p>
</blockquote>
<hr />
<h2 id="best-practices-9">16.9 Best Practices</h2>
<p>Start all services during Application-Start. Centralizing service
startup in one place makes it clear what your application depends on and
ensures consistent initialization order.</p>
<p>Stop all services during Application-End. Both success and error
handlers should attempt to stop services, releasing resources cleanly.
The error handler should be defensive because resources might be in
inconsistent states.</p>
<p>Use Keepalive for any application that runs services. Without it, the
application starts services and immediately exits. The Keepalive action
keeps the application running to process incoming events.</p>
<p>Handle service errors through event handlers when appropriate. Some
services emit error events that you can handle to log failures, attempt
recovery, or alert operators. The happy path philosophy applies, but
observability is still important.</p>
<p>Configure services appropriately for your environment. Development
might use permissive CORS settings and verbose logging. Production might
use restrictive settings and minimal logging. Load configuration from
environment-specific files rather than hardcoding.</p>
<hr />
<p><em>Next: Chapter 17 — Custom Actions</em></p>
<h1 id="chapter-16b-format-aware-file-io">Chapter 16B: Format-Aware File
I/O</h1>
<p><em>“Structured data in, structured data out.”</em></p>
<hr />
<h2 id="b.1-the-format-detection-pattern">16B.1 The Format Detection
Pattern</h2>
<p>When you write data to a file, ARO examines the file extension and
automatically serializes your data to the appropriate format. When you
read a file, ARO parses the content back into structured data. This
eliminates the boilerplate of manual serialization and
deserialization.</p>
<div style="text-align: center; margin: 2em 0;">
<svg width="500" height="120" viewBox="0 0 500 120" xmlns="http://www.w3.org/2000/svg">
<!-- Object box -->
<p><rect x="20" y="35" width="80" height="50" rx="5" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
<text x="60" y="55" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#4338ca">Structured</text>
<text x="60" y="70" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#4338ca">Data</text></p>
<!-- Arrow to detector -->
<p><line x1="100" y1="60" x2="150" y2="60" stroke="#6b7280" stroke-width="2"/>
<polygon points="150,60 142,55 142,65" fill="#6b7280"/></p>
<!-- Format detector -->
<p><rect x="150" y="30" width="100" height="60" rx="5" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="200" y="55" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#92400e">Format</text>
<text x="200" y="70" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#92400e">Detector</text></p>
<!-- Arrow to serializer -->
<p><line x1="250" y1="60" x2="300" y2="60" stroke="#6b7280" stroke-width="2"/>
<polygon points="300,60 292,55 292,65" fill="#6b7280"/></p>
<!-- Serializer -->
<p><rect x="300" y="30" width="80" height="60" rx="5" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="340" y="55" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#166534">Format</text>
<text x="340" y="70" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#166534">Serializer</text></p>
<!-- Arrow to file -->
<p><line x1="380" y1="60" x2="430" y2="60" stroke="#6b7280" stroke-width="2"/>
<polygon points="430,60 422,55 422,65" fill="#6b7280"/></p>
<!-- File icon -->
<p><rect x="430" y="35" width="50" height="50" rx="3" fill="#f3e8ff" stroke="#8b5cf6" stroke-width="2"/>
<text x="455" y="65" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#6b21a8">.json</text></p>
<!-- Extension label -->
<text x="200" y="110" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">Extension
determines format</text>
</svg>
</div>
<p>The file extension is the key. Write to <code>users.json</code> and
get JSON. Write to <code>users.csv</code> and get CSV. Write to
<code>users.yaml</code> and get YAML. The same data, formatted
appropriately for each destination.</p>
<pre class="aro"><code>(* Same data, three different formats *)
&lt;Write&gt; the &lt;users&gt; to &quot;./output/users.json&quot;.
&lt;Write&gt; the &lt;users&gt; to &quot;./output/users.csv&quot;.
&lt;Write&gt; the &lt;users&gt; to &quot;./output/users.yaml&quot;.</code></pre>
<p>This pattern follows ARO’s philosophy of reducing ceremony. The file
path already tells you the intended format. Making you specify it again
would be redundant.</p>
<hr />
<h2 id="b.2-supported-formats">16B.2 Supported Formats</h2>
<p>ARO supports thirteen file formats out of the box. Each format has
specific characteristics that make it suitable for different use
cases.</p>
<table>
<colgroup>
<col style="width: 37%" />
<col style="width: 27%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th>Extension</th>
<th>Format</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>.json</code></td>
<td>JSON</td>
<td>APIs, configuration, data exchange</td>
</tr>
<tr>
<td><code>.jsonl</code>, <code>.ndjson</code></td>
<td>JSON Lines</td>
<td>Streaming, logging, large datasets</td>
</tr>
<tr>
<td><code>.yaml</code>, <code>.yml</code></td>
<td>YAML</td>
<td>Human-readable configuration</td>
</tr>
<tr>
<td><code>.toml</code></td>
<td>TOML</td>
<td>Application configuration</td>
</tr>
<tr>
<td><code>.xml</code></td>
<td>XML</td>
<td>Legacy systems, enterprise integration</td>
</tr>
<tr>
<td><code>.csv</code></td>
<td>CSV</td>
<td>Spreadsheets, data import/export</td>
</tr>
<tr>
<td><code>.tsv</code></td>
<td>TSV</td>
<td>Tab-delimited data</td>
</tr>
<tr>
<td><code>.md</code></td>
<td>Markdown</td>
<td>Documentation tables</td>
</tr>
<tr>
<td><code>.html</code>, <code>.htm</code></td>
<td>HTML</td>
<td>Web output, reports</td>
</tr>
<tr>
<td><code>.txt</code></td>
<td>Plain Text</td>
<td>Simple key-value data</td>
</tr>
<tr>
<td><code>.sql</code></td>
<td>SQL</td>
<td>Database backup, migration</td>
</tr>
<tr>
<td><code>.log</code></td>
<td>Log</td>
<td>Application logs, audit trails</td>
</tr>
<tr>
<td><code>.env</code></td>
<td>Environment</td>
<td>Configuration with uppercase keys</td>
</tr>
<tr>
<td><code>.obj</code> or unknown</td>
<td>Binary</td>
<td>Raw data, unknown formats</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="b.3-writing-structured-data">16B.3 Writing Structured Data</h2>
<p>The Write action serializes your data according to the file
extension. Each format has its own serialization rules.</p>
<h3 id="json-and-json-lines">JSON and JSON Lines</h3>
<p>JSON is the most common format for structured data. ARO produces
pretty-printed JSON with sorted keys for consistency and
readability.</p>
<pre class="aro"><code>&lt;Create&gt; the &lt;users&gt; with [
    { &quot;id&quot;: 1, &quot;name&quot;: &quot;Alice&quot;, &quot;email&quot;: &quot;alice@example.com&quot; },
    { &quot;id&quot;: 2, &quot;name&quot;: &quot;Bob&quot;, &quot;email&quot;: &quot;bob@example.com&quot; }
].

&lt;Write&gt; the &lt;users&gt; to &quot;./output/users.json&quot;.</code></pre>
<p><strong>Output (users.json):</strong></p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;email&quot;</span><span class="fu">:</span> <span class="st">&quot;alice@example.com&quot;</span><span class="fu">,</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Alice&quot;</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;email&quot;</span><span class="fu">:</span> <span class="st">&quot;bob@example.com&quot;</span><span class="fu">,</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Bob&quot;</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div>
<p>JSON Lines (<code>.jsonl</code> or <code>.ndjson</code>) writes one
JSON object per line with no extra whitespace. This format is ideal for
streaming and logging because each line is independently parseable.</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;events&gt; to &quot;./logs/events.jsonl&quot;.</code></pre>
<p><strong>Output (events.jsonl):</strong></p>
<pre><code>{&quot;email&quot;:&quot;alice@example.com&quot;,&quot;id&quot;:1,&quot;name&quot;:&quot;Alice&quot;}
{&quot;email&quot;:&quot;bob@example.com&quot;,&quot;id&quot;:2,&quot;name&quot;:&quot;Bob&quot;}</code></pre>
<h3 id="yaml-and-toml">YAML and TOML</h3>
<p>YAML produces human-readable output that is easy to edit by hand. It
uses indentation to show structure and avoids the visual noise of
brackets and quotes.</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;config&gt; to &quot;./settings.yaml&quot;.</code></pre>
<p><strong>Output (settings.yaml):</strong></p>
<div class="sourceCode" id="cb93"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at">   </span><span class="fu">email</span><span class="kw">:</span><span class="at"> alice@example.com</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">id</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Alice</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at">   </span><span class="fu">email</span><span class="kw">:</span><span class="at"> bob@example.com</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">id</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Bob</span></span></code></pre></div>
<p>TOML is similar but uses explicit section headers. It is particularly
popular for application configuration files.</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;users&gt; to &quot;./config/users.toml&quot;.</code></pre>
<p><strong>Output (users.toml):</strong></p>
<div class="sourceCode" id="cb95"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[[users]]</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="dt">id</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">&quot;Alice&quot;</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="dt">email</span> <span class="op">=</span> <span class="st">&quot;alice@example.com&quot;</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[[users]]</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="dt">id</span> <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">&quot;Bob&quot;</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a><span class="dt">email</span> <span class="op">=</span> <span class="st">&quot;bob@example.com&quot;</span></span></code></pre></div>
<h3 id="csv-and-tsv">CSV and TSV</h3>
<p>Comma-separated values (CSV) is the universal format for spreadsheet
data. ARO writes a header row with field names, followed by data
rows.</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;report&gt; to &quot;./export/report.csv&quot;.</code></pre>
<p><strong>Output (report.csv):</strong></p>
<pre><code>email,id,name
alice@example.com,1,Alice
bob@example.com,2,Bob</code></pre>
<p>Tab-separated values (TSV) works the same way but uses tabs instead
of commas. This is useful when your data contains commas.</p>
<p>Values containing the delimiter character, quotes, or newlines are
automatically escaped with quotes.</p>
<h3 id="xml">XML</h3>
<p>XML output uses the variable name from your Write statement as the
root element. This provides meaningful document structure without
requiring additional configuration.</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;users&gt; to &quot;./data/users.xml&quot;.</code></pre>
<p><strong>Output (users.xml):</strong></p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode xml"><code class="sourceCode xml"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">&lt;?xml</span><span class="ot"> version=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> encoding=</span><span class="st">&quot;UTF-8&quot;</span><span class="fu">?&gt;</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">users</span>&gt;</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">item</span>&gt;</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">id</span>&gt;1&lt;/<span class="kw">id</span>&gt;</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">name</span>&gt;Alice&lt;/<span class="kw">name</span>&gt;</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">email</span>&gt;alice@example.com&lt;/<span class="kw">email</span>&gt;</span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">item</span>&gt;</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">item</span>&gt;</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">id</span>&gt;2&lt;/<span class="kw">id</span>&gt;</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">name</span>&gt;Bob&lt;/<span class="kw">name</span>&gt;</span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">email</span>&gt;bob@example.com&lt;/<span class="kw">email</span>&gt;</span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">item</span>&gt;</span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">users</span>&gt;</span></code></pre></div>
<p>Notice how <code>&lt;users&gt;</code> becomes the root element
because that was the variable name in the Write statement.</p>
<h3 id="markdown-and-html">Markdown and HTML</h3>
<p>Markdown produces pipe-delimited tables suitable for documentation.
HTML produces properly structured tables with thead and tbody
elements.</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;summary&gt; to &quot;./docs/summary.md&quot;.
&lt;Write&gt; the &lt;report&gt; to &quot;./output/report.html&quot;.</code></pre>
<p><strong>Markdown output:</strong></p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> id <span class="pp">|</span> name <span class="pp">|</span> email <span class="pp">|</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="pp">|----|------|-------|</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> 1 <span class="pp">|</span> Alice <span class="pp">|</span> alice@example.com <span class="pp">|</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> 2 <span class="pp">|</span> Bob <span class="pp">|</span> bob@example.com <span class="pp">|</span></span></code></pre></div>
<h3 id="sql">SQL</h3>
<p>SQL output produces INSERT statements for database migration or
backup. The table name comes from the variable name.</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;users&gt; to &quot;./backup/users.sql&quot;.</code></pre>
<p><strong>Output (users.sql):</strong></p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode sql"><code class="sourceCode sql"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> users (<span class="kw">id</span>, name, email) <span class="kw">VALUES</span> (<span class="dv">1</span>, <span class="st">&#39;Alice&#39;</span>, <span class="st">&#39;alice@example.com&#39;</span>);</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> users (<span class="kw">id</span>, name, email) <span class="kw">VALUES</span> (<span class="dv">2</span>, <span class="st">&#39;Bob&#39;</span>, <span class="st">&#39;bob@example.com&#39;</span>);</span></code></pre></div>
<p>String values are properly escaped to prevent SQL injection in the
output.</p>
<h3 id="log">Log</h3>
<p>Log output produces date-prefixed entries, ideal for application logs
and audit trails. Each entry receives an ISO8601 timestamp.</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;message&gt; to &quot;./app.log&quot; with &quot;Server started&quot;.
&lt;Append&gt; the &lt;entry&gt; to &quot;./app.log&quot; with &quot;User logged in&quot;.</code></pre>
<p><strong>Output (app.log):</strong></p>
<pre><code>2025-12-29T10:30:45Z: Server started
2025-12-29T10:30:46Z: User logged in</code></pre>
<p>When writing an array, each element becomes a separate log entry:</p>
<pre class="aro"><code>&lt;Create&gt; the &lt;events&gt; with [&quot;Startup complete&quot;, &quot;Listening on port 8080&quot;].
&lt;Write&gt; the &lt;events&gt; to &quot;./events.log&quot;.</code></pre>
<p><strong>Output:</strong></p>
<pre><code>2025-12-29T10:30:45Z: Startup complete
2025-12-29T10:30:45Z: Listening on port 8080</code></pre>
<h3 id="environment-files">Environment Files</h3>
<p>Environment files use KEY=VALUE format with uppercase keys. Nested
objects are flattened with underscore separators.</p>
<pre class="aro"><code>&lt;Create&gt; the &lt;config&gt; with {
    &quot;database&quot;: { &quot;host&quot;: &quot;localhost&quot;, &quot;port&quot;: 5432 },
    &quot;apiKey&quot;: &quot;secret123&quot;
}.
&lt;Write&gt; the &lt;config&gt; to &quot;./.env&quot;.</code></pre>
<p><strong>Output (.env):</strong></p>
<pre><code>API_KEY=secret123
DATABASE_HOST=localhost
DATABASE_PORT=5432</code></pre>
<p>Environment files can also be read back:</p>
<pre class="aro"><code>&lt;Read&gt; the &lt;settings&gt; from &quot;./.env&quot;.
(* Returns { &quot;API_KEY&quot;: &quot;secret123&quot;, &quot;DATABASE_HOST&quot;: &quot;localhost&quot;, ... } *)</code></pre>
<h3 id="plain-text">Plain Text</h3>
<p>Plain text output produces key=value pairs, one per line. Nested
objects use dot notation.</p>
<pre class="aro"><code>&lt;Create&gt; the &lt;config&gt; with { &quot;host&quot;: &quot;localhost&quot;, &quot;port&quot;: 8080, &quot;debug&quot;: true }.
&lt;Write&gt; the &lt;config&gt; to &quot;./output/config.txt&quot;.</code></pre>
<p><strong>Output (config.txt):</strong></p>
<pre><code>host=localhost
port=8080
debug=true</code></pre>
<hr />
<h2 id="b.4-reading-structured-data">16B.4 Reading Structured Data</h2>
<p>Reading files reverses the process. ARO examines the file extension
and parses the content into structured data that you can work with.</p>
<div style="text-align: center; margin: 2em 0;">
<svg width="500" height="120" viewBox="0 0 500 120" xmlns="http://www.w3.org/2000/svg">
<!-- File icon -->
<p><rect x="20" y="35" width="50" height="50" rx="3" fill="#f3e8ff" stroke="#8b5cf6" stroke-width="2"/>
<text x="45" y="65" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#6b21a8">.csv</text></p>
<!-- Arrow to detector -->
<p><line x1="70" y1="60" x2="120" y2="60" stroke="#6b7280" stroke-width="2"/>
<polygon points="120,60 112,55 112,65" fill="#6b7280"/></p>
<!-- Format detector -->
<p><rect x="120" y="30" width="100" height="60" rx="5" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="170" y="55" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#92400e">Format</text>
<text x="170" y="70" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#92400e">Detector</text></p>
<!-- Arrow to parser -->
<p><line x1="220" y1="60" x2="270" y2="60" stroke="#6b7280" stroke-width="2"/>
<polygon points="270,60 262,55 262,65" fill="#6b7280"/></p>
<!-- Parser -->
<p><rect x="270" y="30" width="80" height="60" rx="5" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="310" y="55" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#166534">Format</text>
<text x="310" y="70" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#166534">Parser</text></p>
<!-- Arrow to object -->
<p><line x1="350" y1="60" x2="400" y2="60" stroke="#6b7280" stroke-width="2"/>
<polygon points="400,60 392,55 392,65" fill="#6b7280"/></p>
<!-- Object box -->
<p><rect x="400" y="35" width="80" height="50" rx="5" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
<text x="440" y="55" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#4338ca">Structured</text>
<text x="440" y="70" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#4338ca">Data</text></p>
<!-- Extension label -->
<text x="170" y="110" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#6b7280">Extension
determines parser</text>
</svg>
</div>
<pre class="aro"><code>(* JSON becomes object or array *)
&lt;Read&gt; the &lt;config&gt; from &quot;./settings.json&quot;.

(* JSONL becomes array of objects *)
&lt;Read&gt; the &lt;events&gt; from &quot;./logs/events.jsonl&quot;.

(* CSV becomes array with headers as keys *)
&lt;Read&gt; the &lt;records&gt; from &quot;./data.csv&quot;.

(* YAML becomes object or array *)
&lt;Read&gt; the &lt;settings&gt; from &quot;./config.yaml&quot;.</code></pre>
<p>Each format parses to an appropriate data structure:</p>
<table>
<thead>
<tr>
<th>Format</th>
<th>Parses To</th>
</tr>
</thead>
<tbody>
<tr>
<td>JSON</td>
<td>Object or Array</td>
</tr>
<tr>
<td>JSON Lines</td>
<td>Array of Objects</td>
</tr>
<tr>
<td>YAML</td>
<td>Object or Array</td>
</tr>
<tr>
<td>TOML</td>
<td>Object</td>
</tr>
<tr>
<td>XML</td>
<td>Object (nested)</td>
</tr>
<tr>
<td>CSV</td>
<td>Array of Objects</td>
</tr>
<tr>
<td>TSV</td>
<td>Array of Objects</td>
</tr>
<tr>
<td>Plain Text</td>
<td>Object</td>
</tr>
<tr>
<td>Environment</td>
<td>Object</td>
</tr>
<tr>
<td>Binary</td>
<td>Raw Data</td>
</tr>
</tbody>
</table>
<h3 id="bypassing-format-detection">Bypassing Format Detection</h3>
<p>Sometimes you want to read a file as raw text without parsing. Use
the <code>String</code> qualifier to bypass format detection:</p>
<pre class="aro"><code>(* Parse JSON to structured data *)
&lt;Read&gt; the &lt;config&gt; from &quot;./settings.json&quot;.

(* Read raw JSON as string - no parsing *)
&lt;Read&gt; the &lt;raw-json: String&gt; from &quot;./settings.json&quot;.</code></pre>
<p>This is useful when you need to inspect the raw content or pass it to
an external system without modification.</p>
<hr />
<h2 id="b.5-csv-and-tsv-options">16B.5 CSV and TSV Options</h2>
<p>CSV and TSV formats support additional configuration options. These
options control how data is formatted when writing and how content is
parsed when reading.</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>delimiter</code></td>
<td>String</td>
<td><code>,</code> (CSV) / <code>\t</code> (TSV)</td>
<td>Field separator</td>
</tr>
<tr>
<td><code>header</code></td>
<td>Boolean</td>
<td><code>true</code></td>
<td>Include/expect header row</td>
</tr>
<tr>
<td><code>quote</code></td>
<td>String</td>
<td><code>"</code></td>
<td>Quote character</td>
</tr>
</tbody>
</table>
<h3 id="custom-delimiter">Custom Delimiter</h3>
<p>Some systems use semicolons or other characters as field
separators:</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;data&gt; to &quot;./export.csv&quot; with { delimiter: &quot;;&quot; }.</code></pre>
<h3 id="header-row-control">Header Row Control</h3>
<p>You can suppress the header row when writing:</p>
<pre class="aro"><code>&lt;Write&gt; the &lt;data&gt; to &quot;./export.csv&quot; with { header: false }.</code></pre>
<p>When reading, if your CSV has no header row, specify this so the
parser knows to treat the first line as data:</p>
<pre class="aro"><code>&lt;Read&gt; the &lt;data&gt; from &quot;./import.csv&quot; with { header: false }.</code></pre>
<hr />
<h2 id="b.6-round-trip-patterns">16B.6 Round-Trip Patterns</h2>
<p>A common pattern is reading data from one format and writing to
another. ARO makes this seamless because the data structure is
format-independent.</p>
<h3 id="data-transformation-pipeline">Data Transformation Pipeline</h3>
<pre class="aro"><code>(Application-Start: Data Transformer) {
    (* Read from CSV *)
    &lt;Read&gt; the &lt;records&gt; from &quot;./input/data.csv&quot;.

    (* Process the data *)
    &lt;Log&gt; the &lt;count&gt; for the &lt;console&gt; with &quot;Processing records...&quot;.

    (* Write to multiple formats *)
    &lt;Write&gt; the &lt;records&gt; to &quot;./output/data.json&quot;.
    &lt;Write&gt; the &lt;records&gt; to &quot;./output/data.yaml&quot;.
    &lt;Write&gt; the &lt;records&gt; to &quot;./output/report.md&quot;.

    &lt;Log&gt; the &lt;done&gt; for the &lt;console&gt; with &quot;Transformation complete!&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;transform&gt;.
}</code></pre>
<h3 id="multi-format-export">Multi-Format Export</h3>
<p>When you need to provide data in multiple formats for different
consumers:</p>
<pre class="aro"><code>(exportData: Export API) {
    &lt;Retrieve&gt; the &lt;users&gt; from the &lt;user-repository&gt;.

    (* Web API consumers get JSON *)
    &lt;Write&gt; the &lt;users&gt; to &quot;./export/users.json&quot;.

    (* Analysts get CSV for spreadsheets *)
    &lt;Write&gt; the &lt;users&gt; to &quot;./export/users.csv&quot;.

    (* Documentation gets Markdown *)
    &lt;Write&gt; the &lt;users&gt; to &quot;./docs/users.md&quot;.

    (* Archive gets SQL for database restore *)
    &lt;Write&gt; the &lt;users&gt; to &quot;./backup/users.sql&quot;.

    &lt;Return&gt; an &lt;OK: status&gt; with &quot;Exported to 4 formats&quot;.
}</code></pre>
<hr />
<h2 id="b.7-best-practices">16B.7 Best Practices</h2>
<p><strong>Choose the right format for your use case.</strong> JSON and
YAML are best for configuration and API data. CSV is best for
spreadsheet workflows. JSON Lines is best for logging and streaming. SQL
is best for database backup.</p>
<p><strong>Use consistent extensions.</strong> Stick to standard
extensions like <code>.json</code>, <code>.yaml</code>,
<code>.csv</code>. Avoid custom extensions unless you need binary format
handling.</p>
<p><strong>Consider human readability.</strong> YAML and Markdown are
easy to read and edit by hand. JSON and XML preserve structure but are
harder to edit manually.</p>
<p><strong>Handle round-trips carefully.</strong> Some formats lose
information during round-trips. Markdown tables become strings when read
back. SQL output cannot be parsed back into objects. Plan your data flow
accordingly.</p>
<p><strong>Use JSON Lines for large datasets.</strong> Regular JSON must
be fully loaded into memory. JSON Lines can be processed line by line,
making it suitable for large files and streaming scenarios.</p>
<hr />
<p><em>Next: Chapter 17 — Custom Actions</em></p>
<h1 id="chapter-17-custom-actions">Chapter 17: Custom Actions</h1>
<p><em>“When 24 actions aren’t enough, write your own.”</em></p>
<hr />
<h2 id="when-to-create-custom-actions">17.1 When to Create Custom
Actions</h2>
<p>ARO’s built-in actions cover common operations, but real applications
often need capabilities beyond the standard set. Custom actions extend
the language with domain-specific operations while maintaining ARO’s
declarative style.</p>
<p>Create custom actions when you need to integrate with external
services. Database drivers, message queues, third-party APIs, and
specialized protocols all require code that cannot be expressed in ARO
alone. A custom action wraps the integration logic and exposes it
through a clean verb in your ARO code.</p>
<p>Create custom actions when you need complex business logic that does
not fit ARO’s linear statement model. Algorithms, complex validations,
recursive processing, and stateful operations are better expressed in
Swift. The custom action handles the complexity; the ARO statement
expresses the intent.</p>
<p>Create custom actions when you want to wrap existing Swift or
Objective-C libraries. Rich ecosystems of libraries exist for image
processing, machine learning, cryptography, and countless other domains.
Custom actions bridge these libraries into ARO.</p>
<p>Create custom actions when you want domain-specific operations that
make your ARO code more expressive. Instead of multiple generic
statements, a single statement with a domain-specific verb can express
complex operations clearly.</p>
<hr />
<h2 id="the-escape-hatch-pattern">17.2 The Escape Hatch Pattern</h2>
<p>No constrained language survives contact with reality without an
extension mechanism. This is the pattern that made other constrained
languages successful: Terraform has providers, Ansible has modules, Make
has recipes—and ARO has actions and services.</p>
<p>The contract is clear: ARO gives you rails; you build the track
extensions when the rails don’t go where you need.</p>
<p>ARO provides two extension mechanisms:</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 32%" />
<col style="width: 18%" />
<col style="width: 23%" />
</colgroup>
<thead>
<tr>
<th>Mechanism</th>
<th>What It Adds</th>
<th>Syntax</th>
<th>Best For</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Custom Actions</strong></td>
<td>New verbs</td>
<td><code>&lt;Geocode&gt; the &lt;coords&gt; from &lt;addr&gt;.</code></td>
<td>Domain-specific operations</td>
</tr>
<tr>
<td><strong>Custom Services</strong></td>
<td>External integrations</td>
<td><code>&lt;Call&gt; from &lt;postgres: query&gt;</code></td>
<td>Systems with multiple methods</td>
</tr>
</tbody>
</table>
<p>Custom actions, covered in this chapter, let you add new verbs to the
language. When you implement a custom action, you can write statements
like
<code>&lt;Geocode&gt; the &lt;coordinates&gt; from the &lt;address&gt;</code>
that feel native to ARO.</p>
<p>Custom services, covered in Chapter 17B, let you integrate external
systems through the <code>Call</code> action. Services provide multiple
methods under a single service name:
<code>&lt;Call&gt; from &lt;postgres: query&gt;</code>,
<code>&lt;Call&gt; from &lt;postgres: insert&gt;</code>.</p>
<p>Plugins, covered in Chapter 18, let you package and share both
actions and services with the community.</p>
<p>The rest of this chapter focuses on implementing custom actions—the
fundamental building block of ARO’s extensibility.</p>
<hr />
<h2 id="the-action-protocol">17.3 The Action Protocol</h2>
<p>Every custom action implements the ActionImplementation protocol.
This protocol defines the structure that the runtime expects: a role
indicating data flow direction, a set of verbs that trigger the action,
valid prepositions that can appear with the action, and an execute
method that performs the work.</p>
<p>The role categorizes the action by its data flow direction. REQUEST
actions bring data from outside the feature set inward—fetching from
APIs, querying databases, reading external state. OWN actions transform
data already present in the feature set—computing, validating,
reformatting. RESPONSE actions send data out and terminate
execution—returning results, throwing errors. EXPORT actions send data
out without terminating—storing, emitting events, logging.</p>
<p>The verbs set contains the words that trigger this action. When the
parser sees one of these verbs in an action statement, it resolves to
this action implementation. Choose verbs that read naturally and
describe what the action does. A geocoding action might use “Geocode” as
its verb.</p>
<p>The valid prepositions set constrains how the action can be used
syntactically. If your action makes sense with “from” (extracting from a
source) but not “into” (inserting into a destination), include only
“from” in the valid prepositions. This helps catch misuse at parse
time.</p>
<p>The execute method does the actual work. It receives descriptors for
the result and object from the statement, plus an execution context that
provides access to bound values and methods for binding new values.</p>
<hr />
<h2 id="accessing-the-context">17.4 Accessing the Context</h2>
<p>The execution context is your interface to the ARO runtime. Through
it, you access values bound by previous statements, bind new values for
subsequent statements, and interact with the event system.</p>
<p>Getting values retrieves bindings created by earlier statements. The
require method returns a value and throws if the binding does not
exist—use this for required inputs. The get method returns an optional
value—use this for optional inputs where missing values are
acceptable.</p>
<p>Setting values creates bindings that subsequent statements can
access. The bind method associates a value with a name. You typically
bind the result using the identifier from the result descriptor, but you
can bind additional values if your action produces multiple outputs.</p>
<p>The object descriptor contains information about the statement’s
object clause. The identifier is the object name. The qualifier, if
present, is the path after the object name. For a statement referencing
“user: address”, the identifier is “user” and the qualifier is
“address”.</p>
<p>The event bus is accessible through the context for emitting events.
Your action can emit domain events that trigger handlers elsewhere in
the application.</p>
<hr />
<h2 id="implementing-an-action">17.5 Implementing an Action</h2>
<p>Implementing a custom action follows a consistent pattern. You define
a struct that conforms to ActionImplementation, specify the required
static properties, and implement the execute method.</p>
<p>Begin by choosing an appropriate role based on what the action does
with data. If it pulls data from an external source, use REQUEST. If it
transforms existing data, use OWN. If it sends data out and ends
execution, use RESPONSE. If it has side effects but allows execution to
continue, use EXPORT.</p>
<p>Choose verbs that describe the action clearly. The verb appears in
ARO statements, so it should read naturally. For a geocoding service,
“Geocode” is clear. For a payment processor, “Charge” or
“ProcessPayment” might work.</p>
<p>Specify which prepositions make sense for your action. Think about
how the statement will read. “Geocode the coordinates from the address”
suggests “from” is appropriate. “Encrypt the ciphertext with the key”
suggests “with” is appropriate.</p>
<p>In the execute method, retrieve inputs from the context, perform your
operation, bind outputs, and return the primary result. Handle errors by
throwing exceptions—the runtime converts these to ARO error
messages.</p>
<hr />
<h2 id="error-handling">17.6 Error Handling</h2>
<p>Custom actions report errors by throwing Swift exceptions. The
runtime catches these exceptions and converts them to ARO error messages
that follow the happy path philosophy.</p>
<p>Throw descriptive errors that explain what went wrong. Include
relevant values in the error message so users can understand the
failure. “Cannot geocode address ‘invalid street’: service returned no
results” is more helpful than “Geocoding failed.”</p>
<p>Consider the different failure modes your action might encounter.
Network errors, validation failures, resource not found, permission
denied—each deserves a distinct error message. Users who see these
messages should understand both what happened and, ideally, what they
might do about it.</p>
<p>The runtime integrates your errors with its error handling system.
HTTP handlers convert errors to appropriate status codes. Logging
includes the full error context. The error message you throw becomes
part of the user-visible output.</p>
<hr />
<h2 id="async-operations">17.7 Async Operations</h2>
<p>Custom actions can be asynchronous, which is essential for I/O
operations. The execute method is declared async, so you can await async
operations within it.</p>
<p>Network requests, database queries, file operations, and external API
calls should all use async/await rather than blocking. This allows the
runtime to handle other work while waiting for I/O to complete.</p>
<p>Swift’s async/await syntax integrates naturally. You await async
calls, handle their results, and proceed. The ARO runtime manages the
execution, ensuring that statement ordering is maintained even with
concurrent underlying operations.</p>
<p>Timeouts and cancellation should be considered for long-running
operations. If your action might take a long time, consider implementing
timeout logic or checking for cancellation signals.</p>
<hr />
<h2 id="thread-safety">17.8 Thread Safety</h2>
<p>Actions must be thread-safe because the runtime may execute them
concurrently. Swift’s Sendable protocol, which ActionImplementation
requires, helps enforce this.</p>
<p>Design actions to be stateless when possible. Actions that store
state between invocations create potential for race conditions. If state
is necessary, use appropriate synchronization mechanisms.</p>
<p>Dependencies like database connection pools or HTTP clients should be
thread-safe. Most well-designed Swift libraries provide thread-safe
interfaces. If you are uncertain about a dependency’s thread safety,
consult its documentation.</p>
<p>Avoid mutable shared state. If your action needs configuration,
receive it during initialization and store it immutably. If your action
needs to accumulate results, use the context’s binding mechanism rather
than internal state.</p>
<hr />
<h2 id="registration">17.9 Registration</h2>
<p>Custom actions must be registered with the action registry before
they can be used. Registration tells the runtime which action
implementation handles which verbs.</p>
<p>Registration typically happens during application initialization,
before any ARO code executes. For embedded applications, you register
actions in your Swift startup code. For plugin-based actions, the plugin
system handles registration.</p>
<p>Registration is straightforward: you call the register method on the
shared action registry, passing your action type. The runtime examines
the type’s static properties to learn its verbs and incorporates it into
action resolution.</p>
<p>Once registered, your action’s verbs become available in ARO code.
Statements using those verbs route to your implementation. The
integration is seamless—users of your action need not know whether it is
built-in or custom.</p>
<hr />
<h2 id="best-practices-10">17.10 Best Practices</h2>
<p>Single responsibility keeps actions focused and testable. Each action
should do one thing well. If an action is doing multiple distinct
operations, consider splitting it into multiple actions.</p>
<p>Choose verbs that read naturally in ARO statements. The statement
“Geocode the coordinates from the address” should sound like a sentence
describing what happens. Avoid generic verbs like “Process” or “Handle”
that do not convey meaning.</p>
<p>Provide helpful error messages. When your action fails, users see
your error message. Invest effort in making these messages clear and
actionable.</p>
<p>Document your actions. Other developers using your actions need to
know what verbs are available, what prepositions are valid, what inputs
are expected, and what outputs are produced. This documentation might
live in code comments, separate documentation files, or both.</p>
<p>Test actions independently. Because actions have a well-defined
interface, they are straightforward to unit test. Create mock contexts,
invoke the execute method, and verify the results.</p>
<hr />
<p><em>Next: Chapter 17B — Custom Services</em></p>
<h1 id="chapter-17b-custom-services">Chapter 17B: Custom Services</h1>
<p><em>“When you need to talk to the outside world.”</em></p>
<hr />
<h2 id="b.1-actions-vs-services-the-key-distinction">17B.1 Actions vs
Services: The Key Distinction</h2>
<p>Before diving into custom services, it is essential to understand how
they differ from custom actions. This distinction shapes how you design
extensions to ARO.</p>
<p><strong>Custom Actions</strong> add new verbs to the language. When
you create a custom action, you define a new way of expressing intent.
The Geocode action lets you write
<code>&lt;Geocode&gt; the &lt;coordinates&gt; from the &lt;address&gt;</code>.
The verb “Geocode” becomes part of your ARO vocabulary.</p>
<p><strong>Custom Services</strong> are external integrations invoked
through the <code>&lt;Call&gt;</code> action. Services do not add new
verbs—they add new capabilities accessible through the existing Call
verb. You write
<code>&lt;Call&gt; the &lt;result&gt; from the &lt;postgres: query&gt;</code>
to invoke the postgres service’s query method.</p>
<p>The pattern reveals the distinction:</p>
<pre class="aro"><code>(* Custom Action - new verb *)
&lt;Geocode&gt; the &lt;coordinates&gt; from the &lt;address&gt;.

(* Custom Service - Call verb with service:method *)
&lt;Call&gt; the &lt;users&gt; from the &lt;postgres: query&gt; with { sql: &quot;SELECT * FROM users&quot; }.</code></pre>
<h3 id="when-to-use-each">When to Use Each</h3>
<table style="width:100%;">
<colgroup>
<col style="width: 43%" />
<col style="width: 34%" />
<col style="width: 21%" />
</colgroup>
<thead>
<tr>
<th>Use Case</th>
<th>Choose</th>
<th>Why</th>
</tr>
</thead>
<tbody>
<tr>
<td>Domain-specific operation that feels like a language feature</td>
<td>Action</td>
<td>Reads naturally:
<code>&lt;Validate&gt; the &lt;order&gt;</code></td>
</tr>
<tr>
<td>External system integration (database, queue, API)</td>
<td>Service</td>
<td>Uniform pattern:
<code>&lt;Call&gt; from &lt;service: method&gt;</code></td>
</tr>
<tr>
<td>Reusable across many projects</td>
<td>Service</td>
<td>Services are more portable</td>
</tr>
<tr>
<td>Single, focused operation</td>
<td>Action</td>
<td>Cleaner syntax for one thing</td>
</tr>
<tr>
<td>Multiple related operations</td>
<td>Service</td>
<td>One service, many methods</td>
</tr>
</tbody>
</table>
<h3 id="the-design-philosophy">The Design Philosophy</h3>
<p>Actions extend the language. Services extend the runtime.</p>
<p>When you add an action, you are saying “this operation is so
fundamental to my domain that it deserves its own verb.” A payment
system might have <code>&lt;Charge&gt;</code>,
<code>&lt;Refund&gt;</code>, and <code>&lt;Authorize&gt;</code> as
actions because these are core operations that should read as naturally
as built-in actions.</p>
<p>When you add a service, you are saying “this external system provides
capabilities my application needs.” A database driver, message queue
client, or cloud storage integration are services because they wrap
external systems with multiple operations.</p>
<hr />
<h2 id="b.2-the-service-protocol">17B.2 The Service Protocol</h2>
<p>Services implement the <code>AROService</code> protocol. This
protocol defines the contract between your service and the ARO
runtime.</p>
<div class="sourceCode" id="cb121"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">protocol</span> AROService<span class="op">:</span> <span class="dt">Sendable</span> <span class="op">{</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Service name used in ARO code (e.g., &quot;postgres&quot;, &quot;redis&quot;)</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">var</span> <span class="va">name</span><span class="op">:</span> String <span class="op">{</span> <span class="kw">get</span> <span class="op">}</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Initialize the service</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">init</span><span class="op">()</span> <span class="kw">throws</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Execute a method call</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">call</span><span class="op">(</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">_</span> <span class="va">method</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">args</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">any</span> <span class="va">Sendable</span>]</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">any</span> <span class="fu">Sendable</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Cleanup resources (optional)</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">func</span> <span class="fu">shutdown</span><span class="op">()</span> <span class="fu">async</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The protocol is simpler than ActionImplementation because services
have a uniform invocation pattern. All service calls go through the
<code>call</code> method; the method parameter distinguishes different
operations.</p>
<hr />
<h2 id="b.3-implementing-a-service">17B.3 Implementing a Service</h2>
<p>Let us build a PostgreSQL service to illustrate the implementation
pattern.</p>
<h3 id="step-1-define-the-service-structure">Step 1: Define the Service
Structure</h3>
<div class="sourceCode" id="cb122"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">PostgresNIO</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">struct</span> PostgresService<span class="op">:</span> <span class="dt">AROService</span> <span class="op">{</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">let</span> <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;postgres&quot;</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">pool</span><span class="op">:</span> PostgresConnectionPool</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">init</span><span class="op">()</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load configuration from environment</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">config</span> <span class="op">=</span> PostgresConnection<span class="op">.</span>Configuration<span class="op">(</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>            host<span class="op">:</span> ProcessInfo<span class="op">.</span>processInfo<span class="op">.</span>environment<span class="op">[</span><span class="st">&quot;DB_HOST&quot;</span><span class="op">]</span> <span class="op">??</span> <span class="st">&quot;localhost&quot;</span><span class="op">,</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>            port<span class="op">:</span> Int<span class="op">(</span>ProcessInfo<span class="op">.</span>processInfo<span class="op">.</span>environment<span class="op">[</span><span class="st">&quot;DB_PORT&quot;</span><span class="op">]</span> <span class="op">??</span> <span class="st">&quot;5432&quot;</span><span class="op">)</span> <span class="op">??</span> <span class="dv">5432</span><span class="op">,</span></span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>            username<span class="op">:</span> ProcessInfo<span class="op">.</span>processInfo<span class="op">.</span>environment<span class="op">[</span><span class="st">&quot;DB_USER&quot;</span><span class="op">]</span> <span class="op">??</span> <span class="st">&quot;postgres&quot;</span><span class="op">,</span></span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>            password<span class="op">:</span> ProcessInfo<span class="op">.</span>processInfo<span class="op">.</span>environment<span class="op">[</span><span class="st">&quot;DB_PASSWORD&quot;</span><span class="op">]</span> <span class="op">??</span> <span class="st">&quot;&quot;</span><span class="op">,</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>            database<span class="op">:</span> ProcessInfo<span class="op">.</span>processInfo<span class="op">.</span>environment<span class="op">[</span><span class="st">&quot;DB_NAME&quot;</span><span class="op">]</span> <span class="op">??</span> <span class="st">&quot;app&quot;</span></span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">)</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>pool <span class="op">=</span> <span class="cf">try</span> PostgresConnectionPool<span class="op">(</span>configuration<span class="op">:</span> config<span class="op">)</span></span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3 id="step-2-implement-the-call-method">Step 2: Implement the Call
Method</h3>
<p>The call method dispatches to different operations based on the
method parameter:</p>
<div class="sourceCode" id="cb123"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">func</span> <span class="fu">call</span><span class="op">(</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>        <span class="va">_</span> <span class="va">method</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">args</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">any</span> <span class="va">Sendable</span>]</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">any</span> <span class="fu">Sendable</span> <span class="op">{</span></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> method<span class="op">.</span>lowercased<span class="op">()</span> <span class="op">{</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;query&quot;</span><span class="op">:</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="cf">try</span> <span class="cf">await</span> executeQuery<span class="op">(</span>args<span class="op">)</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;execute&quot;</span><span class="op">:</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="cf">try</span> <span class="cf">await</span> executeStatement<span class="op">(</span>args<span class="op">)</span></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;insert&quot;</span><span class="op">:</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="cf">try</span> <span class="cf">await</span> executeInsert<span class="op">(</span>args<span class="op">)</span></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> ServiceError<span class="op">.</span>unknownMethod<span class="op">(</span>method<span class="op">,</span> service<span class="op">:</span> Self<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">executeQuery</span><span class="op">(</span><span class="va">_</span> <span class="va">args</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">any</span> <span class="va">Sendable</span>]<span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [[<span class="fu">String</span><span class="op">:</span> <span class="dt">Any</span>]] <span class="op">{</span></span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">sql</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;sql&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> ServiceError<span class="op">.</span>missingArgument<span class="op">(</span><span class="st">&quot;sql&quot;</span><span class="op">)</span></span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">rows</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> pool<span class="op">.</span>query<span class="op">(</span>sql<span class="op">)</span></span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> rows<span class="op">.</span>map <span class="op">{</span> row <span class="cf">in</span></span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Convert PostgreSQL row to dictionary</span></span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">var</span> <span class="va">dict</span><span class="op">:</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="op">=</span> <span class="op">[:]</span></span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span>column<span class="op">,</span> value<span class="op">)</span> <span class="cf">in</span> row <span class="op">{</span></span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a>                dict<span class="op">[</span>column<span class="op">]</span> <span class="op">=</span> value</span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> dict</span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-33"><a href="#cb123-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">executeStatement</span><span class="op">(</span><span class="va">_</span> <span class="va">args</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">any</span> <span class="va">Sendable</span>]<span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">String</span><span class="op">:</span> <span class="dt">Any</span>] <span class="op">{</span></span>
<span id="cb123-34"><a href="#cb123-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">sql</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;sql&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb123-35"><a href="#cb123-35" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> ServiceError<span class="op">.</span>missingArgument<span class="op">(</span><span class="st">&quot;sql&quot;</span><span class="op">)</span></span>
<span id="cb123-36"><a href="#cb123-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb123-37"><a href="#cb123-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-38"><a href="#cb123-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="cf">await</span> pool<span class="op">.</span>execute<span class="op">(</span>sql<span class="op">)</span></span>
<span id="cb123-39"><a href="#cb123-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[</span><span class="st">&quot;success&quot;</span><span class="op">:</span> <span class="kw">true</span><span class="op">]</span></span>
<span id="cb123-40"><a href="#cb123-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-41"><a href="#cb123-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-42"><a href="#cb123-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">executeInsert</span><span class="op">(</span><span class="va">_</span> <span class="va">args</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">any</span> <span class="va">Sendable</span>]<span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">String</span><span class="op">:</span> <span class="dt">Any</span>] <span class="op">{</span></span>
<span id="cb123-43"><a href="#cb123-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">table</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;table&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String<span class="op">,</span></span>
<span id="cb123-44"><a href="#cb123-44" aria-hidden="true" tabindex="-1"></a>              <span class="kw">let</span> <span class="va">data</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;data&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> <span class="op">[</span>String<span class="op">:</span> Any<span class="op">]</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb123-45"><a href="#cb123-45" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> ServiceError<span class="op">.</span>missingArgument<span class="op">(</span><span class="st">&quot;table or data&quot;</span><span class="op">)</span></span>
<span id="cb123-46"><a href="#cb123-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb123-47"><a href="#cb123-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-48"><a href="#cb123-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">columns</span> <span class="op">=</span> data<span class="op">.</span>keys<span class="op">.</span>sorted<span class="op">().</span>joined<span class="op">(</span>separator<span class="op">:</span> <span class="st">&quot;, &quot;</span><span class="op">)</span></span>
<span id="cb123-49"><a href="#cb123-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">placeholders</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1.</span><span class="op">..</span>data<span class="op">.</span>count<span class="op">).</span>map <span class="op">{</span> <span class="st">&quot;</span><span class="ss">$</span><span class="er">\(</span><span class="ss">$</span><span class="st">0)&quot;</span> <span class="op">}.</span>joined<span class="op">(</span>separator<span class="op">:</span> <span class="st">&quot;, &quot;</span><span class="op">)</span></span>
<span id="cb123-50"><a href="#cb123-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">sql</span> <span class="op">=</span> <span class="st">&quot;INSERT INTO </span><span class="er">\(</span><span class="st">table) (</span><span class="er">\(</span><span class="st">columns)) VALUES (</span><span class="er">\(</span><span class="st">placeholders)) RETURNING id&quot;</span></span>
<span id="cb123-51"><a href="#cb123-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-52"><a href="#cb123-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> pool<span class="op">.</span>query<span class="op">(</span>sql<span class="op">,</span> values<span class="op">:</span> data<span class="op">.</span>values<span class="op">.</span>map <span class="op">{</span> $<span class="dv">0</span> <span class="op">})</span></span>
<span id="cb123-53"><a href="#cb123-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[</span><span class="st">&quot;id&quot;</span><span class="op">:</span> result<span class="op">.</span>first<span class="op">?[</span><span class="st">&quot;id&quot;</span><span class="op">]</span> <span class="op">??</span> <span class="dv">0</span><span class="op">]</span></span>
<span id="cb123-54"><a href="#cb123-54" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<h3 id="step-3-implement-shutdown">Step 3: Implement Shutdown</h3>
<div class="sourceCode" id="cb124"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">func</span> <span class="fu">shutdown</span><span class="op">()</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> pool<span class="op">.</span>close<span class="op">()</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<hr />
<h2 id="b.4-using-your-service-in-aro">17B.4 Using Your Service in
ARO</h2>
<p>Once registered, your service is available through the Call
action:</p>
<pre class="aro"><code>(List Active Users: User Management) {
    &lt;Call&gt; the &lt;users&gt; from the &lt;postgres: query&gt; with {
        sql: &quot;SELECT * FROM users WHERE active = true&quot;
    }.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;users&gt;.
}

(Create User: User Management) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.

    &lt;Call&gt; the &lt;result&gt; from the &lt;postgres: insert&gt; with {
        table: &quot;users&quot;,
        data: &lt;data&gt;
    }.

    &lt;Extract&gt; the &lt;id&gt; from the &lt;result: id&gt;.
    &lt;Return&gt; a &lt;Created: status&gt; with { id: &lt;id&gt; }.
}

(Update User Status: User Management) {
    &lt;Extract&gt; the &lt;id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Extract&gt; the &lt;status&gt; from the &lt;request: status&gt;.

    &lt;Call&gt; the &lt;result&gt; from the &lt;postgres: execute&gt; with {
        sql: &quot;UPDATE users SET status = $1 WHERE id = $2&quot;,
        params: [&lt;status&gt;, &lt;id&gt;]
    }.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;update&gt;.
}</code></pre>
<hr />
<h2 id="b.5-service-registration">17B.5 Service Registration</h2>
<p>Services must be registered before use. Registration happens during
application initialization:</p>
<div class="sourceCode" id="cb126"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In your Swift application startup</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">ARORuntime</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="fu">initializeServices</span><span class="op">()</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Register custom services</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> ServiceRegistry<span class="op">.</span>shared<span class="op">.</span>register<span class="op">(</span>PostgresService<span class="op">())</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> ServiceRegistry<span class="op">.</span>shared<span class="op">.</span>register<span class="op">(</span>RedisService<span class="op">())</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span> ServiceRegistry<span class="op">.</span>shared<span class="op">.</span>register<span class="op">(</span>RabbitMQService<span class="op">())</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>For plugin-based services (covered in Chapter 18), registration
happens automatically when the plugin loads.</p>
<hr />
<h2 id="b.6-error-handling-in-services">17B.6 Error Handling in
Services</h2>
<p>Services report errors by throwing Swift exceptions. The runtime
converts these to ARO error messages:</p>
<div class="sourceCode" id="cb127"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">enum</span> ServiceError<span class="op">:</span> <span class="dt">Error</span><span class="op">,</span> <span class="dt">CustomStringConvertible</span> <span class="op">{</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> unknownMethod<span class="op">(</span>String<span class="op">,</span> service<span class="op">:</span> String<span class="op">)</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> missingArgument<span class="op">(</span>String<span class="op">)</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> connectionFailed<span class="op">(</span>String<span class="op">)</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> queryFailed<span class="op">(</span>String<span class="op">)</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">var</span> <span class="va">description</span><span class="op">:</span> String <span class="op">{</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> <span class="kw">self</span> <span class="op">{</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>unknownMethod<span class="op">(</span><span class="kw">let</span> <span class="va">method</span><span class="op">,</span> <span class="kw">let</span> <span class="va">service</span><span class="op">):</span></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="st">&quot;Unknown method &#39;</span><span class="er">\(</span><span class="st">method)&#39; for service &#39;</span><span class="er">\(</span><span class="st">service)&#39;&quot;</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>missingArgument<span class="op">(</span><span class="kw">let</span> <span class="va">arg</span><span class="op">):</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="st">&quot;Missing required argument: </span><span class="er">\(</span><span class="st">arg)&quot;</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>connectionFailed<span class="op">(</span><span class="kw">let</span> <span class="va">reason</span><span class="op">):</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="st">&quot;Connection failed: </span><span class="er">\(</span><span class="st">reason)&quot;</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="op">.</span>queryFailed<span class="op">(</span><span class="kw">let</span> <span class="va">reason</span><span class="op">):</span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="st">&quot;Query failed: </span><span class="er">\(</span><span class="st">reason)&quot;</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>When a service throws, the ARO runtime produces an error like:</p>
<pre><code>Cannot call postgres:query - Connection failed: Connection refused to localhost:5432</code></pre>
<hr />
<h2 id="b.7-complete-example-redis-service">17B.7 Complete Example:
Redis Service</h2>
<p>Here is a complete service implementation for Redis:</p>
<div class="sourceCode" id="cb129"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">RediStack</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">struct</span> RedisService<span class="op">:</span> <span class="dt">AROService</span> <span class="op">{</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">let</span> <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;redis&quot;</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">let</span> <span class="va">connection</span><span class="op">:</span> RedisConnection</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">init</span><span class="op">()</span> <span class="kw">throws</span> <span class="op">{</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">host</span> <span class="op">=</span> ProcessInfo<span class="op">.</span>processInfo<span class="op">.</span>environment<span class="op">[</span><span class="st">&quot;REDIS_HOST&quot;</span><span class="op">]</span> <span class="op">??</span> <span class="st">&quot;localhost&quot;</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">port</span> <span class="op">=</span> Int<span class="op">(</span>ProcessInfo<span class="op">.</span>processInfo<span class="op">.</span>environment<span class="op">[</span><span class="st">&quot;REDIS_PORT&quot;</span><span class="op">]</span> <span class="op">??</span> <span class="st">&quot;6379&quot;</span><span class="op">)</span> <span class="op">??</span> <span class="dv">6379</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>connection <span class="op">=</span> <span class="cf">try</span> RedisConnection<span class="op">.</span>make<span class="op">(</span></span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>            configuration<span class="op">:</span> <span class="op">.</span><span class="kw">init</span><span class="op">(</span>hostname<span class="op">:</span> host<span class="op">,</span> port<span class="op">:</span> port<span class="op">)</span></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">).</span>wait<span class="op">()</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">func</span> <span class="fu">call</span><span class="op">(</span></span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">_</span> <span class="va">method</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">args</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">any</span> <span class="va">Sendable</span>]</span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">any</span> <span class="fu">Sendable</span> <span class="op">{</span></span>
<span id="cb129-21"><a href="#cb129-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">switch</span> method<span class="op">.</span>lowercased<span class="op">()</span> <span class="op">{</span></span>
<span id="cb129-22"><a href="#cb129-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;get&quot;</span><span class="op">:</span></span>
<span id="cb129-23"><a href="#cb129-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">key</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;key&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb129-24"><a href="#cb129-24" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throw</span> ServiceError<span class="op">.</span>missingArgument<span class="op">(</span><span class="st">&quot;key&quot;</span><span class="op">)</span></span>
<span id="cb129-25"><a href="#cb129-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb129-26"><a href="#cb129-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">value</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> connection<span class="op">.</span><span class="kw">get</span><span class="op">(</span>RedisKey<span class="op">(</span>key<span class="op">)).</span><span class="kw">get</span><span class="op">()</span></span>
<span id="cb129-27"><a href="#cb129-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> value<span class="op">.</span>string <span class="op">??</span> <span class="st">&quot;&quot;</span></span>
<span id="cb129-28"><a href="#cb129-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-29"><a href="#cb129-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;set&quot;</span><span class="op">:</span></span>
<span id="cb129-30"><a href="#cb129-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">key</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;key&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String<span class="op">,</span></span>
<span id="cb129-31"><a href="#cb129-31" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">let</span> <span class="va">value</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;value&quot;</span><span class="op">]</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb129-32"><a href="#cb129-32" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throw</span> ServiceError<span class="op">.</span>missingArgument<span class="op">(</span><span class="st">&quot;key or value&quot;</span><span class="op">)</span></span>
<span id="cb129-33"><a href="#cb129-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb129-34"><a href="#cb129-34" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">stringValue</span> <span class="op">=</span> String<span class="op">(</span>describing<span class="op">:</span> value<span class="op">)</span></span>
<span id="cb129-35"><a href="#cb129-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="cf">await</span> connection<span class="op">.</span><span class="kw">set</span><span class="op">(</span>RedisKey<span class="op">(</span>key<span class="op">),</span> to<span class="op">:</span> stringValue<span class="op">).</span><span class="kw">get</span><span class="op">()</span></span>
<span id="cb129-36"><a href="#cb129-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">[</span><span class="st">&quot;success&quot;</span><span class="op">:</span> <span class="kw">true</span><span class="op">]</span></span>
<span id="cb129-37"><a href="#cb129-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-38"><a href="#cb129-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;del&quot;</span><span class="op">,</span> <span class="st">&quot;delete&quot;</span><span class="op">:</span></span>
<span id="cb129-39"><a href="#cb129-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">key</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;key&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb129-40"><a href="#cb129-40" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throw</span> ServiceError<span class="op">.</span>missingArgument<span class="op">(</span><span class="st">&quot;key&quot;</span><span class="op">)</span></span>
<span id="cb129-41"><a href="#cb129-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb129-42"><a href="#cb129-42" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">count</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> connection<span class="op">.</span>delete<span class="op">(</span>RedisKey<span class="op">(</span>key<span class="op">)).</span><span class="kw">get</span><span class="op">()</span></span>
<span id="cb129-43"><a href="#cb129-43" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">[</span><span class="st">&quot;deleted&quot;</span><span class="op">:</span> count<span class="op">]</span></span>
<span id="cb129-44"><a href="#cb129-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-45"><a href="#cb129-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;incr&quot;</span><span class="op">:</span></span>
<span id="cb129-46"><a href="#cb129-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">key</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;key&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb129-47"><a href="#cb129-47" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throw</span> ServiceError<span class="op">.</span>missingArgument<span class="op">(</span><span class="st">&quot;key&quot;</span><span class="op">)</span></span>
<span id="cb129-48"><a href="#cb129-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb129-49"><a href="#cb129-49" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="va">newValue</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> connection<span class="op">.</span>increment<span class="op">(</span>RedisKey<span class="op">(</span>key<span class="op">)).</span><span class="kw">get</span><span class="op">()</span></span>
<span id="cb129-50"><a href="#cb129-50" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">[</span><span class="st">&quot;value&quot;</span><span class="op">:</span> newValue<span class="op">]</span></span>
<span id="cb129-51"><a href="#cb129-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-52"><a href="#cb129-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> <span class="st">&quot;expire&quot;</span><span class="op">:</span></span>
<span id="cb129-53"><a href="#cb129-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">guard</span> <span class="kw">let</span> <span class="va">key</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;key&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String<span class="op">,</span></span>
<span id="cb129-54"><a href="#cb129-54" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">let</span> <span class="va">seconds</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;seconds&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> Int <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb129-55"><a href="#cb129-55" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throw</span> ServiceError<span class="op">.</span>missingArgument<span class="op">(</span><span class="st">&quot;key or seconds&quot;</span><span class="op">)</span></span>
<span id="cb129-56"><a href="#cb129-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb129-57"><a href="#cb129-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span> <span class="cf">await</span> connection<span class="op">.</span>expire<span class="op">(</span>RedisKey<span class="op">(</span>key<span class="op">),</span> after<span class="op">:</span> <span class="op">.</span>seconds<span class="op">(</span>Int64<span class="op">(</span>seconds<span class="op">))).</span><span class="kw">get</span><span class="op">()</span></span>
<span id="cb129-58"><a href="#cb129-58" aria-hidden="true" tabindex="-1"></a>            <span class="kw">return</span> <span class="op">[</span><span class="st">&quot;success&quot;</span><span class="op">:</span> <span class="kw">true</span><span class="op">]</span></span>
<span id="cb129-59"><a href="#cb129-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-60"><a href="#cb129-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">default</span><span class="op">:</span></span>
<span id="cb129-61"><a href="#cb129-61" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> ServiceError<span class="op">.</span>unknownMethod<span class="op">(</span>method<span class="op">,</span> service<span class="op">:</span> Self<span class="op">.</span>name<span class="op">)</span></span>
<span id="cb129-62"><a href="#cb129-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb129-63"><a href="#cb129-63" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-64"><a href="#cb129-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-65"><a href="#cb129-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">func</span> <span class="fu">shutdown</span><span class="op">()</span> <span class="fu">async</span> <span class="op">{</span></span>
<span id="cb129-66"><a href="#cb129-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span><span class="op">?</span> <span class="cf">await</span> connection<span class="op">.</span>close<span class="op">().</span><span class="kw">get</span><span class="op">()</span></span>
<span id="cb129-67"><a href="#cb129-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-68"><a href="#cb129-68" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Usage in ARO:</strong></p>
<pre class="aro"><code>(Cache User: Caching) {
    &lt;Extract&gt; the &lt;user-id&gt; from the &lt;user: id&gt;.

    &lt;Call&gt; the &lt;result&gt; from the &lt;redis: set&gt; with {
        key: &quot;user:&quot; + &lt;user-id&gt;,
        value: &lt;user&gt;
    }.

    (* Set expiration to 1 hour *)
    &lt;Call&gt; the &lt;expire-result&gt; from the &lt;redis: expire&gt; with {
        key: &quot;user:&quot; + &lt;user-id&gt;,
        seconds: 3600
    }.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;cache&gt;.
}

(Get Cached User: Caching) {
    &lt;Extract&gt; the &lt;user-id&gt; from the &lt;request: id&gt;.

    &lt;Call&gt; the &lt;cached&gt; from the &lt;redis: get&gt; with {
        key: &quot;user:&quot; + &lt;user-id&gt;
    }.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;cached&gt;.
}</code></pre>
<hr />
<h2 id="b.8-best-practices">17B.8 Best Practices</h2>
<p><strong>Name services clearly.</strong> The service name appears in
ARO code, so it should be short and recognizable. Use “postgres” not
“postgresqlDatabaseService”.</p>
<p><strong>Keep methods focused.</strong> Each method should do one
thing. “query” runs a query. “execute” runs a statement without results.
“insert” inserts and returns the ID. Do not combine operations.</p>
<p><strong>Document methods.</strong> Users of your service need to know
what methods are available, what arguments each expects, and what it
returns. Consider adding a “help” method that returns documentation.</p>
<p><strong>Handle connection lifecycle.</strong> Services often maintain
connections to external systems. Initialize connections in
<code>init()</code>, reuse them across calls, and close them in
<code>shutdown()</code>.</p>
<p><strong>Use environment variables for configuration.</strong> Host,
port, credentials, and other settings should come from environment
variables, not hardcoded values. This allows the same code to work in
development and production.</p>
<p><strong>Provide meaningful errors.</strong> When a method fails, the
error message should explain what went wrong and ideally suggest a fix.
“Connection refused to localhost:5432” is better than “Connection
error”.</p>
<hr />
<h2 id="b.9-services-vs-built-in-actions">17B.9 Services vs Built-in
Actions</h2>
<p>Some capabilities in ARO are implemented as built-in actions rather
than services. HTTP requests use the <code>Request</code> action, not a
service:</p>
<pre class="aro"><code>(* Built-in Request action - NOT a service *)
&lt;Request&gt; the &lt;weather&gt; from &quot;https://api.weather.com/current&quot;.

(* Service call pattern - for external integrations *)
&lt;Call&gt; the &lt;users&gt; from the &lt;postgres: query&gt; with { sql: &quot;...&quot; }.</code></pre>
<p>The distinction: built-in actions are part of the ARO language and
have dedicated syntax. Services are external integrations that share the
uniform Call pattern.</p>
<table>
<thead>
<tr>
<th>Capability</th>
<th>Implementation</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr>
<td>HTTP requests</td>
<td>Built-in action</td>
<td><code>&lt;Request&gt; the &lt;data&gt; from &lt;url&gt;.</code></td>
</tr>
<tr>
<td>File operations</td>
<td>Built-in action</td>
<td><code>&lt;Read&gt; the &lt;data&gt; from &lt;path&gt;.</code></td>
</tr>
<tr>
<td>Database queries</td>
<td>Custom service</td>
<td><code>&lt;Call&gt; from &lt;postgres: query&gt;</code></td>
</tr>
<tr>
<td>Message queues</td>
<td>Custom service</td>
<td><code>&lt;Call&gt; from &lt;rabbitmq: publish&gt;</code></td>
</tr>
<tr>
<td>Cloud storage</td>
<td>Custom service</td>
<td><code>&lt;Call&gt; from &lt;s3: upload&gt;</code></td>
</tr>
</tbody>
</table>
<hr />
<p><em>Next: Chapter 18 — Plugins</em></p>
<h1 id="chapter-18-plugins">Chapter 18: Plugins</h1>
<p><em>“Package and share your extensions.”</em></p>
<hr />
<h2 id="what-are-plugins">18.1 What Are Plugins?</h2>
<p>Plugins are Swift packages that provide custom actions and services
for ARO applications. They allow you to package extensions together,
share them across projects, and distribute them to other developers
through Swift Package Manager.</p>
<p>The plugin system exists because real applications often need
specialized capabilities that the built-in features do not provide.
Plugins provide a structured way to create, distribute, and use these
extensions.</p>
<p>A plugin can contain two types of extensions:</p>
<table style="width:100%;">
<colgroup>
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 47%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr>
<th>Type</th>
<th>Adds</th>
<th>Invocation Pattern</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Actions</strong></td>
<td>New verbs</td>
<td><code>&lt;Verb&gt; the &lt;result&gt; from &lt;object&gt;.</code></td>
<td><code>&lt;Geocode&gt; the &lt;coords&gt; from &lt;address&gt;.</code></td>
</tr>
<tr>
<td><strong>Services</strong></td>
<td>External integrations</td>
<td><code>&lt;Call&gt; from &lt;service: method&gt;</code></td>
<td><code>&lt;Call&gt; from &lt;zip: compress&gt;</code></td>
</tr>
</tbody>
</table>
<p>The distinction matters for plugin design. Actions extend the
language vocabulary—each action adds a new verb. Services extend runtime
capabilities—they share the <code>Call</code> verb but provide different
methods.</p>
<hr />
<h2 id="plugin-structure">18.2 Plugin Structure</h2>
<p>A plugin follows standard Swift package conventions with ARO-specific
requirements. The package contains source files, a registration
function, and optionally tests and documentation.</p>
<p>The package manifest declares the plugin as a dynamic library
product. This enables runtime loading where the plugin is discovered and
loaded as a shared library.</p>
<p><strong>For Action Plugins:</strong> - Implement the
<code>ActionImplementation</code> protocol - Registration function calls
<code>ActionRegistry.shared.register(YourAction.self)</code> - Each
action adds a new verb to ARO</p>
<p><strong>For Service Plugins:</strong> - Use the C-callable interface
with <code>aro_plugin_init</code> - Return JSON metadata describing
services and their symbols - Each service is called via
<code>&lt;Call&gt; from &lt;service: method&gt;</code></p>
<hr />
<h2 id="creating-an-action-plugin">18.3 Creating an Action Plugin</h2>
<p>Action plugins add new verbs to ARO. Here is a complete example of a
Geocoding action plugin.</p>
<p><strong>Directory Structure:</strong></p>
<pre><code>GeocodePlugin/
├── Package.swift
├── Sources/GeocodePlugin/
│   ├── GeocodeAction.swift
│   └── Registration.swift
└── Tests/GeocodePluginTests/
    └── GeocodeActionTests.swift</code></pre>
<p><strong>Package.swift:</strong></p>
<div class="sourceCode" id="cb133"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co">// swift-tools-version:5.9</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">PackageDescription</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">package</span> <span class="op">=</span> Package<span class="op">(</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>    name<span class="op">:</span> <span class="st">&quot;GeocodePlugin&quot;</span><span class="op">,</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    platforms<span class="op">:</span> <span class="op">[.</span>macOS<span class="op">(.</span>v13<span class="op">)],</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>    products<span class="op">:</span> <span class="op">[</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>library<span class="op">(</span>name<span class="op">:</span> <span class="st">&quot;GeocodePlugin&quot;</span><span class="op">,</span> type<span class="op">:</span> <span class="op">.</span><span class="kw">dynamic</span><span class="op">,</span> targets<span class="op">:</span> <span class="op">[</span><span class="st">&quot;GeocodePlugin&quot;</span><span class="op">])</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">],</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>    dependencies<span class="op">:</span> <span class="op">[</span></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>package<span class="op">(</span>url<span class="op">:</span> <span class="st">&quot;https://github.com/your-org/ARORuntime.git&quot;</span><span class="op">,</span> from<span class="op">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="op">)</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">],</span></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">:</span> <span class="op">[</span></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>target<span class="op">(</span>name<span class="op">:</span> <span class="st">&quot;GeocodePlugin&quot;</span><span class="op">,</span> dependencies<span class="op">:</span> <span class="op">[</span><span class="st">&quot;ARORuntime&quot;</span><span class="op">])</span></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">]</span></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
<p><strong>GeocodeAction.swift:</strong></p>
<div class="sourceCode" id="cb134"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">ARORuntime</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">struct</span> GeocodeAction<span class="op">:</span> <span class="dt">ActionImplementation</span> <span class="op">{</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">let</span> <span class="va">role</span><span class="op">:</span> ActionRole <span class="op">=</span> <span class="op">.</span>request</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">let</span> <span class="va">verbs</span><span class="op">:</span> Set<span class="op">&lt;</span>String<span class="op">&gt;</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Geocode&quot;</span><span class="op">]</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="kw">let</span> <span class="va">validPrepositions</span><span class="op">:</span> Set<span class="op">&lt;</span>Preposition<span class="op">&gt;</span> <span class="op">=</span> <span class="op">[.</span>from<span class="op">]</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">init</span><span class="op">()</span> <span class="op">{}</span></span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">func</span> <span class="fu">execute</span><span class="op">(</span></span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">result</span><span class="op">:</span> <span class="dt">ResultDescriptor</span><span class="op">,</span></span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">object</span><span class="op">:</span> <span class="dt">ObjectDescriptor</span><span class="op">,</span></span>
<span id="cb134-13"><a href="#cb134-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">context</span><span class="op">:</span> <span class="dt">ExecutionContext</span></span>
<span id="cb134-14"><a href="#cb134-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; <span class="fu">any</span> <span class="fu">Sendable</span> <span class="op">{</span></span>
<span id="cb134-15"><a href="#cb134-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Get the address from context</span></span>
<span id="cb134-16"><a href="#cb134-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">address</span><span class="op">:</span> String <span class="op">=</span> <span class="cf">try</span> context<span class="op">.</span>require<span class="op">(</span>object<span class="op">.</span>identifier<span class="op">)</span></span>
<span id="cb134-17"><a href="#cb134-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-18"><a href="#cb134-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Call geocoding API (simplified)</span></span>
<span id="cb134-19"><a href="#cb134-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">coordinates</span> <span class="op">=</span> <span class="cf">try</span> <span class="cf">await</span> geocode<span class="op">(</span>address<span class="op">)</span></span>
<span id="cb134-20"><a href="#cb134-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-21"><a href="#cb134-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Bind result</span></span>
<span id="cb134-22"><a href="#cb134-22" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>bind<span class="op">(</span>result<span class="op">.</span>identifier<span class="op">,</span> value<span class="op">:</span> coordinates<span class="op">)</span></span>
<span id="cb134-23"><a href="#cb134-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-24"><a href="#cb134-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> coordinates</span>
<span id="cb134-25"><a href="#cb134-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-26"><a href="#cb134-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb134-27"><a href="#cb134-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="kw">func</span> <span class="fu">geocode</span><span class="op">(</span><span class="va">_</span> <span class="va">address</span><span class="op">:</span> <span class="dt">String</span><span class="op">)</span> <span class="fu">async</span> <span class="kw">throws</span> -&gt; [<span class="fu">String</span><span class="op">:</span> <span class="dt">Double</span>] <span class="op">{</span></span>
<span id="cb134-28"><a href="#cb134-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Implementation using a geocoding service</span></span>
<span id="cb134-29"><a href="#cb134-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Returns [&quot;latitude&quot;: 37.7749, &quot;longitude&quot;: -122.4194]</span></span>
<span id="cb134-30"><a href="#cb134-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb134-31"><a href="#cb134-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Registration.swift:</strong></p>
<div class="sourceCode" id="cb135"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">ARORuntime</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="at">@_cdecl</span><span class="op">(</span><span class="st">&quot;aro_plugin_register&quot;</span><span class="op">)</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">func</span> <span class="fu">registerPlugin</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>    ActionRegistry<span class="op">.</span>shared<span class="op">.</span>register<span class="op">(</span>GeocodeAction<span class="op">.</span><span class="kw">self</span><span class="op">)</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Usage in ARO:</strong></p>
<pre class="aro"><code>(Get Location: Address Lookup) {
    &lt;Create&gt; the &lt;address&gt; with &quot;1600 Amphitheatre Parkway, Mountain View, CA&quot;.

    (* Custom action - new verb *)
    &lt;Geocode&gt; the &lt;coordinates&gt; from the &lt;address&gt;.

    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &lt;coordinates&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;coordinates&gt;.
}</code></pre>
<hr />
<h2 id="creating-a-service-plugin">18.4 Creating a Service Plugin</h2>
<p>Service plugins provide external integrations called via the
<code>Call</code> action. Here is a complete example of a Zip service
plugin.</p>
<p><strong>Directory Structure:</strong></p>
<pre><code>ZipPlugin/
├── Package.swift
└── Sources/ZipPlugin/
    └── ZipService.swift</code></pre>
<p><strong>Package.swift:</strong></p>
<div class="sourceCode" id="cb138"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co">// swift-tools-version:5.9</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">PackageDescription</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="va">package</span> <span class="op">=</span> Package<span class="op">(</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    name<span class="op">:</span> <span class="st">&quot;ZipPlugin&quot;</span><span class="op">,</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    platforms<span class="op">:</span> <span class="op">[.</span>macOS<span class="op">(.</span>v13<span class="op">)],</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    products<span class="op">:</span> <span class="op">[</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>library<span class="op">(</span>name<span class="op">:</span> <span class="st">&quot;ZipPlugin&quot;</span><span class="op">,</span> type<span class="op">:</span> <span class="op">.</span><span class="kw">dynamic</span><span class="op">,</span> targets<span class="op">:</span> <span class="op">[</span><span class="st">&quot;ZipPlugin&quot;</span><span class="op">])</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">],</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>    dependencies<span class="op">:</span> <span class="op">[</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>package<span class="op">(</span>url<span class="op">:</span> <span class="st">&quot;https://github.com/marmelroy/Zip.git&quot;</span><span class="op">,</span> from<span class="op">:</span> <span class="st">&quot;2.1.0&quot;</span><span class="op">)</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">],</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>    targets<span class="op">:</span> <span class="op">[</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>target<span class="op">(</span>name<span class="op">:</span> <span class="st">&quot;ZipPlugin&quot;</span><span class="op">,</span> dependencies<span class="op">:</span> <span class="op">[</span><span class="st">&quot;Zip&quot;</span><span class="op">])</span></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">]</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
<p><strong>ZipService.swift:</strong></p>
<div class="sourceCode" id="cb139"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">Foundation</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="im">Zip</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Plugin initialization - returns service metadata as JSON</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a><span class="at">@_cdecl</span><span class="op">(</span><span class="st">&quot;aro_plugin_init&quot;</span><span class="op">)</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">func</span> <span class="fu">pluginInit</span><span class="op">()</span> -&gt; <span class="fu">UnsafePointer</span><span class="op">&lt;</span><span class="dt">CChar</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">metadata</span> <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a><span class="st">    {&quot;services&quot;: [{&quot;name&quot;: &quot;zip&quot;, &quot;symbol&quot;: &quot;zip_call&quot;}]}</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;&quot;&quot;</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> UnsafePointer<span class="op">(</span>strdup<span class="op">(</span>metadata<span class="op">)!)</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Main entry point for the zip service</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a><span class="at">@_cdecl</span><span class="op">(</span><span class="st">&quot;zip_call&quot;</span><span class="op">)</span></span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">func</span> <span class="fu">zipCall</span><span class="op">(</span></span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">_</span> <span class="va">methodPtr</span><span class="op">:</span> <span class="dt">UnsafePointer</span>&lt;<span class="va">CChar</span>&gt;<span class="op">,</span></span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">_</span> <span class="va">argsPtr</span><span class="op">:</span> <span class="dt">UnsafePointer</span>&lt;<span class="va">CChar</span>&gt;<span class="op">,</span></span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">_</span> <span class="va">resultPtr</span><span class="op">:</span> <span class="dt">UnsafeMutablePointer</span>&lt;<span class="va">UnsafeMutablePointer</span>&lt;<span class="va">CChar</span>&gt;?&gt;</span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a><span class="op">)</span> -&gt; <span class="fu">Int32</span> <span class="op">{</span></span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">method</span> <span class="op">=</span> String<span class="op">(</span>cString<span class="op">:</span> methodPtr<span class="op">)</span></span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="va">argsJSON</span> <span class="op">=</span> String<span class="op">(</span>cString<span class="op">:</span> argsPtr<span class="op">)</span></span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span> <span class="op">{</span></span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">args</span> <span class="op">=</span> <span class="cf">try</span> parseJSON<span class="op">(</span>argsJSON<span class="op">)</span></span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">result</span> <span class="op">=</span> <span class="cf">try</span> executeMethod<span class="op">(</span>method<span class="op">,</span> args<span class="op">:</span> args<span class="op">)</span></span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>        resultPtr<span class="op">.</span>pointee <span class="op">=</span> encodeJSON<span class="op">(</span>result<span class="op">).</span>withCString <span class="op">{</span> strdup<span class="op">(</span>$<span class="dv">0</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="dv">0</span></span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">catch</span> <span class="op">{</span></span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a>        resultPtr<span class="op">.</span>pointee <span class="op">=</span> <span class="st">&quot;{</span><span class="sc">\&quot;</span><span class="st">error</span><span class="sc">\&quot;</span><span class="st">: </span><span class="sc">\&quot;</span><span class="er">\(</span><span class="st">error)</span><span class="sc">\&quot;</span><span class="st">}&quot;</span><span class="op">.</span>withCString <span class="op">{</span> strdup<span class="op">(</span>$<span class="dv">0</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb139-30"><a href="#cb139-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="dv">1</span></span>
<span id="cb139-31"><a href="#cb139-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb139-32"><a href="#cb139-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb139-33"><a href="#cb139-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-34"><a href="#cb139-34" aria-hidden="true" tabindex="-1"></a><span class="kw">private</span> <span class="kw">func</span> <span class="fu">executeMethod</span><span class="op">(</span><span class="va">_</span> <span class="va">method</span><span class="op">:</span> <span class="dt">String</span><span class="op">,</span> <span class="va">args</span><span class="op">:</span> [<span class="dt">String</span><span class="op">:</span> <span class="dt">Any</span>]<span class="op">)</span> <span class="kw">throws</span> -&gt; [<span class="fu">String</span><span class="op">:</span> <span class="dt">Any</span>] <span class="op">{</span></span>
<span id="cb139-35"><a href="#cb139-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> method<span class="op">.</span>lowercased<span class="op">()</span> <span class="op">{</span></span>
<span id="cb139-36"><a href="#cb139-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&quot;compress&quot;</span><span class="op">,</span> <span class="st">&quot;zip&quot;</span><span class="op">:</span></span>
<span id="cb139-37"><a href="#cb139-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">files</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;files&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> <span class="op">[</span>String<span class="op">],</span></span>
<span id="cb139-38"><a href="#cb139-38" aria-hidden="true" tabindex="-1"></a>              <span class="kw">let</span> <span class="va">output</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;output&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb139-39"><a href="#cb139-39" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> PluginError<span class="op">.</span>missingArgument</span>
<span id="cb139-40"><a href="#cb139-40" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb139-41"><a href="#cb139-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">fileURLs</span> <span class="op">=</span> files<span class="op">.</span>map <span class="op">{</span> URL<span class="op">(</span>fileURLWithPath<span class="op">:</span> $<span class="dv">0</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb139-42"><a href="#cb139-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> Zip<span class="op">.</span>zipFiles<span class="op">(</span>paths<span class="op">:</span> fileURLs<span class="op">,</span> zipFilePath<span class="op">:</span> URL<span class="op">(</span>fileURLWithPath<span class="op">:</span> output<span class="op">),</span> password<span class="op">:</span> <span class="kw">nil</span><span class="op">,</span> progress<span class="op">:</span> <span class="kw">nil</span><span class="op">)</span></span>
<span id="cb139-43"><a href="#cb139-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[</span><span class="st">&quot;success&quot;</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="st">&quot;output&quot;</span><span class="op">:</span> output<span class="op">,</span> <span class="st">&quot;filesCompressed&quot;</span><span class="op">:</span> files<span class="op">.</span>count<span class="op">]</span></span>
<span id="cb139-44"><a href="#cb139-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-45"><a href="#cb139-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&quot;decompress&quot;</span><span class="op">,</span> <span class="st">&quot;unzip&quot;</span><span class="op">:</span></span>
<span id="cb139-46"><a href="#cb139-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">guard</span> <span class="kw">let</span> <span class="va">archive</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;archive&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb139-47"><a href="#cb139-47" aria-hidden="true" tabindex="-1"></a>            <span class="kw">throw</span> PluginError<span class="op">.</span>missingArgument</span>
<span id="cb139-48"><a href="#cb139-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb139-49"><a href="#cb139-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="va">destination</span> <span class="op">=</span> args<span class="op">[</span><span class="st">&quot;destination&quot;</span><span class="op">]</span> <span class="kw">as</span><span class="op">?</span> String <span class="op">??</span> <span class="st">&quot;.&quot;</span></span>
<span id="cb139-50"><a href="#cb139-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> Zip<span class="op">.</span>unzipFile<span class="op">(</span>URL<span class="op">(</span>fileURLWithPath<span class="op">:</span> archive<span class="op">),</span> destination<span class="op">:</span> URL<span class="op">(</span>fileURLWithPath<span class="op">:</span> destination<span class="op">),</span> overwrite<span class="op">:</span> <span class="kw">true</span><span class="op">,</span> password<span class="op">:</span> <span class="kw">nil</span><span class="op">)</span></span>
<span id="cb139-51"><a href="#cb139-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="op">[</span><span class="st">&quot;success&quot;</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="st">&quot;destination&quot;</span><span class="op">:</span> destination<span class="op">]</span></span>
<span id="cb139-52"><a href="#cb139-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-53"><a href="#cb139-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">default</span><span class="op">:</span></span>
<span id="cb139-54"><a href="#cb139-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">throw</span> PluginError<span class="op">.</span>unknownMethod<span class="op">(</span>method<span class="op">)</span></span>
<span id="cb139-55"><a href="#cb139-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb139-56"><a href="#cb139-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb139-57"><a href="#cb139-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-58"><a href="#cb139-58" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> PluginError<span class="op">:</span> <span class="dt">Error</span> <span class="op">{</span></span>
<span id="cb139-59"><a href="#cb139-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> missingArgument<span class="op">,</span> unknownMethod<span class="op">(</span>String<span class="op">)</span></span>
<span id="cb139-60"><a href="#cb139-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Usage in ARO:</strong></p>
<pre class="aro"><code>(Compress Files: Archive) {
    (* Service call - uses Call action *)
    &lt;Call&gt; the &lt;result&gt; from the &lt;zip: compress&gt; with {
        files: [&quot;file1.txt&quot;, &quot;file2.txt&quot;],
        output: &quot;archive.zip&quot;
    }.

    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &lt;result&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;compression&gt;.
}</code></pre>
<hr />
<h2 id="choosing-between-action-and-service-plugins">18.5 Choosing
Between Action and Service Plugins</h2>
<p>When designing a plugin, consider which approach fits better:</p>
<h3 id="choose-action-plugin-when">Choose Action Plugin When:</h3>
<ul>
<li>The operation feels like a language feature</li>
<li>You want natural syntax: <code>&lt;Geocode&gt;</code>,
<code>&lt;Encrypt&gt;</code>, <code>&lt;Validate&gt;</code></li>
<li>The operation is single-purpose</li>
<li>Readability is paramount</li>
</ul>
<pre class="aro"><code>(* Natural, domain-specific syntax *)
&lt;Geocode&gt; the &lt;coordinates&gt; from the &lt;address&gt;.
&lt;Encrypt&gt; the &lt;ciphertext&gt; from the &lt;plaintext&gt; with &lt;key&gt;.
&lt;Validate&gt; the &lt;result&gt; for the &lt;order&gt;.</code></pre>
<h3 id="choose-service-plugin-when">Choose Service Plugin When:</h3>
<ul>
<li>You are wrapping an external system with multiple operations</li>
<li>You want a uniform interface:
<code>&lt;Call&gt; from &lt;service: method&gt;</code></li>
<li>The integration has many related methods</li>
<li>Portability across projects matters</li>
</ul>
<pre class="aro"><code>(* Uniform service pattern *)
&lt;Call&gt; the &lt;result&gt; from the &lt;postgres: query&gt; with { sql: &quot;...&quot; }.
&lt;Call&gt; the &lt;result&gt; from the &lt;postgres: insert&gt; with { table: &quot;...&quot;, data: ... }.
&lt;Call&gt; the &lt;result&gt; from the &lt;zip: compress&gt; with { files: [...] }.
&lt;Call&gt; the &lt;result&gt; from the &lt;zip: decompress&gt; with { archive: &quot;...&quot; }.</code></pre>
<h3 id="comparison-table-1">Comparison Table</h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Action Plugin</th>
<th>Service Plugin</th>
</tr>
</thead>
<tbody>
<tr>
<td>Syntax</td>
<td><code>&lt;Verb&gt; the &lt;result&gt;...</code></td>
<td><code>&lt;Call&gt; from &lt;service: method&gt;</code></td>
</tr>
<tr>
<td>Protocol</td>
<td><code>ActionImplementation</code></td>
<td>C-callable with JSON</td>
</tr>
<tr>
<td>Methods</td>
<td>One per action</td>
<td>Multiple per service</td>
</tr>
<tr>
<td>Registration</td>
<td><code>ActionRegistry.register()</code></td>
<td><code>aro_plugin_init</code> JSON</td>
</tr>
<tr>
<td>Best for</td>
<td>Domain operations</td>
<td>External integrations</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="plugin-loading">18.6 Plugin Loading</h2>
<p>Plugins load in two ways: compile-time linking and runtime
discovery.</p>
<p><strong>Compile-time linking</strong> adds the plugin as a package
dependency. When you build your application, the plugin is linked in.
The registration function runs during initialization.</p>
<p><strong>Runtime discovery</strong> scans a <code>plugins/</code>
directory for compiled libraries. During startup, ARO loads each library
and calls its registration function. This allows adding plugins without
recompiling.</p>
<p>For runtime loading, place compiled <code>.dylib</code> (macOS),
<code>.so</code> (Linux), or <code>.dll</code> (Windows) files in
<code>./plugins/</code>. ARO loads them automatically during
Application-Start.</p>
<hr />
<h2 id="plugin-design-guidelines">18.7 Plugin Design Guidelines</h2>
<p><strong>Cohesion</strong>: Group related functionality. A database
plugin provides all database operations. A compression plugin provides
all compression methods.</p>
<p><strong>Naming</strong>: Use distinctive names. For actions, prefix
with your domain if conflicts are possible. For services, choose clear
names that describe the integration.</p>
<p><strong>Configuration</strong>: Use environment variables for
credentials and connection strings. This keeps configuration separate
from code and allows different values per environment.</p>
<p><strong>Error messages</strong>: Provide clear, actionable errors.
Include what failed, why, and ideally what to do about it.</p>
<hr />
<h2 id="documentation">18.8 Documentation</h2>
<p>Document your plugin thoroughly:</p>
<ul>
<li><strong>Actions</strong>: List verbs, valid prepositions, expected
inputs, outputs, errors</li>
<li><strong>Services</strong>: List methods, arguments for each, return
values</li>
<li><strong>Configuration</strong>: Environment variables, required
setup</li>
<li><strong>Examples</strong>: Show typical usage in ARO code</li>
</ul>
<p>A README should provide quick start instructions. Users should be
productive within minutes of adding your plugin.</p>
<hr />
<h2 id="publishing">18.9 Publishing</h2>
<p>Publish plugins through Git repositories. Swift Package Manager
resolves dependencies from URLs.</p>
<ol type="1">
<li>Create a Git repository for your plugin</li>
<li>Tag releases following semantic versioning</li>
<li>Document installation in your README</li>
<li>Announce in relevant communities</li>
</ol>
<p>Example installation instruction:</p>
<div class="sourceCode" id="cb143"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co">// In your Package.swift</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>dependencies<span class="op">:</span> <span class="op">[</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>package<span class="op">(</span>url<span class="op">:</span> <span class="st">&quot;https://github.com/your-org/GeocodePlugin.git&quot;</span><span class="op">,</span> from<span class="op">:</span> <span class="st">&quot;1.0.0&quot;</span><span class="op">)</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre></div>
<hr />
<h2 id="best-practices-11">18.10 Best Practices</h2>
<p><strong>Test thoroughly.</strong> Plugins may be used in unexpected
ways. Test edge cases and error conditions.</p>
<p><strong>Version carefully.</strong> Breaking changes require major
version bumps. Users depend on stability.</p>
<p><strong>Keep dependencies minimal.</strong> Each dependency is a
dependency for your users. Heavy dependencies cause conflicts.</p>
<p><strong>Document everything.</strong> Users should not need to read
source code to use your plugin.</p>
<hr />
<p><em>Next: Chapter 19 — Native Compilation</em></p>
<h1 id="chapter-19-native-compilation">Chapter 19: Native
Compilation</h1>
<p><em>“From script to standalone binary.”</em></p>
<hr />
<h2 id="what-is-native-compilation">19.1 What Is Native
Compilation?</h2>
<p>ARO can compile applications to standalone native binaries that run
without the ARO runtime installed. This transforms your application from
an interpreted script into a self-contained executable that can be
deployed anywhere the target platform runs.</p>
<p>The native compilation process translates ARO source code into LLVM
IR (intermediate representation), compiles it to machine code, and links
the result with a precompiled runtime library. The output is a native
executable—a binary file that the operating system can run directly
without any interpreter.</p>
<p>This capability matters for deployment scenarios. When you deploy an
interpreted ARO application, you must ensure the ARO runtime is
available on the target system. When you deploy a native binary, you
deploy just the binary (and any required data files like openapi.yaml).
This simplifies deployment, reduces dependencies, and can improve
startup time.</p>
<p>Native binaries also provide some intellectual property protection.
While not impossible to reverse engineer, native binaries obscure your
application logic more than source code would. For applications where
source visibility is a concern, native compilation provides a degree of
protection.</p>
<hr />
<h2 id="the-build-command">19.2 The Build Command</h2>
<p>The aro build command compiles an ARO application to a native binary.
You provide the path to your application directory, and the compiler
produces an executable.</p>
<p>The basic invocation takes just the application path. The output
executable is named after your application directory. If you want a
different name, use the output option to specify it explicitly.</p>
<p>Optimization options control how aggressively the compiler optimizes
the generated code. The optimize flag enables performance optimizations
that may increase compile time but produce faster code. The size flag
optimizes for smaller binary size. The strip flag removes debug symbols,
reducing binary size but making debugging harder.</p>
<p>The release flag combines optimization, size optimization, and symbol
stripping for production builds. This produces the smallest and fastest
binaries at the cost of debugging capability. Use release for
deployment; use unoptimized builds during development when you might
need to debug.</p>
<p>Verbose output shows what the compiler is doing at each step:
discovering source files, parsing, generating LLVM IR, compiling to
machine code, and linking. This visibility helps diagnose build problems
and understand what the compiler does.</p>
<hr />
<h2 id="the-compilation-pipeline">19.3 The Compilation Pipeline</h2>
<div style="text-align: center; margin: 2em 0;">
<svg width="500" height="180" viewBox="0 0 500 180" xmlns="http://www.w3.org/2000/svg">
<!-- Row 1 -->
<!-- Discovery -->
<rect x="10" y="20" width="70" height="45" rx="4" fill="#f3e8ff" stroke="#a855f7" stroke-width="2"/>
<text x="45" y="38" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#7c3aed">DISCOVER</text>
<text x="45" y="52" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#9333ea">.aro
files</text> <!-- Arrow -->
<line x1="80" y1="42" x2="95" y2="42" stroke="#9ca3af" stroke-width="1.5"/>
<polygon points="95,42 89,38 89,46" fill="#9ca3af"/> <!-- Parse -->
<rect x="100" y="20" width="70" height="45" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
<text x="135" y="38" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#1e40af">PARSE</text>
<text x="135" y="52" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#3b82f6">→
AST</text> <!-- Arrow -->
<line x1="170" y1="42" x2="185" y2="42" stroke="#9ca3af" stroke-width="1.5"/>
<polygon points="185,42 179,38 179,46" fill="#9ca3af"/>
<!-- Semantic -->
<rect x="190" y="20" width="70" height="45" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="225" y="38" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#166534">ANALYZE</text>
<text x="225" y="52" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#22c55e">semantics</text>
<!-- Arrow -->
<line x1="260" y1="42" x2="275" y2="42" stroke="#9ca3af" stroke-width="1.5"/>
<polygon points="275,42 269,38 269,46" fill="#9ca3af"/>
<!-- Code Gen -->
<rect x="280" y="20" width="70" height="45" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="2"/>
<text x="315" y="38" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#92400e">GENERATE</text>
<text x="315" y="52" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#f59e0b">→
LLVM IR</text> <!-- Arrow -->
<line x1="350" y1="42" x2="365" y2="42" stroke="#9ca3af" stroke-width="1.5"/>
<polygon points="365,42 359,38 359,46" fill="#9ca3af"/> <!-- Compile -->
<rect x="370" y="20" width="55" height="45" rx="4" fill="#fee2e2" stroke="#ef4444" stroke-width="2"/>
<text x="397" y="38" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#991b1b">COMPILE</text>
<text x="397" y="52" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#ef4444">llc</text>
<!-- Arrow -->
<line x1="425" y1="42" x2="440" y2="42" stroke="#9ca3af" stroke-width="1.5"/>
<polygon points="440,42 434,38 434,46" fill="#9ca3af"/> <!-- Link -->
<rect x="445" y="20" width="45" height="45" rx="4" fill="#1f2937" stroke="#1f2937" stroke-width="2"/>
<text x="467" y="38" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#ffffff">LINK</text>
<text x="467" y="52" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#9ca3af">binary</text>
<!-- Bottom: File representations -->
<text x="45" y="85" text-anchor="middle" font-family="monospace" font-size="8" fill="#6b7280"><em>.aro</text>
<text x="135" y="85" text-anchor="middle" font-family="monospace" font-size="8" fill="#6b7280">AST</text>
<text x="225" y="85" text-anchor="middle" font-family="monospace" font-size="8" fill="#6b7280">validated</text>
<text x="315" y="85" text-anchor="middle" font-family="monospace" font-size="8" fill="#6b7280"></em>.ll</text>
<text x="397" y="85" text-anchor="middle" font-family="monospace" font-size="8" fill="#6b7280">*.o</text>
<text x="467" y="85" text-anchor="middle" font-family="monospace" font-size="8" fill="#6b7280">MyApp</text>
<!-- Runtime library connection -->
<rect x="370" y="110" width="120" height="35" rx="4" fill="#e0e7ff" stroke="#6366f1" stroke-width="1" stroke-dasharray="4,2"/>
<text x="430" y="125" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#4338ca">ARO
Runtime Library</text>
<text x="430" y="138" text-anchor="middle" font-family="monospace" font-size="8" fill="#6366f1">libaro.a</text>
<!-- Dashed line to Link -->
<line x1="430" y1="110" x2="467" y2="65" stroke="#6366f1" stroke-width="1" stroke-dasharray="3,2"/>
</svg>
</div>
<p>Native compilation proceeds through a series of transformations that
convert ARO source code into an executable binary.</p>
<p>The process begins with discovery. The compiler scans your
application directory for ARO source files and auxiliary files like the
OpenAPI specification. It validates that exactly one Application-Start
feature set exists.</p>
<p>Parsing converts source text into abstract syntax trees. Each source
file is parsed independently, producing AST representations of the
feature sets and statements it contains. Parse errors at this stage
indicate syntax problems in your source code.</p>
<p>Semantic analysis validates the parsed code. It checks that
referenced variables are defined, that actions are used with valid
prepositions, and that data flows correctly through feature sets.
Semantic errors indicate logical problems that cannot be detected from
syntax alone.</p>
<p>Code generation produces LLVM IR from the validated AST. Each ARO
statement becomes one or more calls to the runtime library. The
generated code follows a straightforward translation pattern that
preserves the semantics of the original ARO code.</p>
<p>Compilation uses the LLVM toolchain to compile the generated IR into
object code. Optimization happens at this stage—LLVM can apply its full
range of optimizations to the generated code.</p>
<p>Linking combines the object code with the ARO runtime library to
produce the final executable. The runtime library contains
implementations of all the built-in actions, the event bus, HTTP client
and server, and other infrastructure your application depends on.</p>
<hr />
<h2 id="runtime-requirements">19.4 Runtime Requirements</h2>
<p>Native binaries link against the ARO runtime library, which provides
implementations of actions and services. This library is included in
every binary.</p>
<p>The OpenAPI specification file must still be present at runtime for
applications that serve HTTP requests. The specification defines
routing, and the runtime reads it when the HTTP server starts. Deploy
the openapi.yaml file alongside your binary.</p>
<p>Any configuration files or data files your application reads must
also be deployed. The native binary does not embed these files; it reads
them at runtime just as the interpreted version would.</p>
<p>Dynamically loaded plugins are not supported in native builds. All
actions must either be built-in or statically linked at compile time. If
you use plugins, they must be included as compile-time dependencies
rather than loaded at runtime.</p>
<hr />
<h2 id="binary-size-and-performance">19.5 Binary Size and
Performance</h2>
<p>Native binaries have characteristic size and performance profiles
that differ from interpreted execution.</p>
<p>Binary size depends on the complexity of your application and whether
optimizations are enabled. Release builds with stripping produce the
smallest binaries.</p>
<p>Startup time improves significantly with native binaries. Interpreted
execution must parse source files and compile them to an internal
representation before running. Native binaries skip this phase, starting
execution immediately. For applications that start
frequently—command-line tools, serverless functions—this improvement is
meaningful.</p>
<p>Runtime performance for I/O-bound workloads (most ARO applications)
is similar between interpreted and native execution. The bottleneck is
usually I/O—network requests, database queries, file operations—not the
execution of ARO statements. For compute-heavy workloads, native
compilation may provide some improvement.</p>
<p>Memory usage is typically lower for native binaries because they do
not maintain the interpreter infrastructure. This can be significant for
memory-constrained environments.</p>
<hr />
<h2 id="deployment">19.6 Deployment</h2>
<p>Native binaries simplify deployment because they have minimal runtime
dependencies. The binary, the OpenAPI specification (if using HTTP), and
any data files are all you need to deploy.</p>
<p>Containerization with Docker works well with native binaries. A
multi-stage build can use the full ARO development image for compilation
and a minimal base image for the final container. The resulting
container contains only the binary and required files, producing small,
efficient images.</p>
<p>Systemd and other service managers can run native binaries directly.
Create a service unit file that specifies the binary location, working
directory, user, and restart behavior. The binary behaves like any other
system service.</p>
<p>Cloud deployment to platforms that accept binaries—EC2, GCE, bare
metal—is straightforward. Upload the binary and supporting files,
configure networking and security, and run the binary. Platform-specific
considerations like health checks and logging integrations apply as they
would to any application.</p>
<hr />
<h2 id="debugging">19.7 Debugging</h2>
<p>Debugging native binaries requires different tools than debugging
interpreted execution. The runtime’s verbose output is not available;
instead, you use traditional native debugging tools.</p>
<p>Compile without the strip flag to retain debug symbols. These symbols
map binary locations back to source locations, enabling meaningful stack
traces and debugger operation.</p>
<p>System debuggers like lldb on macOS and gdb on Linux can attach to
your binary, set breakpoints, examine memory, and step through
execution. The code you debug is the compiled machine code rather than
the original ARO code, but the relationship is straightforward enough to
follow.</p>
<p>Core dumps capture the state of a crashed binary for post-mortem
analysis. Enable core dumps in your environment, and when a crash
occurs, use the debugger to examine the core file and understand what
happened.</p>
<p>Logging becomes more important when detailed runtime output is not
available. Include logging statements in your ARO code to provide
visibility into execution. The logged output is your primary window into
what the native binary does during execution.</p>
<hr />
<h2 id="output-formatting">19.8 Output Formatting</h2>
<p>Native binaries produce cleaner output than interpreted execution.
This difference is intentional and reflects the different contexts in
which each mode is used.</p>
<p>When running with the interpreter using <code>aro run</code>, log
messages include a feature set name prefix:</p>
<pre><code>[Application-Start] Starting server...
[Application-Start] Server ready on port 8080
[listUsers] Processing request...</code></pre>
<p>When running a compiled binary, the same log messages appear without
the prefix:</p>
<pre><code>Starting server...
Server ready on port 8080
Processing request...</code></pre>
<p>The interpreter’s prefix identifies which feature set produced each
message. This visibility aids debugging during development—when
something goes wrong, you can see exactly where messages originated. The
prefix becomes unnecessary noise in production, where the focus shifts
from debugging to clean operation.</p>
<p>Response formatting remains unchanged between modes. The
<code>[OK]</code> status prefix and response data appear identically in
both cases, providing consistent machine-parseable output for scripts
and monitoring tools.</p>
<hr />
<h2 id="development-workflow-1">19.9 Development Workflow</h2>
<p>Development typically uses interpreted execution for rapid iteration.
The interpreted mode has faster turnaround—you change code and
immediately run the updated version without a compile step. Verbose
output shows what the runtime does, aiding debugging and
understanding.</p>
<p>Native compilation enters the workflow for testing deployment
configurations and for final release builds. Testing with native
binaries before deployment catches problems that might only appear in
the native build, such as missing files or incorrect paths.</p>
<p>Continuous integration should build and test native binaries to
ensure they work correctly. The CI pipeline builds the binary, runs
tests against it, and produces artifacts for deployment. Catching
problems in CI prevents deployment failures.</p>
<p>Release processes should produce native binaries with release
optimizations. Tag releases in version control, build the release
binary, and archive it alongside release notes and deployment
documentation.</p>
<hr />
<h2 id="limitations">19.10 Limitations</h2>
<p>Native compilation has limitations compared to interpreted
execution.</p>
<p>Dynamic plugin loading is not supported. Plugins must be compile-time
dependencies, statically linked into the binary. This is a significant
limitation for applications that depend on runtime-discoverable
plugins.</p>
<p>Some runtime reflection capabilities may not be available. Features
that depend on examining the structure of running code may behave
differently or not work at all in native builds.</p>
<p>Cross-compilation is not currently supported. You build binaries for
the platform where you run the compiler. Building for different target
platforms requires building on those platforms or using platform
emulation.</p>
<p>The compilation step adds time to the development cycle. For rapid
iteration, this overhead makes interpreted execution preferable. Native
compilation is best reserved for testing and release.</p>
<hr />
<h2 id="best-practices-12">19.11 Best Practices</h2>
<p>Use interpreted mode during development for fast iteration and
detailed diagnostics. Switch to native compilation for deployment
testing and release.</p>
<p>Test native binaries before deployment. Some problems only appear in
native builds—missing files, path issues, platform differences. Running
your test suite against the native binary catches these problems
early.</p>
<p>Include native binary builds in continuous integration. Automated
builds ensure that native compilation continues to work as the codebase
evolves.</p>
<p>Use release optimizations for production deployments. The strip,
optimize, and size options (or the combined release option) produce the
smallest and fastest binaries.</p>
<p>Deploy the OpenAPI specification and other required files alongside
the binary. The binary alone is not sufficient for applications that
serve HTTP requests.</p>
<hr />
<p><em>Next: Chapter 20 — Multi-file Applications</em></p>
<h1 id="chapter-20-multi-file-applications">Chapter 20: Multi-file
Applications</h1>
<p><em>“Organize by domain, not by technical layer.”</em></p>
<hr />
<h2 id="application-structure">20.1 Application Structure</h2>
<p>An ARO application is a directory containing source files,
configuration, and optional auxiliary files. The runtime automatically
discovers all ARO source files in this directory and its subdirectories,
compiling them together into a unified application.</p>
<p>This directory-based approach differs from many languages where you
explicitly import dependencies between files. In ARO, there are no
imports. Every feature set in every source file is globally visible
within the application. An event emitted in one file can trigger a
handler defined in another file without any explicit connection between
them.</p>
<p>The automatic discovery means you can organize your source files
however makes sense for your project. Group by domain, by feature, by
technical concern, or by any other scheme. The runtime does not care
about your directory structure—it simply finds all the source files and
processes them together.</p>
<p>Certain files have special significance. The openapi.yaml file, if
present, defines the HTTP API contract. Plugin directories can contain
dynamically loaded extensions. Configuration files might be loaded
during startup. But the core source files—the .aro files containing your
feature sets—are all treated equally regardless of where they appear in
the directory tree.</p>
<hr />
<h2 id="auto-discovery">20.2 Auto-Discovery</h2>
<p>When you run an ARO application, the runtime scans the application
directory recursively for files with the .aro extension. Each file is
parsed, and its feature sets are registered. This happens automatically
without any configuration.</p>
<p>Verbose output shows what the discovery process finds. You can see
which files were discovered, how many feature sets each contains, and
whether an OpenAPI specification was found. This visibility helps you
verify that your application structure matches your expectations.</p>
<p>Subdirectories are fully supported. You can create deep hierarchies
if that helps organize your code. A large application might have domain
directories, each containing subdirectories for different aspects of
that domain. The runtime flattens this hierarchy during discovery—all
feature sets end up in the same namespace regardless of which
subdirectory they came from.</p>
<p>The discovery process validates structural requirements. It checks
that exactly one Application-Start feature set exists across all
discovered files. It checks that at most one Application-End: Success
and one Application-End: Error exist. Violations of these constraints
produce clear error messages indicating which files contain the
conflicting definitions.</p>
<hr />
<h2 id="global-visibility">20.3 Global Visibility</h2>
<p>Feature sets are globally visible without imports. This is a
fundamental design choice that enables loose coupling through
events.</p>
<p>When you emit an event in one file, handlers in any file can respond
to it. The emitting code does not need to know that handlers exist or
where they are defined. The handlers do not need to import the emitting
code. The connection happens at runtime through the event bus based on
naming conventions.</p>
<p>This global visibility means you must ensure feature set names are
unique across your entire application. If two files define feature sets
with the same name, the runtime reports an error. Choose distinctive
names that avoid conflicts.</p>
<p>The same visibility applies to published variables within a business
activity. When you use the Publish action to make a value available, it
becomes accessible from any feature set with the same business activity
that executes afterward. This scoping to business activity enforces
modularity—feature sets in different domains cannot accidentally depend
on each other’s published variables. Use publishing sparingly because
shared state complicates reasoning about program behavior.</p>
<p>Repositories are implicitly shared. When one feature set stores data
to a repository and another retrieves from the same repository, they are
working with shared storage. This is how data flows between feature sets
beyond the scope of a single event handling chain.</p>
<hr />
<h2 id="the-application-start-requirement">20.4 The Application-Start
Requirement</h2>
<p>Every ARO application must have exactly one Application-Start feature
set. This requirement ensures there is an unambiguous entry point for
execution.</p>
<p>Having zero Application-Start feature sets is an error. The runtime
would have nothing to execute, no way to begin the application’s work.
The error message explains this clearly and reminds you of the
requirement.</p>
<p>Having multiple Application-Start feature sets is also an error. The
runtime would not know which one to execute first or whether to execute
all of them. The error message lists the locations of all conflicting
definitions so you can resolve the conflict.</p>
<p>This constraint applies across all source files in the application.
It does not matter which file contains the Application-Start—what
matters is that exactly one exists somewhere in the application.</p>
<p>The Application-End feature sets (Success and Error variants) have
similar constraints. You can have at most one of each. Having multiple
success handlers or multiple error handlers creates ambiguity about
shutdown behavior.</p>
<hr />
<h2 id="organization-strategies">20.5 Organization Strategies</h2>
<p>Several strategies for organizing multi-file applications have proven
effective in practice.</p>
<p>Organization by domain groups related functionality together. A user
management domain might have files for CRUD operations, authentication,
and profile management. An order domain might have files for checkout,
payment, and fulfillment. Each domain directory contains everything
related to that business concept.</p>
<p>Organization by feature groups all code for a specific feature. A
product search feature might have its HTTP handlers, event handlers, and
utilities in one directory. This organization works well when features
are relatively independent and you want to see everything related to a
feature in one place.</p>
<p>Organization by technical concern groups code by what it does
technically. HTTP handlers go in one directory, event handlers in
another, background jobs in a third. This organization works well for
teams familiar with layered architectures and can make it easy to find
all handlers of a particular type.</p>
<p>Many applications combine these strategies. Domain directories at the
top level, with technical concerns separated within each domain. Or
feature directories with shared utilities factored out. The right
organization depends on your team and your application.</p>
<h3 id="complete-application-layout-example">Complete Application Layout
Example</h3>
<p>Here is a complete e-commerce API organized by domain:</p>
<pre><code>ecommerce-api/
├── openapi.yaml              # API contract (required for HTTP server)
├── main.aro                  # Application lifecycle only
├── products/
│   └── products.aro          # Product CRUD operations
├── orders/
│   ├── orders.aro            # Order CRUD operations
│   └── order-events.aro      # Order event handlers
├── inventory/
│   └── inventory.aro         # Stock management
└── notifications/
    └── notifications.aro     # Email/notification handlers</code></pre>
<p><strong>main.aro</strong> — Lifecycle only, no business logic:</p>
<pre class="aro"><code>(Application-Start: E-commerce API) {
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Starting e-commerce API...&quot;.
    &lt;Start&gt; the &lt;http-server&gt; on port 8080.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}

(Application-End: Success) {
    &lt;Stop&gt; the &lt;http-server&gt;.
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;E-commerce API stopped.&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;shutdown&gt;.
}</code></pre>
<p><strong>products/products.aro</strong> — Product domain:</p>
<pre class="aro"><code>(listProducts: Product API) {
    &lt;Retrieve&gt; the &lt;products&gt; from the &lt;product-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;products&gt;.
}

(getProduct: Product API) {
    &lt;Extract&gt; the &lt;id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;product&gt; from the &lt;product-repository&gt; where id = &lt;id&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;product&gt;.
}</code></pre>
<p><strong>orders/orders.aro</strong> — Order domain:</p>
<pre class="aro"><code>(createOrder: Order API) {
    &lt;Extract&gt; the &lt;order-data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;order&gt; with &lt;order-data&gt;.
    &lt;Store&gt; the &lt;order&gt; in the &lt;order-repository&gt;.
    &lt;Emit&gt; an &lt;OrderPlaced: event&gt; with &lt;order&gt;.
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;order&gt;.
}</code></pre>
<p><strong>orders/order-events.aro</strong> — Separated event
handlers:</p>
<pre class="aro"><code>(Reserve Stock: OrderPlaced Handler) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Extract&gt; the &lt;items&gt; from the &lt;order: items&gt;.
    &lt;Update&gt; the &lt;inventory&gt; for &lt;items&gt; with { reserved: true }.
    &lt;Emit&gt; an &lt;StockReserved: event&gt; with &lt;order&gt;.
}</code></pre>
<p><strong>notifications/notifications.aro</strong> — Cross-domain event
handlers:</p>
<pre class="aro"><code>(Send Order Confirmation: OrderPlaced Handler) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Extract&gt; the &lt;email&gt; from the &lt;order: customerEmail&gt;.
    &lt;Send&gt; the &lt;confirmation-email&gt; to the &lt;email-service&gt; with {
        to: &lt;email&gt;,
        template: &quot;order-confirmation&quot;,
        order: &lt;order&gt;
    }.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;notification&gt;.
}</code></pre>
<p>Key points in this layout: - <strong>main.aro</strong> contains only
lifecycle handlers - <strong>Each domain</strong> has its own directory
- <strong>Event handlers</strong> are separated from emitters -
<strong>Cross-domain handlers</strong> (notifications) have their own
location - <strong>No imports needed</strong> — all feature sets are
globally visible</p>
<blockquote>
<p><strong>See also:</strong> <code>Examples/UserService</code> for a
working multi-file application.</p>
</blockquote>
<hr />
<h2 id="recommended-patterns">20.6 Recommended Patterns</h2>
<p>Experience suggests some patterns that work well across different
types of applications.</p>
<p>Keep the main file minimal. It should contain only lifecycle feature
sets—Application-Start and Application-End. Business logic belongs in
other files organized by domain or feature. This keeps the entry point
focused and easy to understand.</p>
<p>Group related feature sets in the same file. All CRUD handlers for a
resource belong together. All handlers for a particular event type might
belong together. When you need to understand or modify how something
works, you should find all the relevant code in one or a few related
files.</p>
<p>Separate event handlers from the feature sets that emit events. The
code that creates a user and emits UserCreated belongs in the user
domain. The handlers that react to UserCreated might belong in separate
files—one for notifications, one for analytics, one for search indexing.
This separation allows adding handlers without modifying the emitting
code.</p>
<p>Use descriptive file names that indicate content. A file named
users.aro clearly contains user-related code. A file named
user-events.aro clearly contains event handlers for user events. Readers
should be able to navigate your codebase by file names alone.</p>
<hr />
<h2 id="sharing-data-between-files">20.7 Sharing Data Between Files</h2>
<p>Feature sets in different files can share data through several
mechanisms, each appropriate for different scenarios.</p>
<p>Events carry data from producers to consumers. When you emit an event
with a payload, handlers extract the data they need from that payload.
This is the primary mechanism for loosely coupled communication. The
producer does not know who consumes the event; consumers do not need to
be in the same file as the producer.</p>
<p>Published variables make data available within a business activity.
When you publish a value during startup, any feature set with the same
business activity that executes afterward can access it. This is
appropriate for configuration, constants, and shared state within a
domain. Use it sparingly because shared state complicates understanding
of program behavior.</p>
<p>Repositories provide persistent shared storage. One feature set
stores data; another retrieves it. The repository provides the shared
namespace. This is how data persists beyond the lifetime of individual
event handling and how different parts of the application work with the
same underlying data.</p>
<p>The choice between these mechanisms depends on the relationship
between the sharing feature sets. Closely related feature sets reacting
to the same event should use event data. Widely separated feature sets
needing configuration should use published variables. Feature sets that
work with persistent domain entities should use repositories.</p>
<hr />
<h2 id="best-practices-13">20.8 Best Practices</h2>
<p>Establish naming conventions early and follow them consistently. File
names, feature set names, event names, and repository names should
follow predictable patterns that team members can learn and apply.</p>
<p>Document the intended organization. New team members should
understand how files are organized and where new code should go. A brief
README or documented convention saves confusion and prevents
inconsistent organization.</p>
<p>Keep files focused. A file with fifty feature sets is probably too
large. If a file grows unwieldy, split it along natural
boundaries—separate CRUD from search, separate handlers from emitters,
separate domains from each other.</p>
<p>Consider how changes propagate. When you modify a feature set, what
other feature sets might be affected? The event-driven model means
effects can be non-obvious. Understanding the event flow through your
application helps you understand change impact.</p>
<p>Test files can follow the same organization as production code. Test
files for user functionality go alongside or parallel to user
functionality source files. This keeps tests easy to find and
maintain.</p>
<hr />
<p><em>Next: Chapter 21 — Patterns &amp; Practices</em></p>
<h1 id="chapter-21-patterns-practices">Chapter 21: Patterns &amp;
Practices</h1>
<p><em>“Good patterns emerge from solving real problems.”</em></p>
<hr />
<h2 id="crud-patterns">21.1 CRUD Patterns</h2>
<p>Most business applications need to create, read, update, and delete
resources. These CRUD operations follow predictable patterns in ARO that
you can apply consistently across your domains.</p>
<p>A complete CRUD service for a resource typically has five feature
sets. The list operation retrieves collections with pagination support.
The get operation retrieves a single resource by identifier. The create
operation makes new resources, stores them, and emits events. The update
operation modifies existing resources while preserving consistency. The
delete operation removes resources and notifies interested parties.</p>
<p>The list operation extracts pagination parameters from the query
string, retrieves matching records with those constraints, computes the
total count for pagination metadata, and returns a structured response
with both data and pagination information. Clients need the total to
know how many pages exist.</p>
<p>The get operation extracts the identifier from the path, retrieves
the matching record, and returns it. If no record matches, the runtime
generates a not-found error automatically. You do not write explicit
handling for the missing case.</p>
<p>The create operation extracts data from the request body, validates
it against the resource schema, creates the entity, stores it to the
repository, emits a created event for downstream processing, and returns
the new entity with a Created status.</p>
<p>The update operation must handle the merge between existing and new
data. It extracts the identifier and update data, retrieves the existing
record, merges the updates into the existing record, stores the result,
emits an updated event, and returns the modified entity.</p>
<p>The delete operation extracts the identifier, deletes the matching
record, emits a deleted event, and returns NoContent to indicate
successful completion without a response body.</p>
<hr />
<h2 id="event-sourcing">21.2 Event Sourcing</h2>
<p>Event sourcing stores the history of changes rather than current
state. Instead of updating a record in place, you append an event
describing what happened. Current state is computed by replaying events
from the beginning.</p>
<p>This pattern provides a complete audit trail of every change. You can
reconstruct state at any point in time by replaying events up to that
moment. You can analyze patterns of changes. You can correct errors by
appending compensating events rather than modifying history.</p>
<p>In ARO, event sourcing stores events to an event store repository
rather than storing entities to a regular repository. Each event
includes its type, the aggregate identifier it belongs to, the data
describing what happened, and a timestamp.</p>
<p>Reading current state requires retrieving all events for an aggregate
and reducing them to compute the current state. A custom action can
encapsulate this reduction logic, taking a list of events and producing
the current state object.</p>
<p>Projections build optimized read models from the event stream. Event
handlers listen for events and update read-optimized data structures.
This separates the write path (append events) from the read path (query
projections), enabling optimization of each independently.</p>
<p>Event sourcing adds complexity compared to simple CRUD. It is most
valuable when the audit trail is important, when you need to analyze
change patterns, or when you need to support time travel queries. For
simpler applications, traditional state-based storage is often
sufficient.</p>
<hr />
<h2 id="the-saga-pattern">21.3 The Saga Pattern</h2>
<div style="float: left; margin: 0 1.5em 1em 0;">
<svg width="160" height="180" viewBox="0 0 160 180" xmlns="http://www.w3.org/2000/svg">
<!-- Title -->
<text x="80" y="15" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#166534">Saga
Flow</text> <!-- Step 1 -->
<rect x="50" y="25" width="60" height="22" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="80" y="40" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#166534">Step
1</text>
<line x1="80" y1="47" x2="80" y2="57" stroke="#22c55e" stroke-width="1.5"/>
<polygon points="80,57 76,52 84,52" fill="#22c55e"/> <!-- Step 2 -->
<rect x="50" y="60" width="60" height="22" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="80" y="75" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#166534">Step
2</text>
<line x1="80" y1="82" x2="80" y2="92" stroke="#22c55e" stroke-width="1.5"/>
<polygon points="80,92 76,87 84,87" fill="#22c55e"/>
<!-- Step 3 (fails) -->
<rect x="50" y="95" width="60" height="22" rx="3" fill="#fee2e2" stroke="#ef4444" stroke-width="1.5"/>
<text x="80" y="110" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#991b1b">Step
3 ✗</text> <!-- Compensation arrows -->
<line x1="50" y1="106" x2="25" y2="106" stroke="#ef4444" stroke-width="1" stroke-dasharray="3,2"/>
<line x1="25" y1="106" x2="25" y2="40" stroke="#ef4444" stroke-width="1" stroke-dasharray="3,2"/>
<polygon points="25,40 21,46 29,46" fill="#ef4444"/>
<!-- Compensation boxes -->
<rect x="5" y="125" width="45" height="18" rx="2" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
<text x="27" y="137" text-anchor="middle" font-family="sans-serif" font-size="6" fill="#92400e">undo
2</text>
<rect x="55" y="125" width="45" height="18" rx="2" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
<text x="77" y="137" text-anchor="middle" font-family="sans-serif" font-size="6" fill="#92400e">undo
1</text> <!-- Labels -->
<text x="80" y="158" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">compensate
on failure</text>
</svg>
</div>
<p>Sagas coordinate long-running business processes that span multiple
steps, each of which might succeed or fail independently. Rather than
executing all steps in a single transaction, sagas chain steps through
events and provide compensation when steps fail.</p>
<p>A typical saga begins with an initiating request that starts the
process. This first step stores initial state, emits an event to trigger
the next step, and returns immediately with an accepted status. The
caller knows the process has started but not that it has completed.</p>
<p>Each subsequent step is an event handler that performs one piece of
the overall process. It receives the event from the previous step, does
its work, and emits an event to trigger the next step. Success
propagates forward through the event chain.</p>
<p>When a step fails, compensation handlers clean up the effects of
previous steps. A PaymentFailed event might trigger a handler that
releases reserved inventory. An InventoryUnavailable event might trigger
a handler that cancels the pending order. Each compensation reverses one
step of the saga.</p>
<p>The saga pattern trades atomicity for availability. Unlike a
transaction that succeeds or fails completely, a saga can be partially
complete while some steps succeed and others fail. The compensation
handlers bring the system to a consistent state, but intermediate states
are visible.</p>
<p>Use sagas when you need to coordinate actions across multiple
services or when steps take significant time. For quick operations that
can complete atomically, simpler patterns are appropriate.</p>
<hr />
<h2 id="the-gateway-pattern">21.4 The Gateway Pattern</h2>
<p>API gateways aggregate data from multiple backend services into
unified responses. Rather than having clients make multiple calls and
combine results, the gateway handles this coordination.</p>
<p>A gateway handler extracts request parameters, makes parallel or
sequential calls to backend services, combines the results into a
unified response, and returns it. The client sees a single endpoint that
provides rich, aggregated data.</p>
<p>The pattern is valuable when clients need data from multiple sources.
A product details page might need product information from the catalog
service, stock levels from the inventory service, reviews from the
review service, and pricing from the pricing service. A gateway endpoint
fetches all of this and returns a complete product details object.</p>
<p>Gateway handlers should be designed for resilience. Backend services
might be slow or unavailable. Consider timeout handling, fallback data
for unavailable services, and partial responses when some data cannot be
retrieved.</p>
<p>The gateway pattern can also handle cross-cutting concerns like
authentication, rate limiting, and logging that apply across all backend
calls. The gateway becomes a single enforcement point for these
concerns.</p>
<hr />
<h2 id="command-query-responsibility-segregation">21.5 Command Query
Responsibility Segregation</h2>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="180" height="160" viewBox="0 0 180 160" xmlns="http://www.w3.org/2000/svg">
<!-- Title -->
<text x="90" y="15" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#374151">CQRS</text>
<!-- Command side -->
<rect x="10" y="30" width="70" height="25" rx="3" fill="#fee2e2" stroke="#ef4444" stroke-width="1.5"/>
<text x="45" y="46" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#991b1b">Commands</text>
<line x1="45" y1="55" x2="45" y2="75" stroke="#ef4444" stroke-width="1.5"/>
<polygon points="45,75 40,68 50,68" fill="#ef4444"/>
<rect x="10" y="80" width="70" height="25" rx="3" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<text x="45" y="96" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#92400e">Write
Store</text> <!-- Query side -->
<rect x="100" y="30" width="70" height="25" rx="3" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
<text x="135" y="46" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#1e40af">Queries</text>
<line x1="135" y1="55" x2="135" y2="75" stroke="#3b82f6" stroke-width="1.5"/>
<polygon points="135,75 130,68 140,68" fill="#3b82f6"/>
<rect x="100" y="80" width="70" height="25" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="135" y="96" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#166534">Read
Model</text> <!-- Sync arrow -->
<line x1="80" y1="92" x2="100" y2="92" stroke="#9ca3af" stroke-width="1" stroke-dasharray="3,2"/>
<polygon points="100,92 95,89 95,95" fill="#9ca3af"/>
<text x="90" y="118" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">events
sync</text> <!-- Labels -->
<text x="45" y="140" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#ef4444">consistency</text>
<text x="135" y="140" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#3b82f6">optimized</text>
</svg>
</div>
<p>CQRS separates read operations from write operations, using different
models optimized for each. Commands (writes) update the authoritative
data store. Queries (reads) retrieve data from optimized read
models.</p>
<p>The write side receives commands, validates them, updates the
authoritative store, and emits events describing what changed. The focus
is on maintaining consistency and enforcing business rules.</p>
<p>The read side maintains projections optimized for query patterns.
When events occur, handlers update these projections. The projections
might denormalize data, pre-compute aggregates, or organize data for
specific query patterns.</p>
<p>This separation allows independent optimization. The write side can
use a normalized relational database that enforces consistency. The read
side can use denormalized document stores, search indices, or caching
layers that optimize for specific query patterns.</p>
<p>CQRS adds complexity because you maintain multiple representations of
data that must stay synchronized. It is most valuable when read and
write patterns differ significantly—when you need rich queries that do
not match your write model, or when read load vastly exceeds write load
and you need to scale them independently.</p>
<hr />
<h2 id="error-handling-patterns">21.6 Error Handling Patterns</h2>
<p>ARO’s happy path philosophy means you do not write explicit error
handling, but you can still respond to errors through event-driven
patterns.</p>
<p>Error events can be emitted by custom actions when failures occur. A
PaymentFailed event carries information about what went wrong. Handlers
for error events can log details, notify administrators, trigger
compensating actions, or update status to reflect the failure.</p>
<p>Retry patterns can be implemented in custom actions that wrap
unreliable operations. The action attempts the operation, retries on
transient failures with backoff, and eventually either succeeds or emits
a failure event. The ARO code sees only success or a well-defined
failure event.</p>
<p>Dead letter handling captures messages that fail repeatedly. After a
configured number of retries, the message goes to a dead letter queue
where it can be examined, corrected, and replayed. This prevents poison
messages from blocking processing while preserving them for
investigation.</p>
<p>Circuit breaker patterns can protect against cascading failures when
backend services are unavailable. A custom action tracks failure rates
and stops making calls when failures exceed a threshold, returning a
fallback response instead. This prevents overwhelming already struggling
services.</p>
<hr />
<h2 id="security-patterns">21.7 Security Patterns</h2>
<p>Authentication verifies caller identity. Security-sensitive endpoints
extract authentication tokens, validate them against an authentication
service, and extract identity claims. Subsequent operations use the
validated identity.</p>
<p>Authorization verifies caller permissions. After authentication
establishes who the caller is, authorization checks what they can do.
This might involve checking role membership, querying a permissions
service, or evaluating policy rules.</p>
<p>Rate limiting prevents abuse by limiting request rates per client. A
rate limiting action checks whether the current request exceeds limits
and fails if so. This protects against denial of service and ensures
fair resource allocation.</p>
<p>Input validation prevents injection and other attacks. Validating
request data against schemas catches malformed input before it can cause
harm. Custom validation actions can implement domain-specific security
rules.</p>
<p>These patterns compose together. A secured endpoint might extract and
validate a token, check rate limits, validate input, and only then
proceed with business logic. Each layer provides defense in depth.</p>
<hr />
<h2 id="performance-patterns">21.8 Performance Patterns</h2>
<p>Caching reduces load on backend services by storing frequently
accessed data. A cache-aware handler first checks the cache. On cache
hit, it returns immediately. On cache miss, it fetches from the source,
stores in the cache, and returns. Time-to-live settings control cache
freshness.</p>
<p>Batch processing handles multiple items efficiently. Rather than
processing items one at a time, a batch handler receives a collection
and processes them together. This can reduce round trips to backend
services and enable bulk operations that are more efficient than
individual operations.</p>
<p>Parallel processing handles independent operations concurrently. When
multiple pieces of data are needed and they do not depend on each other,
fetching them in parallel reduces total latency compared to sequential
fetching.</p>
<p>Connection pooling maintains reusable connections to backend
services. Rather than establishing a new connection for each request,
handlers borrow connections from a pool and return them when done. This
amortizes connection setup cost across many requests.</p>
<p>Pagination prevents unbounded result sets. List operations return
limited pages of results with metadata indicating total count and how to
fetch additional pages. This prevents memory exhaustion from large
result sets and provides consistent response times.</p>
<hr />
<h2 id="best-practices-summary">21.9 Best Practices Summary</h2>
<p>These practices have emerged from experience building ARO
applications and reflect lessons learned about what works well.</p>
<p>Keep feature sets focused on single responsibilities. A feature set
that does one thing well is easier to understand, test, and maintain
than one that does many things.</p>
<p>Use events for side effects and communication. Rather than calling
between feature sets, emit events and let handlers react. This
decoupling makes the system more flexible and easier to evolve.</p>
<p>Organize code by domain rather than technical layer. Put user-related
code together, not all HTTP handlers together. This makes it easier to
understand and modify domain functionality.</p>
<p>Leverage the happy path philosophy. Trust the runtime to handle
errors. Focus your code on what should happen when things work
correctly.</p>
<p>Use meaningful names because they become part of error messages. Good
names make errors understandable without consulting source code.</p>
<p>Keep Application-Start minimal. It should start services and set up
the environment, not implement business logic.</p>
<p>Publish variables sparingly. Shared state complicates reasoning about
program behavior. Prefer events and repositories for sharing data.</p>
<p>Design for idempotency. Events might be delivered more than once.
Handlers that can safely process duplicates are more resilient than
those that cannot.</p>
<p>Test at multiple levels. Unit test individual feature sets.
Integration test event flows. End-to-end test complete scenarios.</p>
<p>Document the non-obvious. Code should be self-documenting for basic
behavior. Comments should explain why, not what—the reasons behind
non-obvious choices.</p>
<hr />
<p><em>Next: Chapter 22 — State Machines</em></p>
<h1 id="chapter-22-state-machines">Chapter 22: State Machines</h1>
<p><em>“A business object is only as valid as its current
state.”</em></p>
<hr />
<h2 id="why-state-machines-matter">22.1 Why State Machines Matter</h2>
<p>Business entities rarely exist in a single state. An order is
drafted, placed, paid, shipped, and delivered. A support ticket is
opened, assigned, escalated, and resolved. A document is drafted,
reviewed, approved, and published. These lifecycles define what
operations are valid at each point in time.</p>
<p>Without explicit state management, code becomes defensive. Developers
scatter validation checks throughout the codebase: “Is this order
paid?”, “Can we ship this?”, “Has this been approved?” These checks
duplicate business rules, create inconsistencies, and make the intended
lifecycle invisible.</p>
<p>State machines make lifecycles explicit. They define what states
exist, what transitions between states are valid, and what happens when
an invalid transition is attempted. The state machine becomes a source
of truth for the entity’s lifecycle.</p>
<hr />
<h2 id="aros-approach-to-state">22.2 ARO’s Approach to State</h2>
<p>ARO takes a deliberately simple approach to state machines. There is
no state machine library, no visual editor, no hierarchical states.
Instead, ARO provides a single action—<code>Accept</code>—that validates
and applies state transitions within your existing feature sets.</p>
<p>This simplicity is intentional. Most business logic needs
straightforward linear or branching state flows, not the full complexity
of hierarchical state machines with parallel regions and history states.
By using a simple primitive, ARO keeps the language small while enabling
the patterns that matter most.</p>
<p>States in ARO are defined as OpenAPI enum types. This means your API
contract documents the valid states for each entity. Clients can see
what states exist. Tooling can validate state values. The contract
becomes the single source of truth.</p>
<hr />
<h2 id="defining-states-in-openapi">22.3 Defining States in OpenAPI</h2>
<p>States are defined as string enums in your OpenAPI specification.
Here is how an order lifecycle might be defined:</p>
<div class="sourceCode" id="cb152"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span><span class="kw">:</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schemas</span><span class="kw">:</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">OrderStatus</span><span class="kw">:</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Valid order states in the lifecycle</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">enum</span><span class="kw">:</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> draft</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> placed</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> paid</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> shipped</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> delivered</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> cancelled</span></span></code></pre></div>
<p>The enum values define all possible states. The order in the enum
often reflects the expected progression, though this is convention
rather than enforcement. An order typically flows from draft through
placed, paid, shipped, to delivered—but the enum itself does not encode
these transitions.</p>
<p>The entity schema references this status type:</p>
<div class="sourceCode" id="cb153"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Order</span><span class="kw">:</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">status</span><span class="kw">:</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">$ref</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;#/components/schemas/OrderStatus&#39;</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">customerId</span><span class="kw">:</span></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">items</span><span class="kw">:</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> array</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">items</span><span class="kw">:</span></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">$ref</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;#/components/schemas/OrderItem&#39;</span></span></code></pre></div>
<p>This creates a clear contract: orders have a status field that must
be one of the defined enum values. The API documentation shows clients
exactly what states exist.</p>
<hr />
<h2 id="the-accept-action">22.4 The Accept Action</h2>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="180" height="200" viewBox="0 0 180 200" xmlns="http://www.w3.org/2000/svg">
<!-- Title -->
<p><text x="90" y="15" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#374151">Accept
Action Flow</text></p>
<!-- Current State -->
<p><rect x="55" y="30" width="70" height="28" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
<text x="90" y="48" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#1e40af">Current
State</text></p>
<!-- Arrow down -->
<p><line x1="90" y1="58" x2="90" y2="72" stroke="#6b7280" stroke-width="1.5"/>
<polygon points="90,72 86,66 94,66" fill="#6b7280"/></p>
<!-- Check box -->
<p><rect x="40" y="75" width="100" height="28" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<text x="90" y="93" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#92400e">Validate:
from?</text></p>
<!-- Branch -->
<p><line x1="90" y1="103" x2="90" y2="115" stroke="#6b7280" stroke-width="1"/></p>
<!-- Yes branch -->
<p><line x1="90" y1="115" x2="50" y2="130" stroke="#22c55e" stroke-width="1.5"/>
<text x="55" y="125" font-family="sans-serif" font-size="7" fill="#22c55e">match</text></p>
<!-- No branch -->
<p><line x1="90" y1="115" x2="130" y2="130" stroke="#ef4444" stroke-width="1.5"/>
<text x="120" y="125" font-family="sans-serif" font-size="7" fill="#ef4444">no
match</text></p>
<!-- Success: Update -->
<p><rect x="15" y="135" width="70" height="28" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="50" y="153" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#166534">Update
to: to</text></p>
<!-- Failure: Error -->
<p><rect x="95" y="135" width="70" height="28" rx="4" fill="#fee2e2" stroke="#ef4444" stroke-width="1.5"/>
<text x="130" y="153" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#991b1b">Throw
Error</text></p>
<!-- Continue -->
<line x1="50" y1="163" x2="50" y2="180" stroke="#22c55e" stroke-width="1.5"/>
<polygon points="50,180 46,174 54,174" fill="#22c55e"/>
<text x="50" y="193" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#166534">continue</text>
</svg>
</div>
<p>The <code>Accept</code> action validates and applies state
transitions. It checks that an object’s current state matches an
expected “from” state, and if so, updates it to a “to” state. If the
current state does not match, execution stops with a descriptive
error.</p>
<p>The syntax uses the <code>_to_</code> separator to specify the
transition:</p>
<pre class="aro"><code>&lt;Accept&gt; the &lt;transition: from_to_target&gt; on &lt;object: field&gt;.</code></pre>
<p>The transition specifier contains both states separated by
<code>_to_</code>. The object specifier identifies which entity and
which field to examine and update.</p>
<p>Here is a concrete example that transitions an order from draft to
placed:</p>
<pre class="aro"><code>&lt;Accept&gt; the &lt;transition: draft_to_placed&gt; on &lt;order: status&gt;.</code></pre>
<p>This statement does three things:</p>
<ol type="1">
<li>Retrieves the current value of <code>order.status</code></li>
<li>Validates that the current value equals <code>"draft"</code></li>
<li>Updates <code>order.status</code> to <code>"placed"</code></li>
</ol>
<p>If the order’s status is not <code>"draft"</code>, execution stops
with an error. The caller receives a message explaining what went
wrong.</p>
<hr />
<h2 id="state-transition-validation">22.5 State Transition
Validation</h2>
<p>The Accept action provides clear error messages when transitions
fail. If you attempt to place an order that has already been paid:</p>
<pre><code>Cannot accept state draft-&gt;placed on order: status. Current state is &quot;paid&quot;.</code></pre>
<p>This message tells you exactly what happened: the transition expected
the order to be in draft state, but it was actually in paid state. No
stack traces, no cryptic error codes—just a clear statement of the
business rule violation.</p>
<p>This follows ARO’s happy path philosophy. You write code for the
expected flow. The runtime handles the error cases automatically,
generating messages that describe the problem in business terms.</p>
<p>Consider what this means for debugging. When a user reports “I can’t
place my order,” you know immediately that the order is not in draft
state. The error message tells you the actual state. You can investigate
why the order reached that state without the transition being attempted
first.</p>
<hr />
<h2 id="complete-example-order-lifecycle">22.6 Complete Example: Order
Lifecycle</h2>
<div style="float: left; margin: 0 1.5em 1em 0;">
<svg width="140" height="280" viewBox="0 0 140 280" xmlns="http://www.w3.org/2000/svg">
<!-- Title -->
<p><text x="70" y="15" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#374151">Order
Lifecycle</text></p>
<!-- Draft -->
<p><rect x="35" y="28" width="70" height="24" rx="12" fill="#e0e7ff" stroke="#6366f1" stroke-width="1.5"/>
<text x="70" y="44" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#4338ca">draft</text></p>
<!-- Arrow to placed -->
<p><line x1="70" y1="52" x2="70" y2="68" stroke="#22c55e" stroke-width="1.5"/>
<polygon points="70,68 66,62 74,62" fill="#22c55e"/></p>
<!-- Placed -->
<p><rect x="35" y="72" width="70" height="24" rx="12" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
<text x="70" y="88" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#1e40af">placed</text></p>
<!-- Arrow to paid -->
<p><line x1="70" y1="96" x2="70" y2="112" stroke="#22c55e" stroke-width="1.5"/>
<polygon points="70,112 66,106 74,106" fill="#22c55e"/></p>
<!-- Paid -->
<p><rect x="35" y="116" width="70" height="24" rx="12" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="70" y="132" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#166534">paid</text></p>
<!-- Arrow to shipped -->
<p><line x1="70" y1="140" x2="70" y2="156" stroke="#22c55e" stroke-width="1.5"/>
<polygon points="70,156 66,150 74,150" fill="#22c55e"/></p>
<!-- Shipped -->
<p><rect x="35" y="160" width="70" height="24" rx="12" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<text x="70" y="176" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#92400e">shipped</text></p>
<!-- Arrow to delivered -->
<p><line x1="70" y1="184" x2="70" y2="200" stroke="#22c55e" stroke-width="1.5"/>
<polygon points="70,200 66,194 74,194" fill="#22c55e"/></p>
<!-- Delivered -->
<p><rect x="35" y="204" width="70" height="24" rx="12" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
<text x="70" y="220" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#065f46">delivered</text></p>
<!-- Cancel branch from draft -->
<p><line x1="35" y1="40" x2="15" y2="40" stroke="#ef4444" stroke-width="1" stroke-dasharray="3,2"/>
<line x1="15" y1="40" x2="15" y2="248" stroke="#ef4444" stroke-width="1" stroke-dasharray="3,2"/>
<line x1="15" y1="248" x2="35" y2="248" stroke="#ef4444" stroke-width="1" stroke-dasharray="3,2"/>
<polygon points="35,248 29,244 29,252" fill="#ef4444"/></p>
<!-- Cancelled -->
<p><rect x="35" y="236" width="70" height="24" rx="12" fill="#fee2e2" stroke="#ef4444" stroke-width="1.5"/>
<text x="70" y="252" text-anchor="middle" font-family="sans-serif" font-size="9" fill="#991b1b">cancelled</text></p>
<!-- Cancel label -->
<text x="8" y="145" font-family="sans-serif" font-size="7" fill="#ef4444" transform="rotate(-90, 8, 145)">cancel</text>
</svg>
</div>
<p>Let us walk through a complete order management service that uses
state transitions. Orders flow through a lifecycle: they start as
drafts, get placed, are paid for, ship, and finally arrive. At any point
before placement, an order can be cancelled.</p>
<p>First, the OpenAPI contract defines the states and the operations
that trigger transitions:</p>
<div class="sourceCode" id="cb157"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paths</span><span class="kw">:</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">/orders/{id}/place</span><span class="kw">:</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">post</span><span class="kw">:</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> placeOrder</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> Place a draft order</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Transitions from draft to placed</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">/orders/{id}/pay</span><span class="kw">:</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">post</span><span class="kw">:</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> payOrder</span></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> Record payment</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Transitions from placed to paid</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">/orders/{id}/ship</span><span class="kw">:</span></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">post</span><span class="kw">:</span></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> shipOrder</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> Ship the order</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Transitions from paid to shipped</span></span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">/orders/{id}/deliver</span><span class="kw">:</span></span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">post</span><span class="kw">:</span></span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> deliverOrder</span></span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> Mark as delivered</span></span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Transitions from shipped to delivered</span></span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">/orders/{id}/cancel</span><span class="kw">:</span></span>
<span id="cb157-27"><a href="#cb157-27" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">post</span><span class="kw">:</span></span>
<span id="cb157-28"><a href="#cb157-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">operationId</span><span class="kw">:</span><span class="at"> cancelOrder</span></span>
<span id="cb157-29"><a href="#cb157-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">summary</span><span class="kw">:</span><span class="at"> Cancel an order</span></span>
<span id="cb157-30"><a href="#cb157-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">description</span><span class="kw">:</span><span class="at"> Only valid from draft state</span></span></code></pre></div>
<p>Each endpoint documents which state transition it performs. This
makes the API self-documenting—clients can see the lifecycle from the
contract.</p>
<p>Now the ARO feature sets that implement these transitions:</p>
<pre class="aro"><code>(* Create a new order in draft state *)
(createOrder: Order Management) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;order: Order&gt; with &lt;data&gt;.
    &lt;Update&gt; the &lt;order: status&gt; with &quot;draft&quot;.
    &lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;order&gt;.
}

(* Place an order - transitions from draft to placed *)
(placeOrder: Order Management) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt;
        where &lt;id&gt; is &lt;order-id&gt;.

    &lt;Accept&gt; the &lt;transition: draft_to_placed&gt; on &lt;order: status&gt;.

    &lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;order&gt;.
}</code></pre>
<p>The <code>createOrder</code> feature set explicitly sets the initial
state to “draft”. This makes the starting point clear in the code. The
<code>placeOrder</code> feature set uses <code>Accept</code> to validate
the transition before updating storage.</p>
<p>The remaining transitions follow the same pattern:</p>
<pre class="aro"><code>(* Pay for an order - transitions from placed to paid *)
(payOrder: Order Management) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Extract&gt; the &lt;payment&gt; from the &lt;request: body&gt;.
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt;
        where &lt;id&gt; is &lt;order-id&gt;.

    &lt;Accept&gt; the &lt;transition: placed_to_paid&gt; on &lt;order: status&gt;.

    &lt;Update&gt; the &lt;order: paymentMethod&gt; from the &lt;payment: paymentMethod&gt;.
    &lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;order&gt;.
}

(* Ship an order - transitions from paid to shipped *)
(shipOrder: Order Management) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Extract&gt; the &lt;shipping&gt; from the &lt;request: body&gt;.
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt;
        where &lt;id&gt; is &lt;order-id&gt;.

    &lt;Accept&gt; the &lt;transition: paid_to_shipped&gt; on &lt;order: status&gt;.

    &lt;Update&gt; the &lt;order: trackingNumber&gt;
        from the &lt;shipping: trackingNumber&gt;.
    &lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;order&gt;.
}

(* Deliver an order - transitions from shipped to delivered *)
(deliverOrder: Order Management) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt;
        where &lt;id&gt; is &lt;order-id&gt;.

    &lt;Accept&gt; the &lt;transition: shipped_to_delivered&gt; on &lt;order: status&gt;.

    &lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;order&gt;.
}</code></pre>
<p>Each feature set retrieves the order, validates and applies its
transition, stores the result, and returns. The business logic is clear:
you can pay a placed order, ship a paid order, and deliver a shipped
order. Any attempt to skip steps fails with a descriptive error.</p>
<hr />
<h2 id="cancellation-paths">22.7 Cancellation Paths</h2>
<p>Real business processes have more than one terminal state. Orders can
be cancelled as well as delivered. The state machine must define which
transitions lead to cancellation.</p>
<pre class="aro"><code>(* Cancel an order - only valid from draft state *)
(cancelOrder: Order Management) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt;
        where &lt;id&gt; is &lt;order-id&gt;.

    &lt;Accept&gt; the &lt;transition: draft_to_cancelled&gt; on &lt;order: status&gt;.

    &lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;order&gt;.
}</code></pre>
<p>This implementation only allows cancellation from the draft state. If
you need to allow cancellation from multiple states, you have
options.</p>
<p>One approach is multiple feature sets with different transitions:</p>
<pre class="aro"><code>(* Cancel from draft *)
(cancelDraftOrder: Order Management) {
    (* ... *)
    &lt;Accept&gt; the &lt;transition: draft_to_cancelled&gt; on &lt;order: status&gt;.
    (* ... *)
}

(* Cancel from placed - might require refund logic *)
(cancelPlacedOrder: Order Management) {
    (* ... *)
    &lt;Accept&gt; the &lt;transition: placed_to_cancelled&gt; on &lt;order: status&gt;.
    &lt;Emit&gt; a &lt;RefundRequired: event&gt; with &lt;order&gt;.
    (* ... *)
}</code></pre>
<p>Another approach is conditional logic using standard control
flow:</p>
<pre class="aro"><code>(cancelOrder: Order Management) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt;
        where &lt;id&gt; is &lt;order-id&gt;.

    (* Check current state and apply appropriate transition *)
    match &lt;order: status&gt; {
        case &quot;draft&quot; {
            &lt;Accept&gt; the &lt;transition: draft_to_cancelled&gt; on &lt;order: status&gt;.
        }
        case &quot;placed&quot; {
            &lt;Accept&gt; the &lt;transition: placed_to_cancelled&gt; on &lt;order: status&gt;.
            &lt;Emit&gt; a &lt;RefundRequired: event&gt; with &lt;order&gt;.
        }
    }

    &lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;order&gt;.
}</code></pre>
<p>The choice depends on whether the different cancellation paths have
different side effects. If cancelling a placed order requires a refund
but cancelling a draft does not, separate feature sets make the
distinction clear.</p>
<hr />
<h2 id="what-aro-does-not-do">22.8 What ARO Does Not Do</h2>
<p>ARO’s state machine approach is deliberately minimal. Understanding
what it does not do helps you decide when simpler approaches suffice and
when you need external tooling.</p>
<p><strong>No hierarchical states.</strong> States are flat strings. If
you need a state like “processing.validating” or “processing.charging”,
you would model these as separate states or use a separate field for the
sub-state.</p>
<p><strong>No parallel states.</strong> An entity has one state at a
time. If you need to track multiple concurrent aspects—order fulfillment
state and payment state separately—use multiple state fields, each with
its own transitions.</p>
<p><strong>No entry or exit actions.</strong> The Accept action does not
automatically trigger code when entering or leaving a state. If you need
side effects on state change, add explicit statements after the Accept
action or emit events that handlers process.</p>
<p><strong>No state machine visualization.</strong> ARO does not
generate state diagrams from your code. The OpenAPI contract with its
enum and operation descriptions serves as documentation. For visual
diagrams, use external tools with your OpenAPI spec as input.</p>
<p><strong>No automatic validation against the enum.</strong> The Accept
action validates that the current state matches the expected “from”
state. It does not validate that both “from” and “to” are members of the
OpenAPI enum. That validation happens when you store the entity or when
an HTTP response is serialized.</p>
<p>These limitations are features, not bugs. They keep the language
simple. For most business applications, flat states with explicit
transitions are sufficient. When you need the full power of statecharts,
integrate a dedicated state machine library through custom actions.</p>
<hr />
<h2 id="combining-states-with-events">22.9 Combining States with
Events</h2>
<p>State transitions naturally pair with events. When an order moves to
a new state, other parts of the system often need to react. Shipping
needs to know when orders are paid. Notifications need to know when
orders are delivered.</p>
<pre class="aro"><code>(shipOrder: Order Management) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt;
        where &lt;id&gt; is &lt;order-id&gt;.

    &lt;Accept&gt; the &lt;transition: paid_to_shipped&gt; on &lt;order: status&gt;.

    &lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.

    (* Notify interested parties *)
    &lt;Emit&gt; an &lt;OrderShipped: event&gt; with &lt;order&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;order&gt;.
}

(* Handler reacts to the state change *)
(Notify Customer: OrderShipped Handler) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Extract&gt; the &lt;customer-email&gt; from the &lt;order: customerEmail&gt;.
    &lt;Extract&gt; the &lt;tracking&gt; from the &lt;order: trackingNumber&gt;.

    &lt;Send&gt; the &lt;shipping-notification: email&gt; to &lt;customer-email&gt;
        with &lt;tracking&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;notification&gt;.
}</code></pre>
<p>The feature set that changes state is responsible for emitting
events. Handlers subscribe to those events and perform side effects.
This separation keeps the state transition code focused on the
transition itself while allowing arbitrary reactions through the event
system.</p>
<p>This pattern also supports saga-style workflows where a state change
in one entity triggers state changes in others, each with its own
validation.</p>
<h3 id="state-guarded-handlers">22.9.1 State-Guarded Handlers</h3>
<p>Sometimes you want handlers to only execute when an entity is in a
specific state. Rather than checking the state inside the handler, you
can filter events at the handler definition using state guards:</p>
<pre class="aro"><code>(* Only process orders that are in &quot;paid&quot; state *)
(Process Paid Order: OrderUpdated Handler&lt;status:paid&gt;) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    (* This handler only runs when order.status = &quot;paid&quot; *)
    &lt;Process&gt; the &lt;fulfillment&gt; for the &lt;order&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;processing&gt;.
}</code></pre>
<p>State guards use angle bracket syntax after “Handler”:</p>
<ul>
<li><code>&lt;field:value&gt;</code> - Match when field equals
value</li>
<li><code>&lt;field:value1,value2&gt;</code> - Match when field equals
any value (OR logic)</li>
<li><code>&lt;field1:value;field2:value&gt;</code> - Match when both
conditions are true (AND logic)</li>
</ul>
<pre class="aro"><code>(* Handle orders that are paid OR shipped *)
(Track Fulfillment: OrderUpdated Handler&lt;status:paid,shipped&gt;) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Tracking update&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;tracking&gt;.
}

(* Only premium customers with delivered orders *)
(VIP Reward: OrderUpdated Handler&lt;status:delivered;tier:premium&gt;) {
    &lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.
    &lt;Send&gt; the &lt;reward&gt; to the &lt;order: email&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;reward&gt;.
}</code></pre>
<p>State guards enable guaranteed ordering through state-based
filtering. Instead of relying on event order, you can ensure handlers
only execute when the entity has reached a specific state.</p>
<hr />
<h2 id="best-practices-14">22.10 Best Practices</h2>
<p><strong>Define all states in OpenAPI.</strong> The contract should be
the source of truth for what states exist. Clients and tooling can use
this information.</p>
<p><strong>Use explicit initial states.</strong> When creating entities,
set their initial state explicitly rather than relying on defaults. This
makes the starting point visible in the code.</p>
<p><strong>Document transitions in OpenAPI descriptions.</strong> Each
endpoint that changes state should document which transition it
performs. The <code>description</code> field is a good place for
this.</p>
<p><strong>Keep states coarse-grained.</strong> Prefer fewer states with
clear business meaning over many fine-grained states. “Processing” is
often better than “validating”, “charging”, “confirming” as separate
states unless those distinctions matter to callers.</p>
<p><strong>Emit events on state changes.</strong> Other parts of the
system often need to know when state changes. Emit events after
successful transitions to enable loose coupling.</p>
<p><strong>Handle the cancelled state carefully.</strong> Cancellation
often needs cleanup—refunds, inventory release, notification. Use events
to trigger this cleanup from handlers rather than cramming it into the
cancellation feature set.</p>
<p><strong>Test transition failures.</strong> Write tests that attempt
invalid transitions and verify the correct error is returned. This
documents the state machine constraints and catches regressions.</p>
<hr />
<p><em>Next: Chapter 23 — Modules and Imports</em></p>
<h1 id="chapter-23-modules-and-imports">Chapter 23: Modules and
Imports</h1>
<p><em>“Compose applications from small, understandable
pieces.”</em></p>
<hr />
<h2 id="application-composition">23.1 Application Composition</h2>
<div style="text-align: center; margin: 2em 0;">
<svg width="400" height="140" viewBox="0 0 400 140" xmlns="http://www.w3.org/2000/svg">
<!-- Module A -->
<rect x="30" y="20" width="100" height="50" rx="5" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
<text x="80" y="40" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#1e40af">Module
A</text>
<text x="80" y="55" text-anchor="middle" font-family="monospace" font-size="8" fill="#3b82f6">/module-a</text>
<!-- Module B -->
<rect x="270" y="20" width="100" height="50" rx="5" fill="#dcfce7" stroke="#22c55e" stroke-width="2"/>
<text x="320" y="40" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#166534">Module
B</text>
<text x="320" y="55" text-anchor="middle" font-family="monospace" font-size="8" fill="#22c55e">/module-b</text>
<!-- Arrows -->
<line x1="80" y1="70" x2="160" y2="100" stroke="#6b7280" stroke-width="2"/>
<polygon points="160,100 152,95 152,105" fill="#6b7280"/>
<line x1="320" y1="70" x2="240" y2="100" stroke="#6b7280" stroke-width="2"/>
<polygon points="240,100 248,95 248,105" fill="#6b7280"/>
<!-- Combined -->
<rect x="150" y="100" width="100" height="35" rx="5" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
<text x="200" y="118" text-anchor="middle" font-family="sans-serif" font-size="10" font-weight="bold" fill="#4338ca">Combined</text>
<text x="200" y="130" text-anchor="middle" font-family="monospace" font-size="7" fill="#6366f1">import
../A ../B</text> <!-- Labels -->
<text x="115" y="85" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">import</text>
<text x="285" y="85" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">import</text>
</svg>
</div>
<p>ARO applications are directories containing <code>.aro</code> files.
When an application grows or when you want to share functionality
between projects, the import system lets you compose applications from
smaller pieces.</p>
<p>The import mechanism is radically simple. You import another
application directory, and all its feature sets become accessible. No
visibility modifiers, no selective imports, no namespacing. If you
import an application, you trust it and want all of it.</p>
<p>This design reflects how project managers think about systems.
Applications are black boxes that do things. If you need what another
application provides, you import it. There are no access control
decisions to make, no visibility declarations to configure.</p>
<hr />
<h2 id="import-syntax">23.2 Import Syntax</h2>
<p>The import statement appears at the top of an ARO file, before any
feature sets:</p>
<pre class="aro"><code>import ../auth-service
import ../payment-gateway
import ../../shared/utilities</code></pre>
<p>Paths are relative to the current file’s directory. The
<code>..</code> notation moves up one directory level. The path points
to a directory containing <code>.aro</code> files.</p>
<p>When the compiler encounters an import:</p>
<ol type="1">
<li>It resolves the path relative to the current file</li>
<li>It finds all <code>.aro</code> files in that directory</li>
<li>It makes all feature sets from those files accessible</li>
<li>Published variables become available</li>
<li>Types become available</li>
</ol>
<p>There is no need to specify what you want from the imported
application. Everything becomes accessible.</p>
<hr />
<h2 id="no-visibility-modifiers">23.3 No Visibility Modifiers</h2>
<p>ARO explicitly rejects visibility modifiers. There is no
<code>public</code>, <code>private</code>, or <code>internal</code>.</p>
<table>
<thead>
<tr>
<th>Traditional</th>
<th>ARO Approach</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>public</code></td>
<td>Everything is accessible after import</td>
</tr>
<tr>
<td><code>private</code></td>
<td>Feature set scope handles encapsulation</td>
</tr>
<tr>
<td><code>internal</code></td>
<td>Not needed</td>
</tr>
<tr>
<td><code>protected</code></td>
<td>No inheritance hierarchy</td>
</tr>
</tbody>
</table>
<p>This might seem dangerous. What about encapsulation? What about
hiding implementation details?</p>
<p>ARO takes a different position. Within a feature set, variables are
scoped naturally. They exist only within that feature set unless
explicitly published. If you want to share data between feature sets,
you use the Publish action or emit events. These are explicit sharing
mechanisms.</p>
<p>When you import an application, you are saying: I want this
application’s capabilities. You trust the imported code. If you need to
restrict what is accessible, the answer is not visibility modifiers. The
answer is to factor the code into appropriate applications.</p>
<hr />
<h2 id="the-modulesexample">23.4 The ModulesExample</h2>
<p>The <code>Examples/ModulesExample</code> directory demonstrates
application composition with three directories:</p>
<pre><code>ModulesExample/
├── ModuleA/
│   ├── main.aro
│   └── openapi.yaml
├── ModuleB/
│   ├── main.aro
│   └── openapi.yaml
└── Combined/
    ├── main.aro
    └── openapi.yaml</code></pre>
<p>Each module can run standalone or be imported into a larger
application.</p>
<h3 id="module-a">Module A</h3>
<p>Module A provides a single endpoint at <code>/module-a</code>:</p>
<pre class="aro"><code>(* Module A - Standalone Application *)

(Application-Start: ModuleA) {
    &lt;Log&gt; the &lt;startup: message&gt; for the &lt;console&gt; with &quot;Module A starting...&quot;.
    &lt;Start&gt; the &lt;http-server&gt; for the &lt;contract&gt;.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}

(getModuleA: ModuleA API) {
    &lt;Create&gt; the &lt;response&gt; with { message: &quot;Hello from Module A&quot; }.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;response&gt;.
}</code></pre>
<p><em>Source: <a
href="../Examples/ModulesExample/ModuleA/main.aro">Examples/ModulesExample/ModuleA/main.aro</a></em></p>
<p>Run it standalone:</p>
<div class="sourceCode" id="cb169"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aro</span> build ./Examples/ModulesExample/ModuleA</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a><span class="ex">./Examples/ModulesExample/ModuleA/ModuleA</span></span></code></pre></div>
<h3 id="module-b">Module B</h3>
<p>Module B provides a single endpoint at <code>/module-b</code>:</p>
<pre class="aro"><code>(* Module B - Standalone Application *)

(Application-Start: ModuleB) {
    &lt;Log&gt; the &lt;startup: message&gt; for the &lt;console&gt; with &quot;Module B starting...&quot;.
    &lt;Start&gt; the &lt;http-server&gt; for the &lt;contract&gt;.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}

(getModuleB: ModuleB API) {
    &lt;Create&gt; the &lt;response&gt; with { message: &quot;Hello from Module B&quot; }.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;response&gt;.
}</code></pre>
<p><em>Source: <a
href="../Examples/ModulesExample/ModuleB/main.aro">Examples/ModulesExample/ModuleB/main.aro</a></em></p>
<h3 id="combined-application">Combined Application</h3>
<p>The Combined application imports both modules and provides both
endpoints:</p>
<pre class="aro"><code>(* Combined Application *)

import ../ModuleA
import ../ModuleB

(Application-Start: Combined) {
    &lt;Log&gt; the &lt;startup: message&gt; for the &lt;console&gt; with &quot;Combined application starting...&quot;.
    &lt;Start&gt; the &lt;http-server&gt; for the &lt;contract&gt;.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}</code></pre>
<p><em>Source: <a
href="../Examples/ModulesExample/Combined/main.aro">Examples/ModulesExample/Combined/main.aro</a></em></p>
<p>The <code>getModuleA</code> and <code>getModuleB</code> feature sets
come from the imported applications. They do not need to be redefined.
The Combined application’s OpenAPI contract defines both routes, and the
imported feature sets handle them.</p>
<hr />
<h2 id="building-standalone-binaries">23.5 Building Standalone
Binaries</h2>
<p>Each module produces its own standalone binary:</p>
<div class="sourceCode" id="cb172"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build Module A</span></span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="ex">aro</span> build ./Examples/ModulesExample/ModuleA</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates: ModuleA/ModuleA</span></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Build Module B</span></span>
<span id="cb172-6"><a href="#cb172-6" aria-hidden="true" tabindex="-1"></a><span class="ex">aro</span> build ./Examples/ModulesExample/ModuleB</span>
<span id="cb172-7"><a href="#cb172-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates: ModuleB/ModuleB</span></span>
<span id="cb172-8"><a href="#cb172-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-9"><a href="#cb172-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Build Combined</span></span>
<span id="cb172-10"><a href="#cb172-10" aria-hidden="true" tabindex="-1"></a><span class="ex">aro</span> build ./Examples/ModulesExample/Combined</span>
<span id="cb172-11"><a href="#cb172-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Creates: Combined/Combined</span></span></code></pre></div>
<p>The Combined binary includes all code from both imported modules. The
resulting binary is self-contained and requires no runtime
dependencies.</p>
<hr />
<h2 id="distributed-services-pattern">23.6 Distributed Services
Pattern</h2>
<div style="float: right; margin: 0 0 1em 1.5em;">
<svg width="160" height="200" viewBox="0 0 160 200" xmlns="http://www.w3.org/2000/svg">
<!-- Auth -->
<rect x="10" y="10" width="60" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
<text x="40" y="28" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#1e40af">Auth</text>
<text x="40" y="40" text-anchor="middle" font-family="monospace" font-size="6" fill="#3b82f6">:8081</text>
<!-- Users -->
<rect x="90" y="10" width="60" height="35" rx="4" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="120" y="28" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#166534">Users</text>
<text x="120" y="40" text-anchor="middle" font-family="monospace" font-size="6" fill="#22c55e">:8082</text>
<!-- Orders -->
<rect x="10" y="60" width="60" height="35" rx="4" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<text x="40" y="78" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#92400e">Orders</text>
<text x="40" y="90" text-anchor="middle" font-family="monospace" font-size="6" fill="#f59e0b">:8083</text>
<!-- Payments -->
<rect x="90" y="60" width="60" height="35" rx="4" fill="#f3e8ff" stroke="#a855f7" stroke-width="1.5"/>
<text x="120" y="78" text-anchor="middle" font-family="sans-serif" font-size="8" font-weight="bold" fill="#7c3aed">Payments</text>
<text x="120" y="90" text-anchor="middle" font-family="monospace" font-size="6" fill="#a855f7">:8084</text>
<!-- Arrows to gateway -->
<line x1="40" y1="45" x2="70" y2="130" stroke="#6b7280" stroke-width="1"/>
<line x1="120" y1="45" x2="90" y2="130" stroke="#6b7280" stroke-width="1"/>
<line x1="40" y1="95" x2="70" y2="130" stroke="#6b7280" stroke-width="1"/>
<line x1="120" y1="95" x2="90" y2="130" stroke="#6b7280" stroke-width="1"/>
<!-- Gateway -->
<rect x="35" y="130" width="90" height="40" rx="4" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
<text x="80" y="150" text-anchor="middle" font-family="sans-serif" font-size="9" font-weight="bold" fill="#4338ca">Gateway</text>
<text x="80" y="163" text-anchor="middle" font-family="monospace" font-size="7" fill="#6366f1">:8080</text>
<!-- Label -->
<text x="80" y="190" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">imports
all services</text>
</svg>
</div>
<p>A common pattern is building microservices that can run independently
or be composed into a monolith for simpler deployments:</p>
<pre><code>services/
├── auth/
│   ├── main.aro
│   └── openapi.yaml
├── users/
│   ├── main.aro
│   └── openapi.yaml
├── orders/
│   ├── main.aro
│   └── openapi.yaml
└── gateway/
    ├── main.aro
    └── openapi.yaml</code></pre>
<p>Each service has its own Application-Start and can run on its own
port. The gateway imports all services and provides a unified API.</p>
<p>For development, you might run the gateway monolith. For production,
you might run each service independently and use a real API gateway.</p>
<hr />
<h2 id="sharing-data-between-applications">23.7 Sharing Data Between
Applications</h2>
<p>When you import an application, you get access to its published
variables within the same business activity. The Publish action (see
ARO-0003) makes values available to feature sets sharing that business
activity:</p>
<pre class="aro"><code>(* In auth-service/auth.aro *)
(Authenticate User: Security) {
    &lt;Extract&gt; the &lt;credentials&gt; from the &lt;request: body&gt;.
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where credentials = &lt;credentials&gt;.
    &lt;Publish&gt; as &lt;authenticated-user&gt; &lt;user&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}</code></pre>
<p>After importing auth-service, other feature sets can access the
published variable:</p>
<pre class="aro"><code>(* In gateway/main.aro *)
import ../auth-service

(Process Request: Gateway) {
    (* Access published variable from imported application *)
    &lt;Use&gt; the &lt;authenticated-user&gt; in the &lt;authorization-check&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;request&gt;.
}</code></pre>
<hr />
<h2 id="what-is-not-imported">23.8 What Is Not Imported</h2>
<p>When you import an application, its Application-Start feature set is
not executed. Only the importing application’s Application-Start runs.
The imported feature sets become available, but lifecycle management
remains with the importing application.</p>
<p>This prevents conflicts when composing applications. Each composed
application might have its own startup logic, but only the top-level
application controls the actual startup sequence.</p>
<p>Similarly, Application-End handlers from imported applications are
not triggered during shutdown. The importing application manages its own
lifecycle.</p>
<hr />
<h2 id="circular-imports">23.9 Circular Imports</h2>
<p>Circular imports are technically allowed:</p>
<pre class="aro"><code>(* service-a/main.aro *)
import ../service-b

(* service-b/main.aro *)
import ../service-a</code></pre>
<p>The compiler handles this by loading all files from all imported
applications, building a unified symbol table, and resolving references
across all loaded feature sets.</p>
<p>However, circular dependencies usually indicate poor architecture. If
two applications need each other, consider:</p>
<ol type="1">
<li>Extracting shared code to a third application that both import</li>
<li>Using events instead of direct access</li>
<li>Reorganizing the application boundaries</li>
</ol>
<hr />
<h2 id="what-is-not-provided">23.10 What Is Not Provided</h2>
<p>ARO deliberately omits many features found in other module
systems:</p>
<ul>
<li><strong>Module declarations</strong> - No
<code>module com.example.foo</code></li>
<li><strong>Namespace qualifiers</strong> - No
<code>com.example.foo.MyType</code></li>
<li><strong>Selective imports</strong> - No
<code>import { User, Order } from ./users</code></li>
<li><strong>Import aliases</strong> - No
<code>import ./users as u</code></li>
<li><strong>Package manifests</strong> - No <code>Package.yaml</code> or
<code>aro.config</code></li>
<li><strong>Version constraints</strong> - No <code>^1.0.0</code> or
<code>~2.1.0</code></li>
<li><strong>Remote package repositories</strong> - No central
registry</li>
</ul>
<p>These are implementation concerns that add complexity without
matching how ARO applications are designed to work. If you need
versioning, use git. If you need remote packages, use git submodules or
symbolic links.</p>
<hr />
<h2 id="summary">23.11 Summary</h2>
<p>The import system embodies ARO’s philosophy of simplicity:</p>
<ol type="1">
<li><code>import ../path</code> imports another application</li>
<li>Everything becomes accessible after import</li>
<li>No visibility modifiers complicate decisions</li>
<li>Each application can run standalone or be composed</li>
<li>Native compilation produces self-contained binaries</li>
</ol>
<p>This is not enterprise-grade module management. It is application
composition for developers who want to build systems from small,
understandable pieces.</p>
<hr />
<p><em>Next: Chapter 24 — Control Flow</em></p>
<h1 id="chapter-24-control-flow">Chapter 24: Control Flow</h1>
<p>ARO provides control flow constructs for conditional execution. This
chapter covers how to make decisions in your feature sets using guarded
statements and match expressions.</p>
<h2 id="when-guards">When Guards</h2>
<p>The <code>when</code> clause conditionally executes a single
statement. If the condition is false, the statement is skipped and
execution continues to the next statement.</p>
<h3 id="syntax">Syntax</h3>
<pre class="aro"><code>&lt;Action&gt; the &lt;result&gt; preposition the &lt;object&gt; when &lt;condition&gt;.</code></pre>
<h3 id="basic-guards">Basic Guards</h3>
<pre class="aro"><code>(getUser: User API) {
    &lt;Extract&gt; the &lt;user-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;user-id&gt;.

    (* Return NotFound only when user is empty *)
    &lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;missing: user&gt; when &lt;user&gt; is empty.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}</code></pre>
<h3 id="guard-examples">Guard Examples</h3>
<pre class="aro"><code>(* Only return OK when count is not zero *)
&lt;Return&gt; an &lt;OK: status&gt; with &lt;items&gt; when &lt;count&gt; is not 0.

(* Send notification only when user has email *)
&lt;Send&gt; the &lt;notification&gt; to the &lt;user: email&gt; when &lt;user: email&gt; exists.

(* Log admin access only for admins *)
&lt;Log&gt; the &lt;admin-access&gt; for the &lt;audit&gt; when &lt;user: role&gt; = &quot;admin&quot;.

(* Return error when validation fails *)
&lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;invalid: input&gt; when &lt;validation&gt; is failed.</code></pre>
<h3 id="comparison-operators">Comparison Operators</h3>
<table>
<thead>
<tr>
<th>Operator</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>is</code></td>
<td>Equality</td>
</tr>
<tr>
<td><code>is not</code></td>
<td>Inequality</td>
</tr>
<tr>
<td><code>is empty</code></td>
<td>Null/empty check</td>
</tr>
<tr>
<td><code>is not empty</code></td>
<td>Has value</td>
</tr>
<tr>
<td><code>exists</code></td>
<td>Value exists</td>
</tr>
<tr>
<td><code>is defined</code></td>
<td>Value is defined</td>
</tr>
<tr>
<td><code>is null</code></td>
<td>Value is null</td>
</tr>
<tr>
<td><code>&gt;</code></td>
<td>Greater than</td>
</tr>
<tr>
<td><code>&lt;</code></td>
<td>Less than</td>
</tr>
<tr>
<td><code>&gt;=</code></td>
<td>Greater than or equal</td>
</tr>
<tr>
<td><code>&lt;=</code></td>
<td>Less than or equal</td>
</tr>
<tr>
<td><code>=</code></td>
<td>Equality</td>
</tr>
<tr>
<td><code>!=</code></td>
<td>Strict inequality</td>
</tr>
</tbody>
</table>
<h3 id="boolean-operators">Boolean Operators</h3>
<p>Combine conditions with <code>and</code>, <code>or</code>,
<code>not</code>:</p>
<pre class="aro"><code>(* Multiple conditions with and *)
&lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt; when &lt;user: active&gt; is true and &lt;user: verified&gt; is true.

(* Either condition with or *)
&lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;unavailable: product&gt; when &lt;stock&gt; is empty or &lt;stock&gt; &lt; &lt;required&gt;.

(* Negation *)
&lt;Allow&gt; the &lt;access&gt; for the &lt;user&gt; when not &lt;user: banned&gt;.

(* Complex condition *)
&lt;Grant&gt; the &lt;admin-features&gt; for the &lt;user&gt; when (&lt;user: role&gt; is &quot;admin&quot; or &lt;user: is-owner&gt; is true) and &lt;resource: public&gt; is false.</code></pre>
<h2 id="match-expressions">Match Expressions</h2>
<p>Pattern matching for multiple cases:</p>
<pre class="aro"><code>match &lt;value&gt; {
    case &lt;pattern&gt; {
        (* handle this case *)
    }
    case &lt;pattern&gt; where &lt;condition&gt; {
        (* handle case with guard *)
    }
    otherwise {
        (* handle all other cases *)
    }
}</code></pre>
<h3 id="simple-value-matching">Simple Value Matching</h3>
<pre class="aro"><code>(PUT /orders/{id}/status: Order API) {
    &lt;Extract&gt; the &lt;order-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Extract&gt; the &lt;new-status&gt; from the &lt;request: body.status&gt;.
    &lt;Retrieve&gt; the &lt;order&gt; from the &lt;order-repository&gt; where id = &lt;order-id&gt;.

    match &lt;new-status&gt; {
        case &quot;confirmed&quot; {
            &lt;Validate&gt; the &lt;order&gt; for the &lt;confirmation-rules&gt;.
            &lt;Emit&gt; an &lt;OrderConfirmed: event&gt; with &lt;order&gt;.
        }
        case &quot;shipped&quot; {
            &lt;Validate&gt; the &lt;order&gt; for the &lt;shipping-rules&gt;.
            &lt;Emit&gt; an &lt;OrderShipped: event&gt; with &lt;order&gt;.
        }
        case &quot;delivered&quot; {
            &lt;Emit&gt; an &lt;OrderDelivered: event&gt; with &lt;order&gt;.
        }
        case &quot;cancelled&quot; {
            &lt;Emit&gt; an &lt;OrderCancelled: event&gt; with &lt;order&gt;.
        }
        otherwise {
            &lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;invalid: status&gt;.
        }
    }

    &lt;Transform&gt; the &lt;updated-order&gt; from the &lt;order&gt; with { status: &lt;new-status&gt; }.
    &lt;Store&gt; the &lt;updated-order&gt; into the &lt;order-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;updated-order&gt;.
}</code></pre>
<h3 id="http-method-routing">HTTP Method Routing</h3>
<pre class="aro"><code>match &lt;http: method&gt; {
    case &quot;GET&quot; {
        &lt;Retrieve&gt; the &lt;resource&gt; from the &lt;database&gt;.
    }
    case &quot;POST&quot; {
        &lt;Create&gt; the &lt;resource&gt; in the &lt;database&gt;.
    }
    case &quot;PUT&quot; {
        &lt;Update&gt; the &lt;resource&gt; in the &lt;database&gt;.
    }
    case &quot;DELETE&quot; {
        &lt;Remove&gt; the &lt;resource&gt; from the &lt;database&gt;.
    }
    otherwise {
        &lt;Return&gt; a &lt;MethodNotAllowed: error&gt; for the &lt;request&gt;.
    }
}</code></pre>
<h3 id="pattern-matching-with-guards">Pattern Matching with Guards</h3>
<pre class="aro"><code>match &lt;user: subscription&gt; {
    case &lt;premium&gt; where &lt;user: credits&gt; &gt; 0 {
        &lt;Grant&gt; the &lt;premium-features&gt; for the &lt;user&gt;.
        &lt;Deduct&gt; the &lt;credit&gt; from the &lt;user: account&gt;.
    }
    case &lt;premium&gt; {
        &lt;Notify&gt; the &lt;user&gt; about the &lt;low-credits&gt;.
        &lt;Grant&gt; the &lt;basic-features&gt; for the &lt;user&gt;.
    }
    case &lt;basic&gt; {
        &lt;Grant&gt; the &lt;basic-features&gt; for the &lt;user&gt;.
    }
    otherwise {
        &lt;Redirect&gt; the &lt;user&gt; to the &lt;subscription-page&gt;.
    }
}</code></pre>
<h3 id="status-code-handling">Status Code Handling</h3>
<pre class="aro"><code>match &lt;status-code&gt; {
    case 200 {
        &lt;Parse&gt; the &lt;response: body&gt; from the &lt;http-response&gt;.
        &lt;Return&gt; the &lt;data&gt; for the &lt;request&gt;.
    }
    case 404 {
        &lt;Return&gt; a &lt;NotFound: error&gt; for the &lt;request&gt;.
    }
    case 500 {
        &lt;Log&gt; the &lt;server-error&gt; for the &lt;monitoring&gt;.
        &lt;Return&gt; a &lt;ServerError&gt; for the &lt;request&gt;.
    }
    otherwise {
        &lt;Return&gt; an &lt;UnknownError&gt; for the &lt;request&gt;.
    }
}</code></pre>
<h3 id="regular-expression-patterns">Regular Expression Patterns</h3>
<p>Match statements support regex patterns for flexible string matching.
Use forward slashes to delimit a regex pattern:</p>
<pre class="aro"><code>match &lt;message.text&gt; {
    case /^ERROR:/i {
        &lt;Log&gt; the &lt;error: alert&gt; for the &lt;console&gt; with &lt;message.text&gt;.
        &lt;Emit&gt; an &lt;AlertTriggered: event&gt; with &lt;message&gt;.
    }
    case /^WARN:/i {
        &lt;Log&gt; the &lt;warning: message&gt; for the &lt;console&gt; with &lt;message.text&gt;.
    }
    case /^[A-Z]{3}-\d{4}$/ {
        (* Matches ticket IDs like &quot;ABC-1234&quot; *)
        &lt;Process&gt; the &lt;ticket-reference&gt; from the &lt;message&gt;.
    }
    otherwise {
        &lt;Log&gt; the &lt;info: message&gt; for the &lt;console&gt; with &lt;message.text&gt;.
    }
}</code></pre>
<h4 id="regex-flags">Regex Flags</h4>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>i</code></td>
<td>Case insensitive</td>
</tr>
<tr>
<td><code>s</code></td>
<td>Dot matches newlines</td>
</tr>
<tr>
<td><code>m</code></td>
<td>Multiline (^ and $ match line boundaries)</td>
</tr>
</tbody>
</table>
<h4 id="common-use-cases">Common Use Cases</h4>
<pre class="aro"><code>(* Email validation *)
match &lt;email&gt; {
    case /^[\w.+-]+@[\w.-]+\.[a-zA-Z]{2,}$/i {
        &lt;Return&gt; an &lt;OK: status&gt; with { valid: true }.
    }
    otherwise {
        &lt;Return&gt; a &lt;BadRequest: status&gt; with { error: &quot;Invalid email format&quot; }.
    }
}

(* Command routing *)
match &lt;input&gt; {
    case /^\/help/i {
        &lt;Emit&gt; a &lt;HelpRequested: event&gt; with &lt;message&gt;.
    }
    case /^\/status\s+\w+$/i {
        &lt;Emit&gt; a &lt;StatusQuery: event&gt; with &lt;message&gt;.
    }
    otherwise {
        &lt;Emit&gt; a &lt;MessageReceived: event&gt; with &lt;message&gt;.
    }
}</code></pre>
<p>Use <code>^</code> and <code>$</code> anchors when you need
full-string matching rather than substring matching.</p>
<h2 id="common-patterns-2">Common Patterns</h2>
<h3 id="validate-or-fail">Validate-or-Fail</h3>
<pre class="aro"><code>(POST /users: User API) {
    &lt;Extract&gt; the &lt;user-data&gt; from the &lt;request: body&gt;.
    &lt;Validate&gt; the &lt;user-data&gt; for the &lt;user-schema&gt;.

    &lt;Return&gt; a &lt;BadRequest: status&gt; with &lt;validation: errors&gt; when &lt;validation&gt; is failed.

    &lt;Create&gt; the &lt;user&gt; with &lt;user-data&gt;.
    &lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.
}</code></pre>
<h3 id="find-or-404">Find-or-404</h3>
<pre class="aro"><code>(GET /products/{id}: Product API) {
    &lt;Extract&gt; the &lt;product-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;product&gt; from the &lt;product-repository&gt; where id = &lt;product-id&gt;.

    &lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;missing: product&gt; when &lt;product&gt; is empty.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;product&gt;.
}</code></pre>
<h3 id="check-permission">Check-Permission</h3>
<pre class="aro"><code>(DELETE /posts/{id}: Post API) {
    &lt;Extract&gt; the &lt;post-id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;post&gt; from the &lt;post-repository&gt; where id = &lt;post-id&gt;.

    &lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;missing: post&gt; when &lt;post&gt; is empty.

    &lt;Return&gt; a &lt;Forbidden: status&gt; for the &lt;unauthorized: deletion&gt;
        when &lt;post: authorId&gt; is not &lt;current-user: id&gt; and &lt;current-user: role&gt; is not &quot;admin&quot;.

    &lt;Delete&gt; the &lt;post&gt; from the &lt;post-repository&gt; where id = &lt;post-id&gt;.
    &lt;Return&gt; a &lt;NoContent: status&gt; for the &lt;deletion&gt;.
}</code></pre>
<h3 id="fail-fast-with-guards">Fail Fast with Guards</h3>
<p>Check error conditions early with guarded returns:</p>
<pre class="aro"><code>(POST /transfer: Banking) {
    &lt;Extract&gt; the &lt;amount&gt; from the &lt;request: body.amount&gt;.
    &lt;Extract&gt; the &lt;from-account&gt; from the &lt;request: body.from&gt;.
    &lt;Extract&gt; the &lt;to-account&gt; from the &lt;request: body.to&gt;.

    (* Early exits for invalid input *)
    &lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;invalid: amount&gt; when &lt;amount&gt; &lt;= 0.
    &lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;same: accounts&gt; when &lt;from-account&gt; is &lt;to-account&gt;.

    &lt;Retrieve&gt; the &lt;source&gt; from the &lt;account-repository&gt; where id = &lt;from-account&gt;.

    &lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;missing: source-account&gt; when &lt;source&gt; is empty.
    &lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;insufficient: funds&gt; when &lt;source: balance&gt; &lt; &lt;amount&gt;.

    (* Now proceed with transfer *)
    &lt;Retrieve&gt; the &lt;destination&gt; from the &lt;account-repository&gt; where id = &lt;to-account&gt;.
    &lt;Transfer&gt; the &lt;amount&gt; from the &lt;source&gt; to the &lt;destination&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;transfer&gt;.
}</code></pre>
<h3 id="conditional-processing">Conditional Processing</h3>
<pre class="aro"><code>(POST /orders: Order API) {
    &lt;Extract&gt; the &lt;order-data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;order&gt; with &lt;order-data&gt;.

    (* Conditional discount *)
    &lt;Compute&gt; the &lt;discount&gt; with &lt;order: total&gt; * 0.1 when &lt;order: total&gt; &gt;= 100.
    &lt;Transform&gt; the &lt;order&gt; from the &lt;order&gt; with { discount: &lt;discount&gt; } when &lt;discount&gt; exists.

    (* Conditional express shipping *)
    &lt;Compute&gt; the &lt;express-fee&gt; for the &lt;order&gt; when &lt;order: express&gt; is true.
    &lt;Transform&gt; the &lt;order&gt; from the &lt;order&gt; with { shippingFee: &lt;express-fee&gt; } when &lt;express-fee&gt; exists.

    &lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;order&gt;.
}</code></pre>
<h2 id="complete-example">Complete Example</h2>
<pre class="aro"><code>(User Authentication: Security) {
    &lt;Require&gt; the &lt;request&gt; from the &lt;framework&gt;.
    &lt;Require&gt; the &lt;user-repository&gt; from the &lt;framework&gt;.

    (* Extract credentials *)
    &lt;Extract&gt; the &lt;username&gt; from the &lt;request: body&gt;.
    &lt;Extract&gt; the &lt;password&gt; from the &lt;request: body&gt;.

    (* Validate input - guarded return *)
    &lt;Return&gt; a &lt;BadRequest: error&gt; for the &lt;request&gt;
        when &lt;username&gt; is empty or &lt;password&gt; is empty.

    (* Look up user *)
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt;.

    (* Handle user not found - guarded statements *)
    &lt;Log&gt; the &lt;failed-login: attempt&gt; for the &lt;username&gt; when &lt;user&gt; is null.
    &lt;Return&gt; an &lt;Unauthorized: error&gt; for the &lt;request&gt; when &lt;user&gt; is null.

    (* Check account status with match *)
    match &lt;user: status&gt; {
        case &quot;locked&quot; {
            &lt;Return&gt; an &lt;AccountLocked: error&gt; for the &lt;request&gt;.
        }
        case &quot;pending&quot; {
            &lt;Send&gt; the &lt;verification-email&gt; to the &lt;user: email&gt;.
            &lt;Return&gt; a &lt;PendingVerification: status&gt; for the &lt;request&gt;.
        }
        case &quot;active&quot; {
            (* Verify password *)
            &lt;Compute&gt; the &lt;password-hash&gt; for the &lt;password&gt;.

            match &lt;password-hash&gt; {
                case &lt;user: password-hash&gt; {
                    &lt;Create&gt; the &lt;session-token&gt; for the &lt;user&gt;.
                    &lt;Log&gt; the &lt;successful-login&gt; for the &lt;user&gt;.
                    &lt;Return&gt; an &lt;OK: status&gt; with the &lt;session-token&gt;.
                }
                otherwise {
                    &lt;Increment&gt; the &lt;failed-attempts&gt; for the &lt;user&gt;.
                    &lt;Lock&gt; the &lt;user: account&gt; for the &lt;security-policy&gt;
                        when &lt;failed-attempts&gt; &gt;= 5.
                    &lt;Return&gt; an &lt;Unauthorized: error&gt; for the &lt;request&gt;.
                }
            }
        }
        otherwise {
            &lt;Return&gt; an &lt;InvalidAccountStatus: error&gt; for the &lt;request&gt;.
        }
    }
}</code></pre>
<h2 id="best-practices-15">Best Practices</h2>
<h3 id="use-guards-for-early-exits">Use Guards for Early Exits</h3>
<p>Guards with <code>when</code> are ideal for: - Input validation -
Preconditions - Error returns</p>
<pre class="aro"><code>(* Good - guards for early exit *)
&lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;missing: id&gt; when &lt;user-id&gt; is empty.
&lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;missing: user&gt; when &lt;user&gt; is empty.
&lt;Return&gt; a &lt;Forbidden: status&gt; for the &lt;private: profile&gt; when &lt;user: private&gt; is true.

(* Continue with main logic *)
&lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.</code></pre>
<h3 id="use-match-for-multiple-outcomes">Use Match for Multiple
Outcomes</h3>
<p>Match expressions are ideal for: - Status handling - Role-based logic
- State machines - Multiple distinct cases</p>
<pre class="aro"><code>(* Good - match for multiple cases *)
match &lt;order: status&gt; {
    case &quot;pending&quot; { ... }
    case &quot;processing&quot; { ... }
    case &quot;shipped&quot; { ... }
    case &quot;delivered&quot; { ... }
    otherwise { ... }
}</code></pre>
<h3 id="be-explicit-in-conditions">Be Explicit in Conditions</h3>
<pre class="aro"><code>(* Good - explicit conditions *)
&lt;Grant&gt; the &lt;access&gt; for the &lt;user&gt; when &lt;user: active&gt; is true and &lt;user: verified&gt; is true.

(* Avoid - implicit truthiness *)
&lt;Grant&gt; the &lt;access&gt; for the &lt;user&gt; when &lt;user: active&gt; and &lt;user: verified&gt;.</code></pre>
<hr />
<p><em>Next: Chapter 25 — Data Pipelines</em></p>
<h1 id="chapter-25-data-pipelines">Chapter 25: Data Pipelines</h1>
<p>ARO provides a map/reduce style data pipeline for filtering,
transforming, and aggregating collections. All operations are type-safe,
with results typed via OpenAPI schemas.</p>
<h2 id="pipeline-operations">Pipeline Operations</h2>
<p>ARO supports four core data operations:</p>
<table>
<colgroup>
<col style="width: 37%" />
<col style="width: 31%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr>
<th>Operation</th>
<th>Purpose</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Fetch</strong></td>
<td>Retrieve and filter data</td>
<td><code>&lt;Fetch&gt; the &lt;users: List&lt;User&gt;&gt; from the &lt;repository&gt;...</code></td>
</tr>
<tr>
<td><strong>Filter</strong></td>
<td>Filter existing collection</td>
<td><code>&lt;Filter&gt; the &lt;active: List&lt;User&gt;&gt; from the &lt;users&gt;...</code></td>
</tr>
<tr>
<td><strong>Map</strong></td>
<td>Transform to different type</td>
<td><code>&lt;Map&gt; the &lt;summaries&gt; as List&lt;UserSummary&gt; from the &lt;users&gt;.</code></td>
</tr>
<tr>
<td><strong>Reduce</strong></td>
<td>Aggregate to single value</td>
<td><code>&lt;Reduce&gt; the &lt;total&gt; as Float from the &lt;orders&gt; with sum(&lt;amount&gt;).</code></td>
</tr>
</tbody>
</table>
<h3 id="type-annotation-syntax">Type Annotation Syntax</h3>
<p>ARO supports two equivalent syntaxes for type annotations:</p>
<pre class="aro"><code>(* Colon syntax: type inside angle brackets *)
&lt;Filter&gt; the &lt;active-users: List&lt;User&gt;&gt; from the &lt;users&gt; where &lt;active&gt; is true.

(* As syntax: type follows the result descriptor *)
&lt;Filter&gt; the &lt;active-users&gt; as List&lt;User&gt; from the &lt;users&gt; where &lt;active&gt; is true.</code></pre>
<p>Both produce identical results. The <code>as Type</code> syntax
(ARO-0038) can be more readable when the variable name is long, while
the colon syntax keeps everything compact. Type annotations are optional
since ARO infers types from the source collection.</p>
<hr />
<h2 id="fetch">Fetch</h2>
<p>Retrieves data with optional filtering, sorting, and pagination.</p>
<pre class="aro"><code>(* Basic fetch *)
&lt;Fetch&gt; the &lt;users: List&lt;User&gt;&gt; from the &lt;user-repository&gt;.

(* With filter *)
&lt;Fetch&gt; the &lt;active-users: List&lt;User&gt;&gt; from the &lt;users&gt;
    where &lt;status&gt; is &quot;active&quot;.

(* With sorting *)
&lt;Fetch&gt; the &lt;recent-users: List&lt;User&gt;&gt; from the &lt;users&gt;
    order by &lt;created-at&gt; desc.

(* With pagination *)
&lt;Fetch&gt; the &lt;page: List&lt;User&gt;&gt; from the &lt;users&gt;
    order by &lt;name&gt; asc
    limit 20
    offset 40.

(* Combined *)
&lt;Fetch&gt; the &lt;top-customers: List&lt;User&gt;&gt; from the &lt;users&gt;
    where &lt;tier&gt; is &quot;premium&quot;
    order by &lt;total-purchases&gt; desc
    limit 10.</code></pre>
<hr />
<h2 id="filter">Filter</h2>
<p>Filters an existing collection with a predicate.</p>
<pre class="aro"><code>(* Filter by equality *)
&lt;Filter&gt; the &lt;admins: List&lt;User&gt;&gt; from the &lt;users&gt;
    where &lt;role&gt; is &quot;admin&quot;.

(* Filter by comparison *)
&lt;Filter&gt; the &lt;high-value: List&lt;Order&gt;&gt; from the &lt;orders&gt;
    where &lt;amount&gt; &gt; 1000.

(* Filter with multiple conditions *)
&lt;Filter&gt; the &lt;active-premium: List&lt;User&gt;&gt; from the &lt;users&gt;
    where &lt;status&gt; is &quot;active&quot; and &lt;tier&gt; is &quot;premium&quot;.</code></pre>
<h3 id="comparison-operators-1">Comparison Operators</h3>
<table>
<thead>
<tr>
<th>Operator</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>is</code>, <code>=</code></td>
<td>Equality</td>
<td><code>&lt;status&gt; is "active"</code></td>
</tr>
<tr>
<td><code>is not</code>, <code>!=</code></td>
<td>Inequality</td>
<td><code>&lt;role&gt; is not "guest"</code></td>
</tr>
<tr>
<td><code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>,
<code>&lt;=</code></td>
<td>Comparison</td>
<td><code>&lt;age&gt; &gt;= 18</code></td>
</tr>
<tr>
<td><code>in</code></td>
<td>Set membership</td>
<td><code>&lt;status&gt; in ["a", "b"]</code></td>
</tr>
<tr>
<td><code>between</code></td>
<td>Range</td>
<td><code>&lt;price&gt; between 10 and 100</code></td>
</tr>
<tr>
<td><code>contains</code></td>
<td>Substring</td>
<td><code>&lt;name&gt; contains "test"</code></td>
</tr>
<tr>
<td><code>starts with</code></td>
<td>Prefix match</td>
<td><code>&lt;email&gt; starts with "admin"</code></td>
</tr>
<tr>
<td><code>ends with</code></td>
<td>Suffix match</td>
<td><code>&lt;file&gt; ends with ".pdf"</code></td>
</tr>
<tr>
<td><code>matches</code></td>
<td>Regex pattern</td>
<td><code>&lt;email&gt; matches /^admin@/i</code></td>
</tr>
</tbody>
</table>
<p>The <code>matches</code> operator supports regex literals with
flags:</p>
<pre class="aro"><code>(* Filter users with admin emails *)
&lt;Filter&gt; the &lt;admins: List&lt;User&gt;&gt; from the &lt;users&gt;
    where &lt;email&gt; matches /^admin@|@admin\./i.

(* Filter valid email addresses *)
&lt;Filter&gt; the &lt;valid-emails: List&lt;User&gt;&gt; from the &lt;users&gt;
    where &lt;email&gt; matches /^[\w.+-]+@[\w.-]+\.[a-zA-Z]{2,}$/i.</code></pre>
<hr />
<h2 id="map">Map</h2>
<p>Transforms a collection to a different OpenAPI-defined type. The
runtime automatically maps fields with matching names.</p>
<pre class="aro"><code>(* Map User to UserSummary *)
&lt;Map&gt; the &lt;summaries: List&lt;UserSummary&gt;&gt; from the &lt;users&gt;.</code></pre>
<p><strong>Requirements:</strong> - Target type must be defined in
<code>openapi.yaml</code> components/schemas - Fields with matching
names are automatically copied - Missing optional fields are omitted -
Missing required fields cause an error</p>
<h3 id="example-types">Example Types</h3>
<div class="sourceCode" id="cb202"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># openapi.yaml</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span><span class="kw">:</span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schemas</span><span class="kw">:</span></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">User</span><span class="kw">:</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">email</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">password-hash</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb202-11"><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">created-at</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb202-12"><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-13"><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">UserSummary</span><span class="kw">:</span></span>
<span id="cb202-14"><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb202-15"><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb202-16"><a href="#cb202-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb202-17"><a href="#cb202-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb202-18"><a href="#cb202-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">email</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span></code></pre></div>
<p>When mapping <code>List&lt;User&gt;</code> to
<code>List&lt;UserSummary&gt;</code>, only <code>id</code>,
<code>name</code>, and <code>email</code> are copied. Sensitive fields
like <code>password-hash</code> are excluded.</p>
<hr />
<h2 id="reduce">Reduce</h2>
<p>Aggregates a collection to a single value using aggregation
functions.</p>
<pre class="aro"><code>(* Count items *)
&lt;Reduce&gt; the &lt;user-count: Integer&gt; from the &lt;users&gt;
    with count().

(* Sum numeric field *)
&lt;Reduce&gt; the &lt;total-revenue: Float&gt; from the &lt;orders&gt;
    with sum(&lt;amount&gt;).

(* Average *)
&lt;Reduce&gt; the &lt;avg-price: Float&gt; from the &lt;products&gt;
    with avg(&lt;price&gt;).

(* Min/Max *)
&lt;Reduce&gt; the &lt;highest-score: Float&gt; from the &lt;scores&gt;
    with max(&lt;value&gt;).

(* With filter *)
&lt;Reduce&gt; the &lt;pending-count: Integer&gt; from the &lt;orders&gt;
    where &lt;status&gt; is &quot;pending&quot;
    with count().</code></pre>
<h3 id="aggregation-functions">Aggregation Functions</h3>
<table>
<thead>
<tr>
<th>Function</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>count()</code></td>
<td>Number of items</td>
<td><code>with count()</code></td>
</tr>
<tr>
<td><code>sum(field)</code></td>
<td>Sum of numeric field</td>
<td><code>with sum(&lt;amount&gt;)</code></td>
</tr>
<tr>
<td><code>avg(field)</code></td>
<td>Average of numeric field</td>
<td><code>with avg(&lt;price&gt;)</code></td>
</tr>
<tr>
<td><code>min(field)</code></td>
<td>Minimum value</td>
<td><code>with min(&lt;date&gt;)</code></td>
</tr>
<tr>
<td><code>max(field)</code></td>
<td>Maximum value</td>
<td><code>with max(&lt;score&gt;)</code></td>
</tr>
<tr>
<td><code>first()</code></td>
<td>First element</td>
<td><code>with first()</code></td>
</tr>
<tr>
<td><code>last()</code></td>
<td>Last element</td>
<td><code>with last()</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="pipeline-composition">Pipeline Composition</h2>
<p>Chain operations to build complex data transformations:</p>
<pre class="aro"><code>(Generate Report: Analytics) {
    (* Step 1: Fetch recent orders *)
    &lt;Fetch&gt; the &lt;recent-orders: List&lt;Order&gt;&gt; from the &lt;orders&gt;
        where &lt;created-at&gt; &gt; now().minus(30.days)
        order by &lt;created-at&gt; desc.

    (* Step 2: Filter high-value orders *)
    &lt;Filter&gt; the &lt;high-value: List&lt;Order&gt;&gt; from the &lt;recent-orders&gt;
        where &lt;amount&gt; &gt; 1000.

    (* Step 3: Map to summaries *)
    &lt;Map&gt; the &lt;summaries: List&lt;OrderSummary&gt;&gt; from the &lt;high-value&gt;.

    (* Step 4: Calculate total *)
    &lt;Reduce&gt; the &lt;total: Float&gt; from the &lt;high-value&gt;
        with sum(&lt;amount&gt;).

    &lt;Return&gt; an &lt;OK: status&gt; with {
        orders: &lt;summaries&gt;,
        total: &lt;total&gt;,
        count: &lt;high-value&gt;.count()
    }.
}</code></pre>
<hr />
<h2 id="sorting">Sorting</h2>
<p>Sort results by one or more fields:</p>
<pre class="aro"><code>(* Single field, ascending *)
&lt;Fetch&gt; the &lt;users: List&lt;User&gt;&gt; from the &lt;repository&gt;
    order by &lt;name&gt; asc.

(* Single field, descending *)
&lt;Fetch&gt; the &lt;recent: List&lt;Order&gt;&gt; from the &lt;orders&gt;
    order by &lt;created-at&gt; desc.

(* Multiple fields *)
&lt;Fetch&gt; the &lt;products: List&lt;Product&gt;&gt; from the &lt;catalog&gt;
    order by &lt;category&gt; asc, &lt;price&gt; desc.</code></pre>
<hr />
<h2 id="pagination">Pagination</h2>
<p>Limit results with offset for pagination:</p>
<pre class="aro"><code>(* First page: items 1-20 *)
&lt;Fetch&gt; the &lt;page1: List&lt;User&gt;&gt; from the &lt;users&gt;
    order by &lt;name&gt; asc
    limit 20.

(* Second page: items 21-40 *)
&lt;Fetch&gt; the &lt;page2: List&lt;User&gt;&gt; from the &lt;users&gt;
    order by &lt;name&gt; asc
    limit 20
    offset 20.

(* Third page: items 41-60 *)
&lt;Fetch&gt; the &lt;page3: List&lt;User&gt;&gt; from the &lt;users&gt;
    order by &lt;name&gt; asc
    limit 20
    offset 40.</code></pre>
<hr />
<h2 id="complete-example-1">Complete Example</h2>
<h3 id="openapi.yaml">openapi.yaml</h3>
<div class="sourceCode" id="cb207"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="fu">openapi</span><span class="kw">:</span><span class="at"> </span><span class="fl">3.0.3</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a><span class="fu">info</span><span class="kw">:</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> Order Analytics</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="fl">1.0.0</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span><span class="kw">:</span></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schemas</span><span class="kw">:</span></span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Order</span><span class="kw">:</span></span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb207-10"><a href="#cb207-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb207-11"><a href="#cb207-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb207-12"><a href="#cb207-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">customer-id</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb207-13"><a href="#cb207-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">customer-name</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb207-14"><a href="#cb207-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">amount</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> number </span><span class="kw">}</span></span>
<span id="cb207-15"><a href="#cb207-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">status</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb207-16"><a href="#cb207-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">region</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb207-17"><a href="#cb207-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">created-at</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span><span class="kw">,</span><span class="at"> </span><span class="fu">format</span><span class="kw">:</span><span class="at"> date-time </span><span class="kw">}</span></span>
<span id="cb207-18"><a href="#cb207-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">id</span><span class="kw">,</span><span class="at"> customer-id</span><span class="kw">,</span><span class="at"> amount</span><span class="kw">,</span><span class="at"> status</span><span class="kw">]</span></span>
<span id="cb207-19"><a href="#cb207-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-20"><a href="#cb207-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">OrderSummary</span><span class="kw">:</span></span>
<span id="cb207-21"><a href="#cb207-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb207-22"><a href="#cb207-22" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb207-23"><a href="#cb207-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb207-24"><a href="#cb207-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">customer-name</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string </span><span class="kw">}</span></span>
<span id="cb207-25"><a href="#cb207-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">amount</span><span class="kw">:</span><span class="at"> </span><span class="kw">{</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> number </span><span class="kw">}</span></span>
<span id="cb207-26"><a href="#cb207-26" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at">id</span><span class="kw">,</span><span class="at"> customer-name</span><span class="kw">,</span><span class="at"> amount</span><span class="kw">]</span></span></code></pre></div>
<h3 id="analytics.aro">analytics.aro</h3>
<pre class="aro"><code>(* Application entry point *)
(Application-Start: Order Analytics) {
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Order Analytics ready&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}

(* Analytics report generation *)
(Generate Report: Order Analytics) {
    (* Fetch recent orders *)
    &lt;Fetch&gt; the &lt;recent: List&lt;Order&gt;&gt; from the &lt;orders&gt;
        where &lt;created-at&gt; &gt; now().minus(30.days)
        order by &lt;created-at&gt; desc.

    (* Calculate metrics *)
    &lt;Reduce&gt; the &lt;total-revenue: Float&gt; from the &lt;recent&gt;
        with sum(&lt;amount&gt;).

    &lt;Reduce&gt; the &lt;order-count: Integer&gt; from the &lt;recent&gt;
        with count().

    &lt;Reduce&gt; the &lt;avg-order: Float&gt; from the &lt;recent&gt;
        with avg(&lt;amount&gt;).

    (* Filter pending orders *)
    &lt;Filter&gt; the &lt;pending: List&lt;Order&gt;&gt; from the &lt;recent&gt;
        where &lt;status&gt; is &quot;pending&quot;.

    &lt;Reduce&gt; the &lt;pending-count: Integer&gt; from the &lt;pending&gt;
        with count().

    (* Map to summaries for response *)
    &lt;Map&gt; the &lt;summaries: List&lt;OrderSummary&gt;&gt; from the &lt;recent&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; with {
        orders: &lt;summaries&gt;,
        metrics: {
            total-revenue: &lt;total-revenue&gt;,
            order-count: &lt;order-count&gt;,
            avg-order-value: &lt;avg-order&gt;,
            pending-count: &lt;pending-count&gt;
        }
    }.
}</code></pre>
<hr />
<h2 id="design-philosophy">Design Philosophy</h2>
<p>ARO’s data pipelines follow these principles:</p>
<ol type="1">
<li><strong>Type-First</strong>: All results are typed via OpenAPI
schemas</li>
<li><strong>No SQL Complexity</strong>: No JOINs, subqueries, or
CTEs</li>
<li><strong>Pipeline Style</strong>: Chain simple operations for complex
transformations</li>
<li><strong>Predictable Performance</strong>: Simple operations with
clear cost</li>
</ol>
<p>For complex data needs, use multiple feature sets and compose results
in your business logic.</p>
<hr />
<p><em>Next: Chapter 26 — Repositories</em></p>
<h1 id="chapter-26-repositories">Chapter 26: Repositories</h1>
<p>Repositories provide persistent in-memory storage that survives
across HTTP requests and event handlers. Unlike regular variables which
are scoped to a single feature set execution, repositories maintain
state for the lifetime of the application.</p>
<h2 id="overview">Overview</h2>
<p>In ARO, each HTTP request creates a fresh execution context.
Variables defined in one request aren’t available in another:</p>
<pre class="aro"><code>(* This won&#39;t work - count resets on each request *)
(GET /count: Counter API) {
    &lt;Create&gt; the &lt;count&gt; with 0.
    &lt;Compute&gt; the &lt;new-count&gt; from &lt;count&gt; + 1.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;new-count&gt;.
}</code></pre>
<p>Repositories solve this by providing shared storage:</p>
<pre class="aro"><code>(POST /increment: Counter API) {
    &lt;Retrieve&gt; the &lt;counts&gt; from the &lt;counter-repository&gt;.
    &lt;Compute&gt; the &lt;current&gt; from &lt;counts: length&gt;.
    &lt;Store&gt; the &lt;current&gt; into the &lt;counter-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;current&gt;.
}

(GET /count: Counter API) {
    &lt;Retrieve&gt; the &lt;counts&gt; from the &lt;counter-repository&gt;.
    &lt;Compute&gt; the &lt;total&gt; from &lt;counts: length&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with { count: &lt;total&gt; }.
}</code></pre>
<h2 id="repository-naming-convention">Repository Naming Convention</h2>
<p>Repository names <strong>must</strong> end with
<code>-repository</code>. This is how ARO distinguishes repositories
from regular variables:</p>
<pre class="aro"><code>(* These are repositories *)
&lt;user-repository&gt;
&lt;message-repository&gt;
&lt;order-repository&gt;
&lt;session-repository&gt;

(* These are NOT repositories - just regular variables *)
&lt;users&gt;
&lt;messages&gt;
&lt;user-data&gt;</code></pre>
<p>The naming convention: - Makes repositories visually distinct in code
- Enables automatic persistence by the runtime - Follows ARO’s
self-documenting code philosophy</p>
<h2 id="storing-data">Storing Data</h2>
<p>Use the <code>&lt;Store&gt;</code> action to save data to a
repository:</p>
<pre class="aro"><code>&lt;Store&gt; the &lt;data&gt; into the &lt;name-repository&gt;.</code></pre>
<h3 id="preposition-variants">Preposition Variants</h3>
<p>All of these are equivalent:</p>
<pre class="aro"><code>&lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.
&lt;Store&gt; the &lt;user&gt; in the &lt;user-repository&gt;.
&lt;Store&gt; the &lt;user&gt; to the &lt;user-repository&gt;.</code></pre>
<h3 id="storage-semantics">Storage Semantics</h3>
<p>Repositories use <strong>list-based storage</strong>. Each store
operation appends to the list:</p>
<pre class="aro"><code>(* First request *)
&lt;Store&gt; the &lt;user1&gt; into the &lt;user-repository&gt;.
(* Repository: [user1] *)

(* Second request *)
&lt;Store&gt; the &lt;user2&gt; into the &lt;user-repository&gt;.
(* Repository: [user1, user2] *)

(* Third request *)
&lt;Store&gt; the &lt;user3&gt; into the &lt;user-repository&gt;.
(* Repository: [user1, user2, user3] *)</code></pre>
<h3 id="example-storing-messages">Example: Storing Messages</h3>
<pre class="aro"><code>(postMessage: Chat API) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.
    &lt;Extract&gt; the &lt;text&gt; from the &lt;data: message&gt;.
    &lt;Extract&gt; the &lt;author&gt; from the &lt;data: author&gt;.

    &lt;Create&gt; the &lt;message&gt; with {
        text: &lt;text&gt;,
        author: &lt;author&gt;,
        timestamp: now
    }.

    &lt;Store&gt; the &lt;message&gt; into the &lt;message-repository&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;message&gt;.
}</code></pre>
<h2 id="retrieving-data">Retrieving Data</h2>
<p>Use the <code>&lt;Retrieve&gt;</code> action to fetch data from a
repository:</p>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;items&gt; from the &lt;name-repository&gt;.</code></pre>
<h3 id="return-value">Return Value</h3>
<ul>
<li>Returns a <strong>list</strong> of all stored items</li>
<li>Returns an <strong>empty list</strong> <code>[]</code> if the
repository is empty or doesn’t exist</li>
<li>Never throws an error for missing repositories</li>
</ul>
<h3 id="example-retrieving-all-messages">Example: Retrieving All
Messages</h3>
<pre class="aro"><code>(getMessages: Chat API) {
    &lt;Retrieve&gt; the &lt;messages&gt; from the &lt;message-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with { messages: &lt;messages&gt; }.
}</code></pre>
<h3 id="filtered-retrieval">Filtered Retrieval</h3>
<p>Use <code>where</code> to filter results:</p>
<pre class="aro"><code>(getUserById: User API) {
    &lt;Extract&gt; the &lt;id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}</code></pre>
<h3 id="single-item-retrieval">Single Item Retrieval</h3>
<p>Use specifiers to retrieve a single item from a repository:</p>
<pre class="aro"><code>(* Get the most recently stored item *)
&lt;Retrieve&gt; the &lt;message&gt; from the &lt;message-repository: last&gt;.

(* Get the first stored item *)
&lt;Retrieve&gt; the &lt;message&gt; from the &lt;message-repository: first&gt;.

(* Get by numeric index - 0 = most recent *)
&lt;Retrieve&gt; the &lt;latest&gt; from the &lt;message-repository: 0&gt;.
&lt;Retrieve&gt; the &lt;second-latest&gt; from the &lt;message-repository: 1&gt;.</code></pre>
<p>Numeric indices count from most recently added (0 = newest, 1 =
second newest, etc.).</p>
<p>This is useful when you only need one item, like the latest message
in a chat:</p>
<pre class="aro"><code>(getLatestMessage: Chat API) {
    &lt;Retrieve&gt; the &lt;message&gt; from the &lt;message-repository: last&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with { message: &lt;message&gt; }.
}</code></pre>
<p>If the repository is empty, an empty string is returned.</p>
<h2 id="business-activity-scoping">Business Activity Scoping</h2>
<p>Repositories are scoped to their <strong>business activity</strong>.
Feature sets with the same business activity share repositories:</p>
<pre class="aro"><code>(* Same business activity: &quot;Chat API&quot; *)
(* These share the same &lt;message-repository&gt; *)

(postMessage: Chat API) {
    &lt;Store&gt; the &lt;message&gt; into the &lt;message-repository&gt;.
    &lt;Return&gt; a &lt;Created: status&gt;.
}

(getMessages: Chat API) {
    &lt;Retrieve&gt; the &lt;messages&gt; from the &lt;message-repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;messages&gt;.
}

(deleteMessage: Chat API) {
    (* Same repository as above *)
    &lt;Retrieve&gt; the &lt;messages&gt; from the &lt;message-repository&gt;.
    (* ... *)
}</code></pre>
<h3 id="different-business-activities-different-repositories">Different
Business Activities = Different Repositories</h3>
<pre class="aro"><code>(* Business activity: &quot;Chat API&quot; *)
(postMessage: Chat API) {
    &lt;Store&gt; the &lt;msg&gt; into the &lt;message-repository&gt;.
}

(* Business activity: &quot;Admin API&quot; - DIFFERENT repository! *)
(postAuditLog: Admin API) {
    (* This &lt;message-repository&gt; is separate from Chat API&#39;s *)
    &lt;Store&gt; the &lt;log&gt; into the &lt;message-repository&gt;.
}</code></pre>
<p>This scoping: - Prevents accidental data leakage between domains -
Allows reuse of generic repository names - Enforces domain
boundaries</p>
<h2 id="complete-example-simple-chat-application">Complete Example:
Simple Chat Application</h2>
<h3 id="main.aro">main.aro</h3>
<pre class="aro"><code>(Application-Start: Simple Chat) {
    &lt;Log&gt; the &lt;startup: message&gt; for the &lt;console&gt; with &quot;Starting Simple Chat...&quot;.
    &lt;Start&gt; the &lt;http-server&gt; for the &lt;contract&gt;.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}</code></pre>
<h3 id="api.aro">api.aro</h3>
<pre class="aro"><code>(* GET /status - Return the last message *)
(getStatus: Simple Chat API) {
    &lt;Retrieve&gt; the &lt;message&gt; from the &lt;message-repository: last&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with { message: &lt;message&gt; }.
}

(* POST /status - Store a new message *)
(postStatus: Simple Chat API) {
    &lt;Extract&gt; the &lt;message&gt; from the &lt;body: message&gt;.

    &lt;Store&gt; the &lt;message&gt; into the &lt;message-repository&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with { message: &lt;message&gt; }.
}</code></pre>
<h3 id="testing">Testing</h3>
<div class="sourceCode" id="cb225"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Post a message</span></span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST http://localhost:8080/status <span class="dt">\</span></span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&#39;Content-Type: application/json&#39;</span> <span class="dt">\</span></span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{&quot;message&quot;:&quot;Hello!&quot;}&#39;</span></span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Response: {&quot;message&quot;:&quot;Hello!&quot;}</span></span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Post another message</span></span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST http://localhost:8080/status <span class="dt">\</span></span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">&#39;Content-Type: application/json&#39;</span> <span class="dt">\</span></span>
<span id="cb225-10"><a href="#cb225-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">&#39;{&quot;message&quot;:&quot;World!&quot;}&#39;</span></span>
<span id="cb225-11"><a href="#cb225-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Response: {&quot;message&quot;:&quot;World!&quot;}</span></span>
<span id="cb225-12"><a href="#cb225-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-13"><a href="#cb225-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the last message</span></span>
<span id="cb225-14"><a href="#cb225-14" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8080/status</span>
<span id="cb225-15"><a href="#cb225-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Response: {&quot;message&quot;:&quot;World!&quot;}</span></span></code></pre></div>
<h2 id="deleting-from-repositories">Deleting from Repositories</h2>
<p>Use the <code>&lt;Delete&gt;</code> action with a <code>where</code>
clause to remove items from a repository:</p>
<pre class="aro"><code>&lt;Delete&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;userId&gt;.</code></pre>
<h3 id="example-deleting-a-user">Example: Deleting a User</h3>
<pre class="aro"><code>(deleteUser: User API) {
    &lt;Extract&gt; the &lt;userId&gt; from the &lt;pathParameters: id&gt;.
    &lt;Delete&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;userId&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with { deleted: &lt;userId&gt; }.
}</code></pre>
<p>The deleted item(s) are bound to the result variable
(<code>user</code> in this example).</p>
<h2 id="repository-observers-2">Repository Observers</h2>
<p>Repository observers are feature sets that automatically react to
repository changes. They receive access to both old and new values,
enabling audit logging, synchronization, and reactive patterns.</p>
<h3 id="observer-syntax">Observer Syntax</h3>
<p>Create an observer by naming your feature set’s business activity as
<code>{repository-name} Observer</code>:</p>
<pre class="aro"><code>(Audit Changes: user-repository Observer) {
    &lt;Extract&gt; the &lt;changeType&gt; from the &lt;event: changeType&gt;.
    &lt;Extract&gt; the &lt;newValue&gt; from the &lt;event: newValue&gt;.
    &lt;Extract&gt; the &lt;oldValue&gt; from the &lt;event: oldValue&gt;.

    &lt;Log&gt; the &lt;audit: message&gt; for the &lt;console&gt; with &lt;changeType&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;audit&gt;.
}</code></pre>
<h3 id="event-payload">Event Payload</h3>
<p>Observers receive an event with the following fields:</p>
<table>
<colgroup>
<col style="width: 26%" />
<col style="width: 23%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>repositoryName</code></td>
<td>String</td>
<td>The repository name (e.g., “user-repository”)</td>
</tr>
<tr>
<td><code>changeType</code></td>
<td>String</td>
<td>“created”, “updated”, or “deleted”</td>
</tr>
<tr>
<td><code>entityId</code></td>
<td>String?</td>
<td>ID of the changed entity (if available)</td>
</tr>
<tr>
<td><code>newValue</code></td>
<td>Any?</td>
<td>The new value (nil for deletes)</td>
</tr>
<tr>
<td><code>oldValue</code></td>
<td>Any?</td>
<td>The previous value (nil for creates)</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td>Date</td>
<td>When the change occurred</td>
</tr>
</tbody>
</table>
<h3 id="change-types">Change Types</h3>
<p>Observers are triggered for three types of changes:</p>
<ul>
<li><strong>created</strong>: New item stored (no previous value existed
with matching ID)</li>
<li><strong>updated</strong>: Existing item modified (matched by
ID)</li>
<li><strong>deleted</strong>: Item removed using
<code>&lt;Delete&gt;</code> action</li>
</ul>
<h3 id="example-tracking-user-changes">Example: Tracking User
Changes</h3>
<pre class="aro"><code>(Track User Changes: user-repository Observer) {
    &lt;Extract&gt; the &lt;changeType&gt; from the &lt;event: changeType&gt;.
    &lt;Extract&gt; the &lt;entityId&gt; from the &lt;event: entityId&gt;.

    &lt;Compare&gt; the &lt;changeType&gt; equals &quot;updated&quot;.

    &lt;Extract&gt; the &lt;oldName&gt; from the &lt;event: oldValue: name&gt;.
    &lt;Extract&gt; the &lt;newName&gt; from the &lt;event: newValue: name&gt;.

    &lt;Log&gt; the &lt;change: message&gt; for the &lt;console&gt;
        with &quot;User &quot; + &lt;entityId&gt; + &quot; renamed from &quot; + &lt;oldName&gt; + &quot; to &quot; + &lt;newName&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;tracking&gt;.
}</code></pre>
<h3 id="multiple-observers">Multiple Observers</h3>
<p>You can have multiple observers for the same repository:</p>
<pre class="aro"><code>(* Audit logging observer *)
(Log All Changes: user-repository Observer) {
    &lt;Extract&gt; the &lt;changeType&gt; from the &lt;event: changeType&gt;.
    &lt;Log&gt; the &lt;audit: message&gt; for the &lt;console&gt; with &lt;changeType&gt;.
    &lt;Return&gt; an &lt;OK: status&gt;.
}

(* Email notification observer *)
(Notify Admin: user-repository Observer) {
    &lt;Extract&gt; the &lt;changeType&gt; from the &lt;event: changeType&gt;.
    &lt;Compare&gt; the &lt;changeType&gt; equals &quot;deleted&quot;.
    &lt;Send&gt; the &lt;notification&gt; to the &lt;admin-email&gt;.
    &lt;Return&gt; an &lt;OK: status&gt;.
}</code></pre>
<h2 id="lifetime-and-persistence">Lifetime and Persistence</h2>
<h3 id="application-lifetime">Application Lifetime</h3>
<p>Repositories persist for the <strong>lifetime of the
application</strong>:</p>
<ul>
<li>Created when first accessed</li>
<li>Survive across all HTTP requests</li>
<li>Cleared when application restarts</li>
</ul>
<h3 id="no-disk-persistence">No Disk Persistence</h3>
<p>Repositories are <strong>in-memory only</strong>:</p>
<ul>
<li>Data is lost when the application stops</li>
<li>No external database required</li>
<li>Fast and simple for prototyping</li>
</ul>
<p>For persistent storage, use a database integration (future ARO
feature).</p>
<h2 id="best-practices-16">Best Practices</h2>
<h3 id="use-descriptive-repository-names">Use Descriptive Repository
Names</h3>
<pre class="aro"><code>(* Good - clear what&#39;s stored *)
&lt;user-repository&gt;
&lt;pending-order-repository&gt;
&lt;session-token-repository&gt;

(* Avoid - too generic *)
&lt;data-repository&gt;
&lt;stuff-repository&gt;</code></pre>
<h3 id="one-repository-per-domain-concept">One Repository Per Domain
Concept</h3>
<pre class="aro"><code>(* Good - separate repositories for different concepts *)
&lt;user-repository&gt;
&lt;order-repository&gt;
&lt;product-repository&gt;

(* Avoid - mixing concepts *)
&lt;everything-repository&gt;</code></pre>
<h3 id="keep-repository-data-simple">Keep Repository Data Simple</h3>
<p>Store simple, serializable data:</p>
<pre class="aro"><code>(* Good - simple object *)
&lt;Create&gt; the &lt;user&gt; with {
    id: &lt;id&gt;,
    name: &lt;name&gt;,
    email: &lt;email&gt;
}.
&lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.

(* Avoid - complex nested structures *)
&lt;Store&gt; the &lt;entire-request-context&gt; into the &lt;debug-repository&gt;.</code></pre>
<hr />
<p><em>Next: Chapter 27 — System Commands</em></p>
<h1 id="chapter-27-system-commands">Chapter 27: System Commands</h1>
<p>ARO provides the <code>&lt;Exec&gt;</code> action for executing shell
commands on the host system. This chapter covers command execution,
result handling, and security considerations.</p>
<h2 id="basic-execution">Basic Execution</h2>
<h3 id="simple-commands">Simple Commands</h3>
<p>Execute shell commands using the <code>&lt;Exec&gt;</code>
action:</p>
<pre class="aro"><code>&lt;Exec&gt; the &lt;result&gt; for the &lt;command&gt; with &quot;ls -la&quot;.
&lt;Exec&gt; the &lt;listing&gt; for the &lt;files&gt; with &quot;find . -name &#39;*.txt&#39;&quot;.
&lt;Exec&gt; the &lt;status&gt; for the &lt;check&gt; with &quot;git status&quot;.</code></pre>
<h3 id="using-variables">Using Variables</h3>
<p>Build commands dynamically with variables:</p>
<pre class="aro"><code>&lt;Create&gt; the &lt;directory&gt; with &quot;/var/log&quot;.
&lt;Exec&gt; the &lt;result&gt; for the &lt;listing&gt; with &quot;ls -la ${directory}&quot;.

&lt;Create&gt; the &lt;pattern&gt; with &quot;*.aro&quot;.
&lt;Exec&gt; the &lt;files&gt; for the &lt;search&gt; with &quot;find . -name &#39;${pattern}&#39;&quot;.</code></pre>
<h2 id="result-object">Result Object</h2>
<p>Every <code>&lt;Exec&gt;</code> action returns a structured result
object:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>error</code></td>
<td>Boolean</td>
<td><code>true</code> if command failed (non-zero exit code)</td>
</tr>
<tr>
<td><code>message</code></td>
<td>String</td>
<td>Human-readable status message</td>
</tr>
<tr>
<td><code>output</code></td>
<td>String</td>
<td>Command stdout (or stderr if error)</td>
</tr>
<tr>
<td><code>exitCode</code></td>
<td>Int</td>
<td>Process exit code (0 = success, -1 = timeout)</td>
</tr>
<tr>
<td><code>command</code></td>
<td>String</td>
<td>The executed command string</td>
</tr>
</tbody>
</table>
<h3 id="accessing-result-fields">Accessing Result Fields</h3>
<pre class="aro"><code>&lt;Exec&gt; the &lt;result&gt; for the &lt;command&gt; with &quot;whoami&quot;.

(* Access individual fields *)
&lt;Log&gt; the &lt;user: message&gt; for the &lt;console&gt; with &lt;result.output&gt;.
&lt;Log&gt; the &lt;exit: code&gt; for the &lt;console&gt; with &lt;result.exitCode&gt;.

(* Check for errors *)
&lt;Log&gt; the &lt;error: message&gt; for the &lt;console&gt; with &lt;result.message&gt; when &lt;result.error&gt; = true.</code></pre>
<h2 id="error-handling-1">Error Handling</h2>
<h3 id="checking-for-errors">Checking for Errors</h3>
<pre class="aro"><code>(Check Disk Space: System Monitor) {
    &lt;Exec&gt; the &lt;result&gt; for the &lt;disk-check&gt; with &quot;df -h&quot;.

    &lt;Log&gt; the &lt;error&gt; for the &lt;console&gt; with &lt;result.message&gt; when &lt;result.error&gt; = true.
    &lt;Return&gt; an &lt;Error: status&gt; with &lt;result&gt; when &lt;result.error&gt; = true.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;result&gt;.
}</code></pre>
<h3 id="handling-non-zero-exit-codes">Handling Non-Zero Exit Codes</h3>
<pre class="aro"><code>(Git Status: Version Control) {
    &lt;Exec&gt; the &lt;result&gt; for the &lt;git&gt; with &quot;git status --porcelain&quot;.

    &lt;Log&gt; the &lt;warning&gt; for the &lt;console&gt; with &quot;Not a git repository&quot; when &lt;result.exitCode&gt; != 0.
    &lt;Return&gt; a &lt;BadRequest: status&gt; with { error: &quot;Not a git repository&quot; } when &lt;result.exitCode&gt; != 0.

    &lt;Return&gt; an &lt;OK: status&gt; with { message: &quot;Working tree clean&quot; } when &lt;result.output&gt; is empty.

    &lt;Return&gt; an &lt;OK: status&gt; with { changes: &lt;result.output&gt; }.
}</code></pre>
<h3 id="timeout-handling">Timeout Handling</h3>
<p>Commands that exceed the timeout return with
<code>exitCode: -1</code>:</p>
<pre class="aro"><code>&lt;Exec&gt; the &lt;result&gt; for the &lt;long-task&gt; with {
    command: &quot;sleep 60&quot;,
    timeout: 5000
}.

&lt;Log&gt; the &lt;timeout&gt; for the &lt;console&gt; with &quot;Command timed out&quot; when &lt;result.exitCode&gt; = -1.</code></pre>
<h2 id="configuration-options">Configuration Options</h2>
<p>For advanced control, use object syntax:</p>
<pre class="aro"><code>&lt;Exec&gt; the &lt;result&gt; on the &lt;system&gt; with {
    command: &quot;npm install&quot;,
    workingDirectory: &quot;/app&quot;,
    timeout: 60000,
    shell: &quot;/bin/bash&quot;,
    environment: { NODE_ENV: &quot;production&quot; }
}.</code></pre>
<h3 id="available-options">Available Options</h3>
<table>
<colgroup>
<col style="width: 22%" />
<col style="width: 16%" />
<col style="width: 25%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr>
<th>Option</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>command</code></td>
<td>String</td>
<td>(required)</td>
<td>The shell command to execute</td>
</tr>
<tr>
<td><code>workingDirectory</code></td>
<td>String</td>
<td>current</td>
<td>Working directory for the command</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td>Int</td>
<td>30000</td>
<td>Timeout in milliseconds</td>
</tr>
<tr>
<td><code>shell</code></td>
<td>String</td>
<td>/bin/sh</td>
<td>Shell to use for execution</td>
</tr>
<tr>
<td><code>environment</code></td>
<td>Object</td>
<td>(inherited)</td>
<td>Additional environment variables</td>
</tr>
<tr>
<td><code>captureStderr</code></td>
<td>Boolean</td>
<td>true</td>
<td>Include stderr in output</td>
</tr>
</tbody>
</table>
<h2 id="context-aware-output">Context-Aware Output</h2>
<p>Following ARO’s context-aware response formatting (ARO-0031),
<code>&lt;Exec&gt;</code> results display differently based on execution
context.</p>
<h3 id="console-output-human-context">Console Output (Human
Context)</h3>
<pre><code>command: ls -la
exitCode: 0
error: false
message: Command executed successfully
output:
  total 48
  drwxr-xr-x  12 user  staff   384 Dec 23 10:00 .
  -rw-r--r--   1 user  staff  1234 Dec 23 10:00 main.aro</code></pre>
<h3 id="http-response-machine-context">HTTP Response (Machine
Context)</h3>
<div class="sourceCode" id="cb242"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;OK&quot;</span><span class="fu">,</span></span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;reason&quot;</span><span class="fu">:</span> <span class="st">&quot;success&quot;</span><span class="fu">,</span></span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;result&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;error&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;message&quot;</span><span class="fu">:</span> <span class="st">&quot;Command executed successfully&quot;</span><span class="fu">,</span></span>
<span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;output&quot;</span><span class="fu">:</span> <span class="st">&quot;total 48</span><span class="ch">\n</span><span class="st">drwxr-xr-x  12 user  staff...&quot;</span><span class="fu">,</span></span>
<span id="cb242-9"><a href="#cb242-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;exitCode&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb242-10"><a href="#cb242-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;command&quot;</span><span class="fu">:</span> <span class="st">&quot;ls -la&quot;</span></span>
<span id="cb242-11"><a href="#cb242-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb242-12"><a href="#cb242-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb242-13"><a href="#cb242-13" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h2 id="common-patterns-3">Common Patterns</h2>
<h3 id="directory-listing">Directory Listing</h3>
<pre class="aro"><code>(Application-Start: Directory Lister) {
    &lt;Log&gt; the &lt;startup: message&gt; for the &lt;console&gt; with &quot;Directory Lister&quot;.
    &lt;Exec&gt; the &lt;listing&gt; for the &lt;command&gt; with &quot;ls -la&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;listing&gt;.
}</code></pre>
<h3 id="system-information">System Information</h3>
<pre class="aro"><code>(System Info: Status API) {
    &lt;Exec&gt; the &lt;hostname&gt; for the &lt;check&gt; with &quot;hostname&quot;.
    &lt;Exec&gt; the &lt;uptime&gt; for the &lt;check&gt; with &quot;uptime&quot;.
    &lt;Exec&gt; the &lt;memory&gt; for the &lt;check&gt; with &quot;free -h&quot;.

    &lt;Create&gt; the &lt;info&gt; with {
        hostname: &lt;hostname.output&gt;,
        uptime: &lt;uptime.output&gt;,
        memory: &lt;memory.output&gt;
    }.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;info&gt;.
}</code></pre>
<h3 id="build-pipeline">Build Pipeline</h3>
<pre class="aro"><code>(Run Build: CI Pipeline) {
    &lt;Log&gt; the &lt;step&gt; for the &lt;console&gt; with &quot;Installing dependencies...&quot;.
    &lt;Exec&gt; the &lt;install&gt; for the &lt;npm&gt; with {
        command: &quot;npm install&quot;,
        workingDirectory: &quot;./app&quot;,
        timeout: 120000
    }.

    &lt;Return&gt; an &lt;Error: status&gt; with &lt;install&gt; when &lt;install.error&gt; = true.

    &lt;Log&gt; the &lt;step&gt; for the &lt;console&gt; with &quot;Running tests...&quot;.
    &lt;Exec&gt; the &lt;test&gt; for the &lt;npm&gt; with {
        command: &quot;npm test&quot;,
        workingDirectory: &quot;./app&quot;
    }.

    &lt;Return&gt; an &lt;Error: status&gt; with &lt;test&gt; when &lt;test.error&gt; = true.

    &lt;Log&gt; the &lt;step&gt; for the &lt;console&gt; with &quot;Building...&quot;.
    &lt;Exec&gt; the &lt;build&gt; for the &lt;npm&gt; with {
        command: &quot;npm run build&quot;,
        workingDirectory: &quot;./app&quot;
    }.

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;build&gt;.
}</code></pre>
<h3 id="health-checks">Health Checks</h3>
<pre class="aro"><code>(Health Check: Monitoring) {
    &lt;Exec&gt; the &lt;curl&gt; for the &lt;health&gt; with {
        command: &quot;curl -s http://localhost:8080/health&quot;,
        timeout: 5000
    }.

    &lt;Return&gt; a &lt;ServiceUnavailable: status&gt; with {
        service: &quot;api&quot;,
        error: &lt;curl.message&gt;
    } when &lt;curl.error&gt; = true.

    &lt;Return&gt; an &lt;OK: status&gt; with { healthy: true }.
}</code></pre>
<h3 id="process-management">Process Management</h3>
<pre class="aro"><code>(List Processes: Admin API) {
    &lt;Exec&gt; the &lt;processes&gt; for the &lt;list&gt; with &quot;ps aux | head -20&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;processes&gt;.
}

(Check Process: Admin API) {
    &lt;Extract&gt; the &lt;name&gt; from the &lt;queryParameters: name&gt;.
    &lt;Exec&gt; the &lt;result&gt; for the &lt;check&gt; with &quot;pgrep -l ${name}&quot;.

    &lt;Return&gt; an &lt;OK: status&gt; with { running: false, process: &lt;name&gt; } when &lt;result.error&gt; = true.

    &lt;Return&gt; an &lt;OK: status&gt; with { running: true, process: &lt;name&gt;, pids: &lt;result.output&gt; }.
}</code></pre>
<h2 id="security-considerations">Security Considerations</h2>
<h3 id="command-injection-prevention">Command Injection Prevention</h3>
<p>Be cautious when constructing commands from user input:</p>
<pre class="aro"><code>(* DANGEROUS - user input directly in command *)
&lt;Exec&gt; the &lt;result&gt; for the &lt;command&gt; with &quot;ls ${userInput}&quot;.

(* SAFER - validate input first *)
&lt;Validate&gt; the &lt;path&gt; for the &lt;userInput&gt; against &quot;^[a-zA-Z0-9_/.-]+$&quot;.
&lt;Return&gt; a &lt;BadRequest: status&gt; with &quot;Invalid path characters&quot; when &lt;path&gt; is not &lt;valid&gt;.
&lt;Exec&gt; the &lt;result&gt; for the &lt;command&gt; with &quot;ls ${path}&quot;.</code></pre>
<h3 id="best-practices-17">Best Practices</h3>
<ol type="1">
<li><strong>Never trust user input</strong> - Always validate and
sanitize before using in commands</li>
<li><strong>Use allowlists</strong> - Define allowed commands or
patterns rather than blocking bad ones</li>
<li><strong>Limit permissions</strong> - Run the ARO application with
minimal required privileges</li>
<li><strong>Set timeouts</strong> - Always specify reasonable timeouts
to prevent hanging</li>
<li><strong>Log commands</strong> - Keep audit logs of executed commands
for security review</li>
</ol>
<h3 id="sandboxing-future">Sandboxing (Future)</h3>
<p>Future versions may support sandboxing options:</p>
<pre class="aro"><code>&lt;Exec&gt; the &lt;result&gt; for the &lt;command&gt; with {
    command: &quot;npm install&quot;,
    sandbox: {
        network: false,
        filesystem: [&quot;/app&quot;],
        maxMemory: &quot;512MB&quot;,
        maxTime: 60000
    }
}.</code></pre>
<hr />
<p><em>Next: Chapter 28 — HTTP Client</em></p>
<h1 id="chapter-28-http-client">Chapter 28: HTTP Client</h1>
<p>ARO provides HTTP client capabilities for making requests to external
services and APIs.</p>
<h2 id="making-http-requests">Making HTTP Requests</h2>
<p>Use the <code>&lt;Request&gt;</code> action to make HTTP requests.
The preposition determines the HTTP method:</p>
<ul>
<li><code>from</code> - GET request</li>
<li><code>to</code> - POST request</li>
<li><code>via METHOD</code> - Explicit method (PUT, DELETE, PATCH)</li>
</ul>
<h2 id="get-requests">GET Requests</h2>
<p>Use <code>from</code> preposition to make GET requests:</p>
<pre class="aro"><code>(* Simple GET request *)
&lt;Create&gt; the &lt;url&gt; with &quot;https://api.example.com/users&quot;.
&lt;Request&gt; the &lt;users&gt; from the &lt;url&gt;.</code></pre>
<h2 id="post-requests">POST Requests</h2>
<p>Use <code>to</code> preposition to make POST requests:</p>
<pre class="aro"><code>(* POST with data from context *)
&lt;Create&gt; the &lt;user-data&gt; with { name: &quot;Alice&quot;, email: &quot;alice@example.com&quot; }.
&lt;Create&gt; the &lt;api-url&gt; with &quot;https://api.example.com/users&quot;.
&lt;Request&gt; the &lt;result&gt; to the &lt;api-url&gt; with &lt;user-data&gt;.</code></pre>
<h2 id="other-http-methods">Other HTTP Methods</h2>
<p>Use <code>via</code> preposition with method specifier for PUT,
DELETE, PATCH:</p>
<pre class="aro"><code>(* PUT request *)
&lt;Request&gt; the &lt;result&gt; via PUT the &lt;url&gt; with &lt;update-data&gt;.

(* DELETE request *)
&lt;Request&gt; the &lt;result&gt; via DELETE the &lt;url&gt;.

(* PATCH request *)
&lt;Request&gt; the &lt;result&gt; via PATCH the &lt;url&gt; with &lt;partial-data&gt;.</code></pre>
<h2 id="config-object-syntax">Config Object Syntax</h2>
<p>For full control over requests, use a config object with the
<code>with { ... }</code> clause:</p>
<pre class="aro"><code>(* POST with custom headers and timeout *)
&lt;Request&gt; the &lt;response&gt; from the &lt;api-url&gt; with {
    method: &quot;POST&quot;,
    headers: { &quot;Content-Type&quot;: &quot;application/json&quot;, &quot;Authorization&quot;: &quot;Bearer token&quot; },
    body: &lt;data&gt;,
    timeout: 60
}.

(* GET with authorization header *)
&lt;Request&gt; the &lt;protected-data&gt; from the &lt;api-url&gt; with {
    headers: { &quot;Authorization&quot;: &quot;Bearer my-token&quot; }
}.</code></pre>
<p><strong>Config Options:</strong></p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>method</code></td>
<td>String</td>
<td>HTTP method: GET, POST, PUT, DELETE, PATCH</td>
</tr>
<tr>
<td><code>headers</code></td>
<td>Map</td>
<td>Custom HTTP headers</td>
</tr>
<tr>
<td><code>body</code></td>
<td>String/Map</td>
<td>Request body (auto-serialized to JSON if map)</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td>Number</td>
<td>Request timeout in seconds (default: 30)</td>
</tr>
</tbody>
</table>
<p>The config <code>method</code> overrides the preposition-based method
detection. This allows you to use <code>from</code> (which defaults to
GET) while specifying POST in the config.</p>
<h2 id="response-handling">Response Handling</h2>
<p>The <code>&lt;Request&gt;</code> action automatically parses JSON
responses. After a request, these variables are available:</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>result</code></td>
<td>Parsed response body (JSON as map/list, or string)</td>
</tr>
<tr>
<td><code>result.statusCode</code></td>
<td>HTTP status code (e.g., 200, 404)</td>
</tr>
<tr>
<td><code>result.headers</code></td>
<td>Response headers as map</td>
</tr>
<tr>
<td><code>result.isSuccess</code></td>
<td>Boolean: true if status 200-299</td>
</tr>
</tbody>
</table>
<pre class="aro"><code>&lt;Create&gt; the &lt;api-url&gt; with &quot;https://api.example.com/users&quot;.
&lt;Request&gt; the &lt;response&gt; from the &lt;api-url&gt;.

(* Access response metadata *)
&lt;Extract&gt; the &lt;status&gt; from the &lt;response: statusCode&gt;.
&lt;Extract&gt; the &lt;is-ok&gt; from the &lt;response: isSuccess&gt;.

(* Access response body - response IS the parsed body *)
&lt;Extract&gt; the &lt;first-user&gt; from the &lt;response: 0&gt;.</code></pre>
<h2 id="complete-example-2">Complete Example</h2>
<pre class="aro"><code>(* Fetch weather data from Open-Meteo API *)

(Application-Start: Weather Client) {
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Fetching weather...&quot;.

    &lt;Create&gt; the &lt;api-url&gt; with &quot;https://api.open-meteo.com/v1/forecast?latitude=52.52&amp;longitude=13.41&amp;current_weather=true&quot;.
    &lt;Request&gt; the &lt;weather&gt; from the &lt;api-url&gt;.

    &lt;Log&gt; the &lt;data: message&gt; for the &lt;console&gt; with &lt;weather&gt;.

    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}</code></pre>
<h2 id="implementation-notes">Implementation Notes</h2>
<ul>
<li>Uses Foundation’s URLSession for HTTP requests</li>
<li>Compatible with both interpreter (<code>aro run</code>) and compiled
binaries (<code>aro build</code>)</li>
<li>Default timeout: 30 seconds</li>
<li>Automatically parses JSON responses</li>
<li>Thread-safe for concurrent requests</li>
<li>Available on macOS and Linux (not Windows)</li>
</ul>
<hr />
<p><em>Next: Chapter 29 — Concurrency</em></p>
<h1 id="chapter-29-concurrency">Chapter 29: Concurrency</h1>
<p>ARO’s concurrency model is radically simple: <strong>feature sets are
async, statements are sync</strong>. This chapter explains how ARO
handles concurrent operations without requiring you to think about
threads, locks, or async/await.</p>
<h2 id="the-philosophy-1">The Philosophy</h2>
<p>ARO’s concurrency model matches how project managers think:</p>
<ul>
<li><strong>“When X happens, do Y”</strong> - Feature sets are triggered
by events</li>
<li><strong>“Do this, then this, then this”</strong> - Steps happen in
order</li>
</ul>
<p>You don’t think about threads, locks, race conditions, or
async/await. You think about things happening and responding to them in
sequence.</p>
<h2 id="feature-sets-are-async">Feature Sets Are Async</h2>
<p>Every feature set runs asynchronously when triggered by an event:</p>
<pre><code>+-----------------------------------------------------+
|                    Event Bus                         |
|                                                      |
|  HTTP Request --+---&gt; (listUsers: User API)          |
|                 |                                    |
|  Socket Data ---+---&gt; (Handle Data: Socket Handler)  |
|                 |                                    |
|  File Changed --+---&gt; (Process File: File Handler)   |
|                 |                                    |
|  UserCreated ---+---&gt; (Send Email: Notification)     |
|                                                      |
|  (Multiple events trigger multiple feature sets     |
|   running concurrently)                              |
+-----------------------------------------------------+</code></pre>
<p>When multiple events arrive, multiple feature sets execute
simultaneously. 100 HTTP requests = 100 concurrent feature set
executions.</p>
<h2 id="statements-are-sync">Statements Are Sync</h2>
<p>Inside a feature set, statements execute
<strong>synchronously</strong> and <strong>serially</strong>:</p>
<pre class="aro"><code>(Process Order: Order API) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.      (* 1. First *)
    &lt;Validate&gt; the &lt;data&gt; for the &lt;order-schema&gt;.       (* 2. Second *)
    &lt;Create&gt; the &lt;order&gt; with &lt;data&gt;.                   (* 3. Third *)
    &lt;Store&gt; the &lt;order&gt; in the &lt;order-repository&gt;.      (* 4. Fourth *)
    &lt;Emit&gt; to &lt;Send Confirmation&gt; with &lt;order&gt;.         (* 5. Fifth *)
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;order&gt;.          (* 6. Last *)
}</code></pre>
<p>Each statement completes before the next one starts. No callbacks. No
promises. No async/await syntax. Just sequential execution.</p>
<h2 id="why-this-model">Why This Model?</h2>
<h3 id="simplicity">Simplicity</h3>
<p>Traditional async code in JavaScript:</p>
<div class="sourceCode" id="cb258"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">processOrder</span>(req) {</span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> <span class="fu">extractData</span>(req)<span class="op">;</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> validated <span class="op">=</span> <span class="cf">await</span> <span class="fu">validate</span>(data)<span class="op">;</span></span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> order <span class="op">=</span> <span class="cf">await</span> <span class="fu">createOrder</span>(validated)<span class="op">;</span></span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">storeOrder</span>(order)<span class="op">;</span></span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> <span class="fu">emitEvent</span>(<span class="st">&#39;OrderCreated&#39;</span><span class="op">,</span> order)<span class="op">;</span></span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { <span class="dt">status</span><span class="op">:</span> <span class="dv">201</span><span class="op">,</span> <span class="dt">body</span><span class="op">:</span> order }<span class="op">;</span></span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>ARO code:</p>
<pre class="aro"><code>(Process Order: Order API) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.
    &lt;Validate&gt; the &lt;data&gt; for the &lt;order-schema&gt;.
    &lt;Create&gt; the &lt;order&gt; with &lt;data&gt;.
    &lt;Store&gt; the &lt;order&gt; in the &lt;order-repository&gt;.
    &lt;Emit&gt; to &lt;Send Confirmation&gt; with &lt;order&gt;.
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;order&gt;.
}</code></pre>
<p>No <code>async</code>. No <code>await</code>. Just statements in
order.</p>
<h3 id="no-race-conditions">No Race Conditions</h3>
<p>Within a feature set, there’s no shared mutable state problem:</p>
<ul>
<li>Variables are scoped to the feature set</li>
<li>Statements execute serially</li>
<li>No concurrent access to the same data</li>
</ul>
<h3 id="natural-event-flow">Natural Event Flow</h3>
<p>Events naturally express concurrency:</p>
<ul>
<li>User A requests an order while User B requests their profile</li>
<li>Both feature sets run concurrently</li>
<li>Each processes their own data independently</li>
</ul>
<h2 id="runtime-optimization">Runtime Optimization</h2>
<p>While you write synchronous-looking code, the ARO runtime executes
operations <strong>asynchronously</strong> based on data dependencies.
This is transparent to you.</p>
<h3 id="how-it-works">How It Works</h3>
<p>The runtime performs <strong>data-flow driven execution</strong>:</p>
<ol type="1">
<li><strong>Eager Start</strong>: I/O operations begin immediately
(non-blocking)</li>
<li><strong>Dependency Tracking</strong>: The runtime tracks which
variables each statement needs</li>
<li><strong>Lazy Synchronization</strong>: Only wait for data when it’s
actually used</li>
<li><strong>Preserved Semantics</strong>: Results appear in statement
order</li>
</ol>
<h3 id="example">Example</h3>
<pre class="aro"><code>(Process Config: File Handler) {
    &lt;Open&gt; the &lt;config-file&gt; from the &lt;path&gt;.        (* 1. Starts file load *)
    &lt;Compute&gt; the &lt;hash&gt; for the &lt;request&gt;.          (* 2. Runs immediately *)
    &lt;Log&gt; the &lt;status&gt; for the &lt;request&gt;.            (* 3. Runs immediately *)
    &lt;Parse&gt; the &lt;config&gt; from the &lt;config-file&gt;.     (* 4. Waits for file *)
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;config&gt;.
}</code></pre>
<p><strong>What happens:</strong></p>
<ul>
<li>Statement 1 kicks off file loading (async, returns immediately)</li>
<li>Statements 2 and 3 execute while the file loads in background</li>
<li>Statement 4 waits only if the file isn’t ready yet</li>
<li>You see: synchronous execution</li>
<li>Runtime does: parallel I/O with sequential semantics</li>
</ul>
<p><strong>Write synchronous code. Get async performance.</strong></p>
<h2 id="event-emission">Event Emission</h2>
<p>Feature sets can trigger other feature sets:</p>
<pre class="aro"><code>(Create User: User API) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.
    &lt;Create&gt; the &lt;user&gt; with &lt;data&gt;.
    &lt;Store&gt; the &lt;user&gt; in the &lt;user-repository&gt;.

    (* Triggers other feature sets asynchronously *)
    &lt;Emit&gt; to &lt;Send Welcome Email&gt; with &lt;user&gt;.

    (* Continues immediately, doesn&#39;t wait for handler *)
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.
}

(Send Welcome Email: Notifications) {
    &lt;Extract&gt; the &lt;email&gt; from the &lt;event: email&gt;.
    &lt;Send&gt; the &lt;welcome-email&gt; to the &lt;email&gt;.
    &lt;Return&gt; an &lt;OK: status&gt;.
}</code></pre>
<p>When <code>&lt;Emit&gt;</code> executes:</p>
<ol type="1">
<li>The event is dispatched to the target feature set</li>
<li>Execution continues in the current feature set</li>
<li>The target handler starts executing independently</li>
</ol>
<h2 id="no-concurrency-primitives">No Concurrency Primitives</h2>
<p>ARO explicitly does <strong>not</strong> provide:</p>
<ul>
<li><code>async</code> / <code>await</code> keywords</li>
<li>Promises / Futures</li>
<li>Threads / Task spawning</li>
<li>Locks / Mutexes / Semaphores</li>
<li>Channels</li>
<li>Actors</li>
<li>Parallel for loops</li>
</ul>
<p>These are implementation concerns. The runtime handles them. You
write sequential code that responds to events.</p>
<h2 id="examples-1">Examples</h2>
<h3 id="http-server-1">HTTP Server</h3>
<pre class="aro"><code>(Application-Start: My API) {
    &lt;Start&gt; the &lt;http-server&gt; on port 8080.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt;.
}

(* Each request triggers this independently *)
(getUser: User API) {
    &lt;Extract&gt; the &lt;id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}</code></pre>
<h3 id="socket-echo-server">Socket Echo Server</h3>
<pre class="aro"><code>(Application-Start: Echo Server) {
    &lt;Start&gt; the &lt;socket-server&gt; on port 9000.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt;.
}

(* Each client message triggers this independently *)
(Handle Data: Socket Event Handler) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;event: data&gt;.
    &lt;Extract&gt; the &lt;connection&gt; from the &lt;event: connection&gt;.
    &lt;Send&gt; the &lt;data&gt; to the &lt;connection&gt;.
    &lt;Return&gt; an &lt;OK: status&gt;.
}</code></pre>
<h3 id="file-watcher">File Watcher</h3>
<pre class="aro"><code>(Application-Start: File Watcher) {
    &lt;Watch&gt; the &lt;directory&gt; for the &lt;changes&gt; with &quot;./watched&quot;.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt;.
}

(* Each file change triggers this independently *)
(Handle File Change: File Event Handler) {
    &lt;Extract&gt; the &lt;path&gt; from the &lt;event: path&gt;.
    &lt;Extract&gt; the &lt;type&gt; from the &lt;event: type&gt;.
    &lt;Log&gt; the &lt;change: message&gt; with &lt;path&gt; and &lt;type&gt;.
    &lt;Return&gt; an &lt;OK: status&gt;.
}</code></pre>
<h2 id="summary-1">Summary</h2>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>Feature sets</td>
<td>Run async (triggered by events)</td>
</tr>
<tr>
<td>Statements</td>
<td>Appear sync (serial execution)</td>
</tr>
<tr>
<td>I/O operations</td>
<td>Async under the hood</td>
</tr>
<tr>
<td>Events</td>
<td>Non-blocking dispatch</td>
</tr>
<tr>
<td>Concurrency primitives</td>
<td>None needed</td>
</tr>
</tbody>
</table>
<p>Write synchronous code. Get async performance. No callbacks, no
promises, no await.</p>
<hr />
<p><em>Next: Chapter 30 — Context-Aware Response Formatting</em></p>
<h1 id="chapter-30-context-aware-response-formatting">Chapter 30:
Context-Aware Response Formatting</h1>
<p>ARO automatically formats responses and log output based on the
execution context. The same code produces different output formats
depending on how it’s invoked.</p>
<h2 id="execution-contexts">Execution Contexts</h2>
<p>ARO recognizes three execution contexts:</p>
<table>
<thead>
<tr>
<th>Context</th>
<th>Trigger</th>
<th>Output Format</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Human</strong></td>
<td><code>aro run</code>, CLI execution</td>
<td>Readable text</td>
</tr>
<tr>
<td><strong>Machine</strong></td>
<td>HTTP API, events</td>
<td>JSON/structured data</td>
</tr>
<tr>
<td><strong>Developer</strong></td>
<td><code>aro test</code>, debug mode</td>
<td>Detailed diagnostics</td>
</tr>
</tbody>
</table>
<h2 id="how-it-works-1">How It Works</h2>
<h3 id="human-context-default">Human Context (Default)</h3>
<p>When you run ARO from the command line, output is formatted for
readability:</p>
<pre class="aro"><code>(Application-Start: Example) {
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Hello, World!&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}</code></pre>
<p>Running with <code>aro run</code>:</p>
<pre><code>[Application-Start] Hello, World!</code></pre>
<h3 id="machine-context">Machine Context</h3>
<p>When code runs via HTTP request or event handler, output is
structured data:</p>
<div class="sourceCode" id="cb267"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;level&quot;</span><span class="fu">:</span><span class="st">&quot;info&quot;</span><span class="fu">,</span><span class="dt">&quot;source&quot;</span><span class="fu">:</span><span class="st">&quot;Application-Start&quot;</span><span class="fu">,</span><span class="dt">&quot;message&quot;</span><span class="fu">:</span><span class="st">&quot;Hello, World!&quot;</span><span class="fu">}</span></span></code></pre></div>
<h3 id="developer-context">Developer Context</h3>
<p>During test execution, output is displayed as a formatted table with
type annotations:</p>
<pre><code>+------------------------------------------+
| LOG [console] Application-Start          |
+------------------------------------------+
| message: String(&quot;Hello, World!&quot;)         |
+------------------------------------------+</code></pre>
<h2 id="automatic-detection">Automatic Detection</h2>
<p>The runtime automatically detects context:</p>
<table>
<thead>
<tr>
<th>Entry Point</th>
<th>Context</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>aro run</code> command</td>
<td>Human</td>
</tr>
<tr>
<td><code>aro test</code> command</td>
<td>Developer</td>
</tr>
<tr>
<td>HTTP route handler</td>
<td>Machine</td>
</tr>
<tr>
<td>Event dispatch</td>
<td>Machine</td>
</tr>
<tr>
<td><code>--debug</code> flag</td>
<td>Developer</td>
</tr>
</tbody>
</table>
<h2 id="example-same-code-different-contexts">Example: Same Code,
Different Contexts</h2>
<pre class="aro"><code>(getUser: User API) {
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;.
    &lt;Log&gt; the &lt;status&gt; for the &lt;console&gt; with &quot;User retrieved&quot;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}</code></pre>
<h3 id="cli-output-human">CLI Output (Human)</h3>
<pre><code>[getUser] User retrieved
[OK] success
  user.id: 123
  user.name: Alice</code></pre>
<h3 id="http-response-machine">HTTP Response (Machine)</h3>
<div class="sourceCode" id="cb271"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;status&quot;</span><span class="fu">:</span> <span class="st">&quot;OK&quot;</span><span class="fu">,</span></span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;reason&quot;</span><span class="fu">:</span> <span class="st">&quot;success&quot;</span><span class="fu">,</span></span>
<span id="cb271-4"><a href="#cb271-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;data&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb271-5"><a href="#cb271-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;user&quot;</span><span class="fu">:</span> <span class="fu">{</span><span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="dv">123</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;Alice&quot;</span><span class="fu">}</span></span>
<span id="cb271-6"><a href="#cb271-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb271-7"><a href="#cb271-7" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h3 id="test-output-developer">Test Output (Developer)</h3>
<pre><code>+------------------------------------------+
| LOG [console] getUser                    |
+------------------------------------------+
| message: String(&quot;User retrieved&quot;)        |
+------------------------------------------+

+------------------------------------------+
| Response&lt;OK&gt;                             |
+----------------+-------------------------+
| reason         | String(&quot;success&quot;)       |
| user.id        | Int(123)                |
| user.name      | String(&quot;Alice&quot;)         |
+----------------+-------------------------+</code></pre>
<h2 id="benefits">Benefits</h2>
<ol type="1">
<li><strong>Write Once</strong>: No need for separate formatting
code</li>
<li><strong>Automatic Adaptation</strong>: Output suits the consumer
automatically</li>
<li><strong>Consistent Behavior</strong>: Same logic, appropriate
presentation</li>
<li><strong>Debug Friendly</strong>: Rich diagnostics during
development</li>
</ol>
<h2 id="integration-with-actions">Integration with Actions</h2>
<h3 id="log-action">Log Action</h3>
<p>The <code>&lt;Log&gt;</code> action respects output context:</p>
<pre class="aro"><code>&lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &lt;value&gt;.</code></pre>
<ul>
<li><strong>Human</strong>: <code>[FeatureSetName] value</code></li>
<li><strong>Machine</strong>:
<code>{"level":"info","source":"FeatureSetName","message":"value"}</code></li>
<li><strong>Developer</strong>: Formatted table with type
annotations</li>
</ul>
<h3 id="return-action">Return Action</h3>
<p>The <code>&lt;Return&gt;</code> action sets the response, which is
formatted based on context:</p>
<pre class="aro"><code>&lt;Return&gt; an &lt;OK: status&gt; with &lt;result&gt;.</code></pre>
<hr />
<p><em>Next: Chapter 31 — Type System</em></p>
<h1 id="chapter-31-type-system">Chapter 31: Type System</h1>
<p>ARO has a simple type system: four built-in primitives, two
collection types, and complex types defined externally in OpenAPI. This
chapter explains how types work in ARO.</p>
<h2 id="primitive-types">Primitive Types</h2>
<p>ARO has four built-in primitive types:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Literal Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>String</code></td>
<td>Text</td>
<td><code>"hello"</code>, <code>'world'</code></td>
</tr>
<tr>
<td><code>Integer</code></td>
<td>Whole numbers</td>
<td><code>42</code>, <code>-17</code>, <code>0xFF</code></td>
</tr>
<tr>
<td><code>Float</code></td>
<td>Decimal numbers</td>
<td><code>3.14</code>, <code>2.5e10</code></td>
</tr>
<tr>
<td><code>Boolean</code></td>
<td>True/False</td>
<td><code>true</code>, <code>false</code></td>
</tr>
</tbody>
</table>
<h2 id="collection-types">Collection Types</h2>
<p>ARO has two built-in collection types:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Literal Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>List&lt;T&gt;</code></td>
<td>Ordered collection</td>
<td><code>[1, 2, 3]</code></td>
</tr>
<tr>
<td><code>Map&lt;K, V&gt;</code></td>
<td>Key-value pairs</td>
<td><code>{ name: "Alice", age: 30 }</code></td>
</tr>
</tbody>
</table>
<h3 id="list-examples">List Examples</h3>
<pre class="aro"><code>&lt;Create&gt; the &lt;numbers: List&lt;Integer&gt;&gt; with [1, 2, 3].
&lt;Create&gt; the &lt;names: List&lt;String&gt;&gt; with [&quot;Alice&quot;, &quot;Bob&quot;, &quot;Charlie&quot;].

for each &lt;number&gt; in &lt;numbers&gt; {
    &lt;Log&gt; the &lt;value&gt; for the &lt;console&gt; with &lt;number&gt;.
}</code></pre>
<h3 id="map-examples">Map Examples</h3>
<pre class="aro"><code>&lt;Create&gt; the &lt;config: Map&lt;String, Integer&gt;&gt; with {
    port: 8080,
    timeout: 30
}.

&lt;Extract&gt; the &lt;port&gt; from the &lt;config: port&gt;.</code></pre>
<h2 id="complex-types-from-openapi">Complex Types from OpenAPI</h2>
<p>All complex types (records, enums) are defined in
<code>openapi.yaml</code>. There are no <code>type</code> or
<code>enum</code> keywords in ARO.</p>
<h3 id="why-openapi">Why OpenAPI?</h3>
<ol type="1">
<li><strong>Single Source of Truth</strong>: Types are defined once,
used everywhere</li>
<li><strong>Contract-First</strong>: Design your data before
implementing</li>
<li><strong>Documentation</strong>: OpenAPI schemas are
self-documenting</li>
<li><strong>Validation</strong>: Runtime can validate against
schemas</li>
</ol>
<h3 id="defining-types-in-openapi">Defining Types in OpenAPI</h3>
<div class="sourceCode" id="cb277"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="co"># openapi.yaml</span></span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a><span class="fu">openapi</span><span class="kw">:</span><span class="at"> </span><span class="fl">3.0.3</span></span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a><span class="fu">info</span><span class="kw">:</span></span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> My Application</span></span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="fl">1.0.0</span></span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span><span class="kw">:</span></span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schemas</span><span class="kw">:</span></span>
<span id="cb277-9"><a href="#cb277-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">User</span><span class="kw">:</span></span>
<span id="cb277-10"><a href="#cb277-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb277-11"><a href="#cb277-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb277-12"><a href="#cb277-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">id</span><span class="kw">:</span></span>
<span id="cb277-13"><a href="#cb277-13" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb277-14"><a href="#cb277-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">name</span><span class="kw">:</span></span>
<span id="cb277-15"><a href="#cb277-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb277-16"><a href="#cb277-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">email</span><span class="kw">:</span></span>
<span id="cb277-17"><a href="#cb277-17" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb277-18"><a href="#cb277-18" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">status</span><span class="kw">:</span></span>
<span id="cb277-19"><a href="#cb277-19" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">$ref</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;#/components/schemas/UserStatus&#39;</span></span>
<span id="cb277-20"><a href="#cb277-20" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">required</span><span class="kw">:</span></span>
<span id="cb277-21"><a href="#cb277-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> id</span></span>
<span id="cb277-22"><a href="#cb277-22" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> name</span></span>
<span id="cb277-23"><a href="#cb277-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> email</span></span>
<span id="cb277-24"><a href="#cb277-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-25"><a href="#cb277-25" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">UserStatus</span><span class="kw">:</span></span>
<span id="cb277-26"><a href="#cb277-26" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span>
<span id="cb277-27"><a href="#cb277-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">enum</span><span class="kw">:</span></span>
<span id="cb277-28"><a href="#cb277-28" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> active</span></span>
<span id="cb277-29"><a href="#cb277-29" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> inactive</span></span>
<span id="cb277-30"><a href="#cb277-30" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> suspended</span></span></code></pre></div>
<h3 id="using-openapi-types-in-aro">Using OpenAPI Types in ARO</h3>
<pre class="aro"><code>(Create User: User Management) {
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.

    (* User type comes from openapi.yaml *)
    &lt;Create&gt; the &lt;user: User&gt; with &lt;data&gt;.

    (* Access fields defined in the schema *)
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &lt;user: name&gt;.

    &lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.
}</code></pre>
<h2 id="type-annotations">Type Annotations</h2>
<p>Type annotations specify the type of a variable.</p>
<h3 id="syntax-1">Syntax</h3>
<pre class="aro"><code>&lt;name: Type&gt;</code></pre>
<h3 id="examples-2">Examples</h3>
<pre class="aro"><code>&lt;name: String&gt;                    (* Primitive *)
&lt;count: Integer&gt;                  (* Primitive *)
&lt;items: List&lt;String&gt;&gt;             (* Collection of primitives *)
&lt;user: User&gt;                      (* OpenAPI schema reference *)
&lt;users: List&lt;User&gt;&gt;               (* Collection of OpenAPI types *)
&lt;config: Map&lt;String, Integer&gt;&gt;    (* Map with primitives *)</code></pre>
<h3 id="when-to-use-type-annotations">When to Use Type Annotations</h3>
<p>Type annotations are optional but recommended when:</p>
<ul>
<li>Extracting data from external sources</li>
<li>Working with OpenAPI schema types</li>
<li>Clarifying intent in complex operations</li>
</ul>
<pre class="aro"><code>(* Recommended: explicit types for external data *)
&lt;Extract&gt; the &lt;userId: String&gt; from the &lt;request: body&gt;.
&lt;Extract&gt; the &lt;items: List&lt;OrderItem&gt;&gt; from the &lt;request: body&gt;.
&lt;Retrieve&gt; the &lt;user: User&gt; from the &lt;user-repository&gt; where id = &lt;userId&gt;.</code></pre>
<h2 id="type-inference">Type Inference</h2>
<p>Types are inferred from literals and expressions:</p>
<pre class="aro"><code>&lt;Create&gt; the &lt;count&gt; with 42.              (* count: Integer *)
&lt;Create&gt; the &lt;name&gt; with &quot;John&quot;.           (* name: String *)
&lt;Create&gt; the &lt;active&gt; with true.           (* active: Boolean *)
&lt;Create&gt; the &lt;price&gt; with 19.99.           (* price: Float *)
&lt;Create&gt; the &lt;items&gt; with [1, 2, 3].       (* items: List&lt;Integer&gt; *)</code></pre>
<h2 id="no-optionals">No Optionals</h2>
<p>ARO has no optional types (<code>?</code>, <code>null</code>,
<code>undefined</code>, <code>Option&lt;T&gt;</code>). Every variable
has a value.</p>
<h3 id="what-happens-when-data-doesnt-exist">What Happens When Data
Doesn’t Exist?</h3>
<p>The runtime throws a descriptive error:</p>
<pre class="aro"><code>(Get User: API) {
    &lt;Extract&gt; the &lt;id&gt; from the &lt;pathParameters: id&gt;.
    &lt;Retrieve&gt; the &lt;user: User&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;.
    (* If user doesn&#39;t exist, runtime throws: *)
    (* &quot;Cannot retrieve the user from the user-repository where id = 123&quot; *)

    &lt;Return&gt; an &lt;OK: status&gt; with &lt;user&gt;.
}</code></pre>
<h3 id="no-null-checks-needed">No Null Checks Needed</h3>
<p>Traditional code:</p>
<div class="sourceCode" id="cb284"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> user <span class="op">=</span> <span class="cf">await</span> repository<span class="op">.</span><span class="fu">find</span>(id)<span class="op">;</span></span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (user <span class="op">===</span> <span class="kw">null</span>) {</span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&quot;User not found&quot;</span>)<span class="op">;</span></span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(user<span class="op">.</span><span class="at">name</span>)<span class="op">;</span></span></code></pre></div>
<p>ARO code:</p>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;.
&lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &lt;user: name&gt;.</code></pre>
<p>The runtime error message IS the error handling. See the Error
Handling chapter for more details.</p>
<h2 id="openapi-without-http">OpenAPI Without HTTP</h2>
<p>You can use OpenAPI just for type definitions, without any HTTP
routes:</p>
<div class="sourceCode" id="cb286"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="co"># openapi.yaml - No paths, just types</span></span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a><span class="fu">openapi</span><span class="kw">:</span><span class="at"> </span><span class="fl">3.0.3</span></span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a><span class="fu">info</span><span class="kw">:</span></span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> My Application Types</span></span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="fl">1.0.0</span></span>
<span id="cb286-6"><a href="#cb286-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-7"><a href="#cb286-7" aria-hidden="true" tabindex="-1"></a><span class="co"># No paths section = No HTTP server</span></span>
<span id="cb286-8"><a href="#cb286-8" aria-hidden="true" tabindex="-1"></a><span class="co"># But types are still available!</span></span>
<span id="cb286-9"><a href="#cb286-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-10"><a href="#cb286-10" aria-hidden="true" tabindex="-1"></a><span class="fu">components</span><span class="kw">:</span></span>
<span id="cb286-11"><a href="#cb286-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schemas</span><span class="kw">:</span></span>
<span id="cb286-12"><a href="#cb286-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">Config</span><span class="kw">:</span></span>
<span id="cb286-13"><a href="#cb286-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">type</span><span class="kw">:</span><span class="at"> object</span></span>
<span id="cb286-14"><a href="#cb286-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">properties</span><span class="kw">:</span></span>
<span id="cb286-15"><a href="#cb286-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">port</span><span class="kw">:</span></span>
<span id="cb286-16"><a href="#cb286-16" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> integer</span></span>
<span id="cb286-17"><a href="#cb286-17" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">host</span><span class="kw">:</span></span>
<span id="cb286-18"><a href="#cb286-18" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">type</span><span class="kw">:</span><span class="at"> string</span></span></code></pre></div>
<table>
<thead>
<tr>
<th>openapi.yaml</th>
<th>paths</th>
<th>components</th>
<th>HTTP Server</th>
<th>Types Available</th>
</tr>
</thead>
<tbody>
<tr>
<td>Missing</td>
<td>-</td>
<td>-</td>
<td>No</td>
<td>Primitives only</td>
</tr>
<tr>
<td>Present</td>
<td>Empty</td>
<td>Has schemas</td>
<td>No</td>
<td>Primitives + Schemas</td>
</tr>
<tr>
<td>Present</td>
<td>Has routes</td>
<td>Has schemas</td>
<td>Yes</td>
<td>Primitives + Schemas</td>
</tr>
</tbody>
</table>
<h2 id="type-checking">Type Checking</h2>
<h3 id="assignment-compatibility">Assignment Compatibility</h3>
<table>
<thead>
<tr>
<th>From</th>
<th>To</th>
<th>Allowed</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>T</code></td>
<td><code>T</code></td>
<td>Yes</td>
</tr>
<tr>
<td><code>Integer</code></td>
<td><code>Float</code></td>
<td>Yes (widening)</td>
</tr>
<tr>
<td><code>Float</code></td>
<td><code>Integer</code></td>
<td>Warning (narrowing)</td>
</tr>
<tr>
<td><code>List&lt;T&gt;</code></td>
<td><code>List&lt;T&gt;</code></td>
<td>Yes</td>
</tr>
<tr>
<td>Schema</td>
<td>Same Schema</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<h3 id="type-errors">Type Errors</h3>
<table>
<thead>
<tr>
<th>Error</th>
<th>Message</th>
</tr>
</thead>
<tbody>
<tr>
<td>Type mismatch</td>
<td><code>Expected 'String', got 'Integer'</code></td>
</tr>
<tr>
<td>Unknown schema</td>
<td><code>Schema 'Foo' not found in openapi.yaml</code></td>
</tr>
<tr>
<td>Missing field</td>
<td><code>Schema 'User' has no field 'age'</code></td>
</tr>
</tbody>
</table>
<h2 id="summary-2">Summary</h2>
<table>
<thead>
<tr>
<th>Concept</th>
<th>Details</th>
</tr>
</thead>
<tbody>
<tr>
<td>Primitives</td>
<td><code>String</code>, <code>Integer</code>, <code>Float</code>,
<code>Boolean</code></td>
</tr>
<tr>
<td>Collections</td>
<td><code>List&lt;T&gt;</code>, <code>Map&lt;K, V&gt;</code></td>
</tr>
<tr>
<td>Complex types</td>
<td>Defined in <code>openapi.yaml</code> components/schemas</td>
</tr>
<tr>
<td>Optionals</td>
<td>None - values exist or operations fail</td>
</tr>
<tr>
<td>Type annotations</td>
<td><code>&lt;name: Type&gt;</code></td>
</tr>
<tr>
<td>Type inference</td>
<td>From literals and expressions</td>
</tr>
</tbody>
</table>
<hr />
<p><em>Next: Appendix A — Action Reference</em></p>
<h1 id="appendix-a-action-reference">Appendix A: Action Reference</h1>
<p>Complete reference for all built-in actions in ARO.</p>
<h2 id="quick-reference-table">Quick Reference Table</h2>
<table>
<colgroup>
<col style="width: 22%" />
<col style="width: 16%" />
<col style="width: 36%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Action</th>
<th>Role</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Extract</strong></td>
<td>REQUEST</td>
<td>Pull data from structured source</td>
<td><code>&lt;Extract&gt; the &lt;id&gt; from the &lt;request: params&gt;.</code></td>
</tr>
<tr>
<td><strong>Retrieve</strong></td>
<td>REQUEST</td>
<td>Fetch from repository</td>
<td><code>&lt;Retrieve&gt; the &lt;user&gt; from the &lt;users&gt; where id = &lt;id&gt;.</code></td>
</tr>
<tr>
<td><strong>Request</strong></td>
<td>REQUEST</td>
<td>Make HTTP request</td>
<td><code>&lt;Request&gt; the &lt;data&gt; from the &lt;api-url&gt;.</code></td>
</tr>
<tr>
<td><strong>Fetch</strong></td>
<td>REQUEST</td>
<td>Fetch from external API</td>
<td><code>&lt;Fetch&gt; the &lt;weather&gt; from &lt;WeatherAPI: GET /forecast&gt;.</code></td>
</tr>
<tr>
<td><strong>Read</strong></td>
<td>REQUEST</td>
<td>Read from file</td>
<td><code>&lt;Read&gt; the &lt;config&gt; from the &lt;file: "./config.json"&gt;.</code></td>
</tr>
<tr>
<td><strong>List</strong></td>
<td>REQUEST</td>
<td>List directory contents</td>
<td><code>&lt;List&gt; the &lt;files&gt; from the &lt;directory: src-path&gt;.</code></td>
</tr>
<tr>
<td><strong>Stat</strong></td>
<td>REQUEST</td>
<td>Get file metadata</td>
<td><code>&lt;Stat&gt; the &lt;info&gt; for the &lt;file: "./doc.pdf"&gt;.</code></td>
</tr>
<tr>
<td><strong>Exists</strong></td>
<td>REQUEST</td>
<td>Check file existence</td>
<td><code>&lt;Exists&gt; the &lt;found&gt; for the &lt;file: "./config.json"&gt;.</code></td>
</tr>
<tr>
<td><strong>Receive</strong></td>
<td>REQUEST</td>
<td>Receive event data</td>
<td><code>&lt;Receive&gt; the &lt;message&gt; from the &lt;event&gt;.</code></td>
</tr>
<tr>
<td><strong>Exec</strong></td>
<td>REQUEST</td>
<td>Execute shell command</td>
<td><code>&lt;Exec&gt; the &lt;result&gt; for the &lt;command&gt; with "ls -la".</code></td>
</tr>
<tr>
<td><strong>Create</strong></td>
<td>OWN</td>
<td>Create new data</td>
<td><code>&lt;Create&gt; the &lt;user&gt; with { name: "Alice" }.</code></td>
</tr>
<tr>
<td><strong>Compute</strong></td>
<td>OWN</td>
<td>Perform calculations</td>
<td><code>&lt;Compute&gt; the &lt;total&gt; for the &lt;items&gt;.</code></td>
</tr>
<tr>
<td><strong>Transform</strong></td>
<td>OWN</td>
<td>Convert/map data</td>
<td><code>&lt;Transform&gt; the &lt;dto&gt; from the &lt;entity&gt;.</code></td>
</tr>
<tr>
<td><strong>Validate</strong></td>
<td>OWN</td>
<td>Check against rules</td>
<td><code>&lt;Validate&gt; the &lt;data&gt; for the &lt;schema&gt;.</code></td>
</tr>
<tr>
<td><strong>Compare</strong></td>
<td>OWN</td>
<td>Compare values</td>
<td><code>&lt;Compare&gt; the &lt;hash&gt; against the &lt;stored&gt;.</code></td>
</tr>
<tr>
<td><strong>Update</strong></td>
<td>OWN</td>
<td>Modify existing data</td>
<td><code>&lt;Update&gt; the &lt;user&gt; with &lt;changes&gt;.</code></td>
</tr>
<tr>
<td><strong>CreateDirectory</strong></td>
<td>OWN</td>
<td>Create directory</td>
<td><code>&lt;CreateDirectory&gt; the &lt;dir&gt; to the &lt;path: "./out"&gt;.</code></td>
</tr>
<tr>
<td><strong>Copy</strong></td>
<td>OWN</td>
<td>Copy file/directory</td>
<td><code>&lt;Copy&gt; the &lt;file: "./a.txt"&gt; to the &lt;destination: "./b.txt"&gt;.</code></td>
</tr>
<tr>
<td><strong>Move</strong></td>
<td>OWN</td>
<td>Move/rename file</td>
<td><code>&lt;Move&gt; the &lt;file: "./old.txt"&gt; to the &lt;destination: "./new.txt"&gt;.</code></td>
</tr>
<tr>
<td><strong>Map</strong></td>
<td>OWN</td>
<td>Transform collection elements</td>
<td><code>&lt;Map&gt; the &lt;names&gt; from the &lt;users: name&gt;.</code></td>
</tr>
<tr>
<td><strong>Filter</strong></td>
<td>OWN</td>
<td>Select matching elements</td>
<td><code>&lt;Filter&gt; the &lt;active&gt; from the &lt;users&gt; where status = "active".</code></td>
</tr>
<tr>
<td><strong>Reduce</strong></td>
<td>OWN</td>
<td>Aggregate collection</td>
<td><code>&lt;Reduce&gt; the &lt;total&gt; from the &lt;items&gt; with sum(&lt;amount&gt;).</code></td>
</tr>
<tr>
<td><strong>Sort</strong></td>
<td>OWN</td>
<td>Order collection</td>
<td><code>&lt;Sort&gt; the &lt;users&gt; by &lt;name&gt;.</code></td>
</tr>
<tr>
<td><strong>Split</strong></td>
<td>OWN</td>
<td>Split string by regex</td>
<td><code>&lt;Split&gt; the &lt;parts&gt; from the &lt;string&gt; by /,/.</code></td>
</tr>
<tr>
<td><strong>Merge</strong></td>
<td>OWN</td>
<td>Combine data</td>
<td><code>&lt;Merge&gt; the &lt;existing-user&gt; with &lt;update-data&gt;.</code></td>
</tr>
<tr>
<td><strong>Return</strong></td>
<td>RESPONSE</td>
<td>Return result</td>
<td><code>&lt;Return&gt; an &lt;OK: status&gt; with &lt;data&gt;.</code></td>
</tr>
<tr>
<td><strong>Throw</strong></td>
<td>RESPONSE</td>
<td>Throw error</td>
<td><code>&lt;Throw&gt; a &lt;NotFound: error&gt; for the &lt;user&gt;.</code></td>
</tr>
<tr>
<td><strong>Log</strong></td>
<td>EXPORT</td>
<td>Write to logs</td>
<td><code>&lt;Log&gt; the &lt;msg&gt; for the &lt;console&gt; with "Done".</code></td>
</tr>
<tr>
<td><strong>Store</strong></td>
<td>EXPORT</td>
<td>Save to repository</td>
<td><code>&lt;Store&gt; the &lt;user&gt; into the &lt;users&gt;.</code></td>
</tr>
<tr>
<td><strong>Write</strong></td>
<td>EXPORT</td>
<td>Write to file</td>
<td><code>&lt;Write&gt; the &lt;data&gt; to the &lt;file: "./out.txt"&gt;.</code></td>
</tr>
<tr>
<td><strong>Append</strong></td>
<td>EXPORT</td>
<td>Append to file</td>
<td><code>&lt;Append&gt; the &lt;line&gt; to the &lt;file: "./log.txt"&gt;.</code></td>
</tr>
<tr>
<td><strong>Send</strong></td>
<td>EXPORT</td>
<td>Send to destination</td>
<td><code>&lt;Send&gt; the &lt;email&gt; to the &lt;recipient&gt;.</code></td>
</tr>
<tr>
<td><strong>Emit</strong></td>
<td>EXPORT</td>
<td>Emit domain event</td>
<td><code>&lt;Emit&gt; a &lt;UserCreated: event&gt; with &lt;user&gt;.</code></td>
</tr>
<tr>
<td><strong>Publish</strong></td>
<td>EXPORT</td>
<td>Make globally available</td>
<td><code>&lt;Publish&gt; as &lt;config&gt; &lt;settings&gt;.</code></td>
</tr>
<tr>
<td><strong>Notify</strong></td>
<td>EXPORT</td>
<td>Send notification</td>
<td><code>&lt;Notify&gt; the &lt;alert&gt; to the &lt;admin&gt;.</code></td>
</tr>
<tr>
<td><strong>Delete</strong></td>
<td>EXPORT</td>
<td>Remove data</td>
<td><code>&lt;Delete&gt; the &lt;user&gt; from the &lt;users&gt; where id = &lt;id&gt;.</code></td>
</tr>
<tr>
<td><strong>Start</strong></td>
<td>SERVICE</td>
<td>Start a service</td>
<td><code>&lt;Start&gt; the &lt;http-server&gt; with &lt;contract&gt;.</code></td>
</tr>
<tr>
<td><strong>Stop</strong></td>
<td>SERVICE</td>
<td>Stop a service</td>
<td><code>&lt;Stop&gt; the &lt;http-server&gt; with &lt;application&gt;.</code></td>
</tr>
<tr>
<td><strong>Listen</strong></td>
<td>SERVICE</td>
<td>Listen for connections</td>
<td><code>&lt;Listen&gt; on port 9000 as &lt;socket-server&gt;.</code></td>
</tr>
<tr>
<td><strong>Connect</strong></td>
<td>SERVICE</td>
<td>Connect to service</td>
<td><code>&lt;Connect&gt; to &lt;host: "db"&gt; on port 5432.</code></td>
</tr>
<tr>
<td><strong>Close</strong></td>
<td>SERVICE</td>
<td>Close connection</td>
<td><code>&lt;Close&gt; the &lt;connection&gt;.</code></td>
</tr>
<tr>
<td><strong>Broadcast</strong></td>
<td>SERVICE</td>
<td>Send to all connections</td>
<td><code>&lt;Broadcast&gt; the &lt;msg&gt; to the &lt;server&gt;.</code></td>
</tr>
<tr>
<td><strong>Route</strong></td>
<td>SERVICE</td>
<td>Define HTTP route</td>
<td><code>&lt;Route&gt; the &lt;handler&gt; for "/api/users".</code></td>
</tr>
<tr>
<td><strong>Keepalive</strong></td>
<td>SERVICE</td>
<td>Keep app running</td>
<td><code>&lt;Keepalive&gt; the &lt;app&gt; for the &lt;events&gt;.</code></td>
</tr>
<tr>
<td><strong>Call</strong></td>
<td>SERVICE</td>
<td>Call external API</td>
<td><code>&lt;Call&gt; the &lt;result&gt; via &lt;API: POST /users&gt;.</code></td>
</tr>
<tr>
<td><strong>Accept</strong></td>
<td>STATE</td>
<td>Accept state transition</td>
<td><code>&lt;Accept&gt; the &lt;order: placed&gt;.</code></td>
</tr>
<tr>
<td><strong>Given</strong></td>
<td>TEST</td>
<td>Test precondition</td>
<td><code>&lt;Given&gt; the &lt;user&gt; with { name: "Test" }.</code></td>
</tr>
<tr>
<td><strong>When</strong></td>
<td>TEST</td>
<td>Test action</td>
<td><code>&lt;When&gt; the &lt;action&gt; is performed.</code></td>
</tr>
<tr>
<td><strong>Then</strong></td>
<td>TEST</td>
<td>Test expectation</td>
<td><code>&lt;Then&gt; the &lt;result&gt; should be &lt;expected&gt;.</code></td>
</tr>
<tr>
<td><strong>Assert</strong></td>
<td>TEST</td>
<td>Assert condition</td>
<td><code>&lt;Assert&gt; the &lt;value&gt; equals &lt;expected&gt;.</code></td>
</tr>
</tbody>
</table>
<h2 id="action-categories">Action Categories</h2>
<table>
<thead>
<tr>
<th>Category</th>
<th>Role</th>
<th>Data Flow</th>
</tr>
</thead>
<tbody>
<tr>
<td>REQUEST</td>
<td>Bring data in</td>
<td>External -&gt; Internal</td>
</tr>
<tr>
<td>OWN</td>
<td>Transform data</td>
<td>Internal -&gt; Internal</td>
</tr>
<tr>
<td>RESPONSE</td>
<td>Send results</td>
<td>Internal -&gt; External</td>
</tr>
<tr>
<td>EXPORT</td>
<td>Publish/persist</td>
<td>Internal -&gt; External</td>
</tr>
<tr>
<td>SERVICE</td>
<td>Control services</td>
<td>System operations</td>
</tr>
<tr>
<td>STATE</td>
<td>State transitions</td>
<td>Internal state changes</td>
</tr>
<tr>
<td>TEST</td>
<td>Testing</td>
<td>Verification actions</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="request-actions">REQUEST Actions</h2>
<h3 id="extract">Extract</h3>
<p>Pulls data from a structured source.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Extract&gt; the &lt;result&gt; from the &lt;source: property&gt;.
&lt;Extract&gt; the &lt;result: specifier&gt; from the &lt;list&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Extract&gt; the &lt;user-id&gt; from the &lt;request: parameters&gt;.
&lt;Extract&gt; the &lt;body&gt; from the &lt;request: body&gt;.
&lt;Extract&gt; the &lt;token&gt; from the &lt;request: headers.Authorization&gt;.
&lt;Extract&gt; the &lt;email&gt; from the &lt;user: email&gt;.
&lt;Extract&gt; the &lt;order&gt; from the &lt;event: order&gt;.</code></pre>
<p><strong>List Element Access (ARO-0038):</strong></p>
<p>Extract specific elements from arrays using result specifiers:</p>
<pre class="aro"><code>(* Keywords *)
&lt;Extract&gt; the &lt;item: first&gt; from the &lt;list&gt;.
&lt;Extract&gt; the &lt;item: last&gt; from the &lt;list&gt;.

(* Numeric index: 0 = last, 1 = second-to-last *)
&lt;Extract&gt; the &lt;item: 0&gt; from the &lt;list&gt;.
&lt;Extract&gt; the &lt;item: 1&gt; from the &lt;list&gt;.

(* Range: elements 2, 3, 4, 5 *)
&lt;Extract&gt; the &lt;subset: 2-5&gt; from the &lt;list&gt;.

(* Pick: elements at indices 0, 3, 7 *)
&lt;Extract&gt; the &lt;selection: 0,3,7&gt; from the &lt;list&gt;.</code></pre>
<table>
<thead>
<tr>
<th>Specifier</th>
<th>Returns</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>first</code></td>
<td>First element</td>
</tr>
<tr>
<td><code>last</code></td>
<td>Last element</td>
</tr>
<tr>
<td><code>0</code></td>
<td>Last element (reverse indexing)</td>
</tr>
<tr>
<td><code>n</code></td>
<td>Element at (count - 1 - n)</td>
</tr>
<tr>
<td><code>2-5</code></td>
<td>Array of elements</td>
</tr>
<tr>
<td><code>0,3,7</code></td>
<td>Array of elements</td>
</tr>
</tbody>
</table>
<p><strong>Valid Prepositions:</strong> <code>from</code></p>
<hr />
<h3 id="retrieve">Retrieve</h3>
<p>Fetches data from a repository.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;result&gt; from the &lt;repository&gt; [where &lt;condition&gt;].</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt;.
&lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;user-id&gt;.
&lt;Retrieve&gt; the &lt;orders&gt; from the &lt;order-repository&gt; where status = &quot;pending&quot;.
&lt;Retrieve&gt; the &lt;products&gt; from the &lt;repository&gt; where category = &lt;cat&gt; and active = true.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>from</code></p>
<hr />
<h3 id="fetch-1">Fetch</h3>
<p>Makes HTTP requests to external APIs.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Fetch&gt; the &lt;result&gt; from &lt;url-or-api-reference&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Fetch&gt; the &lt;data&gt; from &quot;https://api.example.com/resource&quot;.
&lt;Fetch&gt; the &lt;users&gt; from &lt;UserAPI: GET /users&gt;.
&lt;Fetch&gt; the &lt;weather&gt; from &lt;WeatherAPI: GET /forecast?city=${city}&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>from</code></p>
<hr />
<h3 id="request">Request</h3>
<p>Makes HTTP requests to external URLs or APIs.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Request&gt; the &lt;result&gt; from &lt;url&gt;.              (* GET request *)
&lt;Request&gt; the &lt;result&gt; to &lt;url&gt; with &lt;data&gt;.    (* POST request *)
&lt;Request&gt; the &lt;result&gt; via METHOD &lt;url&gt;.        (* Explicit method *)</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>(* GET request *)
&lt;Create&gt; the &lt;api-url&gt; with &quot;https://api.open-meteo.com/v1/forecast&quot;.
&lt;Request&gt; the &lt;weather&gt; from the &lt;api-url&gt;.

(* POST request *)
&lt;Create&gt; the &lt;user-data&gt; with { name: &quot;Alice&quot;, email: &quot;alice@example.com&quot; }.
&lt;Request&gt; the &lt;result&gt; to the &lt;api-url&gt; with &lt;user-data&gt;.

(* PUT/DELETE/PATCH via explicit method *)
&lt;Request&gt; the &lt;result&gt; via PUT the &lt;url&gt; with &lt;update-data&gt;.
&lt;Request&gt; the &lt;result&gt; via DELETE the &lt;url&gt;.</code></pre>
<p><strong>Response Metadata:</strong> After a request, these variables
are available: - <code>result</code> - Parsed response body (JSON as
map/list, or string) - <code>result.statusCode</code> - HTTP status code
(e.g., 200, 404) - <code>result.headers</code> - Response headers as map
- <code>result.isSuccess</code> - Boolean: true if status 200-299</p>
<p><strong>Valid Prepositions:</strong> <code>from</code>,
<code>to</code>, <code>via</code></p>
<hr />
<h3 id="read">Read</h3>
<p>Reads from files.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Read&gt; the &lt;result&gt; from the &lt;file: path&gt;.
&lt;Read&gt; the &lt;result: type&gt; from the &lt;file: path&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Read&gt; the &lt;content&gt; from the &lt;file: &quot;./data.txt&quot;&gt;.
&lt;Read&gt; the &lt;config: JSON&gt; from the &lt;file: &quot;./config.json&quot;&gt;.
&lt;Read&gt; the &lt;image: bytes&gt; from the &lt;file: &quot;./logo.png&quot;&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>from</code></p>
<hr />
<h3 id="exec">Exec</h3>
<p>Executes shell commands on the host system and returns structured
results.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Exec&gt; the &lt;result&gt; for the &lt;command&gt; with &quot;command-string&quot;.
&lt;Exec&gt; the &lt;result&gt; for the &lt;command&gt; with &lt;variable&gt;.
&lt;Exec&gt; the &lt;result&gt; on the &lt;system&gt; with {
    command: &quot;command-string&quot;,
    workingDirectory: &quot;/path&quot;,
    timeout: 30000
}.</code></pre>
<p><strong>Result Object:</strong> The Exec action returns a structured
result with the following fields: - <code>result.error</code> - Boolean:
true if command failed (non-zero exit code) -
<code>result.message</code> - Human-readable status message -
<code>result.output</code> - Command stdout (or stderr if error) -
<code>result.exitCode</code> - Process exit code (0 = success, -1 =
timeout) - <code>result.command</code> - The executed command string</p>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>(* Basic command execution *)
&lt;Exec&gt; the &lt;listing&gt; for the &lt;command&gt; with &quot;ls -la&quot;.
&lt;Return&gt; an &lt;OK: status&gt; for the &lt;listing&gt;.

(* With error handling *)
&lt;Exec&gt; the &lt;result&gt; for the &lt;disk-check&gt; with &quot;df -h&quot;.
&lt;Log&gt; the &lt;error&gt; for the &lt;console&gt; with &lt;result.message&gt; when &lt;result.error&gt; = true.
&lt;Return&gt; an &lt;Error: status&gt; for the &lt;result&gt; when &lt;result.error&gt; = true.
&lt;Return&gt; an &lt;OK: status&gt; for the &lt;result&gt;.

(* Using a variable for the command *)
&lt;Create&gt; the &lt;cmd&gt; with &quot;ps aux | head -20&quot;.
&lt;Exec&gt; the &lt;processes&gt; for the &lt;listing&gt; with &lt;cmd&gt;.

(* With configuration options *)
&lt;Exec&gt; the &lt;result&gt; on the &lt;system&gt; with {
    command: &quot;npm install&quot;,
    workingDirectory: &quot;/app&quot;,
    timeout: 60000
}.</code></pre>
<p><strong>Configuration Options:</strong> When using object syntax,
these options are available: - <code>command</code> (required) - The
shell command to execute - <code>workingDirectory</code> - Working
directory (default: current) - <code>timeout</code> - Timeout in
milliseconds (default: 30000) - <code>shell</code> - Shell to use
(default: /bin/sh) - <code>environment</code> - Additional environment
variables as object</p>
<p><strong>Security Note:</strong> Be cautious when constructing
commands from user input. Always validate and sanitize input to prevent
command injection.</p>
<p><strong>Valid Prepositions:</strong> <code>for</code>,
<code>on</code>, <code>with</code></p>
<hr />
<h2 id="own-actions">OWN Actions</h2>
<h3 id="create">Create</h3>
<p>Creates new data structures.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Create&gt; the &lt;result&gt; with &lt;data&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Create&gt; the &lt;user&gt; with &lt;user-data&gt;.
&lt;Create&gt; the &lt;response&gt; with { message: &quot;Success&quot; }.
&lt;Create&gt; the &lt;order&gt; with {
    items: &lt;items&gt;,
    total: &lt;total&gt;,
    customer: &lt;customer-id&gt;
}.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>with</code></p>
<hr />
<h3 id="compute">Compute</h3>
<p>Performs calculations.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;result&gt; for the &lt;input&gt;.
&lt;Compute&gt; the &lt;result&gt; from &lt;expression&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Compute&gt; the &lt;total&gt; for the &lt;items&gt;.
&lt;Compute&gt; the &lt;hash&gt; for the &lt;password&gt;.
&lt;Compute&gt; the &lt;tax&gt; for the &lt;subtotal&gt;.
&lt;Compute&gt; the &lt;sum&gt; from &lt;a&gt; + &lt;b&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>for</code>,
<code>from</code></p>
<hr />
<h3 id="transform">Transform</h3>
<p>Converts or maps data.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Transform&gt; the &lt;result&gt; from the &lt;source&gt;.
&lt;Transform&gt; the &lt;result&gt; from the &lt;source&gt; with &lt;modifications&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Transform&gt; the &lt;dto&gt; from the &lt;entity&gt;.
&lt;Transform&gt; the &lt;updated-user&gt; from the &lt;user&gt; with &lt;updates&gt;.
&lt;Transform&gt; the &lt;response&gt; from the &lt;data&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>from</code></p>
<hr />
<h3 id="validate">Validate</h3>
<p>Checks data against rules.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Validate&gt; the &lt;data&gt; for the &lt;schema&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Validate&gt; the &lt;user-data&gt; for the &lt;user-schema&gt;.
&lt;Validate&gt; the &lt;email&gt; for the &lt;email-pattern&gt;.
&lt;Validate&gt; the &lt;order&gt; for the &lt;order-rules&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>for</code></p>
<hr />
<h3 id="compare">Compare</h3>
<p>Compares two values.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Compare&gt; the &lt;value1&gt; against the &lt;value2&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Compare&gt; the &lt;password-hash&gt; against the &lt;stored-hash&gt;.
&lt;Compare&gt; the &lt;signature&gt; against the &lt;expected&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>against</code></p>
<hr />
<h3 id="split">Split</h3>
<p>Splits a string into an array of parts using a regex delimiter.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Split&gt; the &lt;parts&gt; from the &lt;string&gt; by /delimiter/.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>(* Split CSV line by comma *)
&lt;Create&gt; the &lt;csv-line&gt; with &quot;apple,banana,cherry&quot;.
&lt;Split&gt; the &lt;fruits&gt; from the &lt;csv-line&gt; by /,/.
(* fruits = [&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;] *)

(* Split by whitespace *)
&lt;Split&gt; the &lt;words&gt; from the &lt;sentence&gt; by /\s+/.

(* Split by multiple delimiters *)
&lt;Split&gt; the &lt;tokens&gt; from the &lt;code&gt; by /[;,\s]+/.

(* Case-insensitive split *)
&lt;Split&gt; the &lt;sections&gt; from the &lt;text&gt; by /SECTION/i.</code></pre>
<p><strong>Behavior:</strong> - Returns an array of strings between
delimiter matches - If no match is found, returns original string as
single-element array - Empty strings included when delimiters are
adjacent - Supports regex flags: <code>i</code> (case-insensitive),
<code>s</code> (dotall), <code>m</code> (multiline)</p>
<p><strong>Valid Prepositions:</strong> <code>from</code> (with
<code>by</code> clause)</p>
<hr />
<h3 id="merge">Merge</h3>
<p>Combines two data structures together. The source values are merged
into the target, with source values overwriting target values for
matching keys.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Merge&gt; the &lt;target&gt; with &lt;source&gt;.
&lt;Merge&gt; the &lt;target&gt; from &lt;source&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>(* Merge update data into existing entity *)
&lt;Retrieve&gt; the &lt;existing-user&gt; from the &lt;user-repository&gt; where id = &lt;id&gt;.
&lt;Extract&gt; the &lt;update-data&gt; from the &lt;request: body&gt;.
&lt;Merge&gt; the &lt;existing-user&gt; with &lt;update-data&gt;.
&lt;Store&gt; the &lt;existing-user&gt; into the &lt;user-repository&gt;.

(* Combine configuration objects *)
&lt;Merge&gt; the &lt;defaults&gt; with &lt;overrides&gt;.

(* Concatenate arrays *)
&lt;Merge&gt; the &lt;all-items&gt; with &lt;new-items&gt;.

(* Concatenate strings *)
&lt;Merge&gt; the &lt;greeting&gt; with &lt;name&gt;.</code></pre>
<p><strong>Supported Types:</strong> - <strong>Dictionaries</strong>:
Source keys overwrite target keys; other target keys preserved -
<strong>Arrays</strong>: Source elements appended to target array -
<strong>Strings</strong>: Source string concatenated to target
string</p>
<p><strong>Valid Prepositions:</strong> <code>with</code>,
<code>into</code>, <code>from</code></p>
<hr />
<h2 id="response-actions">RESPONSE Actions</h2>
<h3 id="return">Return</h3>
<p>Returns a result with status.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Return&gt; [article] &lt;status&gt; [with &lt;data&gt;] [for &lt;context&gt;].</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Return&gt; an &lt;OK: status&gt; with &lt;data&gt;.
&lt;Return&gt; a &lt;Created: status&gt; with &lt;resource&gt;.
&lt;Return&gt; a &lt;NoContent: status&gt; for the &lt;deletion&gt;.
&lt;Return&gt; a &lt;BadRequest: status&gt; with &lt;errors&gt;.
&lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;missing: user&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>with</code>,
<code>for</code></p>
<hr />
<h3 id="throw">Throw</h3>
<p>Throws an error.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Throw&gt; [article] &lt;error-type&gt; for the &lt;context&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Throw&gt; a &lt;ValidationError&gt; for the &lt;invalid: input&gt;.
&lt;Throw&gt; a &lt;NotFoundError&gt; for the &lt;missing: user&gt;.
&lt;Throw&gt; an &lt;AuthenticationError&gt; for the &lt;invalid: token&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>for</code></p>
<hr />
<h2 id="export-actions">EXPORT Actions</h2>
<h3 id="store">Store</h3>
<p>Saves to a repository.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Store&gt; the &lt;data&gt; into the &lt;repository&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.
&lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
&lt;Store&gt; the &lt;log-entry&gt; into the &lt;file: &quot;./app.log&quot;&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>into</code></p>
<hr />
<h3 id="publish">Publish</h3>
<p>Makes variables globally available.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Publish&gt; as &lt;alias&gt; &lt;variable&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Publish&gt; as &lt;app-config&gt; &lt;config&gt;.
&lt;Publish&gt; as &lt;current-user&gt; &lt;user&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>as</code></p>
<hr />
<h3 id="log-1">Log</h3>
<p>Writes to logs.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Log&gt; the &lt;message-type&gt; for the &lt;destination&gt; with &lt;content&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;User logged in&quot;.
&lt;Log&gt; the &lt;error: message&gt; for the &lt;console&gt; with &lt;error&gt;.
&lt;Log&gt; the &lt;audit: entry&gt; for the &lt;audit-log&gt; with &lt;details&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>for</code>,
<code>with</code></p>
<hr />
<h3 id="send">Send</h3>
<p>Sends data to external destinations.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Send&gt; the &lt;data&gt; to the &lt;destination&gt;.
&lt;Send&gt; the &lt;data&gt; to the &lt;destination&gt; with &lt;content&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Send&gt; the &lt;email&gt; to the &lt;user: email&gt;.
&lt;Send&gt; the &lt;notification&gt; to the &lt;push-service&gt;.
&lt;Send&gt; the &lt;data&gt; to the &lt;connection&gt;.
&lt;Send&gt; the &lt;message&gt; to the &lt;connection&gt; with &quot;Hello&quot;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>to</code>,
<code>with</code></p>
<hr />
<h3 id="emit">Emit</h3>
<p>Emits domain events.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Emit&gt; [article] &lt;event-type: event&gt; with &lt;data&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Emit&gt; a &lt;UserCreated: event&gt; with &lt;user&gt;.
&lt;Emit&gt; an &lt;OrderPlaced: event&gt; with &lt;order&gt;.
&lt;Emit&gt; a &lt;PaymentProcessed: event&gt; with &lt;payment&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>with</code></p>
<hr />
<h3 id="write">Write</h3>
<p>Writes to files.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Write&gt; the &lt;data&gt; to the &lt;file: path&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Write&gt; the &lt;content&gt; to the &lt;file: &quot;./output.txt&quot;&gt;.
&lt;Write&gt; the &lt;data: JSON&gt; to the &lt;file: &quot;./data.json&quot;&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>to</code></p>
<hr />
<h3 id="append">Append</h3>
<p>Appends content to a file.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Append&gt; the &lt;data&gt; to the &lt;file: path&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Append&gt; the &lt;log-line&gt; to the &lt;file: &quot;./logs/app.log&quot;&gt;.
&lt;Append&gt; the &lt;entry&gt; to the &lt;file: &quot;./data.txt&quot;&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>to</code>,
<code>into</code></p>
<hr />
<h3 id="list">List</h3>
<p>Lists directory contents.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Create&gt; the &lt;dir-path&gt; with &quot;./path&quot;.
&lt;List&gt; the &lt;result&gt; from the &lt;directory: dir-path&gt;.
&lt;List&gt; the &lt;result&gt; from the &lt;directory: dir-path&gt; matching &quot;pattern&quot;.
&lt;List&gt; the &lt;result&gt; from the &lt;directory: dir-path&gt; recursively.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Create&gt; the &lt;uploads-path&gt; with &quot;./uploads&quot;.
&lt;List&gt; the &lt;entries&gt; from the &lt;directory: uploads-path&gt;.
&lt;List&gt; the &lt;aro-files&gt; from the &lt;directory: src-path&gt; matching &quot;*.aro&quot;.
&lt;List&gt; the &lt;all-files&gt; from the &lt;directory: project-path&gt; recursively.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>from</code></p>
<hr />
<h3 id="stat">Stat</h3>
<p>Gets file or directory metadata.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Stat&gt; the &lt;result&gt; for the &lt;file: path&gt;.
&lt;Stat&gt; the &lt;result&gt; for the &lt;directory: path&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Stat&gt; the &lt;info&gt; for the &lt;file: &quot;./document.pdf&quot;&gt;.
&lt;Stat&gt; the &lt;dir-info&gt; for the &lt;directory: &quot;./src&quot;&gt;.</code></pre>
<p><strong>Result Properties:</strong> - <code>name</code> - file or
directory name - <code>path</code> - full path - <code>size</code> -
size in bytes - <code>isFile</code> - true if file -
<code>isDirectory</code> - true if directory - <code>created</code> -
creation date (ISO 8601) - <code>modified</code> - modification date
(ISO 8601) - <code>permissions</code> - Unix-style permissions</p>
<p><strong>Valid Prepositions:</strong> <code>for</code></p>
<hr />
<h3 id="exists">Exists</h3>
<p>Checks if a file or directory exists.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Exists&gt; the &lt;result&gt; for the &lt;file: path&gt;.
&lt;Exists&gt; the &lt;result&gt; for the &lt;directory: path&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Exists&gt; the &lt;found&gt; for the &lt;file: &quot;./config.json&quot;&gt;.
&lt;Exists&gt; the &lt;dir-exists&gt; for the &lt;directory: &quot;./output&quot;&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>for</code></p>
<hr />
<h3 id="createdirectory">CreateDirectory</h3>
<p>Creates a directory with all intermediate directories.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;CreateDirectory&gt; the &lt;result&gt; to the &lt;path: path&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;CreateDirectory&gt; the &lt;output-dir&gt; to the &lt;path: &quot;./output/reports/2024&quot;&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>to</code>,
<code>for</code></p>
<hr />
<h3 id="copy">Copy</h3>
<p>Copies files or directories.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Copy&gt; the &lt;file: source&gt; to the &lt;destination: dest&gt;.
&lt;Copy&gt; the &lt;directory: source&gt; to the &lt;destination: dest&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Copy&gt; the &lt;file: &quot;./template.txt&quot;&gt; to the &lt;destination: &quot;./copy.txt&quot;&gt;.
&lt;Copy&gt; the &lt;directory: &quot;./src&quot;&gt; to the &lt;destination: &quot;./backup/src&quot;&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>to</code></p>
<hr />
<h3 id="move">Move</h3>
<p>Moves or renames files and directories.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Move&gt; the &lt;file: source&gt; to the &lt;destination: dest&gt;.
&lt;Move&gt; the &lt;directory: source&gt; to the &lt;destination: dest&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Move&gt; the &lt;file: &quot;./draft.txt&quot;&gt; to the &lt;destination: &quot;./final.txt&quot;&gt;.
&lt;Move&gt; the &lt;directory: &quot;./temp&quot;&gt; to the &lt;destination: &quot;./processed&quot;&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>to</code></p>
<hr />
<h3 id="delete">Delete</h3>
<p>Removes data.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Delete&gt; the &lt;target&gt; from the &lt;source&gt; [where &lt;condition&gt;].
&lt;Delete&gt; the &lt;file: path&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Delete&gt; the &lt;user&gt; from the &lt;user-repository&gt; where id = &lt;user-id&gt;.
&lt;Delete&gt; the &lt;file: &quot;./temp.txt&quot;&gt;.
&lt;Delete&gt; the &lt;sessions&gt; from the &lt;repository&gt; where expired = true.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>from</code></p>
<hr />
<h2 id="service-actions">SERVICE Actions</h2>
<h3 id="start">Start</h3>
<p>Starts a service. All services use the standardized <code>with</code>
preposition.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>(* HTTP server from OpenAPI contract *)
&lt;Start&gt; the &lt;http-server&gt; with &lt;contract&gt;.

(* Socket server with port configuration *)
&lt;Start&gt; the &lt;socket-server&gt; with { port: 9000 }.

(* File monitor with directory path *)
&lt;Start&gt; the &lt;file-monitor&gt; with &quot;.&quot;.
&lt;Start&gt; the &lt;file-monitor&gt; with { directory: &quot;./data&quot; }.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Start&gt; the &lt;http-server&gt; with &lt;contract&gt;.
&lt;Start&gt; the &lt;socket-server&gt; with { port: 9000 }.
&lt;Start&gt; the &lt;file-monitor&gt; with &quot;./uploads&quot;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>with</code></p>
<hr />
<h3 id="stop">Stop</h3>
<p>Stops a service gracefully.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Stop&gt; the &lt;service&gt; with &lt;application&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Stop&gt; the &lt;http-server&gt; with &lt;application&gt;.
&lt;Stop&gt; the &lt;socket-server&gt; with &lt;application&gt;.
&lt;Stop&gt; the &lt;file-monitor&gt; with &lt;application&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>with</code></p>
<hr />
<h3 id="listen">Listen</h3>
<p>Listens for connections.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Listen&gt; on port &lt;number&gt; as &lt;name&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Listen&gt; on port 9000 as &lt;socket-server&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>on</code>,
<code>as</code></p>
<hr />
<h3 id="connect">Connect</h3>
<p>Connects to a service.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Connect&gt; to &lt;host: address&gt; on port &lt;number&gt; as &lt;name&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Connect&gt; to &lt;host: &quot;localhost&quot;&gt; on port 5432 as &lt;database&gt;.
&lt;Connect&gt; to &lt;host: &quot;redis.local&quot;&gt; on port 6379 as &lt;cache&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>to</code>,
<code>on</code>, <code>as</code></p>
<hr />
<h3 id="close">Close</h3>
<p>Closes connections.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Close&gt; the &lt;connection&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Close&gt; the &lt;database-connections&gt;.
&lt;Close&gt; the &lt;socket-server&gt;.
&lt;Close&gt; the &lt;connection&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> None</p>
<hr />
<h3 id="call">Call</h3>
<p>Makes API calls.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Call&gt; the &lt;result&gt; via &lt;api-reference&gt; [with &lt;data&gt;].</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Call&gt; the &lt;result&gt; via &lt;UserAPI: POST /users&gt; with &lt;user-data&gt;.
&lt;Call&gt; the &lt;response&gt; via &lt;PaymentAPI: POST /charge&gt; with &lt;payment&gt;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>via</code>,
<code>with</code></p>
<hr />
<h3 id="broadcast">Broadcast</h3>
<p>Sends to all connections.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Broadcast&gt; the &lt;message&gt; to the &lt;server&gt;.</code></pre>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>&lt;Broadcast&gt; the &lt;message&gt; to the &lt;socket-server&gt;.
&lt;Broadcast&gt; the &lt;notification&gt; to the &lt;chat-server&gt; with &quot;User joined&quot;.</code></pre>
<p><strong>Valid Prepositions:</strong> <code>to</code>,
<code>with</code></p>
<hr />
<h3 id="keepalive">Keepalive</h3>
<p>Keeps a long-running application alive to process events.</p>
<p><strong>Syntax:</strong></p>
<pre class="aro"><code>&lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.</code></pre>
<p><strong>Description:</strong> The <code>Keepalive</code> action
blocks execution until a shutdown signal is received (SIGINT/SIGTERM).
This is essential for applications that need to stay alive and process
events, such as HTTP servers, file watchers, and socket servers.</p>
<p><strong>Examples:</strong></p>
<pre class="aro"><code>(* HTTP server auto-starts when openapi.yaml is present *)
(Application-Start: My API) {
    &lt;Log&gt; the &lt;startup: message&gt; for the &lt;console&gt; with &quot;API starting...&quot;.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}

(Application-Start: File Watcher) {
    &lt;Watch&gt; the &lt;directory&gt; for the &lt;changes&gt; with &quot;./watched&quot;.
    &lt;Keepalive&gt; the &lt;application&gt; for the &lt;events&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; for the &lt;startup&gt;.
}</code></pre>
<p><strong>Valid Prepositions:</strong> <code>for</code></p>
<hr />
<h2 id="action-summary-table">Action Summary Table</h2>
<table>
<thead>
<tr>
<th>Action</th>
<th>Role</th>
<th>Prepositions</th>
</tr>
</thead>
<tbody>
<tr>
<td>Extract</td>
<td>REQUEST</td>
<td>from</td>
</tr>
<tr>
<td>Retrieve</td>
<td>REQUEST</td>
<td>from</td>
</tr>
<tr>
<td>Request</td>
<td>REQUEST</td>
<td>from, to, via</td>
</tr>
<tr>
<td>Fetch</td>
<td>REQUEST</td>
<td>from</td>
</tr>
<tr>
<td>Read</td>
<td>REQUEST</td>
<td>from</td>
</tr>
<tr>
<td>Receive</td>
<td>REQUEST</td>
<td>from</td>
</tr>
<tr>
<td>Exec</td>
<td>REQUEST</td>
<td>for, on, with</td>
</tr>
<tr>
<td>Create</td>
<td>OWN</td>
<td>with</td>
</tr>
<tr>
<td>Compute</td>
<td>OWN</td>
<td>for, from</td>
</tr>
<tr>
<td>Transform</td>
<td>OWN</td>
<td>from</td>
</tr>
<tr>
<td>Validate</td>
<td>OWN</td>
<td>for</td>
</tr>
<tr>
<td>Compare</td>
<td>OWN</td>
<td>against</td>
</tr>
<tr>
<td>Update</td>
<td>OWN</td>
<td>with</td>
</tr>
<tr>
<td>Map</td>
<td>OWN</td>
<td>from</td>
</tr>
<tr>
<td>Filter</td>
<td>OWN</td>
<td>from, where</td>
</tr>
<tr>
<td>Reduce</td>
<td>OWN</td>
<td>from, with</td>
</tr>
<tr>
<td>Sort</td>
<td>OWN</td>
<td>by</td>
</tr>
<tr>
<td>Split</td>
<td>OWN</td>
<td>from (by clause)</td>
</tr>
<tr>
<td>Merge</td>
<td>OWN</td>
<td>with, into, from</td>
</tr>
<tr>
<td>Return</td>
<td>RESPONSE</td>
<td>with, for</td>
</tr>
<tr>
<td>Throw</td>
<td>RESPONSE</td>
<td>for</td>
</tr>
<tr>
<td>Store</td>
<td>EXPORT</td>
<td>into</td>
</tr>
<tr>
<td>Publish</td>
<td>EXPORT</td>
<td>as</td>
</tr>
<tr>
<td>Log</td>
<td>EXPORT</td>
<td>for, with</td>
</tr>
<tr>
<td>Send</td>
<td>EXPORT</td>
<td>to, with</td>
</tr>
<tr>
<td>Emit</td>
<td>EXPORT</td>
<td>with</td>
</tr>
<tr>
<td>Write</td>
<td>EXPORT</td>
<td>to</td>
</tr>
<tr>
<td>Delete</td>
<td>EXPORT</td>
<td>from</td>
</tr>
<tr>
<td>Notify</td>
<td>EXPORT</td>
<td>to</td>
</tr>
<tr>
<td>List</td>
<td>FILE</td>
<td>from</td>
</tr>
<tr>
<td>Stat</td>
<td>FILE</td>
<td>for</td>
</tr>
<tr>
<td>Exists</td>
<td>FILE</td>
<td>for</td>
</tr>
<tr>
<td>CreateDirectory</td>
<td>FILE</td>
<td>to</td>
</tr>
<tr>
<td>Copy</td>
<td>FILE</td>
<td>to</td>
</tr>
<tr>
<td>Move</td>
<td>FILE</td>
<td>to</td>
</tr>
<tr>
<td>Append</td>
<td>FILE</td>
<td>to</td>
</tr>
<tr>
<td>Start</td>
<td>SERVICE</td>
<td>with</td>
</tr>
<tr>
<td>Stop</td>
<td>SERVICE</td>
<td>with</td>
</tr>
<tr>
<td>Listen</td>
<td>SERVICE</td>
<td>on, as</td>
</tr>
<tr>
<td>Connect</td>
<td>SERVICE</td>
<td>to, on, as</td>
</tr>
<tr>
<td>Close</td>
<td>SERVICE</td>
<td>-</td>
</tr>
<tr>
<td>Route</td>
<td>SERVICE</td>
<td>for</td>
</tr>
<tr>
<td>Call</td>
<td>SERVICE</td>
<td>via, with</td>
</tr>
<tr>
<td>Broadcast</td>
<td>SERVICE</td>
<td>to, with</td>
</tr>
<tr>
<td>Keepalive</td>
<td>SERVICE</td>
<td>for</td>
</tr>
<tr>
<td>Accept</td>
<td>STATE</td>
<td>-</td>
</tr>
<tr>
<td>Given</td>
<td>TEST</td>
<td>with</td>
</tr>
<tr>
<td>When</td>
<td>TEST</td>
<td>-</td>
</tr>
<tr>
<td>Then</td>
<td>TEST</td>
<td>-</td>
</tr>
<tr>
<td>Assert</td>
<td>TEST</td>
<td>equals, contains</td>
</tr>
</tbody>
</table>
<h1 id="appendix-b-preposition-semantics">Appendix B: Preposition
Semantics</h1>
<p><em>How prepositions shape meaning in ARO.</em></p>
<hr />
<h2 id="overview-1">Overview</h2>
<div style="text-align: center; margin: 2em 0;">
<svg width="480" height="100" viewBox="0 0 480 100" xmlns="http://www.w3.org/2000/svg">
<!-- from -->
<g transform="translate(20, 10)">
<rect x="0" y="20" width="40" height="25" rx="3" fill="#e0e7ff" stroke="#6366f1" stroke-width="1"/>
<text x="20" y="36" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#4338ca">source</text>
<line x1="40" y1="32" x2="55" y2="32" stroke="#22c55e" stroke-width="2"/>
<polygon points="55,32 50,28 50,36" fill="#22c55e"/>
<rect x="55" y="20" width="40" height="25" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="75" y="36" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#166534">result</text>
<text x="47" y="60" text-anchor="middle" font-family="monospace" font-size="9" font-weight="bold" fill="#374151">from</text>
<text x="47" y="72" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">pull
in</text> </g> <!-- to --> <g transform="translate(130, 10)">
<rect x="0" y="20" width="40" height="25" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="20" y="36" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#166534">data</text>
<line x1="40" y1="32" x2="55" y2="32" stroke="#ef4444" stroke-width="2"/>
<polygon points="55,32 50,28 50,36" fill="#ef4444"/>
<rect x="55" y="20" width="40" height="25" rx="3" fill="#fee2e2" stroke="#ef4444" stroke-width="1"/>
<text x="75" y="36" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#991b1b">dest</text>
<text x="47" y="60" text-anchor="middle" font-family="monospace" font-size="9" font-weight="bold" fill="#374151">to</text>
<text x="47" y="72" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">push
out</text> </g> <!-- into --> <g transform="translate(240, 10)">
<rect x="20" y="5" width="30" height="18" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="35" y="17" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#166534">data</text>
<line x1="35" y1="23" x2="35" y2="35" stroke="#f59e0b" stroke-width="2"/>
<polygon points="35,35 31,30 39,30" fill="#f59e0b"/>
<rect x="10" y="35" width="50" height="25" rx="3" fill="#fef3c7" stroke="#f59e0b" stroke-width="1.5"/>
<text x="35" y="51" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#92400e">storage</text>
<text x="35" y="75" text-anchor="middle" font-family="monospace" font-size="9" font-weight="bold" fill="#374151">into</text>
<text x="35" y="87" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">insert</text>
</g> <!-- with --> <g transform="translate(320, 10)">
<rect x="0" y="25" width="40" height="25" rx="3" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
<text x="20" y="41" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#1e40af">action</text>
<rect x="50" y="25" width="40" height="25" rx="3" fill="#f3e8ff" stroke="#a855f7" stroke-width="1"/>
<text x="70" y="41" text-anchor="middle" font-family="sans-serif" font-size="8" fill="#7c3aed">data</text>
<text x="45" y="18" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">+</text>
<text x="45" y="65" text-anchor="middle" font-family="monospace" font-size="9" font-weight="bold" fill="#374151">with</text>
<text x="45" y="77" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">provide</text>
</g> <!-- against --> <g transform="translate(410, 10)">
<rect x="0" y="25" width="30" height="25" rx="3" fill="#dcfce7" stroke="#22c55e" stroke-width="1.5"/>
<text x="15" y="41" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#166534">val</text>
<text x="40" y="41" text-anchor="middle" font-family="sans-serif" font-size="10" fill="#6b7280">⟷</text>
<rect x="50" y="25" width="30" height="25" rx="3" fill="#e0e7ff" stroke="#6366f1" stroke-width="1"/>
<text x="65" y="41" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#4338ca">ref</text>
<text x="40" y="65" text-anchor="middle" font-family="monospace" font-size="9" font-weight="bold" fill="#374151">against</text>
<text x="40" y="77" text-anchor="middle" font-family="sans-serif" font-size="7" fill="#9ca3af">compare</text>
</g>
</svg>
</div>
<p>ARO uses eight prepositions, each with specific semantic meaning:</p>
<table>
<thead>
<tr>
<th>Preposition</th>
<th>Primary Meaning</th>
<th>Data Flow</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>from</code></td>
<td>Source/extraction</td>
<td>External → Internal</td>
</tr>
<tr>
<td><code>with</code></td>
<td>Accompaniment/using</td>
<td>Provides data</td>
</tr>
<tr>
<td><code>for</code></td>
<td>Purpose/target</td>
<td>Indicates beneficiary</td>
</tr>
<tr>
<td><code>to</code></td>
<td>Destination</td>
<td>Internal → External</td>
</tr>
<tr>
<td><code>into</code></td>
<td>Insertion/transformation</td>
<td>Internal → Storage</td>
</tr>
<tr>
<td><code>against</code></td>
<td>Comparison/validation</td>
<td>Reference point</td>
</tr>
<tr>
<td><code>via</code></td>
<td>Through/medium</td>
<td>Intermediate channel</td>
</tr>
<tr>
<td><code>on</code></td>
<td>Location/surface</td>
<td>Attachment point</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="from">from</h2>
<p><strong>Meaning:</strong> Source extraction — data flows from an
external source inward.</p>
<p><strong>Indicates:</strong> The origin of data being pulled into the
current context.</p>
<p><strong>Common with:</strong> <code>Extract</code>,
<code>Retrieve</code>, <code>Fetch</code>, <code>Read</code>,
<code>Receive</code></p>
<h3 id="examples-3">Examples</h3>
<pre class="aro"><code>(* Extract from request context *)
&lt;Extract&gt; the &lt;user-id&gt; from the &lt;pathParameters: id&gt;.
&lt;Extract&gt; the &lt;body&gt; from the &lt;request: body&gt;.
&lt;Extract&gt; the &lt;token&gt; from the &lt;headers: authorization&gt;.

(* Retrieve from repository *)
&lt;Retrieve&gt; the &lt;user&gt; from the &lt;user-repository&gt;.
&lt;Retrieve&gt; the &lt;orders&gt; from the &lt;order-repository&gt; where &lt;status&gt; is &quot;active&quot;.

(* Fetch from external URL *)
&lt;Fetch&gt; the &lt;data&gt; from &quot;https://api.example.com/users&quot;.

(* Read from file *)
&lt;Read&gt; the &lt;config&gt; from the &lt;file&gt; with &quot;config.json&quot;.

(* Filter from collection *)
&lt;Filter&gt; the &lt;active&gt; from the &lt;users&gt; where &lt;status&gt; is &quot;active&quot;.</code></pre>
<h3 id="semantic-notes">Semantic Notes</h3>
<ul>
<li><code>from</code> typically indicates an external or persistent
source</li>
<li>Used when data crosses a boundary into the current scope</li>
<li>The preposition signals that the action is “pulling” data</li>
</ul>
<hr />
<h2 id="with">with</h2>
<p><strong>Meaning:</strong> Accompaniment — data provided alongside or
used by the action.</p>
<p><strong>Indicates:</strong> Additional data, parameters, or
configuration.</p>
<p><strong>Common with:</strong> <code>Create</code>,
<code>Return</code>, <code>Emit</code>, <code>Merge</code>,
<code>Log</code></p>
<h3 id="examples-4">Examples</h3>
<pre class="aro"><code>(* Create with data *)
&lt;Create&gt; the &lt;user&gt; with &lt;user-data&gt;.
&lt;Create&gt; the &lt;greeting&gt; with &quot;Hello, World!&quot;.
&lt;Create&gt; the &lt;total&gt; with &lt;subtotal&gt; + &lt;tax&gt;.

(* Return with payload *)
&lt;Return&gt; an &lt;OK: status&gt; with &lt;users&gt;.
&lt;Return&gt; a &lt;Created: status&gt; with &lt;user&gt;.

(* Emit with event data *)
&lt;Emit&gt; a &lt;UserCreated: event&gt; with &lt;user&gt;.
&lt;Emit&gt; an &lt;OrderPlaced: event&gt; with { orderId: &lt;id&gt;, total: &lt;total&gt; }.

(* Merge with updates *)
&lt;Merge&gt; the &lt;updated&gt; from &lt;existing&gt; with &lt;changes&gt;.

(* Log with message *)
&lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Application started&quot;.

(* Read with path *)
&lt;Read&gt; the &lt;content&gt; from the &lt;file&gt; with &quot;data.json&quot;.</code></pre>
<h3 id="semantic-notes-1">Semantic Notes</h3>
<ul>
<li><code>with</code> provides the data or value to use</li>
<li>Often specifies literal values, expressions, or object
references</li>
<li>Indicates “using this” rather than “from this”</li>
</ul>
<hr />
<h2 id="for">for</h2>
<p><strong>Meaning:</strong> Purpose/target — indicates the beneficiary
or purpose.</p>
<p><strong>Indicates:</strong> What the action is intended for or aimed
at.</p>
<p><strong>Common with:</strong> <code>Return</code>, <code>Log</code>,
<code>Compute</code>, <code>Validate</code></p>
<h3 id="examples-5">Examples</h3>
<pre class="aro"><code>(* Return for a target *)
&lt;Return&gt; an &lt;OK: status&gt; for the &lt;request&gt;.
&lt;Return&gt; a &lt;NoContent: status&gt; for the &lt;deletion&gt;.

(* Log for a destination *)
&lt;Log&gt; the &lt;message&gt; for the &lt;console&gt;.
&lt;Log&gt; the &lt;error&gt; for the &lt;error-log&gt;.

(* Compute for an input *)
&lt;Compute&gt; the &lt;total&gt; for the &lt;items&gt;.
&lt;Compute&gt; the &lt;hash&gt; for the &lt;password&gt;.

(* Validate for a type *)
&lt;Validate&gt; the &lt;input&gt; for the &lt;user-type&gt;.</code></pre>
<h3 id="semantic-notes-2">Semantic Notes</h3>
<ul>
<li><code>for</code> indicates purpose or beneficiary</li>
<li>Often used with logging and return statements</li>
<li>Specifies “on behalf of” or “intended for”</li>
</ul>
<hr />
<h2 id="to">to</h2>
<p><strong>Meaning:</strong> Destination — data flows outward to a
target.</p>
<p><strong>Indicates:</strong> The endpoint or recipient of data.</p>
<p><strong>Common with:</strong> <code>Send</code>, <code>Write</code>,
<code>Connect</code></p>
<h3 id="examples-6">Examples</h3>
<pre class="aro"><code>(* Send to destination *)
&lt;Send&gt; the &lt;email&gt; to the &lt;user: email&gt;.
&lt;Send&gt; the &lt;notification&gt; to the &lt;admin&gt;.
&lt;Send&gt; the &lt;request&gt; to &quot;https://api.example.com/webhook&quot;.

(* Write to file *)
&lt;Write&gt; the &lt;data&gt; to the &lt;file&gt; with &quot;output.json&quot;.

(* Connect to service *)
&lt;Connect&gt; the &lt;database&gt; to &quot;postgres://localhost/mydb&quot;.
&lt;Connect&gt; the &lt;socket&gt; to &quot;localhost:9000&quot;.</code></pre>
<h3 id="semantic-notes-3">Semantic Notes</h3>
<ul>
<li><code>to</code> indicates outward data flow</li>
<li>Used when sending or directing data to an external destination</li>
<li>Opposite direction from <code>from</code></li>
</ul>
<hr />
<h2 id="into">into</h2>
<p><strong>Meaning:</strong> Insertion/transformation — data enters or
transforms.</p>
<p><strong>Indicates:</strong> A container or new form for the data.</p>
<p><strong>Common with:</strong> <code>Store</code>,
<code>Transform</code></p>
<h3 id="examples-7">Examples</h3>
<pre class="aro"><code>(* Store into repository *)
&lt;Store&gt; the &lt;user&gt; into the &lt;user-repository&gt;.
&lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
&lt;Store&gt; the &lt;cache-entry&gt; into the &lt;cache&gt;.

(* Transform into format *)
&lt;Transform&gt; the &lt;dto&gt; into the &lt;json&gt;.
&lt;Transform&gt; the &lt;entity&gt; into the &lt;response-model&gt;.</code></pre>
<h3 id="semantic-notes-4">Semantic Notes</h3>
<ul>
<li><code>into</code> suggests insertion or transformation</li>
<li>Used for persistence and format conversion</li>
<li>Implies the data “enters” something</li>
</ul>
<hr />
<h2 id="against">against</h2>
<p><strong>Meaning:</strong> Comparison/validation — data is checked
against a reference.</p>
<p><strong>Indicates:</strong> The standard or rule for comparison.</p>
<p><strong>Common with:</strong> <code>Validate</code>,
<code>Compare</code></p>
<h3 id="examples-8">Examples</h3>
<pre class="aro"><code>(* Validate against schema *)
&lt;Validate&gt; the &lt;input&gt; against the &lt;user: schema&gt;.
&lt;Validate&gt; the &lt;password&gt; against the &lt;password-rules&gt;.
&lt;Validate&gt; the &lt;token&gt; against the &lt;auth-service&gt;.

(* Compare against reference *)
&lt;Compare&gt; the &lt;old-value&gt; against the &lt;new-value&gt;.
&lt;Compare&gt; the &lt;actual&gt; against the &lt;expected&gt;.</code></pre>
<h3 id="semantic-notes-5">Semantic Notes</h3>
<ul>
<li><code>against</code> implies testing or comparison</li>
<li>Used for validation, verification, and comparison</li>
<li>The object is the reference standard</li>
</ul>
<hr />
<h2 id="via">via</h2>
<p><strong>Meaning:</strong> Through/medium — indicates an intermediate
channel.</p>
<p><strong>Indicates:</strong> The pathway or method used.</p>
<p><strong>Common with:</strong> <code>Fetch</code>,
<code>Send</code></p>
<h3 id="examples-9">Examples</h3>
<pre class="aro"><code>(* Fetch via proxy *)
&lt;Fetch&gt; the &lt;data&gt; from &quot;https://api.example.com&quot; via the &lt;proxy&gt;.

(* Send via channel *)
&lt;Send&gt; the &lt;message&gt; to the &lt;user&gt; via the &lt;email-service&gt;.
&lt;Send&gt; the &lt;notification&gt; to the &lt;subscriber&gt; via the &lt;websocket&gt;.</code></pre>
<h3 id="semantic-notes-6">Semantic Notes</h3>
<ul>
<li><code>via</code> indicates an intermediate hop or method</li>
<li>Less common than other prepositions</li>
<li>Used when specifying how data travels</li>
</ul>
<hr />
<h2 id="on">on</h2>
<p><strong>Meaning:</strong> Location/surface — indicates attachment or
location.</p>
<p><strong>Indicates:</strong> The point of attachment or surface.</p>
<p><strong>Common with:</strong> <code>Start</code>,
<code>Serve</code></p>
<h3 id="examples-10">Examples</h3>
<pre class="aro"><code>(* Start on port *)
&lt;Start&gt; the &lt;http-server&gt; on port 8080.
&lt;Start&gt; the &lt;socket-server&gt; on port 9000.

(* Serve on host *)
&lt;Start&gt; the &lt;http-server&gt; on &quot;0.0.0.0:8080&quot;.</code></pre>
<h3 id="semantic-notes-7">Semantic Notes</h3>
<ul>
<li><code>on</code> specifies a location or attachment point</li>
<li>Primarily used for network configuration</li>
<li>Indicates “located at” or “attached to”</li>
</ul>
<hr />
<h2 id="preposition-selection-guide">Preposition Selection Guide</h2>
<table>
<thead>
<tr>
<th>Intent</th>
<th>Preposition</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pull data in</td>
<td><code>from</code></td>
<td><code>&lt;Extract&gt; the &lt;x&gt; from the &lt;y&gt;</code></td>
</tr>
<tr>
<td>Provide data</td>
<td><code>with</code></td>
<td><code>&lt;Create&gt; the &lt;x&gt; with &lt;y&gt;</code></td>
</tr>
<tr>
<td>Indicate purpose</td>
<td><code>for</code></td>
<td><code>&lt;Return&gt; the &lt;x&gt; for the &lt;y&gt;</code></td>
</tr>
<tr>
<td>Push data out</td>
<td><code>to</code></td>
<td><code>&lt;Send&gt; the &lt;x&gt; to the &lt;y&gt;</code></td>
</tr>
<tr>
<td>Store/transform</td>
<td><code>into</code></td>
<td><code>&lt;Store&gt; the &lt;x&gt; into the &lt;y&gt;</code></td>
</tr>
<tr>
<td>Compare/validate</td>
<td><code>against</code></td>
<td><code>&lt;Validate&gt; the &lt;x&gt; against the &lt;y&gt;</code></td>
</tr>
<tr>
<td>Specify channel</td>
<td><code>via</code></td>
<td><code>&lt;Fetch&gt; the &lt;x&gt; via the &lt;y&gt;</code></td>
</tr>
<tr>
<td>Specify location</td>
<td><code>on</code></td>
<td><code>&lt;Start&gt; the &lt;x&gt; on &lt;y&gt;</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="external-source-indicators">External Source Indicators</h2>
<p>Some prepositions indicate external sources:</p>
<div class="sourceCode" id="cb370"><pre
class="sourceCode swift"><code class="sourceCode swift"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a><span class="co">// From Token.swift</span></span>
<span id="cb370-2"><a href="#cb370-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">var</span> <span class="va">indicatesExternalSource</span><span class="op">:</span> Bool <span class="op">{</span></span>
<span id="cb370-3"><a href="#cb370-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="kw">self</span> <span class="op">{</span></span>
<span id="cb370-4"><a href="#cb370-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="op">.</span>from<span class="op">,</span> <span class="op">.</span>via<span class="op">:</span> <span class="kw">return</span> <span class="kw">true</span></span>
<span id="cb370-5"><a href="#cb370-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">default</span><span class="op">:</span> <span class="kw">return</span> <span class="kw">false</span></span>
<span id="cb370-6"><a href="#cb370-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb370-7"><a href="#cb370-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>from</code> and <code>via</code> prepositions signal that
data is coming from outside the current context, which affects semantic
analysis and data flow tracking.</p>
<h1 id="appendix-c-grammar-specification">Appendix C: Grammar
Specification</h1>
<p>This appendix provides the complete formal grammar specification for
ARO using Extended Backus-Naur Form (EBNF).</p>
<h2 id="notation">Notation</h2>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>=</code></td>
<td>Definition</td>
</tr>
<tr>
<td><code>,</code></td>
<td>Concatenation</td>
</tr>
<tr>
<td><code>\|</code></td>
<td>Alternative</td>
</tr>
<tr>
<td><code>[ ]</code></td>
<td>Optional (0 or 1)</td>
</tr>
<tr>
<td><code>{ }</code></td>
<td>Repetition (0 or more)</td>
</tr>
<tr>
<td><code>( )</code></td>
<td>Grouping</td>
</tr>
<tr>
<td><code>" "</code></td>
<td>Terminal string</td>
</tr>
<tr>
<td><code>' '</code></td>
<td>Terminal character</td>
</tr>
<tr>
<td><code>(* *)</code></td>
<td>Comment</td>
</tr>
</tbody>
</table>
<h2 id="program-structure">Program Structure</h2>
<pre class="ebnf"><code>(* Top-level program *)
program = { feature_set } ;

(* Feature set definition *)
feature_set = &quot;(&quot; , feature_name , &quot;:&quot; , business_activity , &quot;)&quot; , block ;

feature_name = identifier | route_pattern ;
business_activity = identifier , { identifier } ;

(* Route patterns for HTTP handlers *)
route_pattern = http_method , route_path ;
http_method = &quot;GET&quot; | &quot;POST&quot; | &quot;PUT&quot; | &quot;DELETE&quot; | &quot;PATCH&quot; ;
route_path = &quot;/&quot; , { path_segment , &quot;/&quot; } , [ path_segment ] ;
path_segment = identifier | path_parameter ;
path_parameter = &quot;{&quot; , identifier , &quot;}&quot; ;

(* Block of statements *)
block = &quot;{&quot; , { statement } , &quot;}&quot; ;</code></pre>
<h2 id="statements">Statements</h2>
<pre class="ebnf"><code>(* Statement types *)
statement = aro_statement
          | guarded_statement
          | publish_statement
          | match_statement ;

(* Core ARO statement: Action-Result-Object *)
aro_statement = action , [ article ] , result , preposition , [ article ] , object , [ modifiers ] , &quot;.&quot; ;

(* Publish statement *)
publish_statement = &quot;&lt;Publish&gt;&quot; , &quot;as&quot; , alias , variable , &quot;.&quot; ;

(* Guarded statement - ARO statement with conditional suffix *)
guarded_statement = aro_statement_base , &quot;when&quot; , condition , &quot;.&quot; ;
aro_statement_base = action , [ article ] , result , preposition , [ article ] , object , [ modifiers ] ;

(* Match statements *)
match_statement = &quot;match&quot; , variable , &quot;{&quot; , { match_case } , [ default_case ] , &quot;}&quot; ;
match_case = &quot;case&quot; , pattern , block ;
pattern = literal | regex_literal | variable ;
default_case = &quot;default&quot; , block | &quot;otherwise&quot; , block ;</code></pre>
<h2 id="actions-and-objects">Actions and Objects</h2>
<pre class="ebnf"><code>(* Action - the verb *)
action = &quot;&lt;&quot; , action_verb , &quot;&gt;&quot; ;
action_verb = identifier ;

(* Result - what is produced *)
result = variable | typed_variable ;

(* Object - the source or target *)
object = variable
       | typed_variable
       | literal
       | file_reference
       | api_reference
       | repository_reference ;

(* Modifiers *)
modifiers = where_clause | with_clause | on_clause ;
where_clause = &quot;where&quot; , condition , { &quot;and&quot; , condition } ;
with_clause = &quot;with&quot; , ( variable | object_literal | literal ) ;
on_clause = &quot;on&quot; , &quot;port&quot; , number ;</code></pre>
<h2 id="variables-and-types">Variables and Types</h2>
<pre class="ebnf"><code>(* Variable forms *)
variable = &quot;&lt;&quot; , identifier , &quot;&gt;&quot; ;
typed_variable = &quot;&lt;&quot; , identifier , &quot;:&quot; , type_hint , &quot;&gt;&quot; ;
qualified_variable = &quot;&lt;&quot; , identifier , &quot;:&quot; , qualifier , &quot;&gt;&quot; ;

(* Type hints *)
type_hint = &quot;JSON&quot; | &quot;bytes&quot; | &quot;List&quot; | &quot;String&quot; | &quot;Number&quot; | &quot;Boolean&quot; | &quot;Date&quot; | identifier ;

(* Qualifier for accessing properties *)
qualifier = identifier , { identifier } ;

(* Alias for publishing *)
alias = &quot;&lt;&quot; , identifier , &quot;&gt;&quot; ;</code></pre>
<h2 id="references">References</h2>
<pre class="ebnf"><code>(* File reference *)
file_reference = &quot;&lt;&quot; , &quot;file:&quot; , ( string_literal | variable ) , &quot;&gt;&quot; ;

(* Directory reference *)
directory_reference = &quot;&lt;&quot; , &quot;directory:&quot; , string_literal , &quot;&gt;&quot; ;

(* API reference *)
api_reference = &quot;&lt;&quot; , api_name , &quot;:&quot; , [ http_method ] , route_path , &quot;&gt;&quot; ;
api_name = identifier ;

(* Repository reference *)
repository_reference = &quot;&lt;&quot; , identifier , &quot;-repository&quot; , &quot;&gt;&quot; ;

(* Host reference *)
host_reference = &quot;&lt;&quot; , &quot;host:&quot; , string_literal , &quot;&gt;&quot; ;</code></pre>
<h2 id="conditions">Conditions</h2>
<pre class="ebnf"><code>(* Condition expressions *)
condition = comparison | existence_check | boolean_condition ;

(* Comparisons *)
comparison = variable , comparison_op , ( variable | literal | regex_literal ) ;
comparison_op = &quot;is&quot; | &quot;is not&quot; | &quot;&gt;&quot; | &quot;&lt;&quot; | &quot;&gt;=&quot; | &quot;&lt;=&quot; | &quot;matches&quot; | &quot;contains&quot; ;

(* Existence checks *)
existence_check = variable , ( &quot;is empty&quot; | &quot;is not empty&quot; ) ;

(* Boolean combinations *)
boolean_condition = condition , boolean_op , condition ;
boolean_op = &quot;and&quot; | &quot;or&quot; ;

(* Negation *)
negation = &quot;not&quot; , condition ;</code></pre>
<h2 id="literals">Literals</h2>
<pre class="ebnf"><code>(* Literal values *)
literal = string_literal | number | boolean | object_literal ;

(* String literal *)
string_literal = &#39;&quot;&#39; , { string_char | interpolation } , &#39;&quot;&#39; ;
string_char = (* any character except &quot; and $ *) | escape_sequence ;
escape_sequence = &quot;\\&quot; , ( &#39;&quot;&#39; | &quot;\\&quot; | &quot;n&quot; | &quot;t&quot; | &quot;r&quot; ) ;
interpolation = &quot;${&quot; , ( identifier | qualified_variable ) , &quot;}&quot; ;

(* Number literal *)
number = [ &quot;-&quot; ] , digit , { digit } , [ &quot;.&quot; , digit , { digit } ] ;

(* Boolean literal *)
boolean = &quot;true&quot; | &quot;false&quot; ;

(* Object literal *)
object_literal = &quot;{&quot; , [ property , { &quot;,&quot; , property } ] , &quot;}&quot; ;
property = property_name , &quot;:&quot; , ( literal | variable ) ;
property_name = identifier | string_literal ;

(* Regex literal *)
regex_literal = &quot;/&quot; , regex_body , &quot;/&quot; , [ regex_flags ] ;
regex_body = { regex_char | regex_escape } ;
regex_char = (* any character except &quot;/&quot; and newline *) ;
regex_escape = &quot;\\&quot; , (* any character *) ;
regex_flags = { &quot;i&quot; | &quot;s&quot; | &quot;m&quot; | &quot;g&quot; } ;</code></pre>
<h3 id="regex-flags-1">Regex Flags</h3>
<table>
<thead>
<tr>
<th>Flag</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>i</code></td>
<td>Case insensitive matching</td>
</tr>
<tr>
<td><code>s</code></td>
<td>Dot matches newlines (dotall)</td>
</tr>
<tr>
<td><code>m</code></td>
<td>Multiline mode (^ and $ match line boundaries)</td>
</tr>
<tr>
<td><code>g</code></td>
<td>Global (reserved for future replace operations)</td>
</tr>
</tbody>
</table>
<h2 id="lexical-elements">Lexical Elements</h2>
<pre class="ebnf"><code>(* Identifier *)
identifier = letter , { letter | digit | &quot;-&quot; } ;

(* Article *)
article = &quot;a&quot; | &quot;an&quot; | &quot;the&quot; ;

(* Preposition *)
preposition = &quot;from&quot; | &quot;to&quot; | &quot;for&quot; | &quot;with&quot; | &quot;into&quot; | &quot;against&quot; | &quot;via&quot; | &quot;on&quot; | &quot;as&quot; ;

(* Basic character classes *)
letter = &quot;a&quot; | &quot;b&quot; | ... | &quot;z&quot; | &quot;A&quot; | &quot;B&quot; | ... | &quot;Z&quot; ;
digit = &quot;0&quot; | &quot;1&quot; | ... | &quot;9&quot; ;

(* Whitespace (ignored) *)
whitespace = &quot; &quot; | &quot;\t&quot; | &quot;\n&quot; | &quot;\r&quot; ;

(* Comment *)
comment = &quot;(*&quot; , { any_char } , &quot;*)&quot; ;</code></pre>
<h2 id="special-feature-sets">Special Feature Sets</h2>
<pre class="ebnf"><code>(* Application lifecycle *)
application_start = &quot;(&quot; , &quot;Application-Start&quot; , &quot;:&quot; , business_activity , &quot;)&quot; , block ;
application_end_success = &quot;(&quot; , &quot;Application-End&quot; , &quot;:&quot; , &quot;Success&quot; , &quot;)&quot; , block ;
application_end_error = &quot;(&quot; , &quot;Application-End&quot; , &quot;:&quot; , &quot;Error&quot; , &quot;)&quot; , block ;

(* Event handlers *)
event_handler = &quot;(&quot; , handler_name , &quot;:&quot; , event_type , &quot;Handler&quot; , &quot;)&quot; , block ;
handler_name = identifier , { identifier } ;
event_type = identifier ;</code></pre>
<h2 id="api-definitions">API Definitions</h2>
<pre class="ebnf"><code>(* API definition block *)
api_definition = &quot;api&quot; , identifier , &quot;{&quot; , { api_property } , &quot;}&quot; ;
api_property = property_name , &quot;:&quot; , ( string_literal | object_literal ) , &quot;;&quot; ;</code></pre>
<h2 id="complete-examples">Complete Examples</h2>
<h3 id="minimal-program">Minimal Program</h3>
<pre><code>program = feature_set
        = &quot;(&quot; , &quot;Application-Start&quot; , &quot;:&quot; , &quot;Test&quot; , &quot;)&quot; , block
        = &quot;(&quot; , &quot;Application-Start&quot; , &quot;:&quot; , &quot;Test&quot; , &quot;)&quot; , &quot;{&quot; , statement , &quot;}&quot;
        = &quot;(&quot; , &quot;Application-Start&quot; , &quot;:&quot; , &quot;Test&quot; , &quot;)&quot; , &quot;{&quot; , aro_statement , &quot;}&quot;
        = &quot;(&quot; , &quot;Application-Start&quot; , &quot;:&quot; , &quot;Test&quot; , &quot;)&quot; , &quot;{&quot; ,
            &quot;&lt;Return&gt;&quot; , &quot;an&quot; , &quot;&lt;OK: status&gt;&quot; , &quot;for&quot; , &quot;the&quot; , &quot;&lt;startup&gt;&quot; , &quot;.&quot; ,
          &quot;}&quot;</code></pre>
<h3 id="aro-statement-parse">ARO Statement Parse</h3>
<pre><code>&quot;&lt;Extract&gt; the &lt;user-id&gt; from the &lt;request: parameters&gt;.&quot;

= aro_statement
= action , article , result , preposition , article , object , &quot;.&quot;
= &quot;&lt;Extract&gt;&quot; , &quot;the&quot; , &quot;&lt;user-id&gt;&quot; , &quot;from&quot; , &quot;the&quot; , &quot;&lt;request: parameters&gt;&quot; , &quot;.&quot;</code></pre>
<h3 id="guarded-statement-parse">Guarded Statement Parse</h3>
<pre><code>&quot;&lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;user&gt; when &lt;user&gt; is empty.&quot;

= guarded_statement
= aro_statement_base , &quot;when&quot; , condition , &quot;.&quot;
= action , result , preposition , object , &quot;when&quot; , existence_check , &quot;.&quot;
= &quot;&lt;Return&gt;&quot; , &quot;a&quot; , &quot;&lt;NotFound: status&gt;&quot; , &quot;for&quot; , &quot;the&quot; , &quot;&lt;user&gt;&quot; , &quot;when&quot; , &quot;&lt;user&gt;&quot; , &quot;is empty&quot; , &quot;.&quot;</code></pre>
<h2 id="precedence">Precedence</h2>
<p>Operator precedence (highest to lowest):</p>
<ol type="1">
<li>Parentheses <code>( )</code></li>
<li><code>not</code></li>
<li>Comparisons (<code>is</code>, <code>is not</code>,
<code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>,
<code>&lt;=</code>)</li>
<li><code>and</code></li>
<li><code>or</code></li>
</ol>
<h2 id="reserved-words">Reserved Words</h2>
<p>The following identifiers are reserved:</p>
<p><strong>Articles:</strong> <code>a</code>, <code>an</code>,
<code>the</code></p>
<p><strong>Prepositions:</strong> <code>from</code>, <code>to</code>,
<code>for</code>, <code>with</code>, <code>into</code>,
<code>against</code>, <code>via</code>, <code>on</code>,
<code>as</code></p>
<p><strong>Control Flow:</strong> <code>when</code>, <code>match</code>,
<code>case</code>, <code>default</code>, <code>otherwise</code>,
<code>where</code>, <code>and</code>, <code>or</code>, <code>not</code>,
<code>is</code></p>
<p><strong>Literals:</strong> <code>true</code>, <code>false</code>,
<code>empty</code></p>
<p><strong>Status Codes:</strong> <code>OK</code>, <code>Created</code>,
<code>Accepted</code>, <code>NoContent</code>, <code>BadRequest</code>,
<code>Unauthorized</code>, <code>Forbidden</code>,
<code>NotFound</code>, <code>Conflict</code>,
<code>InternalError</code>, <code>ServiceUnavailable</code></p>
<p><strong>Special:</strong> <code>Application-Start</code>,
<code>Application-End</code>, <code>Success</code>, <code>Error</code>,
<code>Handler</code></p>
<h2 id="file-encoding">File Encoding</h2>
<p>ARO source files must be encoded in UTF-8. The <code>.aro</code> file
extension is required.</p>
<h1 id="appendix-d-statements-reference">Appendix D: Statements
Reference</h1>
<p>This appendix provides a complete reference for all statement types
in ARO.</p>
<h2 id="aro-statement">ARO Statement</h2>
<p>The fundamental statement type following the Action-Result-Object
pattern.</p>
<h3 id="syntax-2">Syntax</h3>
<pre><code>&lt;Action&gt; [article] &lt;result&gt; preposition [article] &lt;object&gt; [modifiers].</code></pre>
<h3 id="components">Components</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Action</td>
<td>Yes</td>
<td>Verb in angle brackets</td>
</tr>
<tr>
<td>Article</td>
<td>No</td>
<td>a, an, or the</td>
</tr>
<tr>
<td>Result</td>
<td>Yes</td>
<td>Output variable</td>
</tr>
<tr>
<td>Preposition</td>
<td>Yes</td>
<td>Relationship word</td>
</tr>
<tr>
<td>Object</td>
<td>Yes</td>
<td>Input/target</td>
</tr>
<tr>
<td>Modifiers</td>
<td>No</td>
<td>where, with, on, when clauses</td>
</tr>
</tbody>
</table>
<h3 id="examples-11">Examples</h3>
<pre class="aro"><code>&lt;Extract&gt; the &lt;user-id&gt; from the &lt;request: parameters&gt;.
&lt;Create&gt; a &lt;user&gt; with &lt;user-data&gt;.
&lt;Return&gt; an &lt;OK: status&gt; for the &lt;request&gt;.
&lt;Store&gt; the &lt;order&gt; into the &lt;order-repository&gt;.
&lt;Retrieve&gt; the &lt;user&gt; from the &lt;repository&gt; where id = &lt;user-id&gt;.
&lt;Start&gt; the &lt;http-server&gt; on port 8080.</code></pre>
<h2 id="publish-statement">Publish Statement</h2>
<p>Makes a variable globally accessible across feature sets.</p>
<h3 id="syntax-3">Syntax</h3>
<pre><code>&lt;Publish&gt; as &lt;alias&gt; &lt;variable&gt;.</code></pre>
<h3 id="components-1">Components</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>alias</td>
<td>Name to publish under</td>
</tr>
<tr>
<td>variable</td>
<td>Variable to publish</td>
</tr>
</tbody>
</table>
<h3 id="example-1">Example</h3>
<pre class="aro"><code>&lt;Read&gt; the &lt;config&gt; from the &lt;file: &quot;./config.json&quot;&gt;.
&lt;Publish&gt; as &lt;app-config&gt; &lt;config&gt;.</code></pre>
<h2 id="guarded-statement-when">Guarded Statement (when)</h2>
<p>Conditionally executes a statement based on a condition. If the
condition is false, the statement is skipped.</p>
<h3 id="syntax-4">Syntax</h3>
<pre><code>&lt;Action&gt; the &lt;result&gt; preposition the &lt;object&gt; when &lt;condition&gt;.</code></pre>
<h3 id="conditions-1">Conditions</h3>
<table>
<thead>
<tr>
<th>Condition</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;var&gt; is &lt;value&gt;</code></td>
<td>Equality</td>
</tr>
<tr>
<td><code>&lt;var&gt; is not &lt;value&gt;</code></td>
<td>Inequality</td>
</tr>
<tr>
<td><code>&lt;var&gt; is empty</code></td>
<td>Null/empty check</td>
</tr>
<tr>
<td><code>&lt;var&gt; is not empty</code></td>
<td>Has value</td>
</tr>
<tr>
<td><code>&lt;var&gt; exists</code></td>
<td>Value exists</td>
</tr>
<tr>
<td><code>&lt;var&gt; is null</code></td>
<td>Null check</td>
</tr>
<tr>
<td><code>&lt;var&gt; &gt; &lt;value&gt;</code></td>
<td>Greater than</td>
</tr>
<tr>
<td><code>&lt;var&gt; &lt; &lt;value&gt;</code></td>
<td>Less than</td>
</tr>
<tr>
<td><code>&lt;var&gt; &gt;= &lt;value&gt;</code></td>
<td>Greater or equal</td>
</tr>
<tr>
<td><code>&lt;var&gt; &lt;= &lt;value&gt;</code></td>
<td>Less or equal</td>
</tr>
<tr>
<td><code>&lt;cond1&gt; and &lt;cond2&gt;</code></td>
<td>Both true</td>
</tr>
<tr>
<td><code>&lt;cond1&gt; or &lt;cond2&gt;</code></td>
<td>Either true</td>
</tr>
<tr>
<td><code>not &lt;cond&gt;</code></td>
<td>Negation</td>
</tr>
</tbody>
</table>
<h3 id="examples-12">Examples</h3>
<pre class="aro"><code>(* Return not found only when user is empty *)
&lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;missing: user&gt; when &lt;user&gt; is empty.

(* Send notification only when user has email *)
&lt;Send&gt; the &lt;notification&gt; to the &lt;user: email&gt; when &lt;user: email&gt; exists.

(* Log admin access only for admins *)
&lt;Log&gt; the &lt;admin-access&gt; for the &lt;audit&gt; when &lt;user: role&gt; = &quot;admin&quot;.

(* Early exit on invalid input *)
&lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;invalid: amount&gt; when &lt;amount&gt; &lt;= 0.

(* Combined conditions *)
&lt;Grant&gt; the &lt;access&gt; for the &lt;user&gt; when &lt;user: active&gt; is true and &lt;user: verified&gt; is true.</code></pre>
<h3 id="usage-pattern">Usage Pattern</h3>
<pre class="aro"><code>(PUT /users/{id}: User API) {
    &lt;Extract&gt; the &lt;user-id&gt; from the &lt;request: parameters&gt;.
    &lt;Extract&gt; the &lt;updates&gt; from the &lt;request: body&gt;.

    (* Early exit guards *)
    &lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;missing: id&gt; when &lt;user-id&gt; is empty.
    &lt;Return&gt; a &lt;BadRequest: status&gt; for the &lt;missing: data&gt; when &lt;updates&gt; is empty.

    (* Continue with valid input *)
    &lt;Retrieve&gt; the &lt;user&gt; from the &lt;repository&gt; where id = &lt;user-id&gt;.
    &lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;missing: user&gt; when &lt;user&gt; is empty.

    &lt;Transform&gt; the &lt;updated-user&gt; from the &lt;user&gt; with &lt;updates&gt;.
    &lt;Store&gt; the &lt;updated-user&gt; into the &lt;repository&gt;.
    &lt;Return&gt; an &lt;OK: status&gt; with &lt;updated-user&gt;.
}</code></pre>
<h2 id="match-statement">Match Statement</h2>
<p>Pattern matching for multiple cases.</p>
<h3 id="syntax-5">Syntax</h3>
<pre><code>match &lt;variable&gt; {
    case &lt;value1&gt; {
        (* statements *)
    }
    case &lt;value2&gt; {
        (* statements *)
    }
    otherwise {
        (* fallback statements *)
    }
}</code></pre>
<h3 id="case-with-guard">Case with Guard</h3>
<pre><code>match &lt;variable&gt; {
    case &lt;value&gt; where &lt;condition&gt; {
        (* statements *)
    }
}</code></pre>
<h3 id="example-2">Example</h3>
<pre class="aro"><code>match &lt;status&gt; {
    case &quot;pending&quot; {
        &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Order is pending&quot;.
    }
    case &quot;shipped&quot; {
        &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Order has shipped&quot;.
        &lt;Emit&gt; an &lt;OrderShipped: event&gt; with &lt;order&gt;.
    }
    case &quot;delivered&quot; {
        &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Order delivered&quot;.
        &lt;Emit&gt; an &lt;OrderDelivered: event&gt; with &lt;order&gt;.
    }
    otherwise {
        &lt;Log&gt; the &lt;warning&gt; for the &lt;console&gt; with &quot;Unknown status&quot;.
    }
}</code></pre>
<h3 id="pattern-matching-with-guards-1">Pattern Matching with
Guards</h3>
<pre class="aro"><code>match &lt;user: subscription&gt; {
    case &lt;premium&gt; where &lt;user: credits&gt; &gt; 0 {
        &lt;Grant&gt; the &lt;premium-features&gt; for the &lt;user&gt;.
        &lt;Deduct&gt; the &lt;credit&gt; from the &lt;user: account&gt;.
    }
    case &lt;premium&gt; {
        &lt;Notify&gt; the &lt;user&gt; about the &lt;low-credits&gt;.
        &lt;Grant&gt; the &lt;basic-features&gt; for the &lt;user&gt;.
    }
    case &lt;basic&gt; {
        &lt;Grant&gt; the &lt;basic-features&gt; for the &lt;user&gt;.
    }
    otherwise {
        &lt;Redirect&gt; the &lt;user&gt; to the &lt;subscription-page&gt;.
    }
}</code></pre>
<h2 id="return-statement">Return Statement</h2>
<p>Exits the feature set with a response.</p>
<h3 id="syntax-6">Syntax</h3>
<pre><code>&lt;Return&gt; [article] &lt;status&gt; [with &lt;data&gt;] [for &lt;context&gt;].</code></pre>
<h3 id="status-codes">Status Codes</h3>
<table>
<thead>
<tr>
<th>Status</th>
<th>HTTP Code</th>
<th>Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>OK</code></td>
<td>200</td>
<td>Successful request</td>
</tr>
<tr>
<td><code>Created</code></td>
<td>201</td>
<td>Resource created</td>
</tr>
<tr>
<td><code>Accepted</code></td>
<td>202</td>
<td>Async operation started</td>
</tr>
<tr>
<td><code>NoContent</code></td>
<td>204</td>
<td>Success, no body</td>
</tr>
<tr>
<td><code>BadRequest</code></td>
<td>400</td>
<td>Invalid input</td>
</tr>
<tr>
<td><code>Unauthorized</code></td>
<td>401</td>
<td>Auth required</td>
</tr>
<tr>
<td><code>Forbidden</code></td>
<td>403</td>
<td>Access denied</td>
</tr>
<tr>
<td><code>NotFound</code></td>
<td>404</td>
<td>Not found</td>
</tr>
<tr>
<td><code>Conflict</code></td>
<td>409</td>
<td>Resource conflict</td>
</tr>
<tr>
<td><code>UnprocessableEntity</code></td>
<td>422</td>
<td>Validation failed</td>
</tr>
<tr>
<td><code>TooManyRequests</code></td>
<td>429</td>
<td>Rate limited</td>
</tr>
<tr>
<td><code>InternalError</code></td>
<td>500</td>
<td>Server error</td>
</tr>
<tr>
<td><code>ServiceUnavailable</code></td>
<td>503</td>
<td>Service down</td>
</tr>
</tbody>
</table>
<h3 id="examples-13">Examples</h3>
<pre class="aro"><code>&lt;Return&gt; an &lt;OK: status&gt; with &lt;data&gt;.
&lt;Return&gt; a &lt;Created: status&gt; with &lt;resource&gt;.
&lt;Return&gt; a &lt;NoContent: status&gt; for the &lt;deletion&gt;.
&lt;Return&gt; a &lt;BadRequest: status&gt; with &lt;validation: errors&gt;.
&lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;missing: user&gt;.
&lt;Return&gt; a &lt;Forbidden: status&gt; for the &lt;unauthorized: access&gt;.</code></pre>
<h2 id="comment">Comment</h2>
<p>Adds documentation to code.</p>
<h3 id="syntax-7">Syntax</h3>
<pre><code>(* comment text *)</code></pre>
<h3 id="examples-14">Examples</h3>
<pre class="aro"><code>(* This is a single-line comment *)

(*
   This is a
   multi-line comment
*)

(* Comments can be (* nested *) *)

(Process Order: Order Processing) {
    (* Extract order data from request *)
    &lt;Extract&gt; the &lt;order-data&gt; from the &lt;request: body&gt;.

    (* Validate before processing *)
    &lt;Validate&gt; the &lt;order-data&gt; for the &lt;order-schema&gt;.

    (* Store and return *)
    &lt;Store&gt; the &lt;order&gt; into the &lt;repository&gt;.
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;order&gt;.
}</code></pre>
<h2 id="where-clause">Where Clause</h2>
<p>Filters data in retrieval and deletion.</p>
<h3 id="syntax-8">Syntax</h3>
<pre><code>... where &lt;field&gt; = &lt;value&gt;
... where &lt;field&gt; = &lt;value&gt; and &lt;field2&gt; = &lt;value2&gt;</code></pre>
<h3 id="examples-15">Examples</h3>
<pre class="aro"><code>&lt;Retrieve&gt; the &lt;user&gt; from the &lt;repository&gt; where id = &lt;user-id&gt;.
&lt;Retrieve&gt; the &lt;orders&gt; from the &lt;repository&gt; where status = &quot;pending&quot;.
&lt;Retrieve&gt; the &lt;users&gt; from the &lt;repository&gt; where role = &quot;admin&quot; and active = true.
&lt;Delete&gt; the &lt;sessions&gt; from the &lt;repository&gt; where userId = &lt;user-id&gt;.</code></pre>
<h2 id="with-clause">With Clause</h2>
<p>Provides additional data or parameters.</p>
<h3 id="syntax-9">Syntax</h3>
<pre><code>... with &lt;variable&gt;
... with &lt;object-literal&gt;
... with &lt;string-literal&gt;</code></pre>
<h3 id="examples-16">Examples</h3>
<pre class="aro"><code>&lt;Create&gt; the &lt;user&gt; with &lt;user-data&gt;.
&lt;Create&gt; the &lt;config&gt; with { debug: true, port: 8080 }.
&lt;Transform&gt; the &lt;updated&gt; from the &lt;user&gt; with &lt;updates&gt;.
&lt;Send&gt; the &lt;message&gt; to the &lt;connection&gt; with &quot;Hello, World!&quot;.
&lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;Application started&quot;.</code></pre>
<h2 id="on-clause">On Clause</h2>
<p>Specifies ports for network operations.</p>
<h3 id="syntax-10">Syntax</h3>
<pre><code>... on port &lt;number&gt;</code></pre>
<h3 id="examples-17">Examples</h3>
<pre class="aro"><code>&lt;Start&gt; the &lt;http-server&gt; on port 8080.
&lt;Listen&gt; on port 9000 as &lt;socket-server&gt;.
&lt;Connect&gt; to &lt;host: &quot;localhost&quot;&gt; on port 5432 as &lt;database&gt;.</code></pre>
<h2 id="when-clause">When Clause</h2>
<p>Conditionally executes a statement.</p>
<h3 id="syntax-11">Syntax</h3>
<pre><code>&lt;Action&gt; the &lt;result&gt; preposition the &lt;object&gt; when &lt;condition&gt;.</code></pre>
<h3 id="examples-18">Examples</h3>
<pre class="aro"><code>&lt;Return&gt; a &lt;NotFound: status&gt; for the &lt;user&gt; when &lt;user&gt; is empty.
&lt;Log&gt; the &lt;warning&gt; for the &lt;console&gt; with &quot;Low stock&quot; when &lt;stock&gt; &lt; 10.
&lt;Send&gt; the &lt;alert&gt; to the &lt;admin: email&gt; when &lt;errors&gt; &gt; &lt;threshold&gt;.</code></pre>
<h2 id="statement-order">Statement Order</h2>
<p>Statements execute sequentially from top to bottom:</p>
<pre class="aro"><code>(Process Request: Handler) {
    (* 1. First *)
    &lt;Extract&gt; the &lt;data&gt; from the &lt;request: body&gt;.

    (* 2. Second *)
    &lt;Validate&gt; the &lt;data&gt; for the &lt;schema&gt;.

    (* 3. Third *)
    &lt;Create&gt; the &lt;result&gt; with &lt;data&gt;.

    (* 4. Fourth *)
    &lt;Store&gt; the &lt;result&gt; into the &lt;repository&gt;.

    (* 5. Fifth - ends execution *)
    &lt;Return&gt; a &lt;Created: status&gt; with &lt;result&gt;.

    (* Never executed - after return *)
    &lt;Log&gt; the &lt;message&gt; for the &lt;console&gt; with &quot;This won&#39;t run&quot;.
}</code></pre>
<h2 id="statement-termination-1">Statement Termination</h2>
<p>All statements end with a period (<code>.</code>):</p>
<pre class="aro"><code>(* Correct *)
&lt;Extract&gt; the &lt;data&gt; from the &lt;request&gt;.
&lt;Return&gt; an &lt;OK: status&gt; with &lt;data&gt;.

(* Incorrect - missing period *)
&lt;Extract&gt; the &lt;data&gt; from the &lt;request&gt;</code></pre>
<p>Match blocks use braces without periods on closing brace:</p>
<pre class="aro"><code>match &lt;status&gt; {
    case &quot;active&quot; {
        &lt;Return&gt; an &lt;OK: status&gt;.  (* Period on inner statement *)
    }
}  (* No period on closing brace *)</code></pre>
</body></html>
